<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Redis 的持久化方案</title>
      <link href="/2018/07/18/cjjrthlip007mc7rdyj444jsz/"/>
      <content type="html"><![CDATA[<p>Redis 支持 RDB 和 AOF 两种持久化机制，持久化功能有效地避免因为进程退出造成数据丢失的问题，当下次重启时利用之前持久化的文件即可实现数据恢复。</p><h1 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h1><p>RDB 可以指定时间间隔保存数据快照，这有些类似于数据库表快照性质的，也就是说他隔一段时间就会把数据拍个照片然后保存下来，这也是数据库常用的备份方式，在某一个时间点执行备份 sql 或者是备份目录之类的，出发 RDB 持久化过程分为手动出发和自动触发。</p><h2 id="触发机制"><a href="#触发机制" class="headerlink" title="触发机制"></a>触发机制</h2><p>手动出发分别对应 save 和 bgsave 命令：</p><p><strong>save 命令：</strong>阻塞当前 Redis 服务器，直到 RDB 过程完成为止，对于内存比较大的实例会造成长时间堵塞，线上环境不建议使用。运行 save 命令对应的 Redis 如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB saved on disk</div></pre></td></tr></table></figure><p><strong>bgsave 命令：</strong>Redis 执行 fork 进程操作创建子进程，RDB 持久化过程由紫禁城负责，完成后自动结束。阻塞只发生在 fork 阶段，一般时间很短。运行 bgsave 命令对应的 Redis 日志如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Backgroud saving stated by pid 3151</div><div class="line">DB saved on disk</div><div class="line">RDB: 0 MB of memory used by copy-on-write</div><div class="line">Background saving terminated with success</div></pre></td></tr></table></figure><p>显然bgsave 命令是针对 save 阻塞问题做的优化，因此Redis 内部所有涉及 RDB 的操作都采用 bgsave 的方式，而 save 命令已经被废弃了。</p><p>除了手动触发，之外，Redis 内部还存在自动触发 RDB 的持久化机制：</p><ol><li>使用 save 相关配置，如“save m n”表示 m 秒内数据集存在n 此修改时，自动触发bgsave。</li><li>如果从节点执行全量赋值操作，主节点自动执行 bgsave 生成 RDB 文件并发送给从节点</li><li>执行 debug reload 命令重新加载 Redis 时，也会自动触发 save 操作。</li><li>默认情况下执行 shotdown 命令时，如果没有开启 AOF 持久化功能则自动执行 bgsave</li></ol><h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><ol><li>执行 bgsave 命令，Redis 父进程判断当前是否存在正在执行的子进程，如 RDB/AOF 子进程，如果存在 bgsave 命令则直接返回。</li><li>父进程执行 fork 操作创建子进程，fork 操作过程中父进程会阻塞，通过 info stats 命令查看 latest_fork_usec 选项，可以获取最近一个 fork 操作的耗时，单位为微秒。</li><li>父进程 fork 完成后，bgsave 命令返回“Background saveing started”信息并不再阻塞父进程，可以继续响应其他命令。</li><li>子进程创建 RDB 文件，根据父进程内存生成临时快照文件，完成后对原有文件进行原子替换。执行 lastsave 命令可以获取最后一次生成 RDB 的时间，对应 info 统计的 rdb_last_save_time 选项。</li><li>进程发送信号告诉父进程表示完成，父进程更新统计信息，具体见 info Persistence 下的 rdb_*相关选项。</li></ol><p>RDB 文件保存在 dir 配置指定的目录下，文件通过dbfilename 配置指定。可以公国执行 config set dir {newDir}和 config set dbfilename {newFilename} 运行期间动态执行，当下次运行 RDB 文件会保存到新目录上。</p><h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><p><strong>RDB 模式的优点</strong></p><ul><li>适用于进行备份</li><li>fork 出子进程进行备份，主进程没有任何 IO 操作</li><li>恢复大数据集时的速度快</li></ul><p><strong>RDB 模式的优点：</strong></p><ul><li>特定条件下进行一次持久化，易丢失数据</li><li>庞大数据时，保存时会出现性能问题</li></ul><p>相比之下，RDB 模式将时间设置的相对密集了，频繁的备份就会占用较多的资源，但是如果把时间拉的比较远了，万一出问题，就会恢复到上一个时间点，很可能会丢失数据。</p><h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>AOF 以独立日志的方式保存所有历史操作命令，当需要回复的时候，会按照之前输入的命令挨个都执行一次，主要作用是解决了数据持久化的实时性，目前已经是 Redis 持久化的主流方式。</p><p>配置方式；</p><blockquote><p> redis.confg: appendonly yes</p></blockquote><p>AOF 默认不开启，AOF 文件名通过 appendfilename 进行培植，默认文件名是 appendonly.aof，保存路径与 RDB 一样，需要通过 dir 配置指定。</p><p>AOF 工作流程：命令写入（append）、文件同步（sync）、文件重写（Write）、重启加载（load）</p><p>在命令写入命令时候，Redis 会将命令追加到 aof_buf(缓冲区中)，然后再根据对应的策略向硬盘做同步操作，随着AOF 文件越来越大，需要定期对 AOF 文件进行重写达到压缩的目的。</p><p>当 Redis 重启时候，可以加载 AOF 文件进行恢复。</p><p>AOF 命令的写入的内容直接是文本协议格式，例如 set hello world 这套命令，在 AOF 缓冲区会追加如下文本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*3\r\n$3\rnset\r\n$5\r]nhello\r\n$5\r\nworld\r\n</div></pre></td></tr></table></figure><p>这样有一个好处，文本协议具有可读性，方便直接修改和处理，而且直接采用协议格式，可以避免了二次处理的开销。</p><p>缓冲区同步文件策略：</p><table><thead><tr><th>可配置值</th><th>说明</th></tr></thead><tbody><tr><td>always</td><td>命令写入 aof_buf 后调用系统 fsync 操作同步到 AOF 文件，fsync 完成后线程返回</td></tr><tr><td>everysec</td><td>命令写入 aof_buf 后调用系统 Write 操作，Write 操作完成后县城返回。fsync 同步文件操作由专门线程每秒调用一次。</td></tr><tr><td>no</td><td>命令写入 aof_buf 后调用系统 Write 操作，不对 AOF 文件做 fsync 同步，同步硬盘操作系统由操作系统负责，通常同步周期最长30秒</td></tr></tbody></table><p>系统调用 Write 和 fsync 说明：</p><p>Write 操作会触发延迟写机制，Linux 在内核提供页缓冲区来提高硬盘 IO 性能。Write 操操作在写入系统缓冲区后直接返回，同步硬盘操作依赖于系统调度机制不过同步文件之前，如果此时系统故障宕机，缓冲区内数据将丢失。</p><p>fsync 针对单个文件操作，做强制硬盘同步，fsyn 将阻塞直接写到硬盘完成后返回，保证了数据持久化。</p><h2 id="重写机制"><a href="#重写机制" class="headerlink" title="重写机制"></a>重写机制</h2><h1 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h1><p><strong>AOF模式的优点</strong></p><ul><li>数据非常完整，故障恢复丢失数据少</li><li>可对历史记录进行处理</li></ul><p><strong>AOF模式的缺点</strong></p><ul><li>把整个操作都记录下来，这也就导致了文件体积较大</li><li>速度低于 RDB 且故障恢复速度慢，如果几十万次或者上百万条记录，要比 RDB 慢上很多。</li></ul><p>这两种模式可以同时开启，但是会优先加载 AOF。但是需要注意，如果想要同时开启，尤其 AOF 模式最好 Redis 比较干净的时候就开启，刚开始的时候，我们用的 RDB 模式进行的备份，而 AOF 模式会从 AOF 的那个时间点开始计算，如果在之前有数据，恢复的时候就会出问题了。</p>]]></content>
      
      
    </entry>
    
    <entry>
      <title>从简单的示例中入门 Redis 五种常用数据结构</title>
      <link href="/2018/07/17/1/"/>
      <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Redis 是完全开源免费的，遵守 BSD 协议，是一个高性能的 key-value 数据库。</p><ul><li>简单的 key-value 存储，性能极高</li><li>Redis 拥有更多的数据结构和支持更丰富的数据操作</li><li>Redis 支持数据持久化和数据恢复</li><li>Redis 的所有操作都是原子性的</li><li>服务器支持 AUTH 密码验证</li></ul><h1 id="Redis-和-PHP-组件的依赖关系"><a href="#Redis-和-PHP-组件的依赖关系" class="headerlink" title="Redis 和 PHP 组件的依赖关系"></a>Redis 和 PHP 组件的依赖关系</h1><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180717191043.png" alt=""></p><p>在 Redis 的安装时，有一个配置文件，可以在安装的时候进行详细的配置，安装之后会带一个 cli 命令行的工具，相对而言 Memcached 并没与这样的工具，我们在使用memcached需要使用 telnet，所以 Redis 的命令行要比 Memcache 要好用很多。</p><p>连接方式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis-cli -h host -p port -a password</div></pre></td></tr></table></figure><p>PHP 如果想要连接 Redis 就必须安装 Redis 扩展。</p><p>在这里就不赘述如何进行安装了，我们可以使用包管理工具或者是编译安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis-server</div><div class="line">redis-cli</div><div class="line">set user_1 maksim</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</div><div class="line"><span class="keyword">echo</span> $redis-&gt;get(<span class="string">'user_1'</span>).PHP_EOL;</div></pre></td></tr></table></figure><p>安装完成后，我们可以测试一下，看看能否正常取到值。</p><h1 id="Redis-常用命令"><a href="#Redis-常用命令" class="headerlink" title="Redis 常用命令"></a>Redis 常用命令</h1><table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>DEL</td><td>删除 key</td><td>DEL KEY_NAME</td></tr><tr><td>EXISTS</td><td>检查给定 Key 是否存在</td><td>EXISTS KEY_NAME</td></tr><tr><td>KEYS</td><td>查找所有符合给定模式 pattren 的 key</td><td>KEYS PATTERN</td></tr><tr><td>TYPE</td><td>返回 key 所春初的值的类型</td><td>TYPE KEY_NAME</td></tr><tr><td>EXPIRE</td><td>设置 key 的过期时间</td><td>EXPIRE KEY_NAME TIME_IN_SECONDS</td></tr><tr><td>TTL</td><td>返回 Key 的剩余过期时间</td><td>TTL KEY_NAME</td></tr><tr><td>SAVE</td><td>RDB 持久化</td><td>SAVE</td></tr><tr><td>INFO</td><td>Reids 服务器的各种信息和统计数值</td><td>INFO [section]</td></tr><tr><td>SHUTDOWN</td><td>保存并停止所有客户端</td><td>SHUTDOWN [NOSAVE \</td><td>SAVE]</td></tr></tbody></table><h1 id="Redis-常用字段类型"><a href="#Redis-常用字段类型" class="headerlink" title="Redis 常用字段类型"></a>Redis 常用字段类型</h1><ul><li>String 字符串</li><li>Hash  散列表</li><li>List     列表</li><li>Set      无序集合</li><li>Zset    可排序结合</li></ul><h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>最常见的数据类型，可以是任何类型的字符串比如 JSON、XML、数字、甚至是二进制，最大容量是512M。</p><p>典型的使用场景包括：缓存功能、计数器、共享 Session、限速</p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><table><thead><tr><th>命令</th><th>说明</th><th>Cli 命令</th><th>PHP</th></tr></thead><tbody><tr><td>SET</td><td>赋值</td><td>SET key value</td><td>$redis-&gt;set(‘key’, ‘value’);</td></tr><tr><td>SETEX</td><td>赋值并添加过期时间</td><td>SETEX key expire value</td><td>$redis-&gt;setex(‘key’, ‘expire’, ‘value’);</td></tr><tr><td>GET</td><td>取值</td><td>GET key</td><td>$redis-&gt;get(‘key’);</td></tr><tr><td>INCR</td><td>递增数字</td><td>INCR key</td><td>$redis-&gt;incr(‘int_key’);</td></tr><tr><td>INCRBY</td><td>增加指定的数字</td><td>INCRBY key increment</td><td>$redis-&gt;incrBy(‘int_key’, number);</td></tr><tr><td>DECR</td><td>递减数字</td><td>DECR key</td><td>$redis-&gt;decr(‘key1’);</td></tr><tr><td>DECRBY</td><td>减少指定的数字</td><td>DECRBY key decrement</td><td>$redis-&gt;decrBy(‘key1’, number);</td></tr><tr><td>INCRBYFLOAT</td><td>增加指定浮点型数</td><td>INCRBYFLOAT key increment</td><td>$redis-&gt;incrByFloat(‘key1’, 1.5);</td></tr><tr><td>APPEND</td><td>向稳步追加值</td><td>APPEND key value</td><td>$redis-&gt;append(‘key’, ‘value2’);</td></tr><tr><td>STRLEN</td><td>获取字符串长度</td><td>STRLEN key value</td><td>$redis-&gt;strlen(‘key’);</td></tr><tr><td>MSET</td><td>同时设置多个 key 的值</td><td>MSET key1 [key2 value2 …]</td><td>$redis-&gt;mSet([‘key0’=&gt;’value0’]);</td></tr><tr><td>MGET</td><td>同时获取多个 key 的值</td><td>MGET key1 [key2 …]</td><td>$redis-&gt;mGet([‘key1’,’key2’]);</td></tr></tbody></table><h3 id="示例：使用-String-记录用户登录次数"><a href="#示例：使用-String-记录用户登录次数" class="headerlink" title="示例：使用 String 记录用户登录次数"></a>示例：使用 String 记录用户登录次数</h3><p>有关于文章篇幅有限，所以只是简单实现，首先我们在 redis 中设置一个 user和他的点击次数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">set username_1 maksim</div><div class="line">set views_1 0</div></pre></td></tr></table></figure><p>我们可以通过业务名加上 id 的形式来对 key 进行命名。</p><p>然后编写模拟登录 login.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">session_start();</div><div class="line">$_SESSION[<span class="string">'uid'</span>] = <span class="number">1</span>;</div></pre></td></tr></table></figure><p>再然后进行显示</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$session = session_start();</div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</div><div class="line"></div><div class="line">$data = [</div><div class="line">    <span class="string">'uid'</span> =&gt; $_SESSION[<span class="string">'uid'</span>],</div><div class="line">    <span class="string">'views'</span> =&gt; <span class="number">0</span>,</div><div class="line">    <span class="string">'username'</span> =&gt; <span class="string">'游客'</span>,</div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($data[<span class="string">'uid'</span>])) &#123;</div><div class="line">    $data[<span class="string">'username'</span>] = $redis-&gt;get(<span class="string">'username_'</span>.$data[<span class="string">'uid'</span>]);</div><div class="line">    $data[<span class="string">'views'</span>] = $redis-&gt;get(<span class="string">'views_'</span>.$data[<span class="string">'uid'</span>]);</div><div class="line">&#125;</div><div class="line">$message =  <span class="string">'你当前的用户为：'</span>. $data[<span class="string">'username'</span>].<span class="string">'   这是你第'</span>.$data[<span class="string">'views'</span>].<span class="string">'浏览该内容'</span>;</div><div class="line"></div><div class="line">$redis-&gt;incr(<span class="string">'views_'</span>.$data[<span class="string">'uid'</span>]);</div><div class="line"><span class="keyword">echo</span> $message;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure><h2 id="Hash-类型"><a href="#Hash-类型" class="headerlink" title="Hash 类型"></a>Hash 类型</h2><p>Hash 类型与 PHP 的数组类似，可以保存多个 key-value 对，每个k-v 都是字符串类型，最多2^32-1字段。</p><p>该类型适用于一个属性之中具有多个子属性，比如我们的用户信息。</p><table><thead><tr><th>命令</th><th>说明</th><th>Cli 命令示例</th><th>PHP 写法</th></tr></thead><tbody><tr><td>HSET</td><td>赋值</td><td>HSET key field value</td><td>$redis-&gt;hSet(key, field, value);</td></tr><tr><td>HMSET</td><td>赋值多个字段</td><td>HMSET key filed1 value1 [field2 values]</td><td>$redis-&gt;hMset(key, [‘filed1’=&gt; ‘value1’]);</td></tr><tr><td>HGET</td><td>取值</td><td>HGET key field</td><td>$redis-&gt;hGET(KEY, [‘filed’,’filed2’])</td></tr><tr><td>HMGET</td><td>获取多个字段的值</td><td>HMGET key field1 [field2]</td><td>$redis-&gt;hmGet(key,[‘filed’,’filed2’])</td></tr><tr><td>HGETALL</td><td>获取所有的字段的值</td><td>HGETALL key</td><td>$redis-&gt;hGetAll(key);</td></tr><tr><td>HLEN</td><td>获取字段的数量</td><td>HLEN key</td><td>$redis-&gt;hLen(key);</td></tr></tbody></table><h3 id="示例：-存储用户信息"><a href="#示例：-存储用户信息" class="headerlink" title="示例： 存储用户信息"></a>示例： 存储用户信息</h3><p>在 redis 中存入用户信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hmset userinfo_1 real_name 张三 email 1401588099@qq.com</div></pre></td></tr></table></figure><p>继续在index.php 中编写代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$realName = $redis-&gt;hGet(<span class="string">'userinfo_'</span>.$data[<span class="string">'uid'</span>],<span class="string">'real_name'</span>);</div><div class="line">$email = $redis-&gt;hGet(<span class="string">'userinfo_'</span>.$data[<span class="string">'uid'</span>],<span class="string">'email'</span>);</div><div class="line">$message .= <span class="string">'&lt;br&gt;'</span>. <span class="string">'真实姓名：'</span>.$realName.<span class="string">'&lt;br&gt;'</span>.<span class="string">'邮箱：'</span>.$email;</div></pre></td></tr></table></figure><h2 id="List-类型"><a href="#List-类型" class="headerlink" title="List 类型"></a>List 类型</h2><p>Redis 的 List 类型实现其实就是一个双向链表用于存储一个有序的字符串列表，从队列两端添加和弹出元素，拥有开发经验的同学听到双向列表就应该知道 List 的作用了，他可是当做消息队列来使用，这也是最常见的应用。</p><p>使用场景：消息队列，文章列表</p><table><thead><tr><th>命令</th><th>说明</th><th>cli 命令</th><th>PHP</th></tr></thead><tbody><tr><td>LPUSH</td><td>向列表左端添加元素</td><td>LPUSH key value</td><td>$redis-&gt;lPush(key, value);</td></tr><tr><td>RPUSH</td><td>向列表右端添加元素</td><td>RPUSH key value</td><td>$redis-&gt;rPush(key, value);</td></tr><tr><td>LPOP</td><td>从列表左端弹出元素</td><td>LOPO key</td><td>$redis-&gt;lPop(key);</td></tr><tr><td>RPOP</td><td>从队列右端弹出元素</td><td>RPOP key</td><td>$redis-&gt;rPop(value);</td></tr><tr><td>LLEN</td><td>获取列表中元素个数</td><td>LLEN key</td><td>$redis-&gt;lSize(key);</td></tr><tr><td>LRANGE</td><td>获取列表中某一片段的元素</td><td>LRANGE key start stop</td><td>$redis-&gt;lRange(key, start, end);</td></tr><tr><td>LREM</td><td>删除列表中指定的值</td><td>LREM key count value</td><td>$redis-&gt;lRem(key, value, count)l</td></tr><tr><td>LINDEX</td><td>获取指定索引的元素值</td><td>LINDEX key index</td><td>$redis-&gt;lGet(key, index);</td></tr><tr><td>LSET</td><td>设置指定索引的元素值</td><td>LSET key index value</td><td>$redis-&gt;lSet(key, index, value);</td></tr><tr><td>LTRIM</td><td>只保留列表指定的片段</td><td>LTRIM key start stop</td><td>$redis-&gt;lTrim(key, start, end);</td></tr><tr><td>LINSERT</td><td>向列表中插入元素</td><td>LINSERT key BEFORE/AFTER existing_value value</td><td>$redis-&gt;linsert(key, Redis::BEFORE, existing_value, value)</td></tr></tbody></table><h3 id="示例：秒杀"><a href="#示例：秒杀" class="headerlink" title="示例：秒杀"></a>示例：秒杀</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">//ms_status_3 0 结束 1已经</span></div><div class="line"><span class="comment">//在redis-cli 中输入 set cache_ms_status 1</span></div><div class="line"><span class="comment">//ms_list 秒杀队列</span></div><div class="line"></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'uid'</span>])) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">'参数不合法'</span>;<span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$uid = $_GET[<span class="string">'uid'</span>];</div><div class="line"><span class="keyword">if</span> (!$uid) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">'参数不合法'</span>;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line">$limit = <span class="number">2</span>; <span class="comment">//设置秒杀数</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> ($redis-&gt;lSize(<span class="string">'cache_ms_uids'</span>) &gt;= $limit) &#123;</div><div class="line">    $redis-&gt;set(<span class="string">'cache_ms_status'</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">echo</span> <span class="string">'已经被抢光了，下次再来！'</span>;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($redis-&gt;get(<span class="string">'cache_ms_status'</span>) == <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">'已经结束了'</span>;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$redis-&gt;lPush(<span class="string">'cache_ms_uids'</span>, $uid);</div><div class="line"><span class="keyword">echo</span> <span class="string">'秒杀成功'</span>;</div></pre></td></tr></table></figure><p>安装上面的代码，我们就建立了一个简单的秒杀队列，其业务逻辑基础就是如此，不过请不要将其代码用于实际项目中，因为中间还缺少很多操作，最典型的就是防止黄牛等等一系列业务逻辑。</p><h2 id="Set-类型"><a href="#Set-类型" class="headerlink" title="Set 类型"></a>Set 类型</h2><p>Set 类型类似于集合，其中可以存储不同的类型元素，需要注意的是，Set 集合是禁止重复的，所以一般都用来实现去重，元素最多为2^32 -1 ，其中元素没有顺序，</p><h3 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h3><table><thead><tr><th>命令</th><th>说明</th><th>cli 命令示例</th><th>PHP</th></tr></thead><tbody><tr><td>SADD</td><td>添加元素</td><td>SADD key value [value1 value2 …]</td><td>$redis-&gt;sAdd(‘key’, ‘set’);</td></tr><tr><td>SREM</td><td>删除元素</td><td>SREM key value [value1 value3 …]</td><td>$redis-&gt;sRem(‘key’, ‘set’);</td></tr><tr><td>SMEMBERS</td><td>获取集合中所有元素</td><td>SMEMBERS key</td><td>$redis-&gt;sMembers(‘key’);</td></tr><tr><td>SISMEMBER</td><td>判断元素是否在集合中</td><td>SISMEMBER key value</td><td>$redis-&gt;slsMember(‘key’, ‘value’);</td></tr><tr><td>SDIFF</td><td>对集合做差集运算</td><td>SDIFF key1 key2 [key3 …]</td><td>$redis-&gt;sDiff(‘key1’, ‘key2’, ‘key3’);</td></tr><tr><td>SINTER</td><td>对集合做交集运算</td><td>SINTER key1 key2 [key3 …]</td><td>$redis-&gt;sInter(‘key1’, ‘key2’, ‘key3’);</td></tr><tr><td>SUNION</td><td>对集合做并集运算</td><td>SUNION key1 key2 [key3 …]</td><td>$redis-&gt;sUnion(‘key1’, ‘key2’, ‘key3’);</td></tr><tr><td>SCARD</td><td>获得集合中元素的个数</td><td>SCARD key</td><td>$redis-&gt;sCard(‘key1’);</td></tr><tr><td>SDIFFSTORE</td><td>对集合做差集运算并将结果存储</td><td>SDIFFSTORE destination key1 key2 [key3]</td><td>$redis-&gt;sDiffStore(‘output’, ‘key1’, ‘key2’);</td></tr><tr><td>SINTERSTORE</td><td>对集合做交集运算并将结果存储</td><td>SINTERSTORE destination key1 key2 [key3]</td><td>$redis-&gt;sInterStore(‘output’, ‘key1’, ‘key2’);</td></tr><tr><td>SUNIONSTORE</td><td>对集合做并集运算并将结果存储</td><td>SUNIONSTORE destination key1 key2 [key3]</td><td>$redis-&gt;sUnionStore(‘output’, ‘key1’, ‘key2’);</td></tr><tr><td>SRANDMEMBER</td><td>随机获取集合中的元素</td><td>SRANDMEMBER key [count]</td><td>$redis-&gt;sRandMember(‘key1’, 2);</td></tr><tr><td>SPOP</td><td>随机弹出一个元素</td><td>SPOP key</td><td>$redis-&gt;sPop(‘key1’);</td></tr></tbody></table><h3 id="示例：查并集"><a href="#示例：查并集" class="headerlink" title="示例：查并集"></a>示例：查并集</h3><p>在 Redis 中添加南北方拥有的商品，然后在 PHP 中进行显示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SADD cache_bei apple peach pear</div><div class="line">SADD cache_nan apple banana avocado</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</div><div class="line"></div><div class="line">$bei = $redis-&gt;sMembers(<span class="string">'cache_bei'</span>);</div><div class="line">$nan = $redis-&gt;sMembers(<span class="string">'cache_nan'</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">'北方有的商品：&lt;br&gt;'</span>;</div><div class="line">print_r($bei);</div><div class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">'南方有的商品：&lt;br&gt;'</span>;</div><div class="line">print_r($nan);</div><div class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</div><div class="line"><span class="keyword">echo</span> <span class="string">'两个地方都有的商品：&lt;br&gt;'</span>;</div><div class="line">print_r($redis-&gt;sInter(<span class="string">'cache_bei'</span>, <span class="string">'cache_nan'</span>));</div><div class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</div><div class="line"><span class="keyword">echo</span> <span class="string">'两个地域所有的商品：&lt;br&gt;'</span>;</div><div class="line">print_r($redis-&gt;sUnion(<span class="string">'cache_bei'</span>, <span class="string">'cache_nan'</span>));</div></pre></td></tr></table></figure><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180718-194727.jpg" alt=""></p><h2 id="Zset有序集合"><a href="#Zset有序集合" class="headerlink" title="Zset有序集合"></a>Zset有序集合</h2><p>看名字我们就会知道和上面的集合用法是类似的，不过它是有序的，有序也就意味着每一个元素在插入的时候系统都会给他指定一个分数，然后根据分数高低进行排序，跟集合一样，它也是禁止重复的，分数是可以相同的，有序集合是使用散列表和跳跃表来进行实现的，这也就意味着，如果要去读写中间的数据时非常快的，</p><h3 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h3><table><thead><tr><th>命令</th><th>说明</th><th>cli 命令示例</th><th>PHP</th></tr></thead><tbody><tr><td>ZADD</td><td>添加元素</td><td>ZADD key score value[ score2 value2 …]</td><td>$redis-&gt;zAdd(‘key’,1,’val1’);</td></tr><tr><td>ZSCORE</td><td>设置元素的分数</td><td>ZSCORE key value</td><td>$redis-&gt;zScore(‘key’, val2);</td></tr><tr><td>ZRANGE</td><td>获取正序排名在某范围的元素</td><td>ZRANGE key start stop [WITHSCORE]</td><td>$redis-&gt;zRange(‘key1’, 0, -1);</td></tr><tr><td>ZREVRANGE</td><td>获取倒序排名在某范围的元素</td><td>ZREVRANGE key start stop [WITHSCORE]</td><td>$redis-&gt;zRevRange(‘key’, 0, -1);</td></tr><tr><td>ZRANGEBYSCORE</td><td>获取指定分数范围内的元素</td><td>ZRANGEBYSCORE key min max</td><td>$redis-&gt;zRangeByScore(key, start,end, [withscores, limit]);</td></tr><tr><td>ZINCRBY</td><td>增加某个元素的分数</td><td>ZINCRBY key increment value</td><td>$redis-&gt;zIncrBy(‘key’, increment, ‘member’);</td></tr><tr><td>ZCARD</td><td>获取集合中元素的个数</td><td>ZCARD key</td><td>$redis-&gt;zSize(‘key’);</td></tr><tr><td>ZCOUNT</td><td>获取指定分数范围内的元素个数</td><td>ZCOUNT key min max</td><td>$redis-&gt;zCount(key, start ,end);</td></tr><tr><td>ZREM</td><td>删除一个或多个元素</td><td>ZREM key value1 [value2]</td><td>$redis-&gt;zDelete(‘key’, ‘val’);</td></tr><tr><td>ZREMRANGEBYRANK</td><td>按照排名范围删除元素</td><td>ZREMRANGEBYRANK key start stop</td><td>$redis-&gt;zRemRangeByRank(‘key’, 0, 1);</td></tr><tr><td>ZREMRANGEBYSCORE</td><td>按照分数范围删除元素</td><td>ZREMRANGEBYSCORE key start stop</td><td>$redis-&gt;zRemRangeByScore(‘key’, 0, 3);</td></tr><tr><td>ZRANK</td><td>获取正序排序的元素的排名</td><td>ZRANK key value</td><td>$redis-&gt;zRank(key, val);</td></tr><tr><td>ZREVRANK</td><td>获取逆序排序的元素的排名</td><td>ZREVRANK key value</td><td>$redis-&gt;zRevRank(key, val);</td></tr></tbody></table><h3 id="案例：按照评分给小说排名"><a href="#案例：按照评分给小说排名" class="headerlink" title="案例：按照评分给小说排名"></a>案例：按照评分给小说排名</h3><p>首先还是模拟评分直接在 cli 中添加数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ZADD book_rank 1 冰火魔厨</div><div class="line">ZADD book_rank 2 琴魔</div><div class="line">ZADD book_rank 3 酒神</div><div class="line">ZADD book_rank 3 天火大道</div><div class="line">ZADD book_rank 5 斗罗大陆</div><div class="line">ZADD book_rank 5 惟我独仙</div></pre></td></tr></table></figure><p>然后在 PHP 中使用倒序排列输出排名为前五的小说</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</div><div class="line"></div><div class="line">$books = $redis-&gt;zRevRange(<span class="string">'book_rank'</span>, <span class="number">0</span> ,<span class="number">4</span>, <span class="keyword">true</span>);</div><div class="line">$count = $redis-&gt;zSize(<span class="string">'book_rank'</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">'当前一共有'</span>.$count.<span class="string">'本书，显示排名前五的书籍&lt;br&gt;'</span>;</div><div class="line"><span class="keyword">foreach</span> ($books <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">'《'</span>.$key.<span class="string">'》的评分为:'</span>.$value.<span class="string">'星&lt;br&gt;'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180718-203012.jpg" alt=""></p><h1 id="合理的使用-Redis"><a href="#合理的使用-Redis" class="headerlink" title="合理的使用 Redis"></a>合理的使用 Redis</h1><ul><li><p>防止内存站满：</p><ul><li>设置超时时间，如果把 redis 定位成一个缓存使用，键值一定要设置一个超时时间，如果不设置的话 key 会一直占着内存，造成非常大的浪费，而且随着时间的推移，内存的占用率越来越大，如果有一天达到内存上限，Redis 就会不断的进行持久化，另外一个 key 的时长进行综合评估，也不是越长越好，太长了其实跟没有超时时间没有太大区别。</li><li>不存方过大文件，一般来说 Redis 每一个键在存储数据的时候不要超过500字节，要是超过的话一定要想办法先压缩一下然后在进行储存，Redis 是将数据放到内存中的，如果把太大的东西丢进 Redis 里面肯定会浪费一定的内存的。还有就是数据是需要来回传递的，当访问量非常高的时候，你里面还带了一个非常大的文件，来回的传输，很有可能就把带宽占用满了，其他的服务就不可用。</li><li>不存不常用数据，Redis 比较适合存放一些热数据，所以我们要把冷热数据进行分离，冷数据比较适合放在 Mysql 之中，在 Redis 应该存一些比较高频的数据，把一些不长用的数据放在 Redis 中就太有点浪费资源了。Redis 存储数据量小的时候，速度肯定要快一些。不同的业务数据最好分开存储，不要把一些不相关的业务数据都放到一个 Redis 实例里面。</li></ul></li><li><p>提高使用效率</p><ul><li>合理使用不同的数据类型：Redis 支持的类型非常的多，根据不同业务的业务场景，来使用不同的数据结构，不同的字段类型适用场景是不一样的。</li><li>慎用正则处理或批量操作 Hash、Set 等：这是一个非常恐怖的操作，Hash 和 Set 本身就是一个很大的数据，然后在批量操作的话很要命的，因为 Redis 是单线程的，如果线上 Key 非常多的时候，如果再进行正则匹配效率会非常的低，效率一旦低下来，就会堵塞其他命令的运行。如果在批量操作 Hash 的时候，是需要把 feild 也进行一次操作的，</li></ul><p>所以说不要以为 Redis 是万能的，最终他还是要消耗 CPU 的。</p></li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>利用 tail 命令监控文件变化</title>
      <link href="/2018/07/17/2/"/>
      <content type="html"><![CDATA[<p>tail 命令从指定点开始将文件写到标准输出.使用tail命令的-f选项可以方便的查阅正在改变的日志文件,tail -f filename会把filename里最尾部的内容显示在屏幕上,并且不但刷新,使你看到最新的文件内容. </p><h1 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail(选项)(参数)</div></pre></td></tr></table></figure><p>选项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">--retry：即是在tail命令启动时，文件不可访问或者文件稍后变得不可访问，都始终尝试打开文件。使用此选项时需要与选项“——follow=name”连用；</div><div class="line">-c&lt;N&gt;或——bytes=&lt;N&gt;：输出文件尾部的N（N为整数）个字节内容；</div><div class="line">-f&lt;name/descriptor&gt;或；--follow&lt;nameldescript&gt;：显示文件最新追加的内容。“name”表示以文件名的方式监视文件的变化。“-f”与“-fdescriptor”等效；</div><div class="line">-F：与选项“-follow=name”和“--retry&quot;连用时功能相同；</div><div class="line">-n&lt;N&gt;或——line=&lt;N&gt;：输出文件的尾部N（N位数字）行内容。</div><div class="line">--pid=&lt;进程号&gt;：与“-f”选项连用，当指定的进程号的进程终止后，自动退出tail命令；</div><div class="line">-q或——quiet或——silent：当有多个文件参数时，不输出各个文件名；</div><div class="line">-s&lt;秒数&gt;或——sleep-interal=&lt;秒数&gt;：与“-f”选项连用，指定监视文件变化时间隔的秒数；</div><div class="line">-v或——verbose：当有多个文件参数时，总是输出各个文件名；</div><div class="line">--help：显示指令的帮助信息；</div><div class="line">--version：显示指令的版本信息。</div></pre></td></tr></table></figure><p><strong>2．**</strong>命令功能：**</p><p>用于显示指定文件末尾内容，不指定文件时，作为输入信息进行处理。常用查看日志文件。</p><p><strong>3．**</strong>命令参数：**</p><p>-f 循环读取</p><p>-q 不显示处理信息</p><p>-v 显示详细的处理信息</p><p>-c&lt;数目&gt; 显示的字节数</p><p>-n&lt;行数&gt; 显示行数</p><p>–pid=PID 与-f合用,表示在进程ID,PID死掉之后结束. </p><p>-q, –quiet, –silent 从不输出给出文件名的首部 </p><p>-s, –sleep-interval=S 与-f合用,表示在每次反复的间隔休眠S秒 </p><p><strong>4．**</strong>使用实例：**</p><p><strong>实例1：显示文件末尾内容</strong></p><p><strong>命令：</strong></p><p>tail -n 5 log2014.log</p><p><strong>输出：</strong></p><p>[root@localhost test]# tail -n 5 log2014.log </p><p>2014-09</p><p>2014-10</p><p>2014-11</p><p>2014-12</p><p>==============================[root@localhost test]#</p><p><strong>说明：</strong></p><p>显示文件最后5行内容</p><p><strong>实例2：循环查看文件内容</strong></p><p><strong>命令：</strong></p><p>tail -f test.log</p><p><strong>输出：</strong></p><p>[root@localhost ~]# ping 192.168.120.204 &gt; test.log &amp;</p><p>[1] 11891[root@localhost ~]# tail -f test.log </p><p>PING 192.168.120.204 (192.168.120.204) 56(84) bytes of data.</p><p>64 bytes from 192.168.120.204: icmp_seq=1 ttl=64 time=0.038 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=2 ttl=64 time=0.036 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=3 ttl=64 time=0.033 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=4 ttl=64 time=0.027 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=5 ttl=64 time=0.032 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=6 ttl=64 time=0.026 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=7 ttl=64 time=0.030 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=8 ttl=64 time=0.029 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=9 ttl=64 time=0.044 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=10 ttl=64 time=0.033 ms</p><p>64 bytes from 192.168.120.204: icmp_seq=11 ttl=64 time=0.027 ms</p><p>[root@localhost ~]#</p><p><strong>说明：</strong></p><p>ping 192.168.120.204 &gt; test.log &amp; //在后台ping远程主机。并输出文件到test.log；这种做法也使用于一个以上的档案监视。用Ctrl＋c来终止。 </p><p><strong>实例3：从第5行开始显示文件</strong></p><p><strong>命令：</strong></p><p>tail -n +5 log2014.log</p><p><strong>输出：</strong></p><p>[root@localhost test]# cat log2014.log </p><p>2014-01</p><p>2014-02</p><p>2014-03</p><p>2014-04</p><p>2014-05</p><p>2014-06</p><p>2014-07</p><p>2014-08</p><p>2014-09</p><p>2014-10</p><p>2014-11</p><p>2014-12</p><p>==============================</p><p>[root@localhost test]# tail -n +5 log2014.log</p><p>2014-05</p><p>2014-06</p><p>2014-07</p><p>2014-08</p><p>2014-09</p><p>2014-10</p><p>2014-11</p><p>2014-12</p><p>==============================</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title></title>
      <link href="/2018/07/02/cjjrthl9r0001c7rddk5leqiu/"/>
      <content type="html"><![CDATA[]]></content>
      
      
    </entry>
    
    <entry>
      <title></title>
      <link href="/2018/07/02/cjjrthlgb004vc7rdtk2hi6kf/"/>
      <content type="html"><![CDATA[<hr><hr><p>索引（在MySQL中也叫做“键（key）”）是存储引擎用于快速找到记录的一种数据结构，索引对于良好的性能非常关键，尤其是当表中的数据量越来越大的时候，索引对性能的影响越发重要，不过在数据量较小而且负载较低时，不恰当的索引对性能的影响可能还不明显，担当数据量组件增大时，性能则会几急剧下降。</p><p>而且当表中的数据比较少时，查询的频率比较低的情况下，索引的作用可能不太明显，因为这个时候表中的数据差不多都可以缓存到内存中。所以就算是进行全表扫描，效率也不会太慢。</p><p>但是当数据量越来越庞大，查询频率也越来越高，内存无法缓存所有数据的时候，索引的作用就会显得越来越重要。</p><p>在日常工作中，人们总是忽略或者过分的强调索引的作用，有的时候甚至是会出现两个极端。</p><ul><li>表中除了主键之外一条索引都没有</li><li>表中的每一列都建立索引</li></ul><p>既然是两个极端，那么也就意味着，这两种方法都不正确太少或者太多的索引都会对系统带来一定的影响。只有在正确的列上，建立正确的索引的情况下，才能提升数据库的索引能力。</p><p>为了能够正确的使用索引，我们先来看看MySQL所支持的索引类型。</p><p>在开头，我们说过，索引的作用是告诉存储引擎如何快速的找到所需要的数据，所以索引是在引擎层上实现的，而不是    在 MySQL 服务器层上实现的，所以也就导致不同存储引擎之间实现的方式是不同的，同时的也不是所有的引擎支持所有的索引类型。</p><p>#B-Tree索引</p><p><strong>B-Tree索引</strong>是MySQL中最常见的索引类型，当人们谈论索引的时候，如果没有特别指明类型，那么多半说的就是B-tree索引，它使用B-Tree的结构存储数据，在B-Tree种，每一个叶子节点都会包含一个指向下一个节点的指针。这样可以方便叶子节点之间的遍历。</p><h2 id="B-tree结构存储数据"><a href="#B-tree结构存储数据" class="headerlink" title="B-tree结构存储数据"></a>B-tree结构存储数据</h2><p>通过简单的图例，讲解讲解一下B-tree的存储结构。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180702111251.png" alt=""></p><p>从图中，我们可以看到B+树是一种平衡的查找树，每一个叶子到根部的距离都是相同的，所有的记录节点都是按照键值的大小顺序排列的在同一个节点上的。</p><p>并且每个节点之间是使用指针连接的这就时一个典型的B树存储结构，对于不同的存储引擎的实现可能会有所不同，比如说 MyISAM 索引在叶子节点上是通过物理位置来引用行的，InnoDB则是通过主键来引用行的。</p><ul><li>B-tree索引能够加快数据的查询速度。</li></ul><p>通常情况下，索引的大小远小于表中数据的大小，使用了B-tree索引，存储引擎就不需要进行全表扫描，取而代之的是从索引的根节点进行搜索，根节点存储了指向下一层节点的指针，存储引擎根据这些指针向下层查找。</p><p>通过比较接节点页的值和要查找的值，找到合适的指针进入下一层的子节点，而这些指针实际上是定义了子节点值得上限和下限，所以最终存储引擎要找到对应的值或者是不存在的。</p><p>最终存储引擎通过b-tree查找到子节点，子节点的指针指向的是数据。</p><ul><li>B-tree更适合范围查找</li></ul><p>因为B-tree是顺序存储</p><p>什么情况下可以使用B树索引。</p><ul><li>全值匹配的查询 <code>order_sn = &#39;201723010222&#39;</code></li><li>匹配最左侧前缀的查询</li><li>匹配列前缀查询  <code>order_sn like &#39;9876%&#39;</code></li><li>匹配范围值得查询 <code>order_sn &gt; &#39;201723010222&#39; AND order_sn &lt; &#39;201723010333&#39;</code></li><li>精确匹配左前列并范围匹配另外一列 </li><li>只访问索引的查询 </li></ul><h2 id="B-tree索引的使用限制"><a href="#B-tree索引的使用限制" class="headerlink" title="B-tree索引的使用限制"></a>B-tree索引的使用限制</h2><p>使用索引命中了表中大部分数据时，MySQL查询优化器，使用全表扫描的方式性能可能更好，所以就不适用索引查询了。</p><p>此外在使用B-tree索引的时候还会受一些限制。</p><ul><li>如果偶不是按照索引最左列开始找茬，则无法使用索引</li><li>使用索引时不能跳过索引中的列</li><li>Not in 和 &lt; &gt;操作无法使用索引</li><li>如果查询中有某个列的范围查询，则其右侧所有列都无法使用索引</li></ul><h1 id="Hash索引"><a href="#Hash索引" class="headerlink" title="Hash索引"></a>Hash索引</h1><p>在MySQL的一些存储引擎中还有支持Hash索引的存储引擎，MyISAM 就是同时支持Hash和B-tree，默认情况下使用的是Hash索引，InnoDB支持Hash索引，不过它的Hash索引不是我们来建立的，而是根据B-tree的使用情况自行建立的，也成为自适应Hash索引。</p><ul><li>Hash索引时基于Hash表实现的，只有查询条件精确匹配Hash索引的所有列时，才能使用Hash索引，也就是说Hash索引只能用于等值查询上，如果要进行范围或者模糊查询就无法使用Hash索引。</li><li>对于Hash索引中的所有列，存储引擎都会为每一行计算一个Hash码，Hash索引中存储的就是Hash码。</li></ul>]]></content>
      
      
    </entry>
    
    <entry>
      <title>排序算法图解</title>
      <link href="/2018/06/30/1/"/>
      <content type="html"><![CDATA[<p>这篇博文是来自 <code>https://www.awaimai.com/1980.html</code>，但是都是基于面向过程的代码编写，我用面向对象的方式重新实现了一边，并且按照自己的写作习惯进行了重新编辑。</p><p>在 PHP 日常开发过程中，接触算法的机会并不多，大多数PHP 程序员都是在进行 CURD 的操作，甚至连数据结构的接触也很局限，并且大多数培训班很少回去讲解数据结构与算法，这也导致了 PHP 程序员的水平参差不齐，但是无论是进阶，还是跳槽到 BAT 这样的大公司算法都是一道绕不过去的坎，光是在算法上躺下的程序员就不在少数。</p><p>这也是一道程序员的分水岭之一，掌握算法能够利于我们开发出更加高效的软件，毕竟程序=数据结构+算法。这是每一个科班出身的人第一天上数据结构与算法这门课要学习的第一句话，排序算法是程序员必须掌握的基础内容。</p><p>（未完成，编写工作还在进行）</p><h2 id="1-快速排序"><a href="#1-快速排序" class="headerlink" title="1 快速排序"></a>1 快速排序</h2><p><strong>快速排序</strong>是由<strong>东尼·霍尔</strong>发展的一种排序算法。</p><p>在平均状况下，排序<code>n</code>个项目要<code>Ο(nlog n)</code>次比较。</p><p>在最坏状况下则需要<code>Ο(n2)</code>次比较，但这种状况并不常见。</p><p>事实上，快速排序通常明显比其他<code>Ο(nlog n)</code>算法更快，因为它的内部循环可以在大部分的架构上，很有效率地被实现出来。</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/Sorting_quicksort_anim.gif" alt="img"></p><p>快速排序采用分治法实现排序，具体步骤：</p><ol><li>从数列中挑出一个数作为<strong>基准元素</strong>。通常选择第一个或最后一个元素。</li><li>扫描数列，<strong>以基准元素为比较对象，把数列分成两个区</strong>。规则是：小的移动到基准元素前面，大的移到后面，相等的前后都可以。分区完成之后，基准元素就处于数列的中间位置。</li><li>然后再用同样的方法，<strong>递归地排序划分的两部分</strong>。</li></ol><p>递归的结束条件是数列的大小是<code>0</code>或<code>1</code>，也就是永远都已经被排序好了。</p><p>PHP代码实现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">function quickSort($arr) &#123;</div><div class="line">    // 先设定结束条件，判断是否需要继续进行</div><div class="line">    if(count($arr) &lt;= 1) &#123;</div><div class="line">        return $arr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 选择第一个元素作为基准元素</div><div class="line">    $baseValue = $arr[0];</div><div class="line"></div><div class="line">    // 初始化小于基准元素的左数组</div><div class="line">    $leftArray = array();</div><div class="line"></div><div class="line">    // 初始化大于基准元素的右数组</div><div class="line">    $rightArray = array();</div><div class="line"></div><div class="line">    // 遍历除基准元素外的所有元素，按照大小关系放入左右数组内</div><div class="line">    array_shift($arr);</div><div class="line">    foreach ($arr as $value) &#123;</div><div class="line">        if ($value &lt; $baseValue) &#123;</div><div class="line">            $leftArray[] = $value;</div><div class="line">        &#125; else &#123;</div><div class="line">            $rightArray[] = $value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 再分别对左右数组进行相同的排序</div><div class="line">    $leftArray = quickSort($leftArray);</div><div class="line">    $rightArray = quickSort($rightArray);</div><div class="line"></div><div class="line">    // 合并基准元素和左右数组</div><div class="line">    return array_merge($leftArray, array($baseValue), $rightArray);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="2-冒泡排序"><a href="#2-冒泡排序" class="headerlink" title="2 冒泡排序"></a>2 冒泡排序</h2><p>冒泡排序是一种简单的排序算法。</p><p>算法重复地走访过要排序的数列，一次<strong>比较两个元素</strong>，如果他们的顺序错误就把他们交换过来。</p><p>走访数列的工作重复地进行，直到没有再需要交换，也就是说该数列已经排序完成。</p><p>因为排序过程让<strong>较大的数往下沉，较小的往上冒</strong>，故而叫冒泡法。</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/Bubble_sort_animation.gif" alt="img"></p><p>算法步骤：</p><ol><li>从第一个元素开始，比较相邻的元素，如果第一个比第二个大，就交换他们两个。</li><li>从开始第一对到结尾的最后一对，对每一对相邻元素作同样的工作。比较结束后，最后的元素应该会是最大的数。</li><li>对所有的元素重复以上的步骤，除了最后一个。</li><li>重复上面的步骤，每次比较的对数会越来越少，直到没有任何一对数字需要比较。</li></ol><p>PHP代码实现：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bubbleSort</span><span class="params">($arr)</span></span></div><div class="line">&#123;</div><div class="line">    $len = count($arr);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span>($i = <span class="number">1</span>; $i &lt; $len; $i++) &#123;</div><div class="line">        <span class="keyword">for</span>($k = <span class="number">0</span>; $k &lt; $len - $i; $k++) &#123;</div><div class="line">            <span class="keyword">if</span>($arr[$k] &gt; $arr[$k + <span class="number">1</span>]) &#123;</div><div class="line">                $tmp = $arr[$k + <span class="number">1</span>];</div><div class="line">                $arr[$k + <span class="number">1</span>] = $arr[$k];</div><div class="line">                $arr[$k] = $tmp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $arr;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="3-插入排序"><a href="#3-插入排序" class="headerlink" title="3 插入排序"></a>3 插入排序</h2><p>插入排序是一种简单直观的排序算法。</p><p>插入排序的工作原理是：<strong>将需要排序的数，与前面已经排好序的数据从后往前进行比较，使其插入到相应的位置。</strong></p><p>插入排序在实现上，通常采用in-place排序，即只需用到<code>O(1)</code>的额外空间的排序。</p><p>因而，在从后向前扫描过程中，需要反复把已排序元素逐步向后挪位，为最新元素提供插入空间。</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/insert-sort.gif" alt="img"></p><p>算法步骤：</p><ol><li>从第一个元素开始，该元素可以认为已经被排序；</li><li>取出下一个元素，在已经排序的元素序列中从后向前扫描；</li><li>如果以排序的元素大于新元素，将该元素移到下一位置；</li><li>重复步骤3，直到找到已排序的元素小于或者等于新元素的位置；</li><li>将新元素插入到该位置中；</li><li>重复步骤2。</li></ol><p>PHP代码实现：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InsertionSort</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array &amp;$arr)</span> </span>&#123;</div><div class="line">        $count = count($arr);</div><div class="line"><span class="keyword">if</span> ($arr == <span class="keyword">null</span> || $count &lt; <span class="number">2</span>) &#123;</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; $count ; $i++) &#123;</div><div class="line"><span class="keyword">for</span> ($j = $i - <span class="number">1</span>; $j &gt;= <span class="number">0</span> &amp;&amp; $arr[$j] &gt; $arr[$j + <span class="number">1</span>]; $j--) &#123;</div><div class="line"><span class="keyword">self</span>::swap($arr, $j, $j + <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">swap</span><span class="params">(array &amp;$arr, $i, $j)</span> </span>&#123;</div><div class="line">$arr[$i] = $arr[$i] ^ $arr[$j];</div><div class="line">$arr[$j] = $arr[$i] ^ $arr[$j];</div><div class="line">$arr[$i] = $arr[$i] ^ $arr[$j];</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-选择排序"><a href="#4-选择排序" class="headerlink" title="4 选择排序"></a>4 选择排序</h2><p>选择排序是一种简单直观的排序算法。</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/Selection_sort_animation.gif" alt="img"></p><p>算法步骤：</p><ol><li>首先，在序列中找到最小元素，存放到排序序列的起始位置；</li><li>接着，从剩余未排序元素中继续寻找最小元素，放到已排序序列的末尾。</li><li>重复第二步，直到所有元素均排序完毕。</li></ol><p>PHP代码实现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">function selectSort($arr)</div><div class="line">&#123;</div><div class="line">    $len = count($arr);</div><div class="line"></div><div class="line">    for ($i = 0; $i &lt; $len; $i++) &#123;</div><div class="line">        $p = $i;</div><div class="line"></div><div class="line">        for ($j = $i + 1; $j &lt; $len; $j++) &#123;</div><div class="line">            if ($arr[$p] &gt; $arr[$j]) &#123;</div><div class="line">                $p = $j;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $tmp = $arr[$p];</div><div class="line">        $arr[$p] = $arr[$i];</div><div class="line">        $arr[$i] = $tmp;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return $arr;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="5-归并排序"><a href="#5-归并排序" class="headerlink" title="5 归并排序"></a>5 归并排序</h2><p><strong>归并排序</strong>是建立在归并操作上的一种有效的排序算法。</p><p>归并排序将待排序的序列分成若干组，保证每组都有序，然后再进行合并排序，最终使整个序列有序。</p><p>该算法是采用分治法的一个非常典型的应用。</p><p>算法步骤：</p><ol><li>申请空间，使其大小为两个已经排序序列之和，该空间用来存放合并后的序列；</li><li>设定两个指针，最初位置分别为两个已经排序序列的起始位置</li><li>比较两个指针所指向的元素，选择相对小的元素放入到合并空间，并移动指针到下一位置</li><li>重复步骤3直到某一指针达到序列尾</li><li>将另一序列剩下的所有元素直接复制到合并序列尾</li></ol><p>排序效果：</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/Merge_sort_animation2.gif" alt="img"></p><p>PHP实现代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 归并排序</div><div class="line"> *</div><div class="line"> * @param array $lists</div><div class="line"> * @return array</div><div class="line"> */</div><div class="line">function merge_sort(array $lists)</div><div class="line">&#123;</div><div class="line">    $n = count($lists);</div><div class="line">    if ($n &lt;= 1) &#123;</div><div class="line">        return $lists;</div><div class="line">    &#125;</div><div class="line">    $left = merge_sort(array_slice($lists, 0, floor($n / 2)));</div><div class="line">    $right = merge_sort(array_slice($lists, floor($n / 2)));</div><div class="line">    $lists = merge($left, $right);</div><div class="line">    return $lists;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function merge(array $left, array $right)</div><div class="line">&#123;</div><div class="line">    $lists = [];</div><div class="line">    $i = $j = 0;</div><div class="line">    while ($i &lt; count($left) &amp;&amp; $j &lt; count($right)) &#123;</div><div class="line">        if ($left[$i] &lt; $right[$j]) &#123;</div><div class="line">            $lists[] = $left[$i];</div><div class="line">            $i++;</div><div class="line">        &#125; else &#123;</div><div class="line">            $lists[] = $right[$j];</div><div class="line">            $j++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    $lists = array_merge($lists, array_slice($left, $i));</div><div class="line">    $lists = array_merge($lists, array_slice($right, $j));</div><div class="line">    return $lists;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="6-堆排序"><a href="#6-堆排序" class="headerlink" title="6 堆排序"></a>6 堆排序</h2><p>堆排序是指利用堆这种数据结构所设计的一种排序算法。</p><p>堆积是一个近似完全二叉树的结构，并同时满足堆积的性质：即子结点的键值或索引总是小于（或者大于）它的父节点。</p><p>堆排序的平均时间复杂度为<code>Ο(nlogn)</code> 。</p><p>算法步骤：</p><ol><li>创建一个堆<code>H[0..n-1]</code>；</li><li>把堆首（最大值）和堆尾互换；</li><li>把堆的尺寸缩小<code>1</code>，并调用<code>shift_down(0)</code>，目的是把新的数组顶端数据调整到相应位置；</li><li>重复步骤<code>2</code>，直到堆的尺寸为<code>1</code>。</li></ol><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/Sorting_heapsort_anim.gif" alt="img"></p><p>PHP实现代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 堆排序</div><div class="line"> *</div><div class="line"> * @param array $lists</div><div class="line"> * @return array</div><div class="line"> */</div><div class="line">function heap_sort(array $lists)</div><div class="line">&#123;</div><div class="line">    $n = count($lists);</div><div class="line">    build_heap($lists);</div><div class="line">    while (--$n) &#123;</div><div class="line">        $val = $lists[0];</div><div class="line">        $lists[0] = $lists[$n];</div><div class="line">        $lists[$n] = $val;</div><div class="line">        heap_adjust($lists, 0, $n);</div><div class="line">        //echo &quot;sort: &quot; . $n . &quot;\t&quot; . implode(&apos;, &apos;, $lists) . PHP_EOL;</div><div class="line">    &#125;</div><div class="line">    return $lists;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function build_heap(array &amp;$lists)</div><div class="line">&#123;</div><div class="line">    $n = count($lists) - 1;</div><div class="line">    for ($i = floor(($n - 1) / 2); $i &gt;= 0; $i--) &#123;</div><div class="line">        heap_adjust($lists, $i, $n + 1);</div><div class="line">        //echo &quot;build: &quot; . $i . &quot;\t&quot; . implode(&apos;, &apos;, $lists) . PHP_EOL;</div><div class="line">    &#125;</div><div class="line">    //echo &quot;build ok: &quot; . implode(&apos;, &apos;, $lists) . PHP_EOL;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function heap_adjust(array &amp;$lists, $i, $num)</div><div class="line">&#123;</div><div class="line">    if ($i &gt; $num / 2) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    $key = $i;</div><div class="line">    $leftChild = $i * 2 + 1;</div><div class="line">    $rightChild = $i * 2 + 2;</div><div class="line"></div><div class="line">    if ($leftChild &lt; $num &amp;&amp; $lists[$leftChild] &gt; $lists[$key]) &#123;</div><div class="line">        $key = $leftChild;</div><div class="line">    &#125;</div><div class="line">    if ($rightChild &lt; $num &amp;&amp; $lists[$rightChild] &gt; $lists[$key]) &#123;</div><div class="line">        $key = $rightChild;</div><div class="line">    &#125;</div><div class="line">    if ($key != $i) &#123;</div><div class="line">        $val = $lists[$i];</div><div class="line">        $lists[$i] = $lists[$key];</div><div class="line">        $lists[$key] = $val;</div><div class="line">        heap_adjust($lists, $key, $num);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="7-希尔排序"><a href="#7-希尔排序" class="headerlink" title="7 希尔排序"></a>7 希尔排序</h2><p>希尔排序，也称<strong>递减增量</strong>排序算法，是插入排序的一种更高效的改进版本。</p><p>但希尔排序是非稳定排序算法。</p><p>希尔排序是基于插入排序的以下两点性质而提出改进方法的：</p><ul><li>插入排序在对几乎已经排好序的数据操作时， 效率高， 即可以达到线性排序的效率</li><li>但插入排序一般来说是低效的， 因为插入排序每次只能将数据移动一位</li></ul><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/Sorting_shellsort_anim.gif" alt="img"></p><p>算法步骤：</p><ol><li>先将整个待排序的记录序列分割成为若干子序列，分别进行直接插入排序</li><li>待整个序列中的记录“基本有序”时，再对全体记录进行依次直接插入排序。</li></ol><p>PHP实现代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 希尔排序 标准</div><div class="line"> *</div><div class="line"> * @param array $lists</div><div class="line"> * @return array</div><div class="line"> */</div><div class="line">function shell_sort(array $lists)</div><div class="line">&#123;</div><div class="line">    $n = count($lists);</div><div class="line">    $step = 2;</div><div class="line">    $gap = intval($n / $step);</div><div class="line">    while ($gap &gt; 0) &#123;</div><div class="line">        for ($gi = 0; $gi &lt; $gap; $gi++) &#123;</div><div class="line">            for ($i = $gi; $i &lt; $n; $i += $gap) &#123;</div><div class="line">                $key = $lists[$i];</div><div class="line">                for ($j = $i - $gap; $j &gt;= 0 &amp;&amp; $lists[$j] &gt; $key; $j -= $gap) &#123;</div><div class="line">                    $lists[$j + $gap] = $lists[$j];</div><div class="line">                    $lists[$j] = $key;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        $gap = intval($gap / $step);</div><div class="line">    &#125;</div><div class="line">    return $lists;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="8-基数排序"><a href="#8-基数排序" class="headerlink" title="8 基数排序"></a>8 基数排序</h2><p>基数排序是一种非比较型整数排序算法，其原理是将整数按位数切割成不同的数字，然后按每个位数分别比较。</p><p>由于整数也可以表达字符串（比如名字或日期）和特定格式的浮点数，所以基数排序也不是只能使用于整数。</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/unnamed-file.gif" alt="img"></p><p>说基数排序之前，我们简单介绍桶排序：</p><p>桶排序是将阵列分到有限数量的桶子里。</p><p>每个桶子再个别排序，有可能再使用别的排序算法，或是以递回方式继续使用桶排序进行排序。</p><p>桶排序是鸽巢排序的一种归纳结果。</p><p>当要被排序的阵列内的数值是均匀分配的时候，桶排序使用线性时间<code>O(n)</code>。</p><p>但桶排序并不是 比较排序，他不受到 <code>O(n log n)</code> 下限的影响。</p><p>简单来说，就是把数据分组，放在一个个的桶中，然后对每个桶里面的在进行排序。</p><p>例如，要对大小为<code>[1..1000]</code>范围内的<code>n</code>个整数<code>A[1..n]</code>排序</p><p>首先，可以把桶设为大小为10的范围，具体而言，设集合B[1]存储[1..10]的整数，集合B[2]存储   (10..20]的整数，……集合B[i]存储(   (i-1)<em>10,   i</em>10]的整数，i   =   1,2,..100。总共有  100个桶。</p><p>然后，对A[1..n]从头到尾扫描一遍，把每个A[i]放入对应的桶B[j]中。  再对这100个桶中每个桶里的数字排序，这时可用冒泡，选择，乃至快排，一般来说任  何排序法都可以。</p><p>最后，依次输出每个桶里面的数字，且每个桶中的数字从小到大输出，这  样就得到所有数字排好序的一个序列了。</p><p>假设有n个数字，有m个桶，如果数字是平均分布的，则每个桶里面平均有n/m个数字。</p><p>如果对每个桶中的数字采用快速排序，那么整个算法的复杂度是</p><p>O(n   +   m   <em>   n/m</em>log(n/m))   =   O(n   +   nlogn   –   nlogm)</p><p>从上式看出，当m接近n的时候，桶排序复杂度接近O(n)</p><p>当然，以上复杂度的计算是基于输入的n个数字是平均分布这个假设的。这个假设是很强的  ，实际应用中效果并没有这么好。如果所有的数字都落在同一个桶中，那就退化成一般的排序了。</p><p>前面说的几大排序算法 ，大部分时间复杂度都是O（n2），也有部分排序算法时间复杂度是O(nlogn)。而桶式排序却能实现O（n）的时间复杂度。但桶排序的缺点是：</p><p>1）首先是空间复杂度比较高，需要的额外开销大。排序有两个数组的空间开销，一个存放待排序数组，一个就是所谓的桶，比如待排序值是从0到m-1，那就需要m个桶，这个桶数组就要至少m个空间。</p><p>2）其次待排序的元素都要在一定的范围内等等。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 基数排序</div><div class="line"> *</div><div class="line"> * @param array $lists</div><div class="line"> * @return array</div><div class="line"> */</div><div class="line">function radix_sort(array $lists)</div><div class="line">&#123;</div><div class="line">    $radix = 10;</div><div class="line">    $max = max($lists);</div><div class="line">    $k = ceil(log($max, $radix));</div><div class="line">    if ($max == pow($radix, $k)) &#123;</div><div class="line">        $k++;</div><div class="line">    &#125;</div><div class="line">    for ($i = 1; $i &lt;= $k; $i++) &#123;</div><div class="line">        $newLists = array_fill(0, $radix, []);</div><div class="line">        for ($j = 0; $j &lt; count($lists); $j++) &#123;</div><div class="line">            $key = $lists[$j] / pow($radix, $i - 1) % $radix;</div><div class="line">            $newLists[$key][] = $lists[$j];</div><div class="line">        &#125;</div><div class="line">        $lists = [];</div><div class="line">        for ($j = 0; $j &lt; $radix; $j++) &#123;</div><div class="line">            $lists = array_merge($lists, $newLists[$j]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return $lists;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9 总结"></a>9 总结</h2><p>各种排序的稳定性，时间复杂度、空间复杂度、稳定性总结如下图：</p><p><img src="https://www.awaimai.com/wp-content/uploads/2017/12/sort_table.jpg" alt="img"></p><p>关于时间复杂度：</p><p>(1)平方阶(O(n2))排序<br> 各类简单排序:直接插入、直接选择和冒泡排序；</p><p>(2)线性对数阶(O(nlog2n))排序<br> 　　快速排序、堆排序和归并排序；<br> (3)O(n1+§))排序,§是介于0和1之间的常数。</p><p>希尔排序</p><p>(4)线性阶(O(n))排序</p><p>基数排序，此外还有桶、箱排序。</p><p>关于稳定性：</p><p>稳定的排序算法：冒泡排序、插入排序、归并排序和基数排序</p><p>不是稳定的排序算法：选择排序、快速排序、希尔排序、堆排序</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP基础教程：Memcache</title>
      <link href="/2018/06/29/1/"/>
      <content type="html"><![CDATA[<h1 id="什么是Memcache"><a href="#什么是Memcache" class="headerlink" title="什么是Memcache"></a>什么是Memcache</h1><p>Memcache是一个自由、源码开放、高性能、分布式的分布式内存对象缓存系统 ，用于动态Web应用以减轻数据库的负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高了网站访问的速度。Memcache是一个存储键值对的HashMap，在内存中对任意的数据（比如字符串、对象等）所使用的key-value存储，数据可以来自数据库调用、API调用，或者页面渲染的结果。MemCache设计理念就是小而强大，它简单的设计促进了快速部署、易于开发并解决面对大规模的数据缓存的许多难题，而所开放的API使得MemCache能用于Java、C/C++/C#、Perl、Python、PHP、Ruby等大部分流行的程序语言。 </p><p><strong>MemCache 和 MemCached：</strong></p><p>MemCache是这个项目的名称，而MemCached是服务器端的主程序名称。</p><h1 id="Memcache使用场景"><a href="#Memcache使用场景" class="headerlink" title="Memcache使用场景"></a>Memcache使用场景</h1><p>通常，我们会在访问量高的Web网站和应用中使用Memcache，用来缓解数据库的压力，并且提升网站和应用的响应速度。</p><p><strong>在应用程序中，我们通常在以下节点来使用MemCached：</strong></p><ol><li>访问频繁的数据库数据（身份token、首页动态）</li><li>访问频繁的查询条件和结果</li><li>作为Session的存储方式（提升Session存取性能）</li><li>页面缓存</li><li>更新频繁的非重要数据（访客量、点击次数）</li><li>大量的hot数据</li></ol><h1 id="安装Memcache"><a href="#安装Memcache" class="headerlink" title="安装Memcache"></a>安装Memcache</h1><p>我们在Linux上安装软件一般会采取两种方案，一种是编译安装，另外一种是使用Linux系统为我们提供的包管理工具。</p><p>在安装Memcache之前，我们需要提前安装Libevent，因为Memcache的实现依赖于这个库。</p><p>编译安装的好处是我们可以自定义一些设置，比如说安装到指定的目录下，相对而言假如你在编译时发生一些错误，而你对Linux又不是特别了解的话，可能处理错误时比较困难。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y memcached</div></pre></td></tr></table></figure><p>启动memcache</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">memcached -d -l 127.0.0.1 -p 11211 -m 150 -u root</div></pre></td></tr></table></figure><ul><li>-d 守护进程</li><li>-l IP地址</li><li>-p 端口号</li><li>-m 分配内存</li><li>-u 以什么用户进行运行（在线上不建议使用 root）</li></ul><h1 id="客户端的安装过程"><a href="#客户端的安装过程" class="headerlink" title="客户端的安装过程"></a>客户端的安装过程</h1><p>安装PHP的memcahed扩展需要<a href="http://libmemcached.org/libMemcached.html" target="_blank" rel="noopener">» libmemcached</a>客户端库（版本大于等于 1.0.0）。链接 memcached 服务器时使用SASL认证，需要libmemcached 必须开启SASL选项。</p><p>Memcached从0.2.0开始，要求PHP版本大于等于5.2.0。</p><p>如果libmemcached被安装在一个非标准路径，使用<strong>–with-libmemcached-dir=DIR</strong> 来指定路径，DIR就是libmemcached安装时的prefix参数。这个路径需要包含文件include/libmemcached/memcached.h。</p><p>如果要支持压缩就需要zlib。对于非标准安装的zlib库，使用<strong>–with-zlib-dir=DIR</strong> 来指定zlib安装路径，DIR就是zib安装时的prefix参数。</p><p>session处理器的支持默认是开启的。如果要关闭它，使用选项<strong>–disable-memcached-session</strong> 。</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Swoole 基础（二）：创建 TCP 服务器</title>
      <link href="/2018/06/13/1/"/>
      <content type="html"><![CDATA[<p>swoole-1.7.7增加了内置Http服务器的支持，通过几行代码即可写出一个异步非阻塞多进程的Http服务器。swoole_http_server对Http协议的支持并不完整，建议仅作为应用服务器。并且在前端增加Nginx作为代理</p><p>通过使用apache bench工具进行压力测试，在Inter Core-I5 4核 + 8G内存的普通PC机器上，swoole_http_server可以达到近11万QPS。远远超过php-fpm，golang自带http服务器，node.js自带http服务器。性能几乎接近与Nginx的静态文件处理。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ab -c 200 -n 200000 -k http://127.0.0.1:9501</div></pre></td></tr></table></figure><h1 id="创建Web服务器"><a href="#创建Web服务器" class="headerlink" title="创建Web服务器"></a>创建Web服务器</h1><h2 id="程序代码"><a href="#程序代码" class="headerlink" title="程序代码"></a>程序代码</h2><p>http_server.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$http = <span class="keyword">new</span> swoole_http_server(<span class="string">"0.0.0.0"</span>, <span class="number">9501</span>);</div><div class="line"></div><div class="line">$http-&gt;on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($request, $response)</span> </span>&#123;</div><div class="line">    var_dump($request-&gt;get, $request-&gt;post);</div><div class="line">    $response-&gt;header(<span class="string">"Content-Type"</span>, <span class="string">"text/html; charset=utf-8"</span>);</div><div class="line">    $response-&gt;end(<span class="string">"&lt;h1&gt;Hello Swoole. #"</span>.rand(<span class="number">1000</span>, <span class="number">9999</span>).<span class="string">"&lt;/h1&gt;"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$http-&gt;start();</div></pre></td></tr></table></figure><p>Http服务器只需要关注请求响应即可，所以只需要监听一个<code>onRequest</code>事件。当有新的Http请求进入就会触发此事件。事件回调函数有2个参数，一个是$request对象，包含了请求的相关信息，如GET/POST请求的数据。</p><p>另外一个是response对象，对request的响应可以通过操作response对象来完成。$response-&gt;end()方法表示输出一段HTML内容，并结束此请求。</p><ul><li><code>0.0.0.0</code> 表示监听所有IP地址，一台服务器可能同时有多个IP，如<code>127.0.0.1</code>本地回环IP、<code>192.168.1.100</code>局域网IP、<code>210.127.20.2</code> 外网IP，这里也可以单独指定监听一个IP</li><li><code>9501</code> 监听的端口，如果被占用程序会抛出致命错误，中断执行。</li></ul><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php http_server.php</div></pre></td></tr></table></figure><ul><li>可以打开浏览器，访问<code>http://127.0.0.1:9501</code>查看程序的结果。</li><li>也可以使用apache <code>ab</code>工具对服务器进行压力测试</li></ul><h2 id="使用Http2协议"><a href="#使用Http2协议" class="headerlink" title="使用Http2协议"></a>使用Http2协议</h2><ul><li>需要依赖<code>nghttp2</code>库，<a href="https://github.com/tatsuhiro-t/nghttp2" target="_blank" rel="noopener">下载nghttp2</a>后编译安装</li><li>使用<code>Http2</code>协议必须开启<code>openssl</code></li><li>需要高版本<code>openssl</code>必须支持<code>TLS1.2</code>、<code>ALPN</code>、<code>NPN</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure --enable-openssl --enable-http2</div></pre></td></tr></table></figure><p>设置http服务器的<code>open_http2_protocol</code>为<code>true</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$serv = <span class="keyword">new</span> swoole_http_server(<span class="string">"127.0.0.1"</span>, <span class="number">9501</span>, SWOOLE_PROCESS, SWOOLE_SOCK_TCP | SWOOLE_SSL);</div><div class="line">$serv-&gt;set([</div><div class="line">    <span class="string">'ssl_cert_file'</span> =&gt; $ssl_dir . <span class="string">'/ssl.crt'</span>,</div><div class="line">    <span class="string">'ssl_key_file'</span> =&gt; $ssl_dir . <span class="string">'/ssl.key'</span>,</div><div class="line">    <span class="string">'open_http2_protocol'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">]);</div></pre></td></tr></table></figure><h2 id="nginx-swoole配置"><a href="#nginx-swoole配置" class="headerlink" title="nginx+swoole配置"></a>nginx+swoole配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">root</span> /data/wwwroot/;</div><div class="line">    <span class="attribute">server_name</span> local.swoole.com;</div><div class="line"></div><div class="line">    <span class="attribute">location</span> / &#123;</div><div class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</div><div class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">"keep-alive"</span>;</div><div class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">        <span class="attribute">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</div><div class="line">             <span class="attribute">proxy_pass</span> http://127.0.0.1:9501;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Swoole 基础（二）：创建 TCP 服务器</title>
      <link href="/2018/06/13/1/"/>
      <content type="html"><![CDATA[<h1 id="创建TCP服务器"><a href="#创建TCP服务器" class="headerlink" title="创建TCP服务器"></a>创建TCP服务器</h1><h2 id="程序代码"><a href="#程序代码" class="headerlink" title="程序代码"></a>程序代码</h2><p>server.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">//创建Server对象，监听 127.0.0.1:9501端口</div><div class="line">$serv = new swoole_server(&quot;127.0.0.1&quot;, 9501); </div><div class="line"></div><div class="line">//监听连接进入事件</div><div class="line">$serv-&gt;on(&apos;connect&apos;, function ($serv, $fd) &#123;  </div><div class="line">    echo &quot;Client: Connect.\n&quot;;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">//监听数据接收事件</div><div class="line">$serv-&gt;on(&apos;receive&apos;, function ($serv, $fd, $from_id, $data) &#123;</div><div class="line">    $serv-&gt;send($fd, &quot;Server: &quot;.$data);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">//监听连接关闭事件</div><div class="line">$serv-&gt;on(&apos;close&apos;, function ($serv, $fd) &#123;</div><div class="line">    echo &quot;Client: Close.\n&quot;;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">//启动服务器</div><div class="line">$serv-&gt;start();</div></pre></td></tr></table></figure><p>这里就创建了一个TCP服务器，监听本机9501端口。它的逻辑很简单，当客户端Socket通过网络发送一个 <code>hello</code> 字符串时，服务器会回复一个 <code>Server: hello</code> 字符串。</p><p>swoole_server是异步服务器，所以是通过监听事件的方式来编写程序的。当对应的事件发生时底层会主动回调指定的PHP函数。如当有新的TCP连接进入时会执行onConnect事件回调，当某个连接向服务器发送数据时会回调onReceive函数。</p><ul><li>服务器可以同时被成千上万个客户端连接，$fd就是客户端连接的唯一标识符</li><li>调用 <code>$server-&gt;send()</code> 方法向客户端连接发送数据，参数就是$fd客户端标识符</li><li>调用 <code>$server-&gt;close()</code> 方法可以强制关闭某个客户端连接</li><li>客户端可能会主动断开连接，此时会触发onClose事件回调</li></ul><h2 id="执行程序"><a href="#执行程序" class="headerlink" title="执行程序"></a>执行程序</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php server.php</div></pre></td></tr></table></figure><p>在命令行下运行server.php程序，启动成功后可以使用 <code>netstat</code> 工具看到，已经在监听9501端口。这时就可以使用telnet/netcat工具连接服务器。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">telnet 127.0.0.1 9501</div><div class="line">hello</div><div class="line">Server: hello</div></pre></td></tr></table></figure><h2 id="无法连接到服务器的简单检测手段"><a href="#无法连接到服务器的简单检测手段" class="headerlink" title="无法连接到服务器的简单检测手段"></a>无法连接到服务器的简单检测手段</h2><ul><li>在<code>Linux</code>下，使用<code>netstat -an | grep 端口</code>，查看端口是否已经被打开处于<code>Listening</code>状态</li><li>上一步确认后，检查防火墙问题</li><li>注意服务器所使用的IP地址，如果是<code>127.0.0.1</code>回环地址，则客户端只能使用<code>127.0.0.1</code>才能连接上</li></ul><h1 id="创建TCP-客户端"><a href="#创建TCP-客户端" class="headerlink" title="创建TCP 客户端"></a>创建TCP 客户端</h1><p>client.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//连接 swoole tcp 服务</span></div><div class="line">$client = <span class="keyword">new</span> swoole_client(SWOOLE_SOCK_TCP);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!$client-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">9501</span>)) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"连接失败"</span>;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//PHP CLI 常量，swoole大部分功能都是在 CLI 模式下运作的。</span></div><div class="line">fwrite(STDOUT, <span class="string">"请输入消息："</span>);</div><div class="line">$msg = trim(fgets(STDIN));</div><div class="line"></div><div class="line"><span class="comment">//发送给 TCP Server</span></div><div class="line">$client-&gt;send($msg);</div><div class="line"></div><div class="line"><span class="comment">//接受来自 server 的数据</span></div><div class="line">$result = $client-&gt;recv();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $result.<span class="string">"\n"</span>;</div></pre></td></tr></table></figure><p>Swoole 的 UDP 实现和 TCP 的实现基本一致，下一章就不再讲解如何搭建 UDP 服务了，而是 HTTP 服务。</p>]]></content>
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Swoole 基础（一）：起步</title>
      <link href="/2018/06/12/1/"/>
      <content type="html"><![CDATA[<h1 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h1><p>Swoole 是使用纯 C 语言编写，提供了 PHP 语言的异步多线程服务器，异步 TCP/UDP 网络客户端，异步 MySQL，异步 Redis，数据库连接池，AsyncTask，消息队列，毫秒定时器，异步文件读写，异步DNS查询。 Swoole内置了Http/WebSocket服务器端/客户端、Http2.0服务器端。</p><p>除了异步 IO 的支持之外，Swoole 为 PHP 多进程的模式设计了多个并发数据结构和IPC通信机制，可以大大简化多进程并发编程的工作。其中包括了并发原子计数器，并发 HashTable，Channel，Lock，进程间通信IPC等丰富的功能特性。</p><p>Swoole2.0 支持了类似 Go 语言的协程，可以使用完全同步的代码实现异步程序。PHP 代码无需额外增加任何关键词，底层自动进行协程调度，实现异步。</p><p>Swoole 的官网是 <a href="http://www.swoole.com" target="_blank" rel="noopener">http://www.swoole.com</a></p><h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><ul><li>移动互联网 API 服务器</li><li>物联网（IOT）</li><li>微服务（Micro Service）</li><li>高性能 Web 服务器</li><li>游戏服务器</li><li>在线聊天室</li></ul><h1 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h1><p>安装扩展的方法有很多，那么我们为什么要学习编译安装呢，因为大公司基本上都是以编译进行安装。</p><p>在 PHP 内核书中也提到过，建议开发者以编译形式进行安装，这样可以根据业务要求进行定制安装，例如线程安全等功能，而且对 PHP 的运行速度也会有稍微提升。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>Linux 环境下</li><li>PHP7  Swoole 2.1 redis</li><li>源码安装 PHP7、Swoole</li></ul><h2 id="获取-PHP-源代码"><a href="#获取-PHP-源代码" class="headerlink" title="获取 PHP 源代码"></a>获取 PHP 源代码</h2><p>我们可以到 PHP 官网下载，我们的生产环境都不会使用集成环境，比如 PHPStudy，WAMP，在生产环境我们都是使用编译安装 PHP 源代码。</p><p>我们最好选择最新的 PHP 版本，到本博文截止，最新的版本是7.2.6。</p><p>下载好后我们将其解压，然后按照如下步骤进行安装：</p><ol><li>configure</li><li>make</li><li>make install </li></ol><p>configure 可以对即将安装的软件进行配置与依赖检测，在这里需要注意，编译安装 PHP 需要用到 GCC、autoconfig，如果没有这两个依赖，请进行安装，configure 会给出提示。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/home/work/stduy/soft/php</div></pre></td></tr></table></figure><ul><li>–prefix 安装目录</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make </div><div class="line">make test //对编译结果进行测试</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make install</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /home/work/stduy/soft/php/bin</div><div class="line">./php -v</div></pre></td></tr></table></figure><p>我们可以看到PHP 的版本信息记大功搞成。</p><p>这样 PHP7.2.6 就已经安装完毕了。</p><p>但是每一次都要进入该目录是在是太麻烦了，我们可以直接修改系统的环境变量，也就是 profile。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo vim ~/.bash_profile</div><div class="line">alias /home/work/stduy/soft/php/bin/php</div><div class="line">source ~/.bash_profile</div></pre></td></tr></table></figure><h2 id="编译安装-Swoole"><a href="#编译安装-Swoole" class="headerlink" title="编译安装 Swoole"></a>编译安装 Swoole</h2><h3 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h3><ul><li>仅支持 <code>Linux</code>、<code>FreeBSD</code>、<code>MacOS</code> 三种操作系统</li><li>在<code>Windows</code>平台，可使用<code>CygWin</code>或<code>WSL(Windows Subsystem for Linux)</code></li><li><code>Linux</code> 内核版本 <code>2.3.32</code> 以上</li><li><code>gcc4.4</code> 以上版本或者<code>clang</code></li><li><code>4.x</code>版本起需要<code>gcc-4.8</code>或更高版本</li><li>编译为 <code>libswoole.so</code> 作为 <code>C/C++</code> 库时需要使用 <code>cmake-2.4</code> 或更高版本</li></ul><blockquote><p> 建议使用 <code>Ubuntu14</code>、<code>CentOS7</code> 或更高版本的操作系统</p></blockquote><h3 id="PHP版本依赖"><a href="#PHP版本依赖" class="headerlink" title="PHP版本依赖"></a>PHP版本依赖</h3><ul><li><code>Swoole-1.x</code>需要<code>PHP-5.3.10</code>或更高版本</li><li><code>Swoole-2.x</code>需要<code>PHP-7.0.0</code>或更高版本</li><li>依赖不<code>PHP</code>的<code>stream</code>，<code>sockets</code>，<code>pcntl</code>，<code>posix</code>，<code>sysvmsg</code>等扩展。<code>PHP</code>只需安装最基本的扩展即可</li></ul><h3 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h3><p>安装swoole前必须保证系统已经安装了下列软件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">php-5.3.10 或更高版本</div><div class="line">gcc-4.4 或更高版本</div><div class="line">make</div><div class="line">autoconf</div><div class="line">pcre (centos系统可以执行命令：yum install pcre-devel)</div></pre></td></tr></table></figure><h3 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h3><ul><li><a href="https://github.com/swoole/swoole-src/releases" target="_blank" rel="noopener">https://github.com/swoole/swoole-src/releases</a></li><li><a href="http://pecl.php.net/package/swoole" target="_blank" rel="noopener">http://pecl.php.net/package/swoole</a></li><li><a href="http://git.oschina.net/swoole/swoole" target="_blank" rel="noopener">http://git.oschina.net/swoole/swoole</a></li></ul><p>下载源代码包后，在终端进入源码目录，执行下面的命令进行编译和安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd swoole</div><div class="line">phpize</div><div class="line">./configure</div><div class="line">make </div><div class="line">sudo make install</div></pre></td></tr></table></figure><h3 id="完整编译示例"><a href="#完整编译示例" class="headerlink" title="完整编译示例"></a>完整编译示例</h3><p>以下脚本会下载并编译主分支的swoole源码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mkdir -p ~/build &amp;&amp; \</div><div class="line">cd ~/build &amp;&amp; \</div><div class="line">rm -rf ./swoole-src &amp;&amp; \</div><div class="line">curl -o ./tmp/swoole.tar.gz https://github.com/swoole/swoole-src/archive/master.tar.gz -L &amp;&amp; \</div><div class="line">tar zxvf ./tmp/swoole.tar.gz &amp;&amp; \</div><div class="line">mv swoole-src* swoole-src &amp;&amp; \</div><div class="line">cd swoole-src &amp;&amp; \</div><div class="line">phpize &amp;&amp; \</div><div class="line">./configure \</div><div class="line">--enable-coroutine \</div><div class="line">--enable-openssl  \</div><div class="line">--enable-http2  \</div><div class="line">--enable-async-redis \</div><div class="line">--enable-sockets \</div><div class="line">--enable-mysqlnd &amp;&amp; \</div><div class="line">make clean &amp;&amp; make &amp;&amp; sudo make install</div></pre></td></tr></table></figure><p>详细参数详解请到swoole 官方文档进行查看——<a href="https://wiki.swoole.com/wiki/page/437.html" target="_blank" rel="noopener">传送门</a>。</p><h3 id="PECL"><a href="#PECL" class="headerlink" title="PECL"></a>PECL</h3><p>swoole项目已收录到PHP官方扩展库，除了手工下载编译外，还可以通过PHP官方提供的PECL命令，一键下载安装swoole</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pecl install swoole</div></pre></td></tr></table></figure><h2 id="配置的php-ini"><a href="#配置的php-ini" class="headerlink" title="配置的php.ini"></a>配置的php.ini</h2><p>编译安装成功后，修改php.ini中加入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extension=swoole.so</div></pre></td></tr></table></figure><p>通过<code>php -m</code>或<code>phpinfo()</code>来查看是否成功加载了swoole，如果可能没有的英文<code>php.ini</code>的路径不对，使用可以<code>php --ini</code>来定位到<code>php.ini</code>的绝对路径</p><p>这样我们进入下载的 swoole 目录下，进入 <code>[examples]</code>目录运行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php echo.php</div></pre></td></tr></table></figure><p>如果没有报错便是安装成功了！</p>]]></content>
      
      <categories>
          
          <category> php </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>数据结构入门（03）： 队列</title>
      <link href="/2018/05/04/1/"/>
      <content type="html"><![CDATA[<p>队列 Queue 本身也是一种线性结构，依然是排成一排，相比数组，队列对应的操作也是数组的子集，不过和栈不同，我们只能从一端（队尾）添加元素，只能从另一端（队首）取出元素。我们可以将其想象成我们现实生活中的排队，第一个来的，要第一个出去。也就是说队列是一种先进先出（First In First Out[FIFO]）的数据结构。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/1243953170-57245f3329084_articlex.png" alt=""></p><h1 id="队列的实现"><a href="#队列的实现" class="headerlink" title="队列的实现"></a>队列的实现</h1><p>队列我们只要要实现以下方法</p><p>Queue\<e\></e\></p><ul><li>void enqueue(E)</li><li>E dequeue()</li><li>E getFornt()</li><li>int getSize()</li><li>boolean isEmpty()</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Array;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayQueue</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"><span class="keyword">private</span> Array&lt;T&gt; array;</div><div class="line"><span class="function"><span class="keyword">public</span>  <span class="title">ArrayQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">array = <span class="keyword">new</span> Array&lt;&gt;(capacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">array = <span class="keyword">new</span> Array&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">return</span> array.getSize();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">return</span> array.isEmpty();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.getCapacity();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(T e)</span> </span>&#123;</div><div class="line">array.addLast(e);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.removeFirst();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">getFront</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.getFirst();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">StringBuilder res = <span class="keyword">new</span> StringBuilder();</div><div class="line">res.append(String.format(<span class="string">"Queue: "</span>));</div><div class="line">res.append(<span class="string">"front ["</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.getSize(); i++) &#123;</div><div class="line">res.append(array.get(i));</div><div class="line"><span class="keyword">if</span> (i != array.getSize() -<span class="number">1</span>) &#123;</div><div class="line">res.append(<span class="string">","</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">res.append(<span class="string">']'</span>);</div><div class="line"><span class="keyword">return</span> res.toString();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Queue: front [0] tail</div><div class="line">Queue: front [0,1] tail</div><div class="line">Queue: front [0,1,2] tail</div><div class="line">Queue: front [1,2] tail</div><div class="line">Queue: front [1,2,3] tail</div><div class="line">Queue: front [1,2,3,4] tail</div><div class="line">Queue: front [1,2,3,4,5] tail</div><div class="line">Queue: front [2,3,4,5] tail</div><div class="line">Queue: front [2,3,4,5,6] tail</div><div class="line">Queue: front [2,3,4,5,6,7] tail</div><div class="line">Queue: front [2,3,4,5,6,7,8] tail</div><div class="line">Queue: front [3,4,5,6,7,8] tail</div><div class="line">Queue: front [3,4,5,6,7,8,9] tail</div></pre></td></tr></table></figure><h1 id="循环队列"><a href="#循环队列" class="headerlink" title="循环队列"></a>循环队列</h1><p>数组队列是有局限性的，主要是在于出队这个操作，他的时间复杂度是 O(N) ，当我们删除队首时候，后面的元素都要向前移动一位，这是数组实现队列删除元素走的这样的一个过程，所以他的时间复杂度是O(N)。</p><p>如果我们删除首位后，其他位置不向前移动，因为这样后面的元素，还是保持着队列的样子，所以可以在数组中记录队首是谁 (front)，如果删除了队首[0]，那么就将队首的位置设置成[1]。</p><p>这种数据结构也就是循环队列。</p><p>当队列中一个内容都没有的时候，front(队首)和 tail 队尾指向是在一起的。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180704-210707.jpg" alt=""></p><p>也就是说，当front == tail 的时候，就说明队列为空，只要数组内容不为空，tail 和 front 就不可能相等，当有内容入队了，我们只需要维护 tail 将其指向下一个元素要入队时的位置就可以了，也就是 tail++。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180704-211137.jpg" alt=""></p><p>如果此时队列中已经拥有五个元素了，当我们要进行出队时，只需要将front 指向的元素出队，并且维护 front 向后移动一位。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180704-211545.jpg" alt=""></p><p>我们可以看出循环队列不再要求所有的元素进行移动了，只需要维护 front 的指向改变就可以了。</p><p>现在结构相对简单，但是并不能体现出循环，当入队的元素达到了容量的上限时，tail 就不能再向后移动了。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180704-212058.jpg" alt=""></p><p>从上图我们可以看到，由于队首的元素移出数组之后余下的空间，没有被后面的数据占用，所以前面也许还有可以利用的空间，这就是循环队列的来由。</p><p>其实我们就是把我们的数组看成一个环，现在的数组一共可以容纳8个元素，索引是0到7，7之后的索引其实是0，而此时我们就可以判断数组空间已经被沾满了，</p><p>上面我们说过维护 tail 就是 ++ 运算，但是如果是循环队列就不准确了，应该是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">（当前索引 + 1） % 数组的长度</div></pre></td></tr></table></figure><p>从7计算到0，就是 <code>(7 + 1) % 8 = 0</code>。0这位置还能放心的元素，如果再次加入元素，新的元素就会被放置到0这个位置上。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/Jietu20180704-212959.jpg" alt="">\</p><p>现在到了这种情况，1这个位置是空的，那么是否还能在向其中插入元素呢？</p><p>需要注意的是，我们之前提到过 front == tail 队列为空，如果再有一个新的元素入队了，放到[1]这个位置上，我们的 tail 就会与 front 相等，这个时候，我们的队列其实并不为空，如果还让新的元素可以进来的话，front == tail 既可以表示队列为空，又可以便是队列为满了，这并不是我们希望看到的条件。</p><p>队列满我们应该用 <strong><code>（tail + 1） % capacity == 0</code></strong>。</p><p>当我们在进行入队操作时，发现队列以满之后就可以扩容了，也就是说这样会被浪费掉一个空间。</p>]]></content>
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>数据结构入门（03）：栈</title>
      <link href="/2018/05/03/1/"/>
      <content type="html"><![CDATA[<h1 id="栈的应用"><a href="#栈的应用" class="headerlink" title="栈的应用"></a>栈的应用</h1><p>今天给大家讲解一个全新的线性结构分别是栈和队列，在这一篇文章的前半部分我会首先讲解栈。</p><p>栈也是一种线性结构，比起数组，栈对应的操作是数组的子集。</p><p>栈只能从一端添加元素，也只能从一端取出元素，这一端也被称为<strong>栈顶</strong>。</p><p>向栈添加数据我们将其称之为入栈，如下图：</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180702091057.png" alt=""></p><p>当我们想要取出数据时候，我们只能从栈顶取出数据，也就是说，我们首先取出的是3，然后才是2，1这样的一个顺序。</p><p>按照这个顺序执行，所以栈被称之为<strong>后进先出（Last In First Out [LIFO]）</strong>的数据结构。3其实是最后一个被放到栈中的数据，却是第一个被取出的数据。</p><p>在计算机世界里，栈拥有者不可思议的作用，事实上，在别的数据结构中还会看到栈的作用，甚至我们在学习经典算法或者算法设计的时候都将不可避免的看到栈，看起来很简单，但是应用起来非常广泛的数据结构。</p><ul><li><p>无处不在的Undo操作（撤销）</p></li><li><p>程序调用所使用的系统栈</p></li></ul><p>撤销操作其实很好理解，当我们在编辑器中输入内容时候，比如我们输入XXX、我、喜欢你，这一组数据的时候，其实就是一次入栈操作，依次将XXX、我、喜欢你、压入栈中。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180702095131.png" alt=""></p><p>当我们，感觉喜欢你，不如我爱你贴切的时候，可以执行撤销操作，将喜欢你从栈中取出来，然后输入爱你。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180702095415.png" alt=""></p><p>在我们系统执行中，总会碰到先终止，然后到另外的一个逻辑去执行，所谓的子函数的调用就是这个过程。这个时候，系统就会使用被称之为系统栈的数据结构，来记录程序调用的过程。我们同样通过画图的形式来带领大家理解。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180702101428.png" alt=""></p><p>通过上图中的业务逻辑，我们其实同时也可以很好的理解递归调用的原理，我们在上学时候，或者是在一些文章中总能看到说递归其实就是自己调用自己，这么说是为了让大家方便理解，但是其实真正的原理，就是系统帮助我们进行压栈。</p><h1 id="栈的实现"><a href="#栈的实现" class="headerlink" title="栈的实现"></a>栈的实现</h1><p>Stack\<e\></e\></p><ul><li>void push(E)  入栈</li><li>E pop()           出栈</li><li>E peek()         查看栈顶(top)</li><li>int getSize()   获取栈的大小</li><li>boolean isEmpty();   判断栈是否为空</li></ul><p>从用户的角度来看，我们只需要支持这些操作就完全可以了。具体底层实现，用户是不关心的，实际上底层的实现有多重实现方法。</p><p>在这一篇文章中，我只介绍一种使用动态数组实现ArrayStack的栈，在后续文章中再去介绍另外一种实现方式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Array;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayStack</span>&lt;<span class="title">T</span>&gt;  </span>&#123;</div><div class="line">Array&lt;T&gt; array;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayStack</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">array = <span class="keyword">new</span> Array&lt;&gt;(capacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayStack</span><span class="params">()</span> </span>&#123;</div><div class="line">array = <span class="keyword">new</span> Array&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.getSize();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.isEmpty();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.getCapacity();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span> <span class="params">(T e)</span> </span>&#123;</div><div class="line">array.addLast(e);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">pop</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.removeLast();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">peek</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.getLast();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">StringBuilder res = <span class="keyword">new</span> StringBuilder();</div><div class="line">res.append(<span class="string">"Stack: ["</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.getSize(); i++) &#123;</div><div class="line">res.append(array.get(i));</div><div class="line"><span class="keyword">if</span> (i != array.getSize() - <span class="number">1</span>) &#123;</div><div class="line">res.append(<span class="string">", "</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">res.append(<span class="string">"] top"</span>);</div><div class="line"><span class="keyword">return</span> res.toString();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>注意其中的一段代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">peek</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> array.getLast(); </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在这里，我们复用来我们自己所编写的动态数组Array 类，但是并不完善，并没有提供 getLast 这个功能，其实这个很简单，只需要我们自己实现以下就好了，根据  <code>Array.get</code> 方法就可以轻松实现。</p><p>我们可以看得出来，整个栈的编写非常简单，没有任何复杂的代码，完全是使用我们自己所编写的 Array 类便可以轻松的实现。</p><h1 id="括号匹配"><a href="#括号匹配" class="headerlink" title="括号匹配"></a>括号匹配</h1><p>在我们编程的时候，编译器会自动匹配{}、[]、()，编译器其实也是使用栈结构来进行括号匹配的。</p><p>这是在 LeetCode 上的一道题，编号是20：<a href="https://leetcode-cn.com/problems/valid-parentheses/description/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/valid-parentheses/description/</a></p><p>给定一个只包括 <code>&#39;(&#39;</code>，<code>&#39;)&#39;</code>，<code>&#39;{&#39;</code>，<code>&#39;}&#39;</code>，<code>&#39;[&#39;</code>，<code>&#39;]&#39;</code> 的字符串，判断字符串是否有效。</p><p>有效字符串需满足：</p><ol><li>左括号必须用相同类型的右括号闭合。</li><li>左括号必须以正确的顺序闭合。</li></ol><p>注意空字符串可被认为是有效字符串。</p><p><strong>示例 1:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">输入: &quot;()&quot;</div><div class="line">输出: true</div></pre></td></tr></table></figure><p><strong>示例 2:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">输入: &quot;()[]&#123;&#125;&quot;</div><div class="line">输出: true</div></pre></td></tr></table></figure><p><strong>示例 3:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">输入: &quot;(]&quot;</div><div class="line">输出: false</div></pre></td></tr></table></figure><p><strong>示例 4:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">输入: &quot;([)]&quot;</div><div class="line">输出: false</div></pre></td></tr></table></figure><p><strong>示例 5:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">输入: &quot;&#123;[]&#125;&quot;</div><div class="line">输出: true</div></pre></td></tr></table></figure><p>如果当前我们有这样一串字符<code>{[()]}</code></p><p>我们可以声明一个栈，然后遍历栈中的每一个字符，如果字符是一个左括号，我们就将他压入栈，第一个是<code>{</code>我们将其压栈，然后是<code>[</code>压栈，然后<code>(</code>压栈，这样左括号就全部压入了栈中，往后将是右括号，当走到<code>）</code>的时候，我们查看栈顶的括号是否可以和<code>)</code>匹配。</p><p>如果匹配，则表示通过了验证，然后出栈，然后在向右验证，直到栈中没有数据。其实就是栈顶元素反映了在嵌套层次关系中，最近的需要匹配的元素。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">Stack&lt;Character&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length() ; i++) &#123;</div><div class="line"><span class="keyword">char</span> c = s.charAt(i);</div><div class="line"><span class="keyword">if</span> (c == <span class="string">'('</span> || c == <span class="string">'['</span> || c == <span class="string">'&#123;'</span>) &#123;</div><div class="line">stack.push(c);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">if</span> (stack.isEmpty()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">char</span> topChar = stack.pop();</div><div class="line"><span class="keyword">if</span> (c == <span class="string">')'</span> &amp;&amp; topChar != <span class="string">'('</span>) </div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="keyword">if</span> (c == <span class="string">']'</span> &amp;&amp; topChar != <span class="string">'['</span>)</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="keyword">if</span> (c == <span class="string">'&#125;'</span> &amp;&amp; topChar != <span class="string">'&#123;'</span>) </div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//判断是否还有数据，如果还有数据则证明不完整，只有为空的时候则全都匹配上了。</span></div><div class="line"><span class="keyword">return</span> stack.isEmpty();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>数据结构入门（02）：算法复杂度的分析</title>
      <link href="/2018/05/02/1/"/>
      <content type="html"><![CDATA[<p>算法这一个词汇这两年异常的火爆，就算不是计算机从业人员也对算法如雷贯耳，<em>Alpha</em>Go狂虐各国高手，算法多么多么牛*。</p><p>但是身为计算机从业人员，我们要知道对于一个给定的算法，我们要做两项分析。第一是从数学上证明算法的正确性，这一步主要用到形式化证明的方法及相关推理模式，如循环不变式、数学归纳法等。</p><p>而在证明算法是正确的基础上，第二部就是分析算法的时间复杂度。算法的时间复杂度反映了程序执行时间随输入规模增长而增长的量级，在很大程度上能很好反映出算法的优劣与否。因此，作为程序员，掌握基本的算法时间复杂度分析方法是很有必要的。</p><p>算法执行时间需通过依据该算法编制的程序在计算机上运行时所消耗的时间来度量。而度量一个程序的执行时间通常有两种方法。</p><ol><li>事后统计的方法</li><li>事前分析估算</li></ol><p>这种方法可行，但不是一个好的方法。该方法有两个缺陷：一是要想对设计的算法的运行性能进行评测，必须先依据算法编制相应的程序并实际运行；二是所得时间的统计量依赖于计算机的硬件、软件等环境因素，有时容易掩盖算法本身的优势。</p><p>因事后统计方法更多的依赖于计算机的硬件、软件等环境因素，有时容易掩盖算法本身的优劣。<strong>因此人们常常采用事前分析估算的方法。</strong></p><p>在编写程序前，依据统计方法对算法进行估算。一个用高级语言编写的程序在计算机上运行时所消耗的时间取决于下列因素：</p><ol><li>算法采用的策略、方法；</li><li>编译产生的代码质量；</li><li>问题的输入规模；</li><li>机器执行指令的速度。</li></ol><p>一个算法是由控制结构（顺序、分支和循环3种）和原操作（指固有数据类型的操作）构成的，则算法时间取决于两者的综合效果。为了便于比较同一个问题的不同算法，通常的做法是，从算法中选取一种对于所研究的问题（或算法类型）来说是基本操作的原操作，以该基本操作的重复执行的次数作为算法的时间量度。</p><h1 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h1><h2 id="时间频度"><a href="#时间频度" class="headerlink" title="时间频度"></a>时间频度</h2><p>一个算法执行所耗费的时间，从理论上是不能算出来的，必须上机运行测试才能知道。但我们不可能也没有必要对每个算法都上机测试，只需知道哪个算法花费的时间多，哪个算法花费的时间少就可以了。并且一个算法花费的时间与算法中语句的执行次数成正比例，哪个算法中语句执行次数多，它花费时间就多。一个算法中的语句执行次数称为语句频度或时间频度。记为T(n)。</p><h2 id="时间复杂度-1"><a href="#时间复杂度-1" class="headerlink" title="时间复杂度"></a>时间复杂度</h2><p>在刚才提到的时间频度中，n称为问题的规模，当n不断变化时，时间频度T(n)也会不断变化。但有时我们想知道它变化时呈现什么规律。为此，我们引入时间复杂度概念。</p><p> 一般情况下，算法中基本操作重复执行的次数是问题规模n的某个函数，用T(n)表示，若有某个辅助函数f(n),使得当n趋近于无穷大时，<strong>T(n)/f(n)</strong>的极限值为不等于零的常数，则称f(n)是T(n)的同数量级函数。记作<strong>T(n)=Ｏ(f(n)),</strong>称<strong>Ｏ(f(n))</strong> 为算法的渐进时间复杂度，简称时间复杂度</p><p>另外，上面公式中用到的 Landau符号其实是由德国数论学家保罗·巴赫曼（Paul Bachmann）在其1892年的著作《解析数论》首先引入，由另一位德国数论学家艾德蒙·朗道（Edmund Landau）推广。</p><p><strong>Landau符号的作用在于用简单的函数来描述复杂函数行为，给出一个上或下（确）界</strong>。在计算算法复杂度时一般只用到大<strong>O</strong>符号，Landau符号体系中的小<strong>o</strong>符号、<strong>Θ</strong>符号等等比较不常用。这里的<strong>O</strong>，最初是用大写希腊字母，但现在都用大写英语字母<strong>O</strong>；小<strong>o</strong>符号也是用小写英语字母<strong>o</strong>，<strong>Θ</strong>符号则维持大写希腊字母<strong>Θ</strong>。</p><p> <strong>T (n) = Ο(f (n))</strong> 表示存在一个常数C，使得在当n趋于正无穷时总有 T (n) ≤ C <em> f(n)。简单来说，就是T(n)在n趋于正无穷时最大也就跟f(n)差不多大。也就是说当n趋于正无穷时<strong>T (n)</strong>的上界是**C \</em> f(n)。<strong>其虽然对f(n)没有规定，但是一般都是取尽可能简单的函数。例如，O(2<em>n</em>2+n +1) = O (3<em>n</em>2+n+3) = O (7<em>n</em>2 + n) = </strong>O ( n2 )<strong> ，一般都只用</strong>O(n2)**表示就可以了。</p><p>注意到大O符号里隐藏着一个常数C，所以f(n)里一般不加系数。如果把T(n)当做一棵树，那么O(f(n))所表达的就是树干，只关心其中的主干，其他的细枝末节全都抛弃不管。</p><p>在各种不同算法中，若算法中语句执行次数为一个常数，则时间复杂度为O(1),另外，在时间频度不相同时，时间复杂度有可能相同，如T(n)=<em>n</em>2+3n+4与T(n)=4<em>n</em>2+2n+1它们的频度不同，但时间复杂度相同，都为O(<em>n</em>2)。</p><p>按数量级递增排列，常见的时间复杂度有：常数阶<strong>O(1)</strong>,对数阶<strong>O(log2n),</strong>线性阶<strong>O(n),</strong> 线性对数阶<strong>O(nlog2n),</strong>平方阶<strong>O(n2)，</strong>立方阶<strong>O(n3)</strong>,…， k次方阶<strong>O(nk),</strong>指数阶<strong>O(2n)。</strong>随着问题规模n的不断增大，上述时间复杂度不断增大，算法的执行效率越低。</p><p><img src="http://img.blog.csdn.net/20130920210031796?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvem9sYWxhZA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img"></p><p><strong>从图中可见，我们应该尽可能选用多项式阶O(nk)的算法，而不希望用指数阶的算法。</strong></p><p>常见的算法时间复杂度由小到大依次为：<strong>Ο(1)＜Ο(log2n)＜Ο(n)＜Ο(nlog2n)＜Ο(n2)＜Ο(n3)＜…＜Ο(2n)＜Ο(n!)</strong></p><p>一般情况下，对一个问题（或一类算法）只需选择一种基本操作来讨论算法的时间复杂度即可，有时也需要同时考虑几种基本操作，甚至可以对不同的操作赋予不同的权值，以反映执行不同操作所需的相对时间，这种做法便于综合比较解决同一问题的两种完全不同的算法。</p><h2 id="求解算法的时间复杂度的具体步骤是"><a href="#求解算法的时间复杂度的具体步骤是" class="headerlink" title="求解算法的时间复杂度的具体步骤是"></a>求解算法的时间复杂度的具体步骤是</h2><p>⑴ 找出算法中的基本语句；</p><p>算法中执行次数最多的那条语句就是基本语句，通常是最内层循环的循环体。</p><p>⑵ 计算基本语句的执行次数的数量级；</p><p>只需计算基本语句执行次数的数量级，这就意味着只要保证基本语句执行次数的函数中的最高次幂正确即可，可以忽略所有低次幂和最高次幂的系数。这样能够简化算法分析，并且使注意力集中在最重要的一点上：增长率。</p><p>⑶ 用大Ο记号表示算法的时间性能。</p><p>将基本语句执行次数的数量级放入大Ο记号中。</p><p>如果算法中包含嵌套的循环，则基本语句通常是最内层的循环体，如果算法中包含并列的循环，则将并列循环的时间复杂度相加。例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;=n; i++)  &#123;</div><div class="line">     x++; </div><div class="line">&#125;</div><div class="line">        </div><div class="line"><span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;=n; i++)  &#123;</div><div class="line">    <span class="keyword">for</span> (j=<span class="number">1</span>; j&lt;=n; j++) &#123;</div><div class="line">          x++; </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>第一个for循环的时间复杂度为Ο(n)，第二个for循环的时间复杂度为Ο(<em>n</em>2)，则整个算法的时间复杂度为Ο(n+<em>n</em>2)=Ο(<em>n</em>2)。</p><p>Ο(1)表示基本语句的执行次数是一个常数，一般来说，只要算法中不存在循环语句，其时间复杂度就是Ο(1)。其中<strong>Ο(log2n)、Ο(n)、 Ο(nlog2n)、Ο(n2)和Ο(n3)</strong>称为多项式时间，<strong>而Ο(2n)和Ο(n!)称为指数时间</strong>。计算机科学家普遍认为前者（即多项式时间复杂度的算法）是有效算法，把这类问题称为<strong>P（Polynomial,多项式）类问题</strong>，而把后者（即指数时间复杂度的算法）称为<strong>NP（Non-Deterministic Polynomial, 非确定多项式）问题</strong>。</p><p>一般来说多项式级的复杂度是可以接受的，很多问题都有多项式级的解——也就是说，这样的问题，对于一个规模是n的输入，在n^k的时间内得到结果，称为P问题。有些问题要复杂些，没有多项式时间的解，但是可以在多项式时间里验证某个猜测是不是正确。比如问4294967297是不是质数？如果要直接入手的话，那么要把小于4294967297的平方根的所有素数都拿出来，看看能不能整除。还好欧拉告诉我们，这个数等于641和6700417的乘积，不是素数，很好验证的，顺便麻烦转告费马他的猜想不成立。大数分解、Hamilton回路之类的问题，都是可以多项式时间内验证一个“解”是否正确，这类问题叫做NP问题。</p><h2 id="在计算算法时间复杂度时有以下几个简单的程序分析法则"><a href="#在计算算法时间复杂度时有以下几个简单的程序分析法则" class="headerlink" title="在计算算法时间复杂度时有以下几个简单的程序分析法则"></a>在计算算法时间复杂度时有以下几个简单的程序分析法则</h2><p>(1).对于一些简单的输入输出语句或赋值语句,近似认为需要O(1)时间</p><p>(2).对于顺序结构,需要依次执行一系列语句所用的时间可采用大O下”求和法则”</p><p><strong>求和法则</strong>:是指若算法的2个部分时间复杂度分别为 T1(n)=O(f(n))和 T2(n)=O(g(n)),则 T1(n)+T2(n)=O(max(f(n), g(n)))</p><p>特别地,若T1(m)=O(f(m)), T2(n)=O(g(n)),则 T1(m)+T2(n)=O(f(m) + g(n))</p><p>(3).对于选择结构,如if语句,它的主要时间耗费是在执行then字句或else字句所用的时间,需注意的是检验条件也需要O(1)时间</p><p>(4).对于循环结构,循环语句的运行时间主要体现在多次迭代中执行循环体以及检验循环条件的时间耗费,一般可用大O下”乘法法则”</p><p><strong>乘法法则</strong>: 是指若算法的2个部分时间复杂度分别为 T1(n)=O(f(n))和 T2(n)=O(g(n)),则 T1<em>T2=O(f(n)</em>g(n))</p><p>(5).对于复杂的算法,可以将它分成几个容易估算的部分,然后利用求和法则和乘法法则技术整个算法的时间复杂度</p><p>另外还有以下2个运算法则:(1) 若g(n)=O(f(n)),则O(f(n))+ O(g(n))= O(f(n))；(2) O(Cf(n)) = O(f(n)),其中C是一个正常数</p><h2 id="常见的时间复杂度进行示例说明"><a href="#常见的时间复杂度进行示例说明" class="headerlink" title="常见的时间复杂度进行示例说明"></a>常见的时间复杂度进行示例说明</h2><p><strong>(1)、O(1)</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Temp=i; i=j; j=temp;</div></pre></td></tr></table></figure><p>以上三条单个语句的频度均为1，该程序段的执行时间是一个与问题规模n无关的常数。算法的时间复杂度为常数阶，记作T(n)=O(1)。</p><p><strong>注意：如果算法的执行时间不随着问题规模n的增加而增长，即使算法中有上千条语句，其执行时间也不过是一个较大的常数。此类算法的时间复杂度是O(1)。</strong></p><p><strong>(2)、O(n2)</strong></p><p>2.1. 交换i和j的内容</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sum=<span class="number">0</span>；               （一次）  </div><div class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=n;i++)     （n+<span class="number">1</span>次）  </div><div class="line"><span class="keyword">for</span>(j=<span class="number">1</span>;j&lt;=n;j++)     （n2次）  </div><div class="line">sum++；               （n2次）</div></pre></td></tr></table></figure><p>解：<strong>因为Θ(2n2+n+1)=n2（Θ即：去低阶项，去掉常数项，去掉高阶项的常参得到），所以T(n)= =O(n2)；</strong></p><p>2.2.   </p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;n;i++)    &#123;   </div><div class="line">y=y+<span class="number">1</span>;         ①     </div><div class="line"><span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;=(<span class="number">2</span>*n);j++)   &#123;</div><div class="line">x++;       ②  </div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>解： </p><p>语句1的频度是n-1</p><p>语句2的频度是(n-1)<em>(2n+1)=2<em>*n2</em></em>-n-1</p><p>f(n)=2<strong>n2</strong>-n-1+(n-1)=2<strong>n2</strong>-2；</p><p>又<strong>Θ(2n2-2)=n2</strong><br>该程序的时间复杂度T(n)=O(<strong>n2</strong>).  </p><p>一般情况下，对步进循环语句只需考虑循环体中语句的执行次数，忽略该语句中步长加1、终值判别、控制转移等成分，当有若干个循环语句时，算法的时间复杂度是由嵌套层数最多的循环语句中最内层语句的频度f(n)决定的。     </p><p><strong>(3)、O(n)</strong>                      </p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">a=<span class="number">0</span>;  </div><div class="line">b=<span class="number">1</span>;                      ①  </div><div class="line"><span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;=n;i++) &#123;      ② </div><div class="line">s=a+b;　　　　③  </div><div class="line">b=a;　　　　　④    </div><div class="line">a=s;　　　　　⑤  </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>解： </p><p>语句1的频度：2,        </p><p>语句2的频度： n,        </p><p>语句3的频度： n-1,        </p><p>语句4的频度：n-1,    </p><p>语句5的频度：n-1,                                  </p><p>T(n)=2+n+3(n-1)=4n-1=O(n).</p><p><strong>(4)、O(log2n)</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">i=<span class="number">1</span>;       ①  </div><div class="line"><span class="keyword">while</span> (i&lt;=n)  </div><div class="line">i=i*<span class="number">2</span>;      ②</div></pre></td></tr></table></figure><p>解： 语句1的频度是1,<br>          设语句2的频度是f(n),   则：2^f(n)&lt;=n;f(n)&lt;=<strong>log2n</strong><br>          取最大值f(n)=<strong>log2n</strong>,<br>          T(n)=O(<strong>log2n</strong> )</p><p><strong>(5)、O(n3)</strong> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;n;i++) &#123;    </div><div class="line">    <span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;i;j++) &#123;  </div><div class="line">        <span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;j;k++)  </div><div class="line">             x=x+<span class="number">2</span>;    </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>解：当i=m, j=k的时候,内层循环的次数为k当i=m时, j 可以取 0,1,…,m-1 , 所以这里最内循环共进行了0+1+…+m-1=(m-1)m/2次所以,i从0取到n, 则循环共进行了: 0+(1-1)<em>1/2+…+(n-1)n/2=n(n+1)(n-1)/6所以时间复杂度为O(<em>*n3</em></em>).</p><h2 id="常用的算法的时间复杂度和空间复杂度"><a href="#常用的算法的时间复杂度和空间复杂度" class="headerlink" title="常用的算法的时间复杂度和空间复杂度"></a>常用的算法的时间复杂度和空间复杂度</h2><p><img src="http://img.blog.csdn.net/20130920172327687?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvem9sYWxhZA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="img"></p><p><strong>一个经验规则：</strong>其中c是一个常量，如果一个算法的复杂度为c 、 <strong>log2n</strong> 、n 、 n<strong>*log2n</strong> ,那么这个算法时间效率比较高 ，如果是<strong>2n</strong> ,<strong>3n</strong> ,n!，那么稍微大一些的n就会令这个算法不能动了，居于中间的几个则差强人意。</p><p>算法时间复杂度分析是一个很重要的问题，任何一个程序员都应该熟练掌握其概念和基本方法，而且要善于从数学层面上探寻其本质，才能准确理解其内涵。</p><h1 id="算法的空间复杂度"><a href="#算法的空间复杂度" class="headerlink" title="算法的空间复杂度"></a>算法的空间复杂度</h1><p>类似于时间复杂度的讨论，一个算法的空间复杂度(Space Complexity)S(n)定义为该算法所耗费的存储空间，它也是问题规模n的函数。渐近空间复杂度也常常简称为空间复杂度。</p><p>空间复杂度(Space Complexity)是对一个算法在运行过程中临时占用存储空间大小的量度。一个算法在计算机存储器上所占用的存储空间，包括存储算法本身所占用的存储空间，算法的输入输出数据所占用的存储空间和算法在运行过程中临时占用的存储空间这三个方面。</p><p>算法的输入输出数据所占用的存储空间是由要解决的问题决定的，是通过参数表由调用函数传递而来的，它不随本算法的不同而改变。存储算法本身所占用的存储空间与算法书写的长短成正比，要压缩这方面的存储空间，就必须编写出较短的算法。算法在运行过程中临时占用的存储空间随算法的不同而异，有的算法只需要占用少量的临时工作单元，而且不随问题规模的大小而改变，我们称这种算法是“就地\”进行的，是节省存储的算法，如这一节介绍过的几个算法都是如此；有的算法需要占用的临时工作单元数与解决问题的规模n有关，它随着n的增大而增大，当n较大时，将占用较多的存储单元，例如将在第九章介绍的快速排序和归并排序算法就属于这种情况。</p><p>如当一个算法的空间复杂度为一个常量，即不随被处理数据量n的大小而改变时，可表示为O(1)；当一个算法的空间复杂度与以2为底的n的对数成正比时，可表示为0(10g2n)；当一个算法的空I司复杂度与n成线性比例关系时，可表示为0(n).若形参为数组，则只需要为它分配一个存储由实参传送来的一个地址指针的空间，即一个机器字长空间；若形参为引用方式，则也只需要为其分配存储一个地址的空间，用它来存储对应实参变量的地址，以便由系统自动引用实参变量。</p><p>【1】如果算法的执行时间不随着问题规模n的增加而增长，即使算法中有上千条语句，其执行时间也不过是一个较大的常数。此类算法的时间复杂度是O(1)。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">x=<span class="number">91</span>; y=<span class="number">100</span>;</div><div class="line"><span class="keyword">while</span>(y&gt;<span class="number">0</span>) <span class="keyword">if</span>(x&gt;<span class="number">100</span>) &#123;x=x<span class="number">-10</span>;y--;&#125; <span class="keyword">else</span> x++;</div></pre></td></tr></table></figure><p>解答： T(n)=O(1)，<br>这个程序看起来有点吓人，总共循环运行了1100次，但是我们看到n没有?<br>没。这段程序的运行是和n无关的，<br>就算它再循环一万年，我们也不管他，只是一个常数阶的函数</p><p>【2】当有若干个循环语句时，算法的时间复杂度是由嵌套层数最多的循环语句中最内层语句的频度f(n)决定的。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">x=<span class="number">1</span>; </div><div class="line"><span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=n;i++) </div><div class="line"></div><div class="line">        <span class="keyword">for</span>(j=<span class="number">1</span>;j&lt;=i;j++)</div><div class="line"></div><div class="line">           <span class="keyword">for</span>(k=<span class="number">1</span>;k&lt;=j;k++)</div><div class="line"></div><div class="line">               x++;</div></pre></td></tr></table></figure><p>该程序段中频度最大的语句是(5)，内循环的执行次数虽然与问题规模n没有直接关系，但是却与外层循环的变量取值有关，而最外层循环的次数直接与n有关，因此可以从内层循环向外层分析语句(5)的执行次数：  则该程序段的时间复杂度为T(n)=O(n3/6+低次项)=O(n3)</p><p>【3】算法的时间复杂度不仅仅依赖于问题的规模，还与输入实例的初始状态有关。</p><p>在数值A[0..n-1]中查找给定值K的算法大致如下：   </p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">i=n<span class="number">-1</span>;            </div><div class="line"><span class="keyword">while</span>(i&gt;=<span class="number">0</span>&amp;&amp;(A[i]!=k))       </div><div class="line">i--;        </div><div class="line"><span class="keyword">return</span> i;</div></pre></td></tr></table></figure><p>此算法中的语句(3)的频度不仅与问题规模n有关，还与输入实例中A的各元素取值及K的取值有关: ①若A中没有与K相等的元素，则语句(3)的频度f(n)=n； ②若A的最后一个元素等于K,则语句(3)的频度f(n)是常数0。</p><h1 id="时间复杂度评价性能"><a href="#时间复杂度评价性能" class="headerlink" title="时间复杂度评价性能"></a>时间复杂度评价性能</h1><p>有两个算法A1和A2求解同一问题，时间复杂度分别是T1(n)=100n2，T2(n)=5n3。</p><ol><li>当输入量n＜20时，有T1(n)＞T2(n)，后者花费的时间较少。</li><li>随着问题规模n的增大，两个算法的时间开销之比5n3/100n2=n/20亦随着增大。即当问题规模较大时，算法A1比算法A2要有效地多。它们的渐近时间复杂度O(n2)和O(n3)从宏观上评价了这两个算法在时间方面的质量。在算法分析时，往往对算法的时间复杂度和渐近时间复杂度不予区分，而经常是将渐近时间复杂度T(n)=O(f(n))简称为时间复杂度，其中的f(n)一般是算法中频度最大的语句频度。</li></ol>]]></content>
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>数据结构入门（01）：数组</title>
      <link href="/2018/05/01/1/"/>
      <content type="html"><![CDATA[<h1 id="数组基础"><a href="#数组基础" class="headerlink" title="数组基础"></a>数组基础</h1><p>数组其实就是把所有数据码成一排进行存放，数组对于每一门编程语言来说都是重要的数据结构之一，当然不同语言对数组的实现及处理也不尽相同。 在Java中数组所存放的类型是固定的，在 PHP 中数组是可以存储不同类型数据的。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20180626161609.png" alt=""></p><p>数组的元素是通过索引访问的。数组索引从 0 开始，所以索引值从 0 到 length - 1。</p><p>在这里我们需要<strong>注意</strong>，<strong>索引可以有语意；也可以没有语意</strong>。如上图，scores[2]这个索引2可以有实际的意义，上面的8个索引，可以代表八名学生的成绩，而索引可以代表他们的学号，那么scores[2]就是取2号学员的分数。</p><p>当我调用scores[2]的时候，我看的就是学号为2这个同学得了多少分，2是由实际的语意。当然也可以没有语意，这个0、1、2、3、4、5、6、7，只是简单的它存放在第几个元素而已，不代表学生的学号，就是恰好在2这个位置存了一个分，比如说是66分，存在任何索引的位置都可以，因为这个索引是没有语意的，我们只是想将分数存在数组中而已。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestArray</span> </span>&#123;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      <span class="comment">// 数组大小</span></div><div class="line">      <span class="keyword">int</span> size = <span class="number">8</span>;</div><div class="line">      <span class="comment">// 定义数组</span></div><div class="line">      <span class="keyword">double</span>[] scores = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">8</span>];</div><div class="line">      scores[<span class="number">0</span>] = <span class="number">55.6</span>;</div><div class="line">      scores[<span class="number">1</span>] = <span class="number">60.5</span>;</div><div class="line">      scores[<span class="number">2</span>] = <span class="number">30.3</span>;</div><div class="line">      scores[<span class="number">3</span>] = <span class="number">18.2</span>;</div><div class="line">      scores[<span class="number">4</span>] = <span class="number">43.0</span>;</div><div class="line">      scores[<span class="number">5</span>] = <span class="number">34.33</span>;</div><div class="line">      scores[<span class="number">6</span>] = <span class="number">34.0</span>;</div><div class="line">      scores[<span class="number">7</span>] = <span class="number">45.45</span>;</div><div class="line">      <span class="comment">// 计算所有元素的总和</span></div><div class="line">      <span class="keyword">double</span> total = <span class="number">0</span>;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">         total += scores[i];</div><div class="line">      &#125;</div><div class="line">      System.out.println(<span class="string">"总和为： "</span> + total);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>上面这段代码就是数组的操作，这里不再介绍其他语法，因为本文主要侧重于讲述数据结构，而不是Java的基础语法和使用。</p><p>数组最大的优点是快速查找，myList[2]，数组最好应用于“索引有语意”的情况。如果索引没有语义建议使用其他数据结构。</p><p>虽然如此，有很多场景即使我们可以给索引定义出语言，但是它可能并不适用使用数组，比如说身份证号，可以设计一个数组，存放一个人对应的工资情况，我想索引到不同的人，可能使用身份证号就是一个很好的方式。</p><p>身份证号：110103198512166666</p><p>但是我们不能使用身份证号做索引，因为这个数字太大了，我们要想使用这个数字当索引，我们至少要开辟身份证号那么大的空间，对于一般的计算机来说，开辟这么大的空间是不值当的，甚至是不可能的，更重要的是，我们就算开辟了这么大的空间，对于很多空间都是浪费的。</p><p>我们现在就要考察一个工作小组，里面只有十个人，为了十个人开辟这么大的空间显然是不合理的，很多空间明显是被浪费的，没有一个合法的身份证号是6666。</p><p>如果数组没有语意，又会产生很多新的问题。</p><p>在此时，数组只是一个待存放我们我们考察元素的一个空间，比如我们开辟了一个有八个元素的数组，但是可能我们只考察三个元素，此时就有问题了，剩下的空间就没有元素，当我们访问其余空间时就是非法的，因为从用户的角度来看，是没有3，4，5，6，7这些元素的，只有0、1、3，此时我们该如何表示没有的元素呢？</p><p>与此同时我们还会向数组中提那家元素和删除元素，这些操作要如何做呢？</p><p>还会有很多问题，最典型的就是我们的数组大小，在我们创建的时候就已经固定了，如果我们添加的元素，超过了八个我们要怎么做呢？</p><p>这篇文章就会解决这些问题，但是我们要知道 Java 并没有提供这些功能，我们必须编写属于自己的方法，来为数组添加元素或者删除元素。</p><p>所以我们要基于 Java 的数组，二次封装一个属于我们自己的数组类。</p><h1 id="封装属于我们自己的数组"><a href="#封装属于我们自己的数组" class="headerlink" title="封装属于我们自己的数组"></a>封装属于我们自己的数组</h1><p>原本的数组属于静态数组，而我们要制作的是动态数组。</p><p>创建一个 Array 类，在其中封装一个 Java 的数组 data，针对data 进行增删改查，其实对于对于数据结构跟数据库是一样的，也是存储数据，之后在进行高效的操作，只不过我们设计的数据结构是把这些数据存储在内存中，针对这些数据结构添加的的操作，在大的类别上也是增删改查。</p><p>不过针对不同的数据结构，增删改查的方式是截然不同的，有的数据结构会忽略其中的某一个动作。</p><p>由于数组本身是静态的，也就是在我们创建的时候，就必须指定大小，将其称之为容量（capactiy）也就是数组空间最多装多少个元素。</p><p>但是要注意，我们的数组最多装多少个元素，和我们实际的装了多少个元素是没有关系的，我们数组中实际装了多少个元素，在 Array 类中用 size 变量控制。</p><p>当没有元素时，size 为0，也相当于指向了第一个没有盛放元素的相应的索引也就是0这个位置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Array;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Array</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] data;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 构造函数，传入数组的容量 capactiy 构造 Array</div><div class="line"> * <span class="doctag">@param</span> capactiy</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Array</span><span class="params">(<span class="keyword">int</span> capactiy)</span> </span>&#123;</div><div class="line">data = <span class="keyword">new</span> <span class="keyword">int</span>[capactiy];</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 无参数构造函数，默认数组的容量10</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Array</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">this</span>(<span class="number">10</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取数组中元素的个数</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">return</span> size;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取数组的容量</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> data.length;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 返回数组是否为空</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> size == <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>将 data 和 size 封装成了私有成员，因为不希望用户从外部直接获得这些数据的信息，否则就是危险的，data和 size 就会产生不一致的情况，比如说 data 中实际有三个有效的元素，size 本来也是三，但是 size 是公有的，用户就可以随意更改，这就破坏了类的封装性，这样在写程序的过程中有可能会产生更多 bug。</p><h2 id="向数组添加元素"><a href="#向数组添加元素" class="headerlink" title="向数组添加元素"></a>向数组添加元素</h2><p>向数组添加元素，最简单的形式就是向数组的末尾添加一个元素。向数组末尾添加元素，就等同于向 size 添加元素。因为 size 指向的是第一个没有盛放元素所对应的索引，添加完成后我们需要维护 size，此时多了一个元素所以 size 应该++。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 向数组末尾添加元素</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLast</span><span class="params">(<span class="keyword">int</span> e)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (size == data.length) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"AddLast falid. Array is full"</span>);</div><div class="line">    &#125;</div><div class="line">data[size] = e;</div><div class="line">size++;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在添加元素时候，我们需要检查一下数组的容量，当 size 和 data 容量相等时，表明开辟的数组已经被沾满了，应该给予提示，不过在之后的章节中，我们会对其进行改写，让其实现动态的特性。</p><h2 id="向指定位置添加元素"><a href="#向指定位置添加元素" class="headerlink" title="向指定位置添加元素"></a>向指定位置添加元素</h2><p>我们希望能够维护数组中的元素，让着个数组中的元素都是有序排列的，在这样的情况下，我们就不能将每一个元素都放到最后，我们需要将元素插入到指定的位置。</p><p>如果我们希望将一个元素插入到1的位置上，我们只需要将数组中的元素都向后挪一个位置。</p><p>再具体操作之后，我们需要从最后面的元素开始移动，否则的话，我们就会将其后面的元素覆盖掉了。</p><p>操作完成后，不要忘了维护 size，我们需要++。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 向指定位置插入元素</div><div class="line">* <span class="doctag">@param</span> index 位置</div><div class="line">* <span class="doctag">@param</span> e   元素</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> e)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (size == data.length) </div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"AddLast falid. Array is full"</span>);</div><div class="line"></div><div class="line">    <span class="comment">//index 必须为合法的</span></div><div class="line"><span class="comment">//如果 index 最大是取 size, 在这样的情况下，就相当于向所有的元素后面再添加一个元素</span></div><div class="line"><span class="comment">//如果 index 比 size 还大，说明元素不是紧密排列的，中间存在一些不是合法的元素</span></div><div class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"AddLast falid. Require index &gt;= - and index &lt;= size"</span>);  &#125;</div><div class="line"></div><div class="line"><span class="comment">//后移元素</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt;= index; i--) &#123;</div><div class="line">data [i + <span class="number">1</span>] = data[i];</div><div class="line">&#125;</div><div class="line">data[index] = e;</div><div class="line">size++;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>当我们编写好INSERT方法后，其实 addlast 可以复用insert 方法，并且通过该方法，还可以写出向首位添加元素的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 向数组末尾添加元素</div><div class="line">* <span class="doctag">@param</span> e</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLast</span><span class="params">(<span class="keyword">int</span> e)</span></span></div><div class="line">&#123;</div><div class="line">    insert(size, e);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* 想数组首位置添加元素</div><div class="line">* <span class="doctag">@param</span> e</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFirst</span><span class="params">(<span class="keyword">int</span> e)</span> </span>&#123;</div><div class="line">    insert(<span class="number">0</span> ,e);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="在数组中查询和修改元素"><a href="#在数组中查询和修改元素" class="headerlink" title="在数组中查询和修改元素"></a>在数组中查询和修改元素</h2><p>对于我们封装的数组而言，真正的数组是存储在我们静态数组data 中，我们可以非常方便的在<code>[]</code>中插入索引的方式直接取值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取index 索引的元素</div><div class="line"> * <span class="doctag">@param</span> index</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> int get(int index) &#123;</div><div class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Get failed, Index is illegal."</span>);</div><div class="line">    &#125;</div><div class="line"><span class="keyword">return</span> data[index];</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* 修改 index 位置的元素</div><div class="line">* <span class="doctag">@param</span> index</div><div class="line">* <span class="doctag">@param</span> e</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> void set(int index, int e) &#123;</div><div class="line">    <span class="comment">//确保了用户永远无法查询没有使用的空间。</span></div><div class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Get failed, Index is illegal."</span>);</div><div class="line">&#125;</div><div class="line">    data[index] = e;</div><div class="line"> &#125;</div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> String toString() &#123;</div><div class="line">    StringBuilder res = <span class="keyword">new</span> StringBuilder();</div><div class="line">    res.append(String.format(<span class="string">"Array Szie = %d, capactiy = %d"</span>, size, data.length));</div><div class="line">res.append(<span class="string">'['</span>);</div><div class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">        res.append(data[i]);</div><div class="line">        <span class="keyword">if</span> (i != size <span class="number">-1</span>) &#123;</div><div class="line">            res.append(<span class="string">","</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">    res.append(<span class="string">']'</span>);</div><div class="line"><span class="keyword">return</span> re;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="包含、搜索和删除"><a href="#包含、搜索和删除" class="headerlink" title="包含、搜索和删除"></a>包含、搜索和删除</h2><p>检测是否包含很简单，只需要遍历我们的数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 检测是否包含元素</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contians</span><span class="params">(<span class="keyword">int</span> e)</span> </span>&#123;</div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">         <span class="keyword">if</span> (data[i] == e) &#123;</div><div class="line"> <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"> * 查找数组元素e 所在的索引，如果不存在元素e,则返回-1</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> e)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (data[i] == e) &#123;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure><p>删除索引很简单，与我们插入相反，他是从后向前移动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 从数组删除元素，并且返回删除的元素</div><div class="line"> * <span class="doctag">@param</span> index</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Remove failed, Index is illegal."</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">int</span> ret = data[index];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index + <span class="number">1</span>; i &lt; size; i++ ) &#123;</div><div class="line">data[i - <span class="number">1</span>] = data[i];</div><div class="line">    &#125;</div><div class="line">size--;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>同时我们可以添加删除首位置和末尾的元素</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 删除第一个元素，并且返回被删除的元素</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">removeFirst</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ret = remove(<span class="number">0</span>);</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 删除最后一个元素，并且返回被删除的元素</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">removeLast</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ret = remove(size-<span class="number">1</span>);</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 从数组中删除元素e</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeElement</span><span class="params">(<span class="keyword">int</span> e)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> index = find(e);</div><div class="line">    <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</div><div class="line">remove(index);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="使用泛型优化数组"><a href="#使用泛型优化数组" class="headerlink" title="使用泛型优化数组"></a>使用泛型优化数组</h2><p>现在对于我们的数组，存在最大的问题就是只支持 Int 类型，但是实际上数组类作为存放数据的容器，应该盛放任意类型的数据。</p><p>泛型不可以是基本类型，只能是类的对象。</p><p>Java 的基本类型：</p><ul><li>boolean</li><li>byte</li><li>char</li><li>short</li><li>int </li><li>long </li><li>float</li><li>double</li></ul><p>如果将我们的数组设置为泛型，就不能放置这些基本类型了。Java 为每个基础类型都有对应的包装类。</p><ul><li>Boolean</li><li>Byte</li><li>Char</li><li>Short</li><li>Int</li><li>Long</li><li>Float</li><li>Double</li></ul><p>其实就是 Java 对基本类型的封装，两者之间可以无缝的进行转换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Array;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Array</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> T[] data;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 构造函数，传入数组的容量 capactiy 构造 Array</div><div class="line"> * <span class="doctag">@param</span> capactiy</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Array</span><span class="params">(<span class="keyword">int</span> capactiy)</span> </span>&#123;</div><div class="line">data = (T[])<span class="keyword">new</span> Object[capactiy];</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 无参数构造函数，默认数组的容量10</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Array</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">this</span>(<span class="number">10</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取数组中元素的个数</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">return</span> size;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取数组的容量</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> data.length;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 返回数组是否为空</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> size == <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 向数组末尾添加元素</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLast</span><span class="params">(T e)</span></span></div><div class="line">&#123;</div><div class="line">insert(size, e);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 想数组首位置添加元素</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFirst</span><span class="params">(T e)</span> </span>&#123;</div><div class="line">insert(<span class="number">0</span> ,e);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 向指定位置插入元素</div><div class="line"> * <span class="doctag">@param</span> index 位置</div><div class="line"> * <span class="doctag">@param</span> e元素</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> index,  T e)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">if</span> (size == data.length) </div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"AddLast falid. Array is full"</span>);</div><div class="line"></div><div class="line"><span class="comment">//index 必须为合法的</span></div><div class="line"><span class="comment">//如果 index 最大是取 size, 在这样的情况下，就相当于向所有的元素后面再添加一个元素</span></div><div class="line"><span class="comment">//如果 index 比 size 还大，说明元素不是紧密排列的，中间存在一些不是合法的元素</span></div><div class="line"><span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"AddLast falid. Require index &gt;= 0 and index &lt;= size"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//后移元素</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt;= index; i--) &#123;</div><div class="line">data [i + <span class="number">1</span>] = data[i];</div><div class="line">&#125;</div><div class="line">data[index] = e;</div><div class="line">size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * 获取index 索引的元素</div><div class="line">  * <span class="doctag">@param</span> index</div><div class="line">  * <span class="doctag">@return</span></div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line"> <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Get failed, Index is illegal."</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> data[index];</div><div class="line">&#125;</div><div class="line"> <span class="comment">/**</span></div><div class="line">  * 修改 index 位置的元素</div><div class="line">  * <span class="doctag">@param</span> index</div><div class="line">  * <span class="doctag">@param</span> e</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, T e)</span></span></div><div class="line"> &#123;</div><div class="line"> <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Get failed, Index is illegal."</span>);</div><div class="line"> &#125;</div><div class="line"> data[index] = e;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * 检测是否包含元素</div><div class="line">  * <span class="doctag">@param</span> e</div><div class="line">  * <span class="doctag">@return</span></div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contians</span><span class="params">(T e)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">   <span class="keyword">if</span> (data[i].equals(e)) &#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">/**</span></div><div class="line">  * 查找数组元素e 所在的索引，如果不存在元素e,则返回-1</div><div class="line">  * <span class="doctag">@param</span> e</div><div class="line">  * <span class="doctag">@return</span></div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(T e)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">   <span class="keyword">if</span> (data[i].equals(e)) &#123;</div><div class="line">   <span class="keyword">return</span> i;</div><div class="line">   &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">/**</span></div><div class="line">  * 从数组删除元素，并且返回删除的元素</div><div class="line">  * <span class="doctag">@param</span> index</div><div class="line">  * <span class="doctag">@return</span></div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Remove failed, Index is illegal."</span>);</div><div class="line">&#125;</div><div class="line">T ret = data[index];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = index + <span class="number">1</span>; i &lt; size; i++ ) &#123;</div><div class="line">data[i - <span class="number">1</span>] = data[i];</div><div class="line">&#125;</div><div class="line">size--;</div><div class="line">         data[size] == <span class="keyword">null</span>;</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 删除第一个元素，并且返回被删除的元素</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">removeFirst</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">T ret = remove(<span class="number">0</span>);</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 删除最后一个元素，并且返回被删除的元素</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">removeLast</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">T ret = remove(size-<span class="number">1</span>);</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 从数组中删除元素e</div><div class="line"> * <span class="doctag">@param</span> e</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeElement</span><span class="params">(T e)</span> </span>&#123;</div><div class="line"><span class="keyword">int</span> index = find(e);</div><div class="line"><span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</div><div class="line">remove(index);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/***</span></div><div class="line"> * 打印输出数组</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">StringBuilder res = <span class="keyword">new</span> StringBuilder();</div><div class="line">res.append(String.format(<span class="string">"Array Szie = %d, capactiy = %d"</span>, size, data.length));</div><div class="line">res.append(<span class="string">'['</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">res.append(data[i]);</div><div class="line"><span class="keyword">if</span> (i != size -<span class="number">1</span>) &#123;</div><div class="line">res.append(<span class="string">","</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">res.append(<span class="string">']'</span>);</div><div class="line"><span class="keyword">return</span> res.toString();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在这里需要注意的是，比较==运算进行了替换<code>equals</code>，那是因为<code>==</code>是值比较，而现在泛型比较的是对象，所以需要引用比较。</p><p>在 remove 代码中，可以看到最后有一行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data[size] == <span class="keyword">null</span>;</div></pre></td></tr></table></figure><p>当我们使用泛型时，data 数组中存储的都是对象的引用，在这种情况下，删除了一个元素之后，此时的 data[size]还指着一个引用，在 Java中有一个垃圾回收技术，不过如果我们的 data[‘size’] 还存在引用的话，就不会被回收，将其值设置成 NULL 后对象就没有引用了，就会被自动回收。</p><p>其实在我们使用这个数组的时候，再添加一个新的元素，那么 data[size]指向的对象就会换成一个新的引用，原来的值就会被清理掉，对于这种对象有一个术语<code>loitering objects</code>，这个时候这个对象还在我们的系统中游荡，垃圾回收机制并不能把它回收，但是他已经没有用了，但是需要注意<code>loitering objects</code>的存在并不等于内存泄漏，只是为了程序的优化，如果能手动的把<code>loitering objects</code>给去除更好。</p><p>如果不写这段代码也是没有问题的。</p><h2 id="动态数组"><a href="#动态数组" class="headerlink" title="动态数组"></a>动态数组</h2><p>现在我们实现的数组内部使用的还是 Java 为我们提供的静态数组，容量是有限的，可是很多时候，我们使用的数组类无法实现预估，不知道要放入多少个元素进我们的数组，在这种情况下，容量开的太大的话就会浪费很多空间，如果太小最后空间不够用，这种情况下，我们需要一种方案解决数组的容量是可伸缩的，也就是所谓的动态数组。</p><p>假设现在数组只有4个元素，并且现在4个元素已经装满了，现在向数组中再添加一个元素的话，显然是做不到的，会抛出异常。</p><p>我们首先再开创一个新的数组newData，newData 的空间要比原来的数组空间大一些，比如之前数组是4个元素，那么 newData 就开辟8个空间，然后将 data 中的数据放置到 newData 中。</p><p>其实就是使用 newData 取代 data。</p><p>在程序实现过程中，data 是一个引用，我们改变 data 的引用指向newData。</p><p>对于 newData 而言，在函数执行完成之后就会失效，但是 data 是成员变量，它的生命周期和类是一样的，只要类还在使用 data 的指向就是 newData 的空间。</p><p>只有4个元素的数组，由于没有变量指向它，就会被回收掉。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 向指定位置插入元素</div><div class="line"> * <span class="doctag">@param</span> index 位置</div><div class="line"> * <span class="doctag">@param</span> e元素</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> index,  T e)</span></span>&#123;</div><div class="line">    <span class="comment">//index 必须为合法的</span></div><div class="line"><span class="comment">//如果 index 最大是取 size, 在这样的情况下，就相当于向所有的元素后面再添加一个元素</span></div><div class="line">    <span class="comment">//如果 index 比 size 还大，说明元素不是紧密排列的，中间存在一些不是合法的元素</span></div><div class="line"><span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"AddLast falid. Require index &gt;= 0 and index &lt;= size"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (size == data.length) </div><div class="line">        resize(<span class="number">2</span> * data.length);</div><div class="line"><span class="comment">//后移元素</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt;= index; i--) &#123;</div><div class="line">        data [i + <span class="number">1</span>] = data[i];</div><div class="line">&#125;</div><div class="line">data[index] = e;</div><div class="line">    size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> capactiy)</span> </span>&#123;</div><div class="line">    T[] newData = (T[])<span class="keyword">new</span> Object[capactiy];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">        newData[i] = data[i];</div><div class="line">&#125;</div><div class="line">    data = newData;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">resize(<span class="number">2</span> * data.length);</div></pre></td></tr></table></figure><p>在扩容时候，我将其设置成了原有数组的二倍，在这里主要是不希望比原来的 data.length 再加上一个常数，扩容的大小到底取多少，其实很难判断，如果每一次只扩容十个空间，假设当前数组有一个10000元素了，然后我们扩容成10010个，很有可能我们的这个扩容是比较低效的，因为现在的数组装10000个数组已经装满了，又有新的元素来了，很有可能还会来新的元素，如果我们再次加入1000个元素，那么就需要扩容100次，这样的性能消耗实在是太大了。</p><p>如果每次都扩容1000个容量，但是这样做也有问题，如果当前整个数组只有10个的话，一次性扩容1000个空间，那么很大的概率大部分空间会被浪费掉。</p><p>现在2 * data.length 就是根据当前数组有多少容量是相关的，扩容的量是跟当前数组已经有用的容量是在一个数量级的，那么我当前有100元素，就给他扩容到200。</p><p>其实将其设置成2或者是3都是完全可以的，这只是一个参数选择上的问题，在 Java 中 ArrayList 的实现中这个参数选择的是1.5。</p><p>相对于扩容来说，同理在我们从元素中删除元素的时候，为了节省空间，我们也可以设置当删除到一定程度的时候，我们整个数组的容量进行一下缩小。</p><p>我们可以通过 resize 函数实现这个功能，对 remove 函数进行修改，如果是数组容积的二分之一的时候，我们就可以 resize。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 从数组删除元素，并且返回删除的元素</div><div class="line"> * <span class="doctag">@param</span> index</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; size) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Remove failed, Index is illegal."</span>);</div><div class="line">&#125;</div><div class="line">     T ret = data[index];</div><div class="line">     </div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = index + <span class="number">1</span>; i &lt; size; i++ ) &#123;</div><div class="line">     data[i - <span class="number">1</span>] = data[i];</div><div class="line">     &#125;</div><div class="line">     size--;</div><div class="line">     data[size] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (size == data.length / <span class="number">2</span>) &#123;</div><div class="line">resize(data.length /<span class="number">2</span>);</div><div class="line">     &#125;</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>此时，我们就实现了一个真正意义上的动态数组。不过在真正意义上还不够完善，因为在删除元素时候，存在一个问题，如果我们要删除数组中的 ‘E’，当找到第一个 ‘E’的时候，程序删除掉就会停止执行，这个时候在后面的元素中也有可能会存在’E’，所以为了程序更加完善可以在添加一个删除所有，同时查找元素也存在这一问题。</p>]]></content>
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Linux典型应用实践：NFS共享文件</title>
      <link href="/2018/04/12/2/"/>
      <content type="html"><![CDATA[<h1 id="为什么要用NFS"><a href="#为什么要用NFS" class="headerlink" title="为什么要用NFS"></a>为什么要用NFS</h1><p>NFS（Network File System）网络文件系统，由 SUN 公司开发，是FreeBSD支持的文件系统中的一种，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。</p><p>简单的来说：它就是是可以透过网络，让不同的主机、不同的操作系统可以共享存储。</p><p>以下是NFS最显而易见的好处：</p><ol><li>节省本地存储空间，将常用的数据存放在一台NFS服务器上且可以通过网络访问，那么本地终端将可以减少自身存储空间的使用。</li><li>用户不需要在网络中的每个机器上都建有Home目录，Home目录可以放在NFS服务器上且可以在网络上被访问使用。</li><li>一些存储设备CDROM和Zip（一种高储存密度的磁盘驱动器与磁盘）等都可以在网络上被别的机器使用。这可以减少整个网络上可移动介质设备的数量。</li></ol><p>NFS 的基本原则是“容许不同的客户端及服务端通过一组RPC分享相同的文件系统”，它是独立于操作系统，容许不同硬件及操作系统的系统共同进行文件的分享。</p><p>NFS在文件传送或信息传送过程中依赖于RPC协议。RPC，远程过程调用 (Remote Procedure Call) 是能使客户端执行其他系统中程序的一种机制。NFS本身是没有提供信息传输的协议和功能的，但NFS却能让我们通过网络进行资料的分享，这是因为NFS使用了一些其它的传输协议。而这些传输协议用到这个RPC功能的。</p><p>可以说NFS本身就是使用RPC的一个程序。或者说NFS也是一个RPC SERVER。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责负责信息的传输。</p><h1 id="NSF-的工作流程"><a href="#NSF-的工作流程" class="headerlink" title="NSF 的工作流程"></a>NSF 的工作流程</h1><ol><li>由程序在NFS客户端发起存取文件的请求，客户端本地的RPC(rpcbind)服务会通过网络向NFS服务端的RPC的111端口发出文件存取功能的请求。</li><li>NFS服务端的RPC找到对应已注册的NFS端口，通知客户端RPC服务。</li><li>客户端获取正确的端口，并与NFS daemon联机存取数据。</li><li>存取数据成功后，返回前端访问程序，完成一次存取操作。</li></ol><h1 id="CentOS-7搭建NFS服务器实例"><a href="#CentOS-7搭建NFS服务器实例" class="headerlink" title="CentOS 7搭建NFS服务器实例"></a>CentOS 7搭建NFS服务器实例</h1><table><thead><tr><th style="text-align:center">服务器系统</th><th style="text-align:center">角色</th><th style="text-align:center">IP</th></tr></thead><tbody><tr><td style="text-align:center">CentOS 7</td><td style="text-align:center">Server</td><td style="text-align:center">192.168.0.100</td></tr><tr><td style="text-align:center">CentOS 7</td><td style="text-align:center">Client</td><td style="text-align:center">192.168.0.101</td></tr></tbody></table><p><strong>1、因是测试环境，先关闭selinux和firewalld</strong></p><p>关闭selinux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# sed -i s#SELINUX=enforcing#SELINUX=disabled#g /etc/selinux/config</div></pre></td></tr></table></figure><p>停止防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# systemctl stop firewalld.service</div></pre></td></tr></table></figure><p><strong>2、服务器部署</strong></p><p>1）检查系统版本及NFS服务nfs-utils 和rpcbind有没有安装 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# cat /etc/redhat-release #查看系统版本</div><div class="line">CentOS Linux release 7.5.1804 (Core)</div><div class="line">[root@service ~]# uname -r #查看系统内核版本</div><div class="line">3.10.0-862.el7.x86_64</div><div class="line">[root@servicer ~]# uname -m #查看系统是否64位</div><div class="line">x86_64</div><div class="line">[root@service ~]# rpm -qa nfs-utils rpcbind #检查安装的软件包</div><div class="line">rpcbind-0.2.0-44.el7.x86_64</div><div class="line">nfs-utils-1.3.0-0.54.el7.x86_64</div></pre></td></tr></table></figure><p>2）如果没有安装在系统中通过yum 命令进行安装以上两个包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# yum install -y nfs-utils rpcbind #安装上述所需的两个软件包</div></pre></td></tr></table></figure><p>3）启动rpcbind服务（<strong>一定要先启动rpcbind服务再启动nfs服务</strong>,由于在NFS服务过程中，必须先启动rpcbind，再启动nfs，这样才能让NFS在rpcbind上注册成功) </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@service ~]#  systemctl start rpcbind  #启动</div><div class="line">[root@service ~]#  systemctl status rpcbind  #查看状态</div><div class="line">● rpcbind.service - RPC bind service</div><div class="line">   Loaded: loaded (/usr/lib/systemd/system/rpcbind.service; enabled; vendor preset: enabled)</div><div class="line">   Active: active (running) since 三 2018-06-27 16:02:27 CST; 29s ago</div><div class="line">  Process: 1577 ExecStart=/sbin/rpcbind -w $RPCBIND_ARGS (code=exited, status=0/SUCCESS)</div><div class="line"> Main PID: 1578 (rpcbind)</div><div class="line">   CGroup: /system.slice/rpcbind.service</div><div class="line">           └─1578 /sbin/rpcbind -w</div><div class="line"></div><div class="line">6月 27 16:02:27 bogon systemd[1]: Starting RPC bind service...</div><div class="line">6月 27 16:02:27 bogon systemd[1]: Started RPC bind service.</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# lsof -i :111  #查询rpcbind监听状态 (111是rpcbind的主端口)</div><div class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</div><div class="line">rpcbind 1578  rpc    6u  IPv4  19786      0t0  UDP *:sunrpc</div><div class="line">rpcbind 1578  rpc    8u  IPv4  19788      0t0  TCP *:sunrpc (LISTEN)</div><div class="line">rpcbind 1578  rpc    9u  IPv6  19789      0t0  UDP *:sunrpc</div><div class="line">rpcbind 1578  rpc   11u  IPv6  19791      0t0  TCP *:sunrpc (LISTEN)</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# netstat -lntup |grep rpcbind #查询rpcbind服务启动状态 (同lsof查询端口效果一样)</div><div class="line">tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1578/rpcbind</div><div class="line">tcp6       0      0 :::111                  :::*                    LISTEN      1578/rpcbind</div><div class="line">udp        0      0 0.0.0.0:905             0.0.0.0:*                           1578/rpcbind</div><div class="line">udp        0      0 0.0.0.0:111             0.0.0.0:*                           1578/rpcbind</div><div class="line">udp6       0      0 :::905                  :::*                                1578/rpcbind</div><div class="line">udp6       0      0 :::111                  :::*                                1578/rpcbind</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# rpcinfo -p localhost#查看nfs服务向rpc注册的端 口信息</div><div class="line">program vers proto   port  service</div><div class="line">    100000    4   tcp    111  portmapper</div><div class="line">    100000    3   tcp    111  portmapper</div><div class="line">    100000    2   tcp    111  portmapper</div><div class="line">    100000    4   udp    111  portmapper</div><div class="line">    100000    3   udp    111  portmapper</div><div class="line">    100000    2   udp    111  portmapper</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# systemctl list-unit-files | grep rpcbind #检查rpcbind自启动情况</div><div class="line">rpcbind.service                               enabled</div><div class="line">rpcbind.socket                                enabled</div><div class="line">rpcbind.target                                static</div></pre></td></tr></table></figure><p>如果rpcbind.service不是enable将其加入自启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# systemctl enable rpcbind.service</div></pre></td></tr></table></figure><p>4）启动NFS服务并查看其状态 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# systemctl start nfs #启动NFS</div><div class="line">[root@service ~]# systemctl status nfs #查看NFS</div><div class="line">● nfs-server.service - NFS server and services</div><div class="line">   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)</div><div class="line">   Active: active (exited) since 三 2018-06-27 16:15:44 CST; 30s ago</div><div class="line">  Process: 9397 ExecStart=/usr/sbin/rpc.nfsd $RPCNFSDARGS (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 9392 ExecStartPre=/bin/sh -c /bin/kill -HUP `cat /run/gssproxy.pid` (code=exited, status=0/SUCCESS)</div><div class="line">  Process: 9391 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=0/SUCCESS)</div><div class="line"> Main PID: 9397 (code=exited, status=0/SUCCESS)</div><div class="line">   CGroup: /system.slice/nfs-server.service</div><div class="line"></div><div class="line">6月 27 16:15:44 bogon systemd[1]: Starting NFS server and services...</div><div class="line">6月 27 16:15:44 bogon systemd[1]: Started NFS server and services.</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@NFS-server ~]# netstat -lntup|grep nfs #查看NFS端口启动(FNS默认端口为2049)</div><div class="line">[root@NFS-server ~]# lsof -i :2049 #查看NFS端口启动(FNS默认端口为2049)</div><div class="line">[root@NFS-server ~]# netstat -lntup|grep 2049 #查看NFS端口启动(FNS默认端口为2049)</div><div class="line">tcp        0      0 0.0.0.0:2049            0.0.0.0:*               LISTEN      -</div><div class="line">tcp6       0      0 :::2049                 :::*                    LISTEN      -</div><div class="line">udp        0      0 0.0.0.0:2049            0.0.0.0:*                           -</div><div class="line">udp6       0      0 :::2049                 :::*                                -</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@NFS-server ~]# rpcinfo -p localhost #启动NFS过后rpcbind服务已经启用了对FNS的端口映射</div></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@NFS-server ~]# systemctl list-unit-files | grep nfs  #查看nfs的开机自启动情况</div><div class="line">proc-fs-nfsd.mount                            static</div><div class="line">var-lib-nfs-rpc_pipefs.mount                  static</div><div class="line">nfs-blkmap.service                            disabled</div><div class="line">nfs-config.service                            static</div><div class="line">nfs-idmap.service                             static</div><div class="line">nfs-idmapd.service                            static</div><div class="line">nfs-lock.service                              static</div><div class="line">nfs-mountd.service                            static</div><div class="line">nfs-rquotad.service                           disabled</div><div class="line">nfs-secure.service                            static</div><div class="line">nfs-server.service                            disabled</div><div class="line">nfs-utils.service                             static</div><div class="line">nfs.service                                   disabled</div><div class="line">nfslock.service                               static</div><div class="line">nfs-client.target                             enabled</div><div class="line">[root@NFS-server ~]# systemctl enable nfs #让FNS开机自启动</div></pre></td></tr></table></figure><p>5）授权nfsnobody于/data/bbs让客户端挂载后可写可读</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@service /]# chown nfsnobody:nfsnobody /data/bbs</div></pre></td></tr></table></figure><p>6）创建测试目录及文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# mkdir /data/bbs -p</div><div class="line">[root@service ~]# mkdir /data/bbs/test.txt</div></pre></td></tr></table></figure><p>7）配置NFS服务的export文件 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# echo "/data/bbs/ 192.168.0.0/24(rw,sync,root_squash)"&gt;&gt;/etc/exports</div></pre></td></tr></table></figure><p>重新加载nfs配置文件 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# exportfs -rv</div><div class="line">exporting 192.168.0.0/24:/data/bbs</div></pre></td></tr></table></figure><p>exportfs：NFS服务端发布共享控制命令。 </p><ul><li>-r：表示重新刷新共享</li><li>-a：表示将配置文件/etc/exports中的所有定义共享发布出去。</li><li>-v：显示确认共享设置</li><li>-u：表示不发布共享</li></ul><p>查看nfs服务器挂载情况 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@service ~]# showmount -e localhost</div><div class="line">Export list for localhost:</div><div class="line">/data/bbs 192.168.10.1/24</div></pre></td></tr></table></figure><ul><li>ro：目录只读</li><li>rw：目录读写</li><li>sync：将数据同步写入内存缓冲区与磁盘中，效率低，但可以保证数据的一致性</li><li>async：将数据先保存在内存缓冲区中，必要时才写入磁盘</li><li>all_squash：将远程访问的所有普通用户及所属组都映射为匿名用户或用户组(nfsnobody)</li><li>no_all_squash：与all_squash取反(默认设置)</li><li>root_squash：将root用户及所属组都映射为匿名用户或用户组(默认设置)</li><li>no_root_squash：与rootsquash取反</li><li>anonuid=xxx：将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户(UID=xxx)</li><li>anongid=xxx：将远程访问的所有用户组都映射为匿名用户组账户</li></ul><p><strong>3、客户端配置</strong> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# yum install nfs-utils rpcbind</div></pre></td></tr></table></figure><p>把rpcbind加入开机自启动 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]# systemctl enable rpcbind.service</div></pre></td></tr></table></figure><p>创建测试目录文件 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# mkdir /data/bbs/ -p</div></pre></td></tr></table></figure><p>扫描NFS服务器的文件共享列表 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]# showmount -e 192.168.0.100</div><div class="line">Export list for 192.168.0.100:</div><div class="line">/data/bbs 192.168.0.100/24</div></pre></td></tr></table></figure><p>把服务器的目录挂载到客户端 的目录下 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# mount -t nfs -o noexec,nosuid,nodev,rw,rsize=65536,wsize=65536 192.168.10.150:/data/bbs /data/bbs</div><div class="line">[root@localhost ~]# df -h</div><div class="line">文件系统                 容量  已用  可用 已用% 挂载点</div><div class="line">/dev/mapper/centos-root  6.2G  1.1G  5.1G   18% /</div><div class="line">devtmpfs                 485M     0  485M    0% /dev</div><div class="line">tmpfs                    496M     0  496M    0% /dev/shm</div><div class="line">tmpfs                    496M  6.8M  490M    2% /run</div><div class="line">tmpfs                    496M     0  496M    0% /sys/fs/cgroup</div><div class="line">/dev/sda1               1014M  129M  886M   13% /boot</div><div class="line">tmpfs                    100M     0  100M    0% /run/user/0</div><div class="line">192.168.0.100:/data/bbs  6.2G  1.1G  5.1G   18% /data/bbs</div></pre></td></tr></table></figure><h1 id="数据测试"><a href="#数据测试" class="headerlink" title="数据测试"></a>数据测试</h1><p>Service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@service /]# cd /data/bbs</div><div class="line">[root@service bbs]# touch a.txt</div></pre></td></tr></table></figure><p>Client</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# ls /data/bbsa.txt</div></pre></td></tr></table></figure><p>提示:  </p><ol><li>配置NFS服务端后，不用重启NFS服务，只要使用exportfs -rv           </li><li>rpc主程序Centos5.8下为portmap 、Centos6.4和Centos7下为rpcbind          </li><li>NFS共享目录不要授权于777权限，可以改所属主和组为nfsnobody，因为nfsnobody权限不是很大，也不能登陆 </li></ol><h1 id="配置客户端-开机自动挂载NFS共享目录"><a href="#配置客户端-开机自动挂载NFS共享目录" class="headerlink" title="配置客户端 开机自动挂载NFS共享目录"></a>配置客户端 开机自动挂载NFS共享目录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# chmod +x /etc/rc.d/rc.local     #centos7需要给rc.local赋予执行权限后，rc.local文件才能生效</div><div class="line">[root@localhost ~]# echo "mount -t nfs -o noexec,nosuid,nodev,rw,rsize=65536,wsize=65536 192.168.10.150:/data/bbs /data/bbs"&gt;&gt;/etc/rc.local</div><div class="line">[root@localhost ~]# cat /etc/rc.local</div><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line"><span class="meta">#</span> THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES#</div><div class="line"><span class="meta">#</span> It is highly advisable to create own systemd services or udev rules</div><div class="line"><span class="meta">#</span> to run scripts during boot instead of using this file.#</div><div class="line"><span class="meta">#</span> In contrast to previous versions due to parallel execution during boot</div><div class="line"><span class="meta">#</span> this script will NOT be run after all other services.#</div><div class="line"><span class="meta">#</span> Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</div><div class="line"><span class="meta">#</span> that this script will be executed during boot.</div><div class="line"> </div><div class="line">mount -t nfs -o noexec,nosuid,nodev,rw,rsize=65536,wsize=65536 192.168.10.150:/data/bbs /data/bbs</div></pre></td></tr></table></figure><h1 id="客户端mount挂载优化"><a href="#客户端mount挂载优化" class="headerlink" title="客户端mount挂载优化"></a>客户端mount挂载优化</h1><p>在企业生产环境中，NFS客户端挂载的参数有noexec、nosuid、nodev、noatime、rsize、wsize、nodiratime等，</p><p> 一般来说，NFS服务器共享的只是普通静态数据（图片、附件、视频），不需要执行suid、exec等权限，挂载的这个文件系统只能作为数据存取之用，无法执行程序，对于客户端来讲增加了安全性，例如：很多<em>*</em>修改站点文件都是由上传入口上传的程序存储目录，然后执行，因此在挂载时，用下面的命令是有必要的，</p><p>普遍安全挂载参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -t nfs -o nosuid,noexec,nodev,rw 192.168.10.150:/data/bbs /data/bbs</div></pre></td></tr></table></figure><p>挂载的读写缓存</p><p>wsize和rsize写和读缓存</p><p>wsize和rsize的最大值</p><p>NFSV2   rsize=8192 wsize=8192</p><p>NFSV3   rsize=32768 wsize=32768</p><p>NFSV4   rsize=65536 wsize=65536</p><p>现在一般centos5.8以上的系统都己经增加了读写缓存，如需修改可以加以上参数</p><p>例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -t nfs -o noexec,nosuid,nodev,rw,rsize=65536,wsize=65536 192.168.10.150:/data/bbs /data/bbs</div></pre></td></tr></table></figure><p>mount的一些常用挂载优化参数：</p><ul><li><p>wsize和rsize写和读缓存</p></li><li><p>async     数据不同步写到磁盘，提高性参，但降低数据安全，不推荐使用</p></li><li>noatime和nodiratime  这两个选是说在读写磁盘时，不更新文件和目录的时间戳，而更新文件时间戳对于工作数据必要性不大，增加了磁盘IO的次数，拖慢系统性参，</li><li>defaults   这个缺省值包括rw,suid,dev,exec,auto,nouser,and async  cat /etc/fstab的结果默认大部人都是缺省值</li><li>noauto    不会自动挂载文件系统</li><li>noexec    不允许安装的直接执行任何二进制文件</li><li>ro         挂载一个只读文件系统</li><li>rw        挂载一个可写的文件系统</li><li>sync       把数据同步写入硬盘</li><li>nosuid     不允许设置用户标识或设置组标识符位</li><li>nodev      不解释字符或文件块特殊设备</li><li><p>intr       表示可以中断</p><p>企业生产环境中nfs性参优化挂载例子：</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mount -t nfs -o noatime,nodiratime 192.168.10.150:/data/bbs /data/bbs</div><div class="line">mount -t nfs -o nosuid,noexec,nodev,noatime,nodiratime,intr,rsize=65536,wsize=65536 192.168.10.150:/data/bbs /data/bbs</div></pre></td></tr></table></figure><p>如果是本地系统：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -o defaults,async,noatime,data=writeback,barrier=0 /dev/sdb1 /mnt</div></pre></td></tr></table></figure><p>data=writeback,barrier=0 是日志文件系统的优化</p><p>提示：本地文件系统挂载如果加nodiratime会报错，</p><h1 id="加优化参数和不加的数据写入测试"><a href="#加优化参数和不加的数据写入测试" class="headerlink" title="加优化参数和不加的数据写入测试"></a>加优化参数和不加的数据写入测试</h1><p><strong>使用普通挂载</strong> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# mount -t nfs 192.168.0.150:/data/bbs /data/bbs</div></pre></td></tr></table></figure><p> 测试单个文件写入速度 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# cd /data/bbs</div><div class="line">[root@localhost bbs]# time dd if=/dev/zero of=/data/bbs/dingjianfile bs=9k count=2000</div><div class="line">2000+0 records in</div><div class="line">2000+0 records out</div><div class="line">18432000 bytes (18 MB) copied, 0.114592 s, 161 MB/s</div><div class="line">real    0m0.125s</div><div class="line">user    0m0.000s</div><div class="line">sys     0m0.021s</div></pre></td></tr></table></figure><p>测试批量创建文件的写入速度 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]# time for ((i=1;i&lt;10000;i++));do /bin/cp /bin/touch /data/bbs/test$i;done</div><div class="line">real    2m2.877s</div><div class="line">user    0m10.242s</div><div class="line">sys     0m33.882s</div></pre></td></tr></table></figure><p><strong>加优化参数挂载:</strong> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]#mount -t nfs -o noexec,nosuid,nodev,rw,rsize=65536,wsize=65536 192.168.10.150:/data/bbs /data/bbs</div></pre></td></tr></table></figure><p>测试单个文件写入速度 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]#  time dd if=/dev/zero of=/data/bbs/dingjianfile bs=9k count=2000</div><div class="line">2000+0 records in</div><div class="line">2000+0 records out</div><div class="line">18432000 bytes (18 MB) copied, 0.10043 s, 184 MB/s</div><div class="line">real    0m0.107s</div><div class="line">user    0m0.001s</div><div class="line">sys     0m0.017s</div></pre></td></tr></table></figure><p>测试批量创建文件的写入速度 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]# time for ((i=1;i&lt;10000;i++));do /bin/cp /bin/touch /data/bbs/test$i;done</div><div class="line">real    1m38.526s</div><div class="line">user    0m9.989s</div><div class="line">sys     0m32.788s</div></pre></td></tr></table></figure><h1 id="配置fstab文件令开机自动加载网络文件系统和本地的文件系统-和rc-local效果一样"><a href="#配置fstab文件令开机自动加载网络文件系统和本地的文件系统-和rc-local效果一样" class="headerlink" title="配置fstab文件令开机自动加载网络文件系统和本地的文件系统(和rc.local效果一样)"></a>配置fstab文件令开机自动加载网络文件系统和本地的文件系统(和rc.local效果一样)</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@localhost bbs]# vi /etc/fstab</div><div class="line"><span class="meta">#</span> /etc/fstab</div><div class="line"><span class="meta">#</span> Created by anaconda on Wed Jun 27 15:39:33 2018</div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span> Accessible filesystems, by reference, are maintained under '/dev/disk'</div><div class="line"><span class="meta">#</span> See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</div><div class="line"><span class="meta">#</span></div><div class="line">/dev/mapper/centos-root /                       xfs     defaults        0 0</div><div class="line">UUID=cbf5711b-4a2b-44ca-a6da-69d181f03617 /boot xfs     defaults        0 0</div><div class="line">/dev/mapper/centos-swap swap                    swap    defaults        0 0</div><div class="line"></div><div class="line">192.168.0.100:/data/bbs /data/bbs   nfs defaults,nosuid,noatime,nodiratime,noexec,nodev,intr,rsize=65536,wsize=65536     0 0</div><div class="line">~</div></pre></td></tr></table></figure><p>参考资料：</p><ol><li>《centos7下NFS使用与配置》 <a href="http://blog.51cto.com/mrxiong2017/2087001" target="_blank" rel="noopener">http://blog.51cto.com/mrxiong2017/2087001</a></li><li>《详细讲解NFS配置过程》<a href="https://www.cnblogs.com/alonones/p/6105586.html" target="_blank" rel="noopener">https://www.cnblogs.com/alonones/p/6105586.html</a></li><li>百度百科 <a href="https://baike.baidu.com/item/NFS/812203?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/NFS/812203?fr=aladdin</a></li></ol>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>写作的准备-读《完全写作指南》</title>
      <link href="/2018/04/08/1/"/>
      <content type="html"><![CDATA[<p>写作需要明确目标、确定读者、用头脑风暴总结出中心思想、组织内容、写初稿以及修改。但在大多数写作课上，这些步骤以现行的方式展现的，像这样：</p><p>目标 → 读者 → 头脑风暴 → 组织 → 写初稿 → 修改</p><p>从理论上讲，按照这个顺序操作，你就能得到一篇组织得当、逻辑严谨的完美稿件。这个方法对一部分人是有用的，但是如果你和大多数人一样，那么他可能就不适合你。在现实生活中，大部分都不是线性思维的写作者。</p><p>这六个步骤没错，错的是这个强制性的顺序。当遵循渐进编程了因循守旧，它可能会阻碍你写作能力的发挥。</p><p>你可以以这个步骤中任意一步作为起点，头脑风暴、提纲或者是写初稿。</p><h2 id="明确目标"><a href="#明确目标" class="headerlink" title="明确目标"></a>明确目标</h2><p>当要写作时，首先我们要确定自己的目标是什么，你希望达到什么目的。</p><p>仔细思考写作目的能帮你搞清楚该说什么，以及怎么说。又去的是，这样一来你的读者也会更加轻松，如果你也有过收到大量简历的经理，你就会知道一封周到、工整且有针对性的求职信会让你干到多么轻松。</p><h2 id="了解你的读者"><a href="#了解你的读者" class="headerlink" title="了解你的读者"></a>了解你的读者</h2><p>除了私人日记之外，所有的作品都是有读者的，你的作品需要指向这些特定的读者。</p><p>站在读者的角度进行思考，有两个关键问题：</p><ul><li>信息</li><li>态度</li></ul><p>选择信息的黄金法则是：<strong>要有足量的有效信息，让你的读者行动起来。</strong></p><p>了解读者潜在的态度也是成功的关键。</p><ul><li>你的读者会有什么样的反应？</li><li>他们很容易接受你的信息吗?</li><li>还是会有抵触情绪？</li><li>他们是否怀有敌意。</li></ul><blockquote><p>笔者说：</p><p>在这里，可以读《美国航空航天局科学家给赞比亚修女的一封信》，这是一封大师级的回信，在本文结束处。</p></blockquote><h2 id="用他头脑风暴锁定你想表达的内容"><a href="#用他头脑风暴锁定你想表达的内容" class="headerlink" title="用他头脑风暴锁定你想表达的内容"></a>用他头脑风暴锁定你想表达的内容</h2><p>头脑风暴有一些规则。如果你在学校或者工作的地方参加过头脑风暴式的讨论，那么你很可能看到过这些规则：</p><ol><li>相处的点子越多越好。如果你能把注意力放在数量而非质量上，那么提出有用的点子概率就会更大，点子都多多益善。</li><li>不要审查，不要评论。头脑风暴时，让你的思绪自由发散。这并不是对点子进行评论的时候，不要说这个点子不太好，那个点子不合适。把脑袋里评论的声音关掉，把所有想到的东西都写出来。你可以之后再删除。</li><li>接受不同寻常的想法。不要考虑你的想法靠不靠谱。你的这些想法可能完全超出预料，但它们当中可能会有一个非常有用，或至少能为你的思考指引方向的点子。充分发挥自己的想象力。</li><li>合并改进你的点子。如果你任由思绪自由发散，那么点子很可能会有一些重合。观察它们的相似之处，并加以合并调整。</li></ol><p>当写完初稿后，发现内容不够完整，不够有说服力时候甚至可以重新进行头脑风暴。</p><h1 id="美国航空航天局科学家给赞比亚修女的一封信"><a href="#美国航空航天局科学家给赞比亚修女的一封信" class="headerlink" title="美国航空航天局科学家给赞比亚修女的一封信"></a>美国航空航天局科学家给赞比亚修女的一封信</h1><p>背景： 1970年，赞比亚修女玛丽·尤肯达给美国航空航天局科学家恩斯特·施图林格博士问道：目前地球上还有这么多小孩子吃不上饭，他怎么能舍得为远在火星的项目花费数十亿美元。</p><p>1970年，赞比亚修女玛丽·尤肯达（Mary Jucunda）给恩斯特·施图林格（Ernst Stuhlinger）博士写了一封信。施图林格因在火星之旅工程中的原创性研究，成为NASA（美国航空航天局）马绍尔太空航行中心的科学副总监。信中，玛丽·尤肯达修女问道：目前地球上还有这么多小孩子吃不上饭，他怎么能舍得为远在火星的项目花费数十亿美元。施图林格很快给尤肯达修女回了信，同时还附带了一张题为“升起的地球”的照片，这张标志性的照片是宇航员威廉·安德斯于1968年在月球轨道上拍摄的（照片中可以看到月球的地面）。他这封真挚的回信随后由NASA以《为什么要探索宇宙》为标题发表。</p><p>1970年5月6日</p><p>亲爱的玛丽·尤肯达修女：每天，我都会收到很多类似的来信，但这封对我的触动最深，因为它来自一颗慈悲的饱含探求精神的心灵。我会尽自己所能来回答你这个问题。首先，请允许我向你以及你勇敢的姐妹们表达深深的敬意，你们献身于人类最崇高的事业：帮助身处困境的同胞。</p><p>在来信中，你问我在目前地球上还有儿童由于饥饿面临死亡威胁的情况下，为什么还要花费数十亿美元来进行飞向火星的航行。 我清楚你肯定不希望这样的答案：“哦，我之前不知道还有小孩子快饿死了，好吧，从现在开始，暂停所有的太空项目，直到孩子们都吃上饭再说。”事实上，早在了解火星之旅的技术之前，我已经对儿童的饥荒问题有所了解。而且，同我很多朋友的看法一样，我认为此时此刻，我们就应该开始通往月球、火星乃至其他行星的伟大探险。从长远来看，相对于那些要么只有年复一年的辩论和争吵，要么连妥协之后也迟迟无法落实的各种援助计划来说，我甚至觉得探索太空的工程给更有助于解决人类目前所面临的种种危机。</p><p>在详细说明我们的太空项目如何帮助解决地面上的危机之前，我想先简短讲一个真实的故事。那是在400年前，德国某小镇里有一位伯爵。他是个心地善良的人，他将自己收入的一大部分捐给了镇子上的穷人。这十分令人钦佩，因为中世纪时穷人很多，而且那时经常爆发席卷全国的瘟疫。一天，伯爵碰到了一个奇怪的人，他家中有一个工作台和一个小实验室，他白天卖力工作，每天晚上的几小时的时间专心进行研究。他把小玻璃片研磨成镜片，然后把研磨好的镜片装到镜筒里，用此来观察细小的物件。伯爵被这个前所未见的可以把东西放大观察的小发明迷住了。他邀请这个怪人住到了他的城堡里，作为伯爵的门客，此后他可以专心投入所有的时间来研究这些光学器件。</p><p>然而，镇子上的人得知伯爵在这么一个怪人和他那些无用的玩意儿上花费金钱之后，都很生气，“我们还在受瘟疫的苦”，他们抱怨道，“而他却为那个闲人和他没用的爱好乱花钱！”伯爵听到后不为所动，“我会尽可能地接济大家”，他表示，“但我会继续资助这个人和他的工作，我确信终有一天会有回报。”</p><p>果不其然，他的工作赢来了丰厚的回报：显微镜。显微镜的发明给医学带来了前所未有的发展，由此展开的研究及其成果，消除了世界上大部分地区肆虐的瘟疫和其他一些传染性疾病。</p><p>伯爵为支持这项研究发明所花费的金钱，其最终结果大大减轻了人类所遭受的苦难，这回报远远超过单纯将这些钱用来救济那些遭受瘟疫的人。</p><p>我们目前面临类似的问题。美国总统的年度预算共有2000亿美元，这些钱将用于医疗、教育、福利、城市建设、高速公路、交通运输、海外援助、国防、环保、科技、农业以及其他多项国内外的工程。今年，预算中的1.6%将用于探索宇宙，这些花销将用于阿波罗以计划、其他一些涵盖了天体物理学、深空天文学、空间生物学、行星探测工程、地球资源工程的小项目以及空间工程技术。为担负这些太空项目的支出，平均每个年收入10,000美元的美国纳税人需要支付约30美元给太空，剩下的9,970美元则可用于一般生活开支、休闲娱乐、储蓄、别的税项等花销。</p><p>也许你会问：“为什么不从纳税人为太空支付的30美元里抽出5美元或3美元或是1美元来救济饥饿的儿童呢？”为了回答这个问题，我需要先简单解释一下我们国家的经济是如何运行的，其他国家也是类似的情形。政府由几个部门（如内政部、司法部、卫生部与公众福利部、教育部、运输部、国防部等）和几个机构（国家科学基金会、国家航空航天局等）组成，这些部门和机构根据自己的职能制定相应的年度预算，并严格执行以应对国务委员会的监督，同时还要应付来自预算部门和总统对于其经济效益的压力。当资金最终由国会拨出后，将严格用于经预算批准的计划中的项目。</p><p>显然，NASA的预算中所包含的项目都是和航空航天有关的。未经国会批准的预算项目，是不会得到资金支持的，自然也不会被课税，除非有其他部门的预算涵盖了该项目，借此花掉没有分配给太空项目的资金。由这段简短的说明可以看出，要想援助饥饿的儿童，或在美国已有的对外援助项目上增加援助金额，需要首先由相关部门提出预算，然后由国会批准才行。</p><p>要问是否同意政府实施类似的政策，我个人的意见是绝对赞成。我完全不介意每年多付出一点点税款来帮助饥饿的儿童，无论他们身在何处。</p><p>我相信我的朋友们也会持相同的态度。然而，事情并不是仅靠把去往火星航行的计划取消就能轻易实现的。相对的，我甚至认为可以通过太空项目，来为缓解乃至最终解决地球上的贫穷和饥饿问题作出贡献。解决饥饿问题的关键有两部分：食物的生产和食物的发放。食物的生产所涉及的农业、畜牧业、渔业及其他大规模生产活动在世界上的一些地区高效高产，而在有的地区则产量严重不足。通过高科技手段，如灌溉管理，肥料的使用，天气预报，产量评估，程序化种植，农田优选，作物的习性与耕作时间选择，农作物调查及收割计划，可以显著提高土地的生产效率。</p><p>人造地球卫星无疑是改进这两个关键问题最有力的工具。在远离地面的运行轨道上，卫星能够在很短的时间里扫描大片的陆地，可以同时观察计算农作物生长所需要的多项指标，土壤、旱情、雨雪天气等等，并且可以将这些信息广播至地面接收站以便做进一步处理。事实证明，配备有土地资源传感器及相应的农业程序的人造卫星系统，即便是最简单的型号，也能给农作物的年产量带来数以十亿美元计的提升。</p><p>如何将食品发放给需要的人则是另外一个全新的问题，关键不在于轮船的容量，而在于国际间的合作。小国统治者对于来自大国的大量食品的输入很难做出准确的判断，他们害怕伴随着食物一同而来的还有外国势力对其统治地位的影响。恐怕在国与国之间消除隔阂之前，饥饿问题无法得以高效解决了。我不认为太空计划能一夜之间创造奇迹，然而，探索宇宙有助于促使问题向着良好的方向发展。</p><p>以最近发生的阿波罗13号事故为例。当宇航员处于关键的大气层再入期时，为了保证通讯畅通，苏联关闭了境内与阿波罗飞船所用频带相同的所有广播通信。同时派出舰艇到太平洋和大西洋海域以备第一时间进行搜救工作。如果宇航员的救生舱降落到俄方舰船附近，俄方人员会像对待从太空返回的本国宇航员一样对他们进行救助。同样，如果俄方的宇宙飞船遇到了类似的紧急情况，美国也一定会毫不犹豫地提供援助。 </p><p>通过卫星进行监测与分析来提高食品产量，以及通过改善国际关系提高食品发放的效率，只是通过太空项目提高人类生活质量的两个方面。下面我想介绍另外两个重要作用：促进科学技术的发展和提高一代人的科学素养。</p><p>登月工程需要历史上前所未有的高精度和高可靠性。面对如此严苛的要求，我们要寻找新材料，新方法；开发出更好的工程系统；用更可靠的制作流程；让仪器的工作寿命更长久；甚至需要探索全新的自然规律。</p><p>这些为登月发明的新技术同样可以用于地面上的工程项目。每年，都有大概一千项从太空项目中发展出来的新技术被用于日常生活中，这些技术打造出更好的厨房用具和农场设备，更好的缝纫机和收音机，更好的轮船和飞机，更精确的天气预报和风暴预警，更好的通讯设施，更好的医疗设备，乃至更好的日常小工具。你可能会问为什么先设计出宇航员登月舱的维生系统，而不是先为听力障碍患者造出有声阅读设备呢。答案很简单：解决工程问题时，重要的技术突破往往并不是按部就班直接得到的，而是来自能够激发出强大创新精神，能够燃起的想象力和坚定的行动力，以及能够整合好所有资源的充满挑战的目标。</p><p>太空旅行无可置疑地是一项充满挑战的事业。通往火星的航行并不能直接提供食物解决饥荒问题。然而，它所带来大量的新技术和新方法可以用在火星项目之外，这将产生数倍于原始花费的收益。若希望人类生活得越来越好，除了需要新的技术，我们还需要基础科学不断有新的进展。包括物理学和化学，生物学和生理学，特别是医学，用来照看人类的健康，应对饥饿、疾病、食物和水的污染以及环境污染等问题。</p><p>我们需要更多的年轻人投入到科学事业中来，我们需要给予那些投身科研事业的有天分的科学家更多的帮助。随时要有富于挑战的研究项目，同时要保证对项目给予充分的资源支持。在此我要重申，太空项目是科技进步的催化剂，它为学术研究工作提供了绝佳和实践机会，包括对月球和其他行星的眼睛、物理学和天文学、生物学和医学科学等学科，有它，科学界源源不断出现令人激动不已研究课题，人类得以窥见宇宙无比瑰丽的景象；为了它，新技术新方法不断涌现。</p><p>由美国政府控制并提供资金支持的所有活动中，太空项目无疑最引人瞩目也最容易引起争议，尽管其仅占全部预算的1.6%，不到全民生产总值的千分之三。作为新技术的驱动者和催化剂，太空项目开展了多项基础科学的研究，它的地位注定不同于其他活动。从某种意义上来说，以太空项目的对社会的影响，其地位相当于3-4千年前的战争活动。</p><p>如果国家之间不再比拼轰炸机和远程导弹，取而代之比拼月球飞船的性能，那将避免多少战乱之苦！聪慧的胜利者将满怀希望，失败者也不用饱尝痛苦，不再埋下仇恨的种子，不再带来复仇的战争。</p><p>尽管我们开展的太空项目研究的东西离地球很遥远，已经将人类的视野延伸至月亮、至太阳、至星球、直至那遥远的星辰，但天文学家对地球的关注，超过以上所有天外之物。太空项目带来的不仅有那些新技术所所提供的生活品质的提升，随着对宇宙研究的深入，我们对地球，对生命，对人类自身的感激之情将越深。太空探索让地球更美好。</p>]]></content>
      
      <categories>
          
          <category> 读书笔记 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Linux 安全系列之删除特殊的用户和用户组</title>
      <link href="/2018/04/02/1/"/>
      <content type="html"><![CDATA[<p>Linux 提供了各种不同角色的系统账号，在系统安装完成后，默认会按照很多不必要的用户和用户组，如果不需要某些用户或者用户组，应立即删除它们，因为账户越多，系统就越不安全，从而很渴能被黑客利用，威胁服务器的安全。</p><p>Linux 系统中可以删除的默认用户和用户组大致如下：</p><ul><li>可删除的用户，如 adm、lp、sync、shutdown、halt、news、uucp、operator、games、gopher 等。</li><li>可删除的用户组，如 adm、lp、news、uucp、games、dip、pppusers、popusers、slipusers 等。</li></ul><p>删除的方法很简单，下面以删除 games 用户和用户组为例介绍具体的操作。</p><p>删除用户所使用的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">userdel games</div></pre></td></tr></table></figure><p>删除用户组使用的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">groupdel games</div></pre></td></tr></table></figure><p>有些时候，某些用户仅仅作为进程调度或者用户组调用，并不需要登录功能，此时可以禁止这些用户登录系统的功能，例如要禁止 nagios 用户的登录功能，可以执行如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usermod -s /sbin/nologin nagios</div></pre></td></tr></table></figure><p>其实要删除哪些用户和用户组，并没有固定要求，可以根据服务器的用途来决定，如果服务器用于 Web 应用的，那么系统默认的 Apache 用户和用户组就无需删除；如果服务器用于数据库应用，那么建议删除系统默认的 Apache 用户和用户组。</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>AndroidStudio解决一直处于Building gradle project info的问题</title>
      <link href="/2018/03/10/1/"/>
      <content type="html"><![CDATA[<p>问题的原因是gradle包（即gradle-wrapper.properties里的gradle压缩文件）本地没有需要下载，因为墙的原因，一直卡在下载的环节。 </p><p>有三个解决方案：（选其一，推荐第三个方案） </p><ol><li>科学#上网，不多说，必备。加载多久看你网速了。（但即使是如此速度依旧很慢）</li><li>将 gradle-wrapper.properties中的版本改为已经存在的版本，找一个可以编译的项目复制 gradle 版本号即可。</li><li>下载对应离线包放到本地（如：C:\Users\Administrator.gradle\wrapper\dists\gradle-4.0.1-all\26awvqv6f41r14q9x72t4n0s，不解压，重启as），离线包地址：services.gradle.org/distributions/或者<a href="http://download.csdn.net/album/detail/2265" target="_blank" rel="noopener">http://download.csdn.net/album/detail/2265</a>；然后打开File-&gt;Settings-&gt;Build, Exectution, Deployment-&gt;Gradle ，设置 “Gradle home” 为解压目录即可.</li></ol><blockquote><p>原文地址：<a href="http://blog.csdn.net/nifanggge/article/details/53397942" target="_blank" rel="noopener">http://blog.csdn.net/nifanggge/article/details/53397942</a></p></blockquote>]]></content>
      
      <categories>
          
          <category> Andriod </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Nginx的安装</title>
      <link href="/2018/02/27/1/"/>
      <content type="html"><![CDATA[<p>Nginx 最初的设计，是成为一个 HTTP 服务器，一个能解决 C10K 问题的 HTTP 服务器，为了实现这个目标，Nginx 通过基于事件的链接——处理机制，并且操作系统也要使用相应的事件机制，便可以解决 C10K 问题。</p><p>在安装 Nginx 时，我们可以通过以下两种方式进行安装：</p><ol><li>使用包管理器安装 Nginx</li><li>通过源代码安装 Nginx</li></ol><h2 id="使用包管理器安装-Nginx"><a href="#使用包管理器安装-Nginx" class="headerlink" title="使用包管理器安装 Nginx"></a>使用包管理器安装 Nginx</h2><p>使用包管理器安装 Nginx 的机会，是你使用的操作系统已经提供了 Nginx 的安装包。使用包管理器安装 Nginx 的方式很简单，只需要在终端输入：</p><p>Linux(基于 deb，如 Ubunut)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install nginx</div></pre></td></tr></table></figure><p> Linux（基于 rpm，如 CentOS)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo yum install nginx</div></pre></td></tr></table></figure><p>FreeBSD</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo pkg_install -r nginx</div></pre></td></tr></table></figure><p>通过上述命令，Nginx 将会安装到操作系统的标准位置下。如果使用操作系统的安装包安装 Nginx，那么通过上面的命令来安装是最佳方式。</p><p>Nginx 核心团队也提供了稳定的二进制版本，可以从 <a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a> 页面下载可用版本。未发布 Nginx 安装包的系统用户（例如，CentOS），可以使用下面指导来安装预测试、预编译二进制版本。</p><p>通过创建下面的文件，在系统中添加 Nginx 仓库的 yum 配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/yum.repos.d/nginx.repo</div><div class="line">[nginx]</div><div class="line">name=nginx repo baseurl=http://nginx.org/packages/centos/7/$basearch/ gpgcheck=0</div><div class="line">enabled=1</div></pre></td></tr></table></figure><p>然后，听过执行如下命令来安装 Nginx：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo yum install nginx</div></pre></td></tr></table></figure><p>也可以按照前面介绍的 URL 下载 nginx 发行版安装。</p><h2 id="从源代码安装-Nginx"><a href="#从源代码安装-Nginx" class="headerlink" title="从源代码安装 Nginx"></a>从源代码安装 Nginx</h2><p>Nginx 代码提供了两种独立的下载分支——开发版与稳定版。开发分支是一个正处于积极开发状态的版本。在这个版本中，会有一些新功能被集成到其中，在稳定版中是找不到这些功能的。当发布一个“开发”版时，它会经历同样的 QA 和作为稳定版本的一组类似测试功能。因此无论哪一个分支都一颗用于生产环境中，两者主要的不同，在于对第三方模块的支持。在开发板中，内部的 API 可能会发生改变，而稳定版则保持不变。因此，为了与第三方模块向下兼容，在稳定版中第三方模块都可以有效使用。</p><h3 id="准备编译环境"><a href="#准备编译环境" class="headerlink" title="准备编译环境"></a>准备编译环境</h3><p>为了从源代码编译 Nginx，系统需要满足某些必要条件，除了编译器外，如果想分别启用 SSL 支持和使用 rewrite 模块，那么还需要提供响应的 OpenSSL 与 PCRE（Perl Compatible Regular Expressions）库及开发头文件。rewrite 模块是默认安装的。如果你还没有 PCRE 库与开发头文件，你需要在配置阶段禁用 rewrite 模块。这依赖于系统，也有可能在系统中已经默认安装了这些必要条件。如果没有安装，则需要从其安装包安装或者从源码下载并且解压安装，在 Nginx 配置脚本中指定他们在系统中的安装位置。</p><p>如果在配置文件中使用了—with-\<library\>=\<path\>选项，那么 Nginx 会视图建立一个静态依赖库。如果你想让 Nginx 不依赖于系统的任何其他部分，或是想获得些 Nginx 的二进制额外性能，那么你可能会使用构建静态库的做法。如果你使用外部库功能只能从某一个版本起有效（例如，NPN[Next Protocol Negotiation]TLS扩展从 OpenSSL1.0.1版有效），那么你就不得不将其指定到特定版本解压后的源代码路径中。</path\></library\></p><p>根据自己的喜好，你可能会提供其他的、可选安装包。你可以为这些安装包提供支持。他们包括 MD5和 SHA-1以支持散列算法、zip 压缩库、libatomic 库。在 Nginx 中，很多地方法会用到散列库，例如为了计算 URI 散列进而计算缓存 key。</p><p>zlib 压缩裤被用来投递 gzip 压缩内容。如果 atomic_ops 库有效，那么 Nginx 会用它来实现自动内存更新操作，以实现高性能的内存锁定代码。</p><h3 id="从源代码编译"><a href="#从源代码编译" class="headerlink" title="从源代码编译"></a>从源代码编译</h3><p>读者可以从 <a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a> 下载 Nginx，在该页面找到.tar.gz 或者.zip 格式的源代码分支，安装如下步骤将下载的安装包解压到一个临时目录中:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> mkdir ~/bulid</div><div class="line"><span class="meta">$</span> cd ~/bulid &amp;&amp; tar xzf nginx-&lt;version-number&gt;.tar.gz</div></pre></td></tr></table></figure><p>使用下面命令配置 Nginx:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> cd ~/bulid/nginx-&lt;version-number&gt; &amp;&amp; ./configure</div></pre></td></tr></table></figure><p>然后，使用下面命令进行编译安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> make &amp;&amp; sudo make install</div></pre></td></tr></table></figure><p>在编译自己的二进制 nginx 时，你会有很大的灵活性来包含你仅使用的功能。你已经指定使用哪个用户运行 Nginx 了吗?你要使用默认的 logfile 位置，以便不用在 Nginx 的配置文件明确地说明它们吗?表 1-1 所示是配置选项列表，通过它来帮助你设计出自己的 nginx 命令。这些选项对 Nginx 都是有效的，模块可以被独立激活。</p><table><thead><tr><th>选项</th><th style="text-align:left">解释</th></tr></thead><tbody><tr><td>–prefix=\<path\></path\></td><td style="text-align:left">Nginx 安装的根路径，所有其他的安装路径都要依赖于该选项</td></tr><tr><td>–sbin-path=\<path\></path\></td><td style="text-align:left">指定 Nginx 二进制文件的路径。如果没有指定，那么这个路径依赖于——prefix 选项</td></tr><tr><td>–conf-path=\<path\></path\></td><td style="text-align:left">如果在命令行没有指定配置文件，那么将会通过这里指定的路径，Nginx 将会去那里寻找它的配置文件</td></tr><tr><td>–error-log-path=\<path\></path\></td><td style="text-align:left">指定错误文件的路径，Nginx 会将其中写入错误日志文件，除非有其他配置</td></tr><tr><td>–pid-path=\<path\></path\></td><td style="text-align:left">指定的文件将会写入 Nginx master 进程的pid，通常在/var/run 下</td></tr><tr><td>–lock-path=\<path\></path\></td><td style="text-align:left">共享存储器互斥锁文件的路径</td></tr><tr><td>–user=\<user\></user\></td><td style="text-align:left">worker 进程运行的用户</td></tr><tr><td>–group=\<group\></group\></td><td style="text-align:left">worker 进程运行的组</td></tr><tr><td>–with-file-aio</td><td style="text-align:left">为 FreeBSD4.3+和 Linux2.6.22+系统启用异步 I/O</td></tr><tr><td>–with-debug</td><td style="text-align:left">这个选项用于启用调试日志。在生产环境中不推荐使用该选项。</td></tr></tbody></table><p>你可以使用优化编译，单但是如果使用包管理工具进行安装将无法获得这些优化，如下表：</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>–with-cc=\<path\></path\></td><td>如果想设置一个不再默认 Path 下的编译器</td></tr><tr><td>–with-cpp=\<path\></path\></td><td>设置 C 预处理器的响应路径</td></tr><tr><td>–with-cc-opt=\<options></options></td><td>指定必要的 include 文件路径，可能（-I\<path\>）指出，也可能是优化(-O4)并指定64位构建</path\></td></tr><tr><td>–with-ld-opt=\<options\></options\></td><td>包含连接器库的路径(-L\<path\>)和运行路径(-R\<path\>)</path\></path\></td></tr><tr><td>—with-cpu-opt=\<cpu\></cpu\></td><td>通过该选项为特定的 CPU 构建 Nginx</td></tr></tbody></table><h2 id="配置-SSL-支持"><a href="#配置-SSL-支持" class="headerlink" title="配置 SSL 支持"></a>配置 SSL 支持</h2><p>对于 TLS/SSL 协议，Nginx 使用 OpenSSL 项目。有关此开源工具包的更多信息，请访问 <a href="https://www.openssl.org。你可以从操作系统或者直接从工具包的单独副本来获取对" target="_blank" rel="noopener">https://www.openssl.org。你可以从操作系统或者直接从工具包的单独副本来获取对</a> SSL 的支持。如果使用不带–with-ssl 选项的–with-http_ssl_module 或者–with-mail_ssl_module，你正在使用执行了 configure 命令的、安装在计算机上的 OpenSSL 库。如果你想要针对特定版本的 OpenSSL 进行编译，请下载该分发包，将其解压缩到一个目录中，然后将该目录的路径指定为–with-openssl 的参数。使用–with-openssl-opt 选项为 OpenSSL本身指定额外的构建选项。</p><p>例如，为了使用具有优化椭圆曲线的 OpenSSL 来构建 Nginx，您将使用如下的命令:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> ./configure --with-http_ssl_module --with-openssl=$&#123;BUILD_DIR&#125;/openssl-1.0.1p --with-openssl-opt=enable-ec_nistp_64_gcc_128</div></pre></td></tr></table></figure><h2 id="查找并安装第三方模块"><a href="#查找并安装第三方模块" class="headerlink" title="查找并安装第三方模块"></a>查找并安装第三方模块</h2><p>由于有多个开源项目，所以在 Nginx 周围就会有一个活跃的开发社区。由于 Nginx 的模块化特性，这个社区能够开发和发布模块，从而为 Nginx 提供额外的功能。它们涵盖了广泛的应用，所以着手开发自己的模块之前应该看看有什么可用模块。</p><p>安装第三方模块的过程相当简单，步骤如下。</p><p>1.定位你想要使用的模块(在 <a href="https://github.com" target="_blank" rel="noopener">https://github.com</a> 或者是 <a href="http://wiki.nginx.org/3rdPartyModules查找)。" target="_blank" rel="noopener">http://wiki.nginx.org/3rdPartyModules查找)。</a></p><p>2.下载该模块。</p><p>3.解压缩源代码安装包。</p><p>4.如果有 README 文件，那么阅读 README 文件，查看在安装中是否有依赖安装。</p><p>5.通过./configure–add-module=\<path\>选项配置使用该模块。</path\></p><p>这个过程会给你的 nginx 二进制文件与模块附加这个功能。</p><p>需要注意的是，很多第三方模块是实验性质的。因此，在将这些模块用于生产系统之前，首先要测试使用这些模块。另外请记住，Nginx 的开发版本中可能会有 API 的变化，会导致第三方模块出现问题。</p><h2 id="添加对-Lua-的支持"><a href="#添加对-Lua-的支持" class="headerlink" title="添加对 Lua 的支持"></a>添加对 Lua 的支持</h2><p>特别应该提到的是 ngx_lua 这个第三方模块，ngx_lua 模块提供了启用 Lua 的功能，而不是像 Perl 一样在配置时嵌入式脚本语言。该模块对于 perl 模块来说最大的优点就是它的无阻塞性，并与其他第三方模块紧密集成。对于它的安装说明的完整描述详见:<a href="https://github.com/openresty/lua-nginx-module#installation。我们将以这个模块为例，在下一节中介绍如何安装第三方模块。" target="_blank" rel="noopener">https://github.com/openresty/lua-nginx-module#installation。我们将以这个模块为例，在下一节中介绍如何安装第三方模块。</a></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过编译你自己的二进制文件，你可以定制 Nginx能够为你提供哪些功能。对于你来说，构建和安装软件应该不会陌生。所以，创造一个构建环境或者确保所有依赖关系都存在，这并不会花费你很多的时间。一个 Nginx 的安装应该是按照你的需要，能随时启用或禁用模块，正如你看到的，启用或者是禁用一个模块应该感到很容易。</p><p>参考资料：</p><p>《精通 Nginx》第二版</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>利用Pathogen安装VIM插件</title>
      <link href="/2018/02/23/1/"/>
      <content type="html"><![CDATA[<p>pathogen的安装其实非常简单。git上有非常全面的介绍和文档，<a href="http://github.com/tpope/vim-pathogen" target="_blank" rel="noopener">http://github.com/tpope/vim-pathogen</a>。简单的几条命令即可搞定pathogen的安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p ~/.vim/autoload ~/.vim/bundle   </div><div class="line">curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim</div></pre></td></tr></table></figure><p>也就是在 ~/.vim目录下（如果没有，则新建）新建目录autoload、bundle（插件会放在这个目录），然后将pathogen放在autoload目录下即可</p><p>安装完成之后，这时候，pathogen还没有生效，需要在~/.vimrc添加：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">execute pathogen#infect()</div></pre></td></tr></table></figure><p>如果没有~/.vimrc则需要新建文件，并添加如下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">execute pathogen#infect()  </div><div class="line">syntax on  </div><div class="line">filetype plugin indent on</div></pre></td></tr></table></figure><p>完成之后，就可以使用pathogen管理vim插件了，只需要将插件放在~/.vim/bundle目录下即可。</p>]]></content>
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>function与感叹号</title>
      <link href="/2018/02/01/1/"/>
      <content type="html"><![CDATA[<h1 id="function与感叹号"><a href="#function与感叹号" class="headerlink" title="function与感叹号"></a>function与感叹号</h1><p>最近有空可以让我静下心来看看各种代码，function与感叹号的频繁出现，让我回想起2个月前我回杭州最后参加团队会议的时候，<a href="http://weibo.com/exqy" target="_blank" rel="noopener">@西子剑影</a>抛出的一样的问题：<strong>如果在function之前加上感叹号 (!) 会怎么样</strong>？比如下面的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// true</span></div></pre></td></tr></table></figure><p>在控制台运行后得到的值时true，为什么是true这很容易理解，因为这个匿名函数没有返回值，默认返回的就是undefined，求反的结果很自然的就是true。所以问题并不在于结果值，而是在于，为什么求反操作能够让一个匿名函数的自调变的合法？</p><p>平时我们可能对添加括号来调用匿名函数的方式更为习惯：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;)()        <span class="comment">// true</span></div></pre></td></tr></table></figure><p>或者：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;())        <span class="comment">// true</span></div></pre></td></tr></table></figure><p>虽然上述两者括号的位置不同，不过效果完全一样。</p><p>那么，是什么好处使得为数不少的人对这种叹号的方式情有独钟？如果只是为了节约一个字符未免太没有必要了，这样算来即使一个100K的库恐怕也节省不了多少空间。既然不是空间，那么就是说也许还有时间上的考量，事实很难说清，文章的最后有提到性能。</p><p>回到核心问题，为什么能这么做？甚至更为核心的问题是，为什么必须这么做？</p><p>其实无论是括号，还是感叹号，让整个语句合法做的事情只有一件，就是<strong>让一个函数声明语句变成了一个表达式</strong>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;        <span class="comment">// undefined</span></div></pre></td></tr></table></figure><p>这是一个函数声明，如果在这么一个声明后直接加上括号调用，解析器自然不会理解而报错：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// SyntaxError: unexpected_token</span></div></pre></td></tr></table></figure><p>因为这样的代码混淆了函数声明和函数调用，以这种方式声明的函数 <code>a</code>，就应该以 <code>a();</code> 的方式调用。</p><p>但是括号则不同，它将一个函数声明转化成了一个表达式，解析器不再以函数声明的方式处理函数a，而是作为一个函数表达式处理，也因此只有在程序执行到函数a时它才能被访问。</p><p>所以，<strong>任何消除函数声明和函数表达式间歧义的方法，都可以被解析器正确识别</strong>。比如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> i = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="number">10</span>&#125;();        <span class="comment">// undefined</span></div><div class="line"><span class="number">1</span> &amp;&amp; <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="literal">true</span>&#125;();        <span class="comment">// true</span></div><div class="line"><span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;();        <span class="comment">// undefined</span></div></pre></td></tr></table></figure><p>赋值，逻辑，甚至是逗号，各种操作符都可以告诉解析器，这个不是函数声明，它是个函数表达式。并且，对函数一元运算可以算的上是消除歧义最快的方式，感叹号只是其中之一，如果不在乎返回值，这些<strong>一元运算都是有效的</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">!<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// true</span></div><div class="line">+<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// NaN</span></div><div class="line">-<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// NaN</span></div><div class="line">~<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// -1</span></div></pre></td></tr></table></figure><p>甚至下面这些关键字，都能很好的工作：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// undefined</span></div><div class="line"><span class="keyword">new</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// Object</span></div><div class="line"><span class="keyword">delete</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;()        <span class="comment">// true</span></div></pre></td></tr></table></figure><p>最后，括号做的事情也是一样的，消除歧义才是它真正的工作，而不是把函数作为一个整体，所以无论括号括在声明上还是把整个函数都括在里面，都是合法的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;)()        <span class="comment">// undefined</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'iifksp'</span>)&#125;())        <span class="comment">// undefined</span></div></pre></td></tr></table></figure><p>说了这么多，实则在说的一些都是最为基础的概念——语句，表达式，表达式语句，这些概念如同指针与指针变量一样容易产生混淆。虽然这种混淆对编程无表征影响，但却是一块绊脚石随时可能因为它而头破血流。</p><p>最后讨论下性能。我在jsperf上简单建立了一个测试：<a href="http://jsperf.com/js-funcion-expression-speed" target="_blank" rel="noopener">http://jsperf.com/js-funcion-expression-speed</a> ，可以用不同浏览器访问，运行测试查看结果。我也同时将结果罗列如下表所示（由于我比较穷，测试配置有点丢人不过那也没办法：奔腾双核1.4G，2G内存，win7企业版）：</p><table><thead><tr><th>Option</th><th>Code</th><th>Ops/sec</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>Chrome 13</td><td>Firefox 6</td><td>IE9</td><td>Safari 5</td><td></td><td></td></tr><tr><td>!</td><td>!function(){;}()</td><td>3,773,196</td><td>10,975,198</td><td>572,694</td><td>2,810,197</td></tr><tr><td>+</td><td>+function(){;}()</td><td>21,553,847</td><td>12,135,960</td><td>572,694</td><td>1,812,238</td></tr><tr><td>-</td><td>-function(){;}()</td><td>21,553,847</td><td>12,135,960</td><td>572,694</td><td>1,864,155</td></tr><tr><td>~</td><td>~function(){;}()</td><td>3,551,136</td><td>3,651,652</td><td>572,694</td><td>1,876,002</td></tr><tr><td>(1)</td><td>(function(){;})()</td><td>3,914,953</td><td>12,135,960</td><td>572,694</td><td>3,025,608</td></tr><tr><td>(2)</td><td>(function(){;}())</td><td>4,075,201</td><td>12,135,960</td><td>572,694</td><td>3,025,608</td></tr><tr><td>void</td><td>void function(){;}()</td><td>4,030,756</td><td>12,135,960</td><td>572,694</td><td>3,025,608</td></tr><tr><td>new</td><td>new function(){;}()</td><td>619,606</td><td>299,100</td><td>407,104</td><td>816,903</td></tr><tr><td>delete</td><td>delete function(){;}()</td><td>4,816,225</td><td>12,135,960</td><td>572,694</td><td>2,693,524</td></tr><tr><td>=</td><td>var i = function(){;}()</td><td>4,984,774</td><td>12,135,960</td><td>565,982</td><td>2,602,630</td></tr><tr><td>&amp;&amp;</td><td>1 &amp;&amp; function(){;}()</td><td>5,307,200</td><td>4,393,486</td><td>572,694</td><td>2,565,645</td></tr><tr><td>\</td><td>\</td><td></td><td>0 \</td><td>\</td><td>function(){;}()</td><td>5,000,000</td><td>4,406,035</td><td>572,694</td><td>2,490,128</td></tr><tr><td>&amp;</td><td>1 &amp; function(){;}()</td><td>4,918,209</td><td>12,135,960</td><td>572,694</td><td>1,705,551</td></tr><tr><td>\</td><td></td><td>1 \</td><td>function(){;}()</td><td>4,859,802</td><td>12,135,960</td><td>572,694</td><td>1,612,372</td></tr><tr><td>^</td><td>1 ^ function(){;}()</td><td>4,654,916</td><td>12,135,960</td><td>572,694</td><td>1,579,778</td></tr><tr><td>,</td><td>1, function(){;}()</td><td>4,878,193</td><td>12,135,960</td><td>572,694</td><td>2,281,186</td></tr></tbody></table><p>可见不同的方式产生的结果并不相同，而且，差别很大，因浏览器而异。</p><p>但我们还是可以从中找出很多共性：<strong>new方法永远最慢</strong>——这也是理所当然的。其它方面很多差距其实不大，但有一点可以肯定的是，感叹号并非最为理想的选择。反观<strong>传统的括号，在测试里表现始终很快</strong>，在大多数情况下比感叹号更快——所以平时我们常用的方式毫无问题，甚至可以说是最优的。<strong>加减号在chrome表现惊人</strong>，而且在其他浏览器下也普遍很快，相比感叹号效果更好。</p><p>当然这只是个简单测试，不能说明问题。但有些结论是有意义的：括号和加减号最优。</p><p>但是为什么这么多开发者钟情于感叹号？我觉得这只是一个习惯问题，它们之间的优劣完全可以忽略。一旦习惯了一种代码风格，那么这种约定会使得程序从混乱变得可读。如果习惯了感叹号，我不得不承认，它比括号有更好的可读性。我不用在阅读时留意括号的匹配，也不用在编写时粗心遗忘——</p><p>当我也这么干然后嚷嚷着这居然又节省了一个字符而沾沾自喜的时候，却忘了自己仓皇翻出一本卷边的C语言教科书的窘迫和荒唐……任何人都有忘记的时候，当再捡起来的时候，捡起的就已经不单单是忘掉的东西了。</p><p>2011-10-31更新：如果你使用aptana，那么在使用（!+-）时要注意一点，它们会让aptana的解析失效，导致Outline窗口没有任何显示。但是就代码本身而言，其运行没有任何问题。</p><blockquote><p>本文转自扩葵中剑的博客</p><p>原文地址：<a href="https://swordair.com/function-and-exclamation-mark/" target="_blank" rel="noopener">https://swordair.com/function-and-exclamation-mark/</a></p></blockquote>]]></content>
      
      <categories>
          
          <category> javascript </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（10）：MySQL优化</title>
      <link href="/2018/01/14/2/"/>
      <content type="html"><![CDATA[<p>在本文中，并没有实现过程，算是一个提纲，当我们需要对MySQL进行优化的时候，可以通过本篇文章，了解一下，我们要对MySQL进行哪些优化，也算是对MySQL的优化先要有一个总体的认知。</p><p>因为如果要将所有的操作过程都放到这篇文章中，估计还没等看完，你就已经睡着了，具体的操作，我会在其他系列的博文中陆续的更新出来。</p><h1 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h1><ul><li>数据表数据类型优化</li><li>索引优化</li><li>SQL 语句优化</li><li>存储引擎的优化</li><li>数据表结构设计的优化</li><li>数据库服务器架构的优化</li></ul><h1 id="数据表数据类型优化"><a href="#数据表数据类型优化" class="headerlink" title="数据表数据类型优化"></a>数据表数据类型优化</h1><p>在做数据表结构类型优化时，我们需要考虑如下几点：</p><ul><li>字段使用什么样的数据类型更合适</li><li>字段使用什么样的数据类型性能更快</li></ul><h3 id="Int-tinyint、smallint、bigint"><a href="#Int-tinyint、smallint、bigint" class="headerlink" title="Int: tinyint、smallint、bigint"></a>Int: tinyint、smallint、bigint</h3><p>在使用Int类型存储值的时候，一定要按需选择，需要对空间、范围进行考虑，比如存储年龄通常是0~120多，所以我们选择一个最小的tinyint类型，如果加上无符号那么最大值是255，足够我们存储年龄，选择smallint或者bigint明显是一种浪费。</p><h3 id="char、varchar"><a href="#char、varchar" class="headerlink" title="char、varchar"></a>char、varchar</h3><p>char 的空间效率要比 varchar 要好，如果是存储电话号码，固定为11位，这种类似的需求，使用char要更好。</p><p>对于varchar存储一些可变的数据，如用户名。</p><p>###　enum</p><p>特性、固定的分类可以使用 enum 存储，效率更快。</p><p>一定要是固定的分类，如果将来的分类会变，就不适合使用enum，因为这样我们就需要去修改数据库表结构，扩展性会变得很差。</p><h3 id="IP-地址的存储"><a href="#IP-地址的存储" class="headerlink" title="IP 地址的存储"></a>IP 地址的存储</h3><p>IP 地址一般会采用字符型来进行存储，但是这种存储方式会带来很大的空间占用，我们可以使用整型来进行存储，PHP为我们提供了转换函数 <code>ip2lang</code></p><h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><p>在做索引型优化时，我们需要考虑如下几点：</p><ul><li>建立合适的索引</li><li>索引在什么场景下效率最高</li></ul><h2 id="索引的创建原则"><a href="#索引的创建原则" class="headerlink" title="索引的创建原则"></a>索引的创建原则</h2><ul><li><p>索引不是越多越好，在合适的字段上创建合适的索引，索引本身会影响我们的写操作的速度，并且会占用磁盘空间。</p></li><li><p>符合索引的前缀原则。</p></li></ul><h2 id="索引的注意事项"><a href="#索引的注意事项" class="headerlink" title="索引的注意事项"></a>索引的注意事项</h2><ul><li>符合索引的前缀原则</li><li>like 查询%的问题</li><li>全表扫描优化</li><li>or 条件索引使用情况</li><li>字符串类型索引失效的问题</li></ul><h1 id="SQL-语句的优化"><a href="#SQL-语句的优化" class="headerlink" title="SQL 语句的优化"></a>SQL 语句的优化</h1><ul><li>优化查询过程中的数据访问<ul><li>使用Limit</li><li>返回列不用 *</li></ul></li><li>优化长难句的查询语句<ul><li>变复杂为简单</li><li>切分查询</li><li>分解关联查询</li></ul></li><li>优化特定类型的查询语句<ul><li>优化count()</li><li>优化关联查询</li><li>优化子查询</li><li>优化 Group by 和 distinct</li><li>优化 limit 和 union</li></ul></li></ul><h1 id="存储引擎的优化"><a href="#存储引擎的优化" class="headerlink" title="存储引擎的优化"></a>存储引擎的优化</h1><ul><li>尽量使用 <code>InnoDB</code> 存储引擎</li></ul><h1 id="数据表结构设计的优化"><a href="#数据表结构设计的优化" class="headerlink" title="数据表结构设计的优化"></a>数据表结构设计的优化</h1><ul><li>分区操作<ul><li>通过特定的策略对数据表进行物理拆分</li><li>对用户透明</li><li>partition by</li></ul></li><li>分库分表<ul><li>水平拆分</li><li>垂直拆分</li></ul></li></ul><h1 id="数据库架构的优化"><a href="#数据库架构的优化" class="headerlink" title="数据库架构的优化"></a>数据库架构的优化</h1><ul><li>主从复制</li><li>读写分离</li><li>双主热备</li><li>负载均衡<ul><li>通过 <code>LVS</code> 的三种基本模式实现负载均衡</li><li><code>MyCat</code> 数据库中间件实现负载均衡。</li></ul></li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（9）：数据库缓存</title>
      <link href="/2018/01/14/1/"/>
      <content type="html"><![CDATA[<h1 id="什么是数据库缓存"><a href="#什么是数据库缓存" class="headerlink" title="什么是数据库缓存"></a>什么是数据库缓存</h1><p><strong>MySQL</strong> 等一些常见的关系型数据库的数据都存储在硬盘当中，在高并发场景下，业务应用对 MySQL 产生的增、删、改、查的操作造成巨大的I/O开销和查询压力，这无疑对数据库和服务器都是一种巨大的压力，为了解决此类问题，缓存数据的概念应运而生。</p><p>使用数据库缓存可以极大的解决我们数据的压力，提高应用数据的响应速度，因为不用再动态查询了，直接将静态数据返回，无论是速度还是效率都要更快一些，节省了，很多查询和计算的时间。</p><p>常见的缓存形式：内存缓存，文件缓存</p><p>为了避免I/O开销，应该尽量使用内存缓存。</p><h1 id="为什么要使用缓存"><a href="#为什么要使用缓存" class="headerlink" title="为什么要使用缓存"></a>为什么要使用缓存</h1><p>缓存诗句是为了让客户端很少，甚至是不访问数据库服务器进行数据的查询，高并发下，能最大程度地降低对数据库服务器的访问压力。</p><p>当我们默认情况下<strong>不使用缓存</strong>的情况下，我们的执行顺序如下：</p><ol><li>用户请求</li><li>数据查询</li><li>链接数据库服务器并查询数据</li><li>将数据缓存起来（HTML、内存、JSON、序列化数据）</li><li>显示给客户端</li></ol><p>当我们第二次请求或者是新用户访问时候，执行顺序如下：</p><ol><li>用户再次请求或者新用户访问</li><li>数据查询</li><li>直接从缓存中获取数据</li><li>显示给客户端</li></ol><h2 id="缓存需要考虑的内容"><a href="#缓存需要考虑的内容" class="headerlink" title="缓存需要考虑的内容"></a>缓存需要考虑的内容</h2><ul><li><p>缓存方式的选择</p></li><li><p>缓存场景的选择</p></li><li><p>缓存数据的实时性</p></li><li>缓存数据的稳定性</li></ul><h1 id="使用-MySQL查询缓存"><a href="#使用-MySQL查询缓存" class="headerlink" title="使用 MySQL查询缓存"></a>使用 MySQL查询缓存</h1><p>启用MySQL查询缓存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">query_cache_type</div></pre></td></tr></table></figure><p>查询缓存类型，有0、1、2三个取值。</p><ul><li>0 不是用查询缓存</li><li>1 始终使用查询缓存</li><li>2 按需查询缓存</li></ul><p>query_cache_type为1时，也可以关闭查询缓存</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE * <span class="keyword">FROM</span>　my_table <span class="keyword">WHERE</span> condition;</div></pre></td></tr></table></figure><p>query_cache_type为2时，可以按需使用查询缓存</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">SQL_CACHE</span> * <span class="keyword">FROM</span> my_table <span class="keyword">WHERE</span> condition;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">query_cache_size</div></pre></td></tr></table></figure><p>默认情况下query_cache_size为0，表示查询缓存预留的内存为0，则无法使用查询缓存。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SET GLOBAL query_cache_size = 134217728;</div></pre></td></tr></table></figure><p>查询缓存可以看成是 SQL 文本和查询结果的映射。</p><p>第二查询的SQL和第二次查询的SQL要完全相同，才会使用缓存。</p><p>我们可以通过下面的语句查看缓存的命中次数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SHOW STATUS LIKE &apos;Qcache_hits&apos;;</div></pre></td></tr></table></figure><p>表的结构发生改变时候，查询缓存中的数据不再有效。</p><p>清理缓存如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FLUSH QUERY CACHE;  //清理查询缓存内部碎片</div><div class="line">RESET QUERY CACHE;  //从查询花村中移出所有查询</div><div class="line">FLUSH TABLES;//关闭所有打开的表，同时该操作将会清空查询缓存中的内容。</div></pre></td></tr></table></figure><h1 id="使用-Memcache"><a href="#使用-Memcache" class="headerlink" title="使用 Memcache"></a>使用 Memcache</h1><p>对于大型的站点，如果没有中间缓存层，当流量打入数据库层的时候，即便有之前的几层为我们挡住了大量流量，但是在大并发的请胯下，还是会有大量请求涌入数据库，这样对于数据库服务器的压力冲击很大，响应速度也会下降，因此添加中间缓存层很有必要。</p><p>Memcache 是一套分布式的高速缓存系统， 由 LiveJournal 的Brad Fitzpatrick 开发，但目前被许多网站使用以提升网站的访问速度，尤其对于一些大型的、需要频繁访问数据库的网站访问速度提升效果十分显著。</p><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>Memcache 是一个高性能的分布式的内存对象缓存系统，通过在内存里维护一个统一的巨大的Hash表，它能够用来存储各种格式的数据，包括图像、视频、文件以及数据库检索出来的结果等。简单的说就是讲数据调用到内存，然后从内存中读取，从而大大提高读取速度。</p><h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p>先检查服务端的请求数据是否在 <code>memcached</code>中，如果存在直接把请求数据返回，不再对数据库进行任何操作。如果请求的数据不再<code>memcached</code>中，就去查询数据库, 把从数据库中获取的诗句返回给客户端，同时把数据缓存一份到<code>memcached</code>中。</p><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>获取：get(key)</p><p>设置：set(key, val, expire)</p><p>删除 : delete(key)</p><h2 id="通用缓存机制"><a href="#通用缓存机制" class="headerlink" title="通用缓存机制"></a>通用缓存机制</h2><p>用查询的方法名 + 参数作为查询时的key value对应中的key值。</p><h1 id="使用-Redis"><a href="#使用-Redis" class="headerlink" title="使用 Redis"></a>使用 Redis</h1><h2 id="与Memcache的区别"><a href="#与Memcache的区别" class="headerlink" title="与Memcache的区别"></a>与Memcache的区别</h2><ul><li>性能相差不大</li><li>Redis 在2.0版本后增加了自己的 VM 特性，突破了物理内存的限制</li><li>Memcache 可以修改最大可用内存，采用 LRU（缓存淘汰） 算法</li><li>Redis 依赖客户端来实现分布式读写</li><li>Memcache 本身没有数据冗余机制</li><li>Redis 支持（快照、AOF），依赖快照进行持久化，AOF 增强了可靠性的同时，对性能也有所影响</li><li>Memcache 不支持持久化，通常做缓存，提升性能</li><li>Memcache 在并发场景下，用 cas 保证一致性，Redis 事务支持比较弱，只能保证事务中的每个操作的连续执行</li><li>Redis 支持多种数据类型</li><li>Redis 用于数据量较小的高性能操作和运算上</li><li>Memcache 用于动态系统中减少数据库负载，提升性能；适合做缓存，提高性能</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（11）：Web服务器负载均衡</title>
      <link href="/2018/01/14/3/"/>
      <content type="html"><![CDATA[<p>负载均衡，英文名称为 <code>LoadBalance</code>，其意思就是将负载(工作任务)进行平衡，分摊到多个操作单元上进行执行(例如Web服务器、FTP服务器等)，实现多个服务器共同完成工作任务的目标。负载均衡建立在现有网络结构之上，它提升了服务器的性能、提高了带宽利用率，增强了网络的灵活性和可靠性。</p><h1 id="七层负载均衡的实现"><a href="#七层负载均衡的实现" class="headerlink" title="七层负载均衡的实现"></a>七层负载均衡的实现</h1><p>基于URL等应用层信息的负载均衡，Nginx 的 proxy 是它一个很强大的功能，实现了7层负载均衡。</p><ul><li>功能强大，性能卓越，运行稳定</li><li>配置简单灵活</li><li>能够自动剔除工作不正常的后端服务器</li><li>上传文件可以使用异步模式</li><li>支持多种分配策略，可以分配权重，分配方式灵活</li></ul><p>NGINX 拥有两种策略：<strong>内置策略</strong>、<strong>扩展策略</strong></p><p>内置策略是NGINX安装后内置，开箱即用的均衡策略，而扩展策略反之，需要我们安装特定的模块才能进行使用。</p><p>内置策略： IP Hash、加权轮询</p><p>扩展策略：fair策略、通用hash、一致性hash。</p><p><strong>加权轮询：</strong>首先将请求都发给高权的机器，直到该机器的权值降到了比其他机器底，才开始将请求分给下一个高权重的机器。当所有后端机器都 down 掉时，NGINX 会立即将所有机器的标志位清成初始状态，以避免所有的机器都处于 timeout 的状态。</p><p><strong>IP Hash：</strong> 流程和轮询很类似，只是其中的算法和具体的策略有些变化，IP HASH算法算是一种变相的轮询算法。</p><p><strong>fair 策略：</strong>根据后端服务器的响应时间判断负载情况，从中选出负载最轻的机器进行分流。</p><p><strong>通用hash、一致性hash：</strong>比较简单，可以以 NGINX 内置的变量为key进行hash，一致性hash采用了NGINX内置的一致性Hash环，支持 memcache。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    upstream cluster &#123;</div><div class="line">        ip hash;</div><div class="line">        server serv1;</div><div class="line">        server serv2;</div><div class="line">        server serv3;</div><div class="line">    &#125;</div><div class="line">    server &#123;</div><div class="line">        listen 80;</div><div class="line">        location/ &#123;</div><div class="line">            proxy_pass http://cluster;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="四层负载均衡的实现"><a href="#四层负载均衡的实现" class="headerlink" title="四层负载均衡的实现"></a>四层负载均衡的实现</h1><p>通过报文中的目标地址和端口，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。</p><p>在四层负载均衡上，我们可以使用LVS （Linux Virtual Server），意即Linux 虚拟服务器，是一个虚拟服务器的集群系统。该软件是在1998年5月由章文嵩山博士创建，是国内最早出现的自由软件项目之一，它具有良好的可靠性、可扩展性和可操作性。</p><h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>LVS 是基于 IP 地址的调度方法实现的，是最高效的实现方法，IP 负载均衡是通过 IPVS 内核模块实现的，IPVS 是 LVS 集群系统的核心软件。</p><p>也就是说在我们使用 LVS 之前，我们必须要先安装 ipvs 软件。</p><p>安装在 Director Server 上，同时在 Director Server 上虚拟出一个 IP（VIP-Virtual IP）地址。在进行域名解析的时候，我们需要将域名解析到 VIP 上。然后根据 VIP 找到 Director Server分发到真实的服务器上。</p><p>访问的请求首选in 经过 VIP 到负载调度器，由负载调度器从 Real Server 列表中选取一个节点响应用户的请求。</p><p>Real Server 节点返回给用户数据使用过 ipvs 实现的，ipvs 实现负载均衡的机制有三种：<strong>NAT(地址转发)</strong>，<strong>DR （直接路由）</strong>和<strong>TUN（隧道模式）</strong>。</p><h2 id="LVS-安装"><a href="#LVS-安装" class="headerlink" title="LVS 安装"></a>LVS 安装</h2><p>上文提到过，安装 LVS 需要安装 ipvs，我们需要到其官网进行下载：</p><p><a href="http://www.linuxvirtualserver.org/software/index.html" target="_blank" rel="noopener">http://www.linuxvirtualserver.org/software/index.html</a></p><p>在下载软件时我们需要注意，要下载对应的内核版本号，使用 uname -r 查看当前 Linux 的内核版本。</p><p>同时，我们也可以使用 Linux 自带的包管理器进行安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install ipsadm</div></pre></td></tr></table></figure><h2 id="NAT-模式"><a href="#NAT-模式" class="headerlink" title="NAT 模式"></a>NAT 模式</h2><p>地址转换技术 DR 只需要将 VIP 配置到 DR 上，将受到的集群服务请求报文目标地址转换成根据算法计算得出的后端主机 IP 地址。</p><p>然后后端主主机将相应报文发送至 DR，再由 DR 将原地址转换成 VIP 地址。下面是他的网络拓扑图：</p><p><img src="http://www.uml.org.cn/zjjs/images/2012111243.PNG" alt=""></p><p>在 LVS（Director）上面需要两双网卡：DIP（内网）和 VIP（外网）</p><p>内网的 Real Server 主机的 IP 必须和 DIP 在同一个网络中，并且要求其网关都需要指向 DIP 的地址。</p><p>RIP 都是私有 IP地址，仅用于各个节点之间的通信，Director 位于 client 和 Real Server 之间，负责处理所有的进站、出站的通信，支持端口映射。</p><p>应用在较大规模的应用场景中，但 Director 容易成为整个架构的瓶颈。</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（8）：独立图片服务器的部署</title>
      <link href="/2018/01/13/4/"/>
      <content type="html"><![CDATA[<ul><li><h1 id="独立图片服务器的必要性"><a href="#独立图片服务器的必要性" class="headerlink" title="独立图片服务器的必要性"></a>独立图片服务器的必要性</h1><p>我们知道，无论对于Apache还是Nginx，图片始终是最消耗系统资源的，如果将图片服务和应用服务放在同一个服务器的话，应用服务器很容易会因为图片的 高I/O负载而崩溃，因此对于有些大型网站项目，我们有必要将图片服务器和应用服务器分离。</p><p>部署独立的图片服务器（甚至是服务器集群）是大型网站图片存储解决方案中最基础的，因为有了独立的图片服务器后，我们才能对图片服务器做更有针对性的性能优化，为图片服务器设置针对性的缓存方案，减少带宽成本，提高访问速度。</p><p>从硬件角度说，图片服务器可以配置高端的硬盘，7200转的换成15000转的，而CPU只需要使用一般的CPU就可以了。</p><p>从软件角度说，可以为图片服务器配置特殊的文件系统来满足对图片的I/O请求，如淘宝 的TFS，就很好地解决了大规模小图片文件带来的I/O噩梦，同时，我们也可以采用Nginx、squid来代理图片请求，通过增加图片服务器，提高图片吞吐能力。</p><p>分担 Web 服务器的 I/O 负载-将耗资源的图片服务分离出来，提高服务器的性能、稳定性和扩展性。</p><h1 id="采用独立域名"><a href="#采用独立域名" class="headerlink" title="采用独立域名"></a>采用独立域名</h1><p>注意，这里是指独立域名，不是子域哦，比如yahoo.com图片服务器用了yimg.com的域名，而不是用二级域名img.yahoo.com。</p><p>同一域名下浏览器的并发链接数有限制，突破浏览器链接数的限制，通常情况下浏览器的并发连接数是2到6个。</p><p>这样，我们如果给图片服务器配置独立的域名，那么在一个页面中加载图片时，就可以突破浏览器连接数的限制，理论上，增加一个独立域名，并发连接数加倍。  </p><p>另外还有由于 Cookie 的原因，大部分 Web Cache都只缓存不带 Cookie 的请求，导致每次的图片请求都不能命中 Cache。而仍旧要去原始服务器获取图片，导致图片缓存意义不大。所以，还是给单独搞一个图片独立域名吧，当然，不只是图片，CSS和JavaScript文件也可以参照这个思路来搞。  </p><h1 id="如何进行图片上传和图片同步"><a href="#如何进行图片上传和图片同步" class="headerlink" title="如何进行图片上传和图片同步?"></a>如何进行图片上传和图片同步?</h1><h2 id="NFS-共享方式"><a href="#NFS-共享方式" class="headerlink" title="NFS 共享方式"></a>NFS 共享方式</h2><p>NFS是Network  File System（网络文件系统）。主要功能是通过网络让不同的服务器之间可以共享文件或者目录。</p><p>NFS客户端一般是应用服务器（比如web，负载均衡等），可以通过挂载的方式将NFS服务器端共享的目录挂载到NFS客户端本地的目录下。       </p><p>NFS在文件传送过程中依赖与RPC（远程过程调用）协议。NFS本身是没有提供信息传送的协议和功能的，但是能够用过网络进行图片，视频，附件等分享功能。只要用到NFS的地方都需要启动RPC服务，不论是NFS的服务端还是客户端。       </p><p>NFS和RPC的关系：可以理解为NFS是一个网络文件系统（比喻为租房的房主），而RPC是负责信息的传输（中介），客户端（相当于租房的租客） </p><p>了解 NFS 可以看我的另外一篇博文《LInux 典型应用：》</p><h2 id="利用-FTP-同步"><a href="#利用-FTP-同步" class="headerlink" title="利用 FTP 同步"></a>利用 FTP 同步</h2><p>用户上传完图片后是利用 FTP 同步到各个图片服务器的，PHP、Java、Asp.net基本上都能操作 FTP。这样的话 每个图片服务器就都保存一份图片的副本，也起到了备份的作用。但是缺点是将图片ftp到服务器比较耗时，如果异步去同步的话又会有延时，不过一般的小图片 文件也还好了。  </p></li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（7）：动态语言静态化</title>
      <link href="/2018/01/13/3/"/>
      <content type="html"><![CDATA[<h1 id="什么是动态语言静态化"><a href="#什么是动态语言静态化" class="headerlink" title="什么是动态语言静态化"></a>什么是动态语言静态化</h1><p>将现有 PHP 等动态语言的逻辑代码生成为静态HTML 文件，用户访问动态脚本重定向到静态 HTML 文件的过程。</p><p>如果页面中的的数据一直都在变化，那么不建议使用静态化。</p><h1 id="为什么要静态化"><a href="#为什么要静态化" class="headerlink" title="为什么要静态化"></a>为什么要静态化</h1><p>动态脚本通常会做逻辑运算和数据查询，访问量越大，服务器压力越大。</p><p>访问量大的时候可能造成 CPU 负载过高，数据服务器压力过大，静态化可以减轻逻辑处理能力，降低数据库服务器的查询压力。</p><h1 id="静态化的实现方式"><a href="#静态化的实现方式" class="headerlink" title="静态化的实现方式"></a>静态化的实现方式</h1><h2 id="使用模板引擎"><a href="#使用模板引擎" class="headerlink" title="使用模板引擎"></a>使用模板引擎</h2><p>可以使用 Smarty 的缓存机制生成静态 HTML 缓存文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$smarty-&gt;cache_dir = $ROOT.<span class="string">'/cache'</span>; <span class="comment">//缓存目录</span></div><div class="line">$smarty-&gt;caching = <span class="keyword">true</span>;    <span class="comment">//是否开启缓存</span></div><div class="line">$smarty-&gt;cache_lifetime = <span class="string">'3600'</span>;    <span class="comment">//缓存时间</span></div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$smarty-&gt;display(strign template [,string cache_id[, strign compile_id]]);</div></pre></td></tr></table></figure><p>如果开启了缓存，Smarty 会自动的生成 HTML 缓存文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$smarty-&gt;clear_all_cache();<span class="comment">//清除所有缓存</span></div><div class="line">$smarty-&gt;clear_cache(<span class="string">'file.html'</span>);<span class="comment">//清除指定缓存</span></div><div class="line">$smarty-&gt;clear_cache(<span class="string">'article,html'</span>, $cache_id) <span class="comment">//清除一同模板下的指定缓存号的缓存。</span></div></pre></td></tr></table></figure><h2 id="利用-OB-系列函数"><a href="#利用-OB-系列函数" class="headerlink" title="利用 OB 系列函数"></a>利用 OB 系列函数</h2><ul><li>ob_start()：打开输出控制缓冲</li><li>ob_get_contents()：返回输出缓冲区的内容</li><li>ob_clean()：清空输出缓冲区</li><li>ob_end_flush()：冲刷出（送出）输出缓冲区内容并且关闭缓冲</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ob_start();</div><div class="line">输出到页面的 HTML 代码</div><div class="line">ob_get_contents();</div><div class="line">ob_end_flush();</div><div class="line">fopen()写入</div></pre></td></tr></table></figure><p>可以使用 filectime 函数 判断文件的 inode 修改时间，判断是否过期。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$cache_name = md5(<span class="keyword">__FILE__</span>).<span class="string">'html'</span>;</div><div class="line">$cache_lifetime = <span class="number">3600</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ( filectime(<span class="keyword">__FILE__</span>) &lt;= filectime($cache_name) file_exists($cache_name) &amp;&amp; filectime($cache_name) + $cache_lifetime &gt; time()) &#123;</div><div class="line">    <span class="comment">//判断 PHP 文件修改时间</span></div><div class="line"><span class="comment">//判断是否存在缓存</span></div><div class="line"><span class="comment">//判断是否过期</span></div><div class="line">    <span class="keyword">include</span> $cache_name;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line">ob_start();</div><div class="line"><span class="meta">?&gt;</span></div><div class="line">&lt;b&gt; This is my Script&lt;/b&gt;</div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$content = ob_get_contents();    </div><div class="line">$ob_end_flush();</div><div class="line">$handle = fopen($cache_name, <span class="string">'w'</span>);</div><div class="line">fwrite($handle, $content);</div><div class="line">fclose($handle);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（5）： CDN 加速</title>
      <link href="/2018/01/13/1/"/>
      <content type="html"><![CDATA[<h1 id="什么是CDN"><a href="#什么是CDN" class="headerlink" title="什么是CDN"></a>什么是CDN</h1><p>CDN 的全城是 Content Delivery Network，即内容分发网络，尽可能避开互联网上有可能影响数据传输速度和稳定性的平静和环节，是内容传输的更快、更稳定。</p><p>在网络各处放置节点服务器所构成的在现有的互联网基础之上的一层只能虚拟网络，比如说我们现在有一个服务器的集群，现在在北京，有几台服务器在北京，在上海访问北京服务器就会比较慢，我们就可以使用 CDN 解决这样的问题，可以在香港、上海建立一个 CDN 节点，这样当我的用户在某一个节点访问我们的网站时，可以去请求香港的 CDN 节点，这样距离他比较近，CDN 已经把真实服务器的数据缓存到了 CDN 当中，相当于一个镜像。</p><p>CDN 系统能够实时地根据网络流量和各节点的连接、敷在情况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。</p><h1 id="使用-CDN-的优势"><a href="#使用-CDN-的优势" class="headerlink" title="使用 CDN 的优势"></a>使用 CDN 的优势</h1><p>本地 Cache 加速，提高企业站点（尤其含有大量图片和静态资源页面站点）的访问速度。</p><p>跨运营商的网络加速，保证不同网络的用户能得到最好的访问质量。</p><p>远程访问用户根据 DNS 负载均衡技术只能选择 Cache 服务器。</p><p>自动生成服务器的远程 Mirror（镜像）Cache 服务器，远程用户访问时从 Cache 服务器上读取数据，减少远程访问的带宽、分带网络流量、减轻原站点 WEB 服务器负载等能力。</p><p>广泛分布的 CDN 节点加上节点之间的智能冗余机制，可以有效地预防黑客入侵。</p><h1 id="CDN-的工作原理"><a href="#CDN-的工作原理" class="headerlink" title="CDN 的工作原理"></a>CDN 的工作原理</h1><h2 id="传统访问"><a href="#传统访问" class="headerlink" title="传统访问"></a>传统访问</h2><p>用户在浏览器输入域名发起请求–&gt;解析域名获取服务器 IP 地址–&gt;根据 IP 地址找到对应的服务器—&gt;服务器响应并返回。</p><h2 id="使用-CDN-访问"><a href="#使用-CDN-访问" class="headerlink" title="使用 CDN 访问"></a>使用 CDN 访问</h2><p>用户发起请求–&gt;只能 DND 解析（根据 IP 判断地理位置、接入网类型、选择路由最短和负载最轻的服务器）–&gt;获得缓存服务器 IP–&gt;把内容返回给用户（如果缓存中有）—&gt;向源站发起请求—&gt;将结果返回给用户—&gt;将结果存入缓存服务器。</p><h1 id="CDN-适用场景"><a href="#CDN-适用场景" class="headerlink" title="CDN 适用场景"></a>CDN 适用场景</h1><ul><li>站点或者应用中大量静态资源的加速分发，例如：CSS，JS，图片和 HTML。</li><li>大文件下载</li><li>直播网站</li></ul><h1 id="CDN-的实现"><a href="#CDN-的实现" class="headerlink" title="CDN 的实现"></a>CDN 的实现</h1><p>BAT 等都有提供 CDN 服务。</p><p>可用 LVS 做4层负载均衡。</p><p>可用 Nginx，Varnish，Squid，Apache TrafficServer 做7层负载均衡和 Cache。</p><p>使用 squid 反向代理，或者 Nginx 等的反向代理</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（6）：动态语言并发处理</title>
      <link href="/2018/01/13/2/"/>
      <content type="html"><![CDATA[<h1 id="什么是进程、线程、协程"><a href="#什么是进程、线程、协程" class="headerlink" title="什么是进程、线程、协程"></a>什么是进程、线程、协程</h1><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><p>进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。</p><h3 id="进程的三态模型"><a href="#进程的三态模型" class="headerlink" title="进程的三态模型"></a>进程的三态模型</h3><p>进程的三态模型：多道程序系统中，进程在处理器上交替运行，状态不断地发生变化</p><p><strong>运行：</strong>当一个进程在处理机上运行时，则称该进程处于运行状态。处于此状态的进程的数目小于等于处理器的数目，对于单机处理系统，处于运行状态的进程只有一个。没有其他进程可以执行时（如所有进程都在阻塞状态），通常会自动执行系统的空闲进程。</p><p><strong>就绪</strong>：当一个程序获得了除处理机意外的一切所需资源，一旦得到处理机即可运行，则称此进程出于就绪状态。就绪进程可以按多个优先级来划分队列。例如，当一个进程处于时间片用完而进入就绪状态时，排入低优先级队列；当前进程由 I/O 操作完成而进入就绪状态时，排入高优先队列。</p><p><strong>阻塞：</strong>也称之为等待或者睡眠状态，一个进程正在等待某一事件发生（例如请求 I/O而等待 I/O 完成等）而暂时停止运行，这时即使把处理机分配给进程也无法运行，故称该进程出于阻塞状态。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180621140421.png" alt=""></p><h3 id="进程的五态模型"><a href="#进程的五态模型" class="headerlink" title="进程的五态模型"></a>进程的五态模型</h3><p>进程的五态模型：对于一个实际的系统，进程的状态及其转换更为复杂分为新建态、活跃就绪/静止就绪、运行、活跃阻塞/静止阻塞、终止态,可见下图。</p><p><img src="http://blog.51cto.com/attachment/201302/105409473.png" alt=""></p><p><strong>新建态：</strong>对应于进程刚刚被创建时没有被提交的状态，并等待系统完成创建进程的所有必要信息。</p><p><strong>活跃就绪：</strong>是指进程在主内存并且可被调度的状态。</p><p><strong>静止就绪（挂起就绪）：</strong>是指进程被对换到辅存时的就绪状态，是不能被直接调度的状态，只有当主存中没有活跃就绪态进程，或者是挂起就绪态进程具有更高的优先级，系统将被挂起就绪态进程调回主存并转化为活跃就绪。</p><p><strong>活跃阻塞</strong>：是指进程已在主存，一旦等待事件产生便进入活跃就绪状态</p><p><strong>静止阻塞：</strong>进程对换到辅存时的阻塞状态，一旦等地啊的事件产生便进入静止就绪状态。</p><p><strong>终止态：</strong>进程已经结束运行，回收除进程控制块之外的其他资源，并让其他进程从进程控制块中有关信息。</p><h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><p>由于我们用户的并发请求，为每一个请求都创建一个进程显然是行不通的，从系统资源开销方面或是响应用户请求的效率方面来看。因此系统中线程概念便被引进了。</p><p>线程，有时被称之为轻量级的进程（Lightweight Process, LWP），是程序执行流的最小单元。</p><p>线程是进程中的一个实体，是被系统独立调度和分派的基本单位，线程自己不拥有系统资源，只拥有一点儿在运行中必不可少的资源，但它可与同属的一个进程的其他线程共享进程所拥有的全部资源。</p><p>一个线程可以创建和撤销另一个线程，统一进程的多个线程之间可以并发执行。</p><p>线程是程序中一个单一的顺序控制流程。进程内一个相对独立的、可调度的执行单元，是系统独立调度和分派CPU的基本单位指运行中的程序的调度单位。</p><p>在单个程序中同事运行多个线程完成不同的工作，称之为<strong>多线程。</strong></p><p>每一个程序都只要有一个线程，若程序只有一个线程，那就是程序本身。</p><p>线程的状态：<strong>就绪</strong>、<strong>阻塞</strong>、<strong>运行</strong>。</p><p><strong>就绪状态：</strong>线程具备运行的所有条件，逻辑上可以运行，在等待处理机。</p><p><strong>阻塞状态：</strong>线程在等待一个事件（如某个信号量），逻辑上不可执行。</p><p><strong>运行状态：</strong>线程占有处理机正在运行。</p><h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>协程是一种用户态的轻量级线程，协程的调度完全由用户控制。协程已拥有自己的寄存器上下文和栈，协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈基本没有内核切换开销，可以不加锁访问全局变量，所以上下文的切换非常快。</p><p>如果想要深入的了解协程的实现，可以读鸟哥有关于协程的博文，里面详细介绍了PHP协程 的实现——<a href="http://www.laruence.com/2015/05/28/3038.html" target="_blank" rel="noopener">传送门</a>。</p><h2 id="线程与进程的区别"><a href="#线程与进程的区别" class="headerlink" title="线程与进程的区别"></a>线程与进程的区别</h2><ol><li>线程是进程内的一个执行单元，进程内至少有一个线程，它们共享进程的地址空间，而进程有自己独立的地址空间。</li><li>进程是资源分配和拥有的单元，同一个进程内的线程共享进程的资源。</li><li>线城市处理器调度的基本单位，进程不是。</li><li>两者均可并发执行</li><li>每个独立的线程有一个程序运行的入口，顺序执行序列和程序的出口，但是线程不能够独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。</li></ol><h2 id="线程和协程的区别"><a href="#线程和协程的区别" class="headerlink" title="线程和协程的区别"></a>线程和协程的区别</h2><ol><li>一个线程可以有多个协程，一个协程也可以单独拥有多个协程</li><li>线程进程都是同步机制，而协程这是异步</li><li>协程能保留上一次调用时的状态，每次过程重入时，就相当于进入上一次调用的状态。</li></ol><h1 id="什么是多进程，多线程"><a href="#什么是多进程，多线程" class="headerlink" title="什么是多进程，多线程"></a>什么是多进程，多线程</h1><p><strong>多进程</strong>是指同一时间里，统一计算机系统中如果允许两个或者两个以上的进程处于运行状态，就是多进程。多开一个进程，多分配一份资源，进程间通信不方便。</p><p><strong>多线程</strong>就是把一个进程分为很多片，每一片都可以是一个独立的流程与多进程的却别是只会使用一个进程的资源，线程间可以直接通信。</p><h1 id="同步阻塞模型"><a href="#同步阻塞模型" class="headerlink" title="同步阻塞模型"></a>同步阻塞模型</h1><p>在最早的服务器端程序透视通过多进程、多线程来解决并发IO的问题。</p><p>一个请求创建一个进程，然后子进程进入循环同步阻塞地与客户端进行交互，收发处理数据。</p><p>多线程模式实现非常简单，线程可以直接向某一个客户端连接发送数据。</p><p>步骤：</p><ol><li>创建一个 socket，绑定服务器端口（bind），监听端口（listen），在PHP中用stream_socket_server一个函数就能完成上面3个步骤，当然也可以使用更底层的sockets扩展分别实现。</li><li>进入while循环，阻塞在accept操作上，等待客户端连接进入。此时程序会进入睡眠状态，直到有新的客户端发起connect到服务器，操作系统会唤醒此进程。accept函数返回客户端连接的socket</li><li>主进程在多进程模型下通过fork（PHP: pcntl_fork）创建子进程，多线程模型下使用pthread_create（PHP: new Thread）创建子线程。下文如无特殊声明将使用进程同时表示进程/线程。</li><li>子进程创建成功后进入while循环，阻塞在recv（PHP: fread）调用上，等待客户端向服务器发送数据。收到数据后服务器程序进行处理然后使用send（PHP: fwrite）向客户端发送响应。长连接的服务会持续与客户端交互，而短连接服务一般收到响应就会close。</li><li>当客户端连接关闭时，子进程/线程退出并销毁所有资源。主进程/线程会回收掉此子进程/线程。</li></ol><p>缺点：</p><ul><li>这种模型严重依赖进程的数量解决并发问题，一个客户端连接就需要占用一个进程，工作进程的数量有多少，并发处理能力就有多少。操作系统可以创建的进程数量是有限的。</li><li>启动大量进程会带来额外的进程调度消耗。数百个进程时可能进程上下文切换调度消耗占CPU不到1%可以忽略不计，如果启动数千甚至数万个进程，消耗就会直线上升。调度消耗可能占到 CPU 的百分之几十甚至 100%。</li></ul><p>另外有一些场景多进程模型无法解决，比如即时聊天程序（IM），一台服务器要同时维持上万甚至几十万上百万的连接（经典的C10K问题），多进程模型就力不从心了。</p><p>还有一种场景也是多进程模型的软肋。通常Web服务器启动100个进程，如果一个请求消耗100 ms，100个进程可以提供1000 QPS，这样的处理能力还是不错的。但是如果请求内要调用外网HTTP接口，像QQ、微博登录，耗时会很长，一个请求需要10s。那一个进程1秒只能处理0.1个请求，100个进程只能达到QPS，这样的处理能力就太差了。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建scoket监听</span></div><div class="line">$scokserv = stream_scoket_server(<span class="string">'tcp://0.0.0.0:8880'</span>, $errno, $errstr);</div><div class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">5</span>; $i++)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>（pcntl_fork() == <span class="number">0</span>） &#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            $conn = stream_scoket_accept($sockserv);</div><div class="line">            <span class="keyword">if</span> ($conn == <span class="keyword">false</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            $request = fread($conn, <span class="number">9000</span>);</div><div class="line">            $response = <span class="string">'hello'</span>;</div><div class="line">            fwrite($conn, $response);</div><div class="line">            fclose($conn);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">exit</span>();</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="异步非阻塞模型"><a href="#异步非阻塞模型" class="headerlink" title="异步非阻塞模型"></a>异步非阻塞模型</h1><p>现在各种高并发异步IO的服务器程序都是基于 <strong>epoll</strong> 实现的。</p><p>在早期Linux就提供了<strong>select</strong>，可以在一个进程内维持1024个连接，后来加入了<strong>poll</strong>，可以维持任意数量个连接。</p><p>但是<strong>poll</strong>需要循环检测是否有事件，如果服务器当前有100 W个连接，但是某一个时间内只有一条连接向服务器发送数据，这样系统就会循环100 W次，对于CPU是一种浪费。</p><p><strong>Linux在2.6时提供了epoll</strong>，可以在系统内维持无数个连接，而且无需轮训。</p><p>IO复用异步非阻塞程序使用经典的 <strong>Reactor</strong> 模型，<strong>Reactor</strong> 顾名思义，就是反应堆的意思，它本身不处理任何数据收发，只是可以监视一个socket句柄的事件变化。</p><p>Reactor模型：</p><ul><li><strong>Add:</strong>  添加一个 SOCKET到 Reactor </li><li><strong>Set：</strong> 修改 SOCKET 对应的事件，如可读可写</li><li><strong>Del：</strong> 从 Reactor 中移除</li><li><strong>Callback：</strong> 事件发生后回调指定的函数</li></ul><p><img src="http://rango.swoole.com/static/io/6.png" alt=""></p><h1 id="PHP-并发编程实践"><a href="#PHP-并发编程实践" class="headerlink" title="PHP 并发编程实践"></a>PHP 并发编程实践</h1><h3 id="PHP的Swoole扩展"><a href="#PHP的Swoole扩展" class="headerlink" title="PHP的Swoole扩展"></a>PHP的Swoole扩展</h3><p>PHP的异步、并行、高性能的网络通信引擎，使用纯C语言编写，提供了PHP语言的异步多线程服务器，异步TCP/UDP 网络客户端，异步 MySQL，异步 Redis，数据库连接池，AsyncTask，消息队列，毫秒定时器，异步文件读写，异步 DNS 查询。</p><p>除了异步IO的支持之外，Swoole 为 PHP 多进程的模式设计了多个并发数据结构和 IPC 通信机制，可以大大简化多进程并发编程的工作。</p><p>Swoole 2.0支持了类似Go语言的协程，可以使用完全同步的代码实现异步程序。</p><h4 id="Swoole-的异步MySQL实现"><a href="#Swoole-的异步MySQL实现" class="headerlink" title="Swoole 的异步MySQL实现"></a>Swoole 的异步MySQL实现</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$db = <span class="keyword">new</span> swoole_mysql;</div><div class="line">$server = <span class="keyword">array</span>(</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'192.168.56.102'</span>,</div><div class="line">    <span class="string">'port'</span> =&gt; <span class="number">3306</span>,</div><div class="line">    <span class="string">'user'</span> =&gt; <span class="string">'test'</span>,</div><div class="line">    <span class="string">'password'</span> =&gt; <span class="string">'test'</span>,</div><div class="line">    <span class="string">'database'</span> =&gt; <span class="string">'test'</span>,</div><div class="line">    <span class="string">'charset'</span> =&gt; <span class="string">'utf8'</span>, <span class="comment">//指定字符集</span></div><div class="line">    <span class="string">'timeout'</span> =&gt; <span class="number">2</span>,  <span class="comment">// 可选：连接超时时间（非查询超时时间），默认为SW_MYSQL_CONNECT_TIMEOUT（1.0）</span></div><div class="line">);</div><div class="line"></div><div class="line">$db-&gt;connect($server, <span class="function"><span class="keyword">function</span> <span class="params">($db, $r)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ($r === <span class="keyword">false</span>) &#123;</div><div class="line">        var_dump($db-&gt;connect_errno, $db-&gt;connect_error);</div><div class="line">        <span class="keyword">die</span>;</div><div class="line">    &#125;</div><div class="line">    $sql = <span class="string">'show tables'</span>;</div><div class="line">    $db-&gt;query($sql, <span class="function"><span class="keyword">function</span><span class="params">(swoole_mysql $db, $r)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> ($r === <span class="keyword">false</span>)</div><div class="line">        &#123;</div><div class="line">            var_dump($db-&gt;error, $db-&gt;errno);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">elseif</span> ($r === <span class="keyword">true</span> )</div><div class="line">        &#123;</div><div class="line">            var_dump($db-&gt;affected_rows, $db-&gt;insert_id);</div><div class="line">        &#125;</div><div class="line">        var_dump($r);</div><div class="line">        $db-&gt;close();</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure><h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><h4 id="用户注册"><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h4><p><strong>场景说明：</strong>当用户注册后，需要发注册邮件和注册短信。</p><p><strong>串行方式：</strong>将注册信息写入数据库成功以后，发送注册邮件，再发送注册短信。</p><p><strong>并行方式：</strong>将注册写入数据库成功后，发送注册邮件的同事，发送注册短信。</p><p><strong>消息队列方式：</strong>将注册信息写入数据库成功后，将成功信息写入队列，此时直接返回成功给用户，写入队列的时间非常短，可以忽略不计，然后异步发送邮件和短信。</p><h4 id="解耦操作"><a href="#解耦操作" class="headerlink" title="解耦操作"></a>解耦操作</h4><p><strong>场景说明：</strong>用户下单后，订单系统需要通知库存系统。假如库存系统无法访问，则订单减库存将失败，从而导致订单失败。此时需要进行解耦。</p><p><strong>引入队列：</strong> </p><ol><li>用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户下单成功。</li><li>库存系统订阅下单的消息，采用拉/推得方式，获取下单信息，库存系统根据下单信息，进行库存操作。</li></ol><h4 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h4><p><strong>应用场景：</strong>秒杀活动，流量瞬间激增，服务器压力大</p><p>用户发起请求，服务器接收后，先写入消息队列，假如消息队列长度超过最大值，则直接报错或提示用户。</p><p>后续程序读取消息队列，在进行处理。</p><h4 id="日志处理"><a href="#日志处理" class="headerlink" title="日志处理"></a>日志处理</h4><p><strong>应用场景：</strong>解决大量日志的传输</p><p>日志采集程序可以将日志写入消息队列，然后通过日志处理程序的订阅消费日志。</p><h4 id="消息通讯"><a href="#消息通讯" class="headerlink" title="消息通讯"></a>消息通讯</h4><p><strong>应用场景：</strong> 聊天室</p><p>多个客户端订阅同一主题，进行消息发布和接收。</p><h4 id="常见的消息队列产品"><a href="#常见的消息队列产品" class="headerlink" title="常见的消息队列产品"></a>常见的消息队列产品</h4><p>kafka、ActiveMQ、ZeroMQ, RabbitMQ、Redis等等。</p><h3 id="接口的并发请求"><a href="#接口的并发请求" class="headerlink" title="接口的并发请求"></a>接口的并发请求</h3><p>curl_multi系列函数。</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（4）：浏览器缓存和压缩优化技术</title>
      <link href="/2018/01/12/2/"/>
      <content type="html"><![CDATA[<h1 id="HTTP-缓存机制"><a href="#HTTP-缓存机制" class="headerlink" title="HTTP 缓存机制"></a>HTTP 缓存机制</h1><h2 id="缓存分类"><a href="#缓存分类" class="headerlink" title="缓存分类"></a>缓存分类</h2><p>在HTTP缓存模型中，如果请求成功会有三种情况。</p><ul><li>200 from cache</li><li>304 Not Modified</li><li>200 OK</li></ul><p><strong>200 from cache: </strong>直接从本地缓存中获取响应，最快速，最省流量，因为根本没有向服务器发送请求I看到。</p><p>浏览器本身就有缓存机制，当我们浏览器检测到该资源在本地存在，那么就不需要向服务器发送请求，从下图中我们可以看到size没有大小显示的是 <strong>from cache</strong>，就是读取的缓存。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627102555.png" alt=""></p><p>查看其响应头我们可以看到下图。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627103642.png" alt=""></p><p><strong>304 Not Modified: </strong>协商缓存，浏览器在本地没有命中的情况下请求头中发送一定的教研数据到服务端，如果服务端数据没有改变，浏览器从本地缓存响应，返回304。    </p><p>快速，发送的数据很少，只会返回一些基本的响应头信息，数据量很小，不发送实际响应体。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627103903.png" alt=""></p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627104104.png" alt=""></p><p><strong>200 OK：</strong> 以上两种缓存全部失效，服务器返回完整响应。没有用到缓存，相对较慢，对于200 OK不能称之为缓存，因为根本没有用到缓存机制。</p><h2 id="相关-Header"><a href="#相关-Header" class="headerlink" title="相关 Header"></a>相关 Header</h2><ul><li>Pragma</li><li>Expires</li><li>Cache-Control</li></ul><p><strong>Pragma：</strong> HTTP 1.0 时代的遗留产物，该字段被设置为no-cache时，会告知浏览器禁用本地缓存，即每次都向服务器发送请求。</p><p><strong>Expires：</strong>HTTP 1.0 时代用来启用本地缓存的字段，expires值对应一个形式如Thu, 31 Dec 2037 23:55:55 GMT的格林威治时间，告诉浏览器缓存实现的时刻，如果还没到该时刻，标明缓存有效，无需发送请求。</p><p>浏览器与服务器的时间无法保持一致，如果时间差比较大，就会影响缓存结果。我们可以保证服务器的时间，但是无法保证客户端的时间与服务器时间的一致。（QQ 空间就有对客户端时间进行检测，感兴趣的可以将本地时间调整一下然后去访问QQ空间）</p><p><strong>Cache-Control：</strong>HTTP 1.1 针对 Expires 时间不一致的解决方案，运用 Cache-Control 告知浏览器缓存过期时间间隔，而不是时刻，即使具体时间不一致，也不影响缓存的管理。</p><p>在Cache-Control下我们还可以设置一些头信息：</p><ul><li>no-store：禁止浏览器缓存响应</li><li>no-cache：不允许直接使用本地缓存，先发起请求和服务器协商，也就是协商缓存</li><li>max-age=delta-seconds：告知浏览器该响应本地缓存有效的最长期限，以秒为单位。</li></ul><p>优先级： Pragma &gt; Cache-Control &gt; Expires</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627110528.png" alt=""></p><p>在上图中，我们可以看到上面的头信息，设置了Cache-Control和Expires。</p><p><strong>协商缓存</strong>当浏览器没有命中本地缓存，如果本地缓存过期或者响应中生命不允许直接使用本地缓存（Pragma或者Cache-Control设置成了no-cache），那么浏览器肯定会发起服务端请求。服务端会验证数据是否修改，如果没有通知浏览器使用本地缓存。</p><p>相关的Header:</p><ul><li>Last-Modified：通知浏览器资源的最后修改时间，格式如上图。</li><li>If-Modified-Since：这是与Last-Modified相对应的一个头信息，得到资源的最后修改时间后，会将这个信息通过If-Modified-Since提交到服务器进行检查，如果没有修改则返回304状态码。</li><li>ETag: HTTP 1.1 推出，文件的指纹标识符，如果文件内容修改，指纹会改变，Last-Modified只能精确到秒，而 ETag 如果发生了改变，它就会改变，它就相当于文件的标识（”78437822c-6739”），也更加准确。</li><li>If-Node-Match：与ETag相对应的一个头信息，本地缓存失效，会携带此值去请求服务端，服务端判断该资源是否改变，如果没有改变直接使用本地缓存，返回304</li></ul><p>通过下面的两张图，我们可以看到完整的协商缓存交互：</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627112513.png" alt=""></p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180627112544.png" alt="">    </p><h2 id="缓存策略的选择"><a href="#缓存策略的选择" class="headerlink" title="缓存策略的选择"></a>缓存策略的选择</h2><p>适合的内容：</p><ul><li>不变的图像，如logo，图标等</li><li>js、css静态文件</li><li>可下载的内容，媒体文件</li></ul><p>建议使用协商缓存：</p><ul><li>HTML文件</li><li>经常替换的图片</li><li>经常修改的js、css</li><li>js、css问价你的加载可以加入文件的签名来拒绝缓存 （index.css?签名、index.签名.js）</li></ul><p>不建议缓存的内容：</p><ul><li>用户隐私等敏感数据</li><li>经常改变的 api 数据接口</li></ul><h1 id="NGINX-配置缓存策略"><a href="#NGINX-配置缓存策略" class="headerlink" title="NGINX 配置缓存策略"></a>NGINX 配置缓存策略</h1><p>首先，我们使用PHP模拟NGINX的缓存。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    <span class="comment">//1. 获取If-Modified-Since</span></div><div class="line">    $since = $_SERVER[<span class="string">'HTTP_IF_MODIFIED_SINCE'</span>];</div><div class="line"><span class="comment">//2. 设置过期时间一个小时</span></div><div class="line">$lifetime = <span class="number">3600</span>;</div><div class="line"><span class="comment">//3. 如果没有过期直接返回304告诉浏览器使用本地缓存</span></div><div class="line">    <span class="keyword">if</span> (strtotime($since) + $lifetime &gt; time()) &#123;</div><div class="line">header(<span class="string">'HTTP/1.1 304 Not Modified'</span>);</div><div class="line">        <span class="keyword">exit</span>;</div><div class="line">    &#125;</div><div class="line"><span class="comment">//4. 设置最后修改时间</span></div><div class="line">header(<span class="string">'Last-Modified:'</span>. gmdate(<span class="string">'D, d M Y H:i:s'</span>, time()). <span class="string">' GMT'</span>);</div><div class="line"><span class="comment">//5. 网页显示的内容，用于验证是否开启缓存</span></div><div class="line"><span class="keyword">echo</span> time();</div></pre></td></tr></table></figure><p>上述代码就是NGINX的缓存原理，不过NGINX判断的不是3600秒，而是文件的修改时间。</p><p>本地缓存配置</p><p>add_header指令：添加状态码为2XX和3XX的响应头信息。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">add_header</span> name value [always];</div></pre></td></tr></table></figure><p>可以设置Pragma/Expires/Cache-Control，可以继承</p><p>expires指令：通知浏览器过期市场</p><p>expires time; </p><ul><li>为负值时表示Cache-Control:no-cache；</li><li>为正或0时，就表示Cache-Control:max-age=指定的时间；</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</div><div class="line">&#123;</div><div class="line">    expires 30d;</div><div class="line">&#125;</div><div class="line">location ~ .*\.(js|css)?$ </div><div class="line">｛</div><div class="line">expires 12h;</div><div class="line">｝</div></pre></td></tr></table></figure><p>当设为max时，会把Expires设置为”Thu, 31 Dec 2037 23:55:55 GMT”，Cache-Control设置到10年。</p><p>协商缓存配置</p><p>ETag指令：指定签名</p><p>etag on | off 默认是on</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span></div><div class="line">&#123;</div><div class="line">    <span class="attribute">etag</span> <span class="literal">on</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Cache-Control</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location ~ .*\.(js|css)?$ </div><div class="line">｛</div><div class="line">add_header cache-control max-age = 3600;</div><div class="line">｝</div></pre></td></tr></table></figure><h1 id="前端代码和资源的压缩"><a href="#前端代码和资源的压缩" class="headerlink" title="前端代码和资源的压缩"></a>前端代码和资源的压缩</h1><ul><li>优势<ul><li>让资源文件更小</li><li>加快文件在网络中的传输</li><li>让网页更快的展示</li><li>降低带宽和流量的开销</li></ul></li></ul><p>压缩方式</p><ul><li>JS、CSS、图片、HTML代码的压缩</li><li>Gzip压缩</li></ul><h2 id="JavaScript代码压缩"><a href="#JavaScript代码压缩" class="headerlink" title="JavaScript代码压缩"></a>JavaScript代码压缩</h2><p>JavaScript压缩的原理一般是去掉多余的空格和回车、替换长变量名、简化一些代码的写法。</p><p>压缩工具有很多，有在线工具、有应用程序、有编辑器插件。</p><p><strong>常用的压缩工具：</strong></p><ul><li>UglifyJs： 压缩、语法检查、美化代码、代码缩减、转化</li><li>YUI compressor：来自Yahoo，只有压缩功能</li><li>Closure Compiler：来自Google、功能和UglifyJs有些类似，压缩的方式不太一样。</li></ul><h2 id="CSS代码压缩"><a href="#CSS代码压缩" class="headerlink" title="CSS代码压缩"></a>CSS代码压缩</h2><p>原理和JavaScript压缩原理类似，同样是去除空白符、注释并且优化一些CSS语义规则。</p><p><strong>常用的压缩工具：</strong></p><ul><li>YUI compressor：来自Yahoo，只有压缩功能</li><li>CSS Compiler：压缩时候可以选择模式，也可以对一些语法进行优化</li></ul><h2 id="HTML代码压缩"><a href="#HTML代码压缩" class="headerlink" title="HTML代码压缩"></a>HTML代码压缩</h2><p>不建议使用代码压缩，有时会破坏代码结构，可以使用Gzip压缩，当然也可以使用htmlcompressor工具，不过转换后一定要检查代码结构。</p><h2 id="图片压缩"><a href="#图片压缩" class="headerlink" title="图片压缩"></a>图片压缩</h2><p>除了代码的压缩外，有时对图片的压缩也是很有必要的，一般情况下图片在Web系统的比重都比较大。</p><p>压缩工具</p><ul><li>tinypng</li><li>JpegMini</li><li>ImageOptim</li></ul><h2 id="Gzip压缩"><a href="#Gzip压缩" class="headerlink" title="Gzip压缩"></a>Gzip压缩</h2><p>GZIP最早由Jean-loup Gailly和Mark Adler创建，用于UNⅨ系统的<a href="https://baike.baidu.com/item/%E6%96%87%E4%BB%B6%E5%8E%8B%E7%BC%A9" target="_blank" rel="noopener">文件压缩</a>。我们在<a href="https://baike.baidu.com/item/Linux" target="_blank" rel="noopener">Linux</a>中经常会用到后缀为.gz的文件，它们就是GZIP格式的。现今已经成为Internet 上使用非常普遍的一种<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9" target="_blank" rel="noopener">数据压缩</a>格式，或者说一种文件格式。</p><p>HTTP协议上的GZIP编码是一种用来改进WEB应用程序性能的技术。大流量的WEB站点常常使用GZIP<a href="https://baike.baidu.com/item/%E5%8E%8B%E7%BC%A9%E6%8A%80%E6%9C%AF" target="_blank" rel="noopener">压缩技术</a>来让用户感受更快的速度。这一般是指WWW服务器中安装的一个功能，当有人来访问这个服务器中的网站时，服务器中的这个功能就将网页内容压缩后传输到来访的电脑浏览器中显示出来.一般对纯文本内容可压缩到原大小的40%.这样传输就快了，效果就是你点击网址后会很快的显示出来.当然这也会增加服务器的负载. 一般服务器中都安装有这个功能模块的。</p><p>NGINX配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">gzip</span> <span class="literal">on</span>|of <span class="comment">#是否开启gzip</span></div><div class="line">gzip_buffres <span class="number">32</span> <span class="number">4k</span>| <span class="number">16</span> <span class="number">8k</span>; <span class="comment">#缓冲（在内存中缓冲几块，每块多大）</span></div><div class="line"><span class="attribute">gzip_comp_level</span> [<span class="number">1</span>-<span class="number">9</span>] <span class="comment">#推荐6 压缩级别（级别越高，压缩的越小，越浪费CPU计算资源）</span></div><div class="line">gzip_disable <span class="comment">#正则匹配UA什么样的Uri不进行gzip</span></div><div class="line">gzip_min_length <span class="number">200</span> <span class="comment">#开始压缩的最小长度</span></div><div class="line">gzip_http_version <span class="number">1</span>.<span class="number">0</span>|<span class="number">1</span>.<span class="number">1</span> <span class="comment">#开启压缩的http协议版本</span></div><div class="line">gzip_proxied<span class="comment">#设置请求者代理服务器，该如何缓存内容</span></div><div class="line">gzip_types text/plain applecation/xml <span class="comment">#对那些文件类型使用压缩</span></div><div class="line">gzip_vary <span class="literal">on</span> | <span class="literal">off</span> <span class="comment">#是否传输gzip压缩标志</span></div></pre></td></tr></table></figure><h2 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h2><ul><li>自动化构建工具Grunt</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 高并发 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（3）：减少 HTTP 请求</title>
      <link href="/2018/01/12/1/"/>
      <content type="html"><![CDATA[<h2 id="为什么要减少HTTP请求"><a href="#为什么要减少HTTP请求" class="headerlink" title="为什么要减少HTTP请求"></a>为什么要减少HTTP请求</h2><h3 id="性能黄金法则："><a href="#性能黄金法则：" class="headerlink" title="性能黄金法则："></a>性能黄金法则：</h3><p>只有10%~20%的最终永不响应时间花在接收请求的HTML文档上，剩下的80%~90%时间花在HTML文档所引用的所有组件（图片，script，css，flash等等）进行的HTTP请求上。</p><h3 id="如何改善"><a href="#如何改善" class="headerlink" title="如何改善"></a>如何改善</h3><p>改善响应时间的最简单途径就是减少组件的数量，并由此减少HTTP请求的数量。</p><h3 id="HTTP链接产生的开销"><a href="#HTTP链接产生的开销" class="headerlink" title="HTTP链接产生的开销"></a>HTTP链接产生的开销</h3><p>域名解析 – TCP链接 – 发送请求 – 等待 – 下载资源 –  解析时间</p><ul><li>需要注意 DNS 缓存也需要时间，多个缓存就要查找多次有可能缓存会被清除 </li><li>HTTP1.1 协议规定请求只能串行发送，也就是说一百个请求必须一次逐个发送，前面的一个请求完成才能开始下一个请求。</li></ul><h2 id="减少HTTP请求的方式"><a href="#减少HTTP请求的方式" class="headerlink" title="减少HTTP请求的方式"></a>减少HTTP请求的方式</h2><h3 id="图片地图"><a href="#图片地图" class="headerlink" title="图片地图"></a>图片地图</h3><p>图片地图允许你在一个图片上关联多个URL。目标URL的选择取决于用户单击了图片上的哪个位置。 </p><p>我们可以通过使用五个分开的图片，然后每个图片对应一个超链接产生了5个HTTP请求，我们的目标是要减少HTTP请求。</p><p>将五个图片合并成为一张图片，然后以位置信息定位超链接。</p><p>把HTTP请求减少为一个 ，可以暴增设计的完整性和功能的齐全性。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span><span class="tag">&lt;<span class="name">area</span>&gt;</span><span class="tag">&lt;/<span class="name">map</span>&gt;</span><span class="tag">&lt;/<span class="name">map</span>&gt;</span></div></pre></td></tr></table></figure><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>未使用图像地图的例子：</p><p><a href="http://stevesouders.com/hpws/imagemap-no.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/imagemap-no.php</a></p><p>使用图像地图的例子：    </p><p><a href="http://stevesouders.com/hpws/imagemap.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/imagemap.php</a></p><h3 id="CSS-Sprites"><a href="#CSS-Sprites" class="headerlink" title="CSS Sprites"></a>CSS Sprites</h3><p>CSS Sprites 中文翻译为 CSS 精灵，通过使用合并图片，通过指定 CSS 的 backgroud-image 和backgroud-position来显示元素。</p><p><strong>backgroud-position属性</strong></p><p>backgroud-position:x,y; x和y可以写负值也可以写正值，我们可以想象图片的左上方为（0，0），以（0，0）坐标向右是为负数的 X 轴，以（0，0）坐标向下是为负数的 y 轴。</p><p>使用图片精灵的案例：</p><p><a href="http://stevesouders.com/hpws/sprites.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/sprites.php</a></p><p>图片地图和 CSS Sprites 的响应时间基本相同，但比使用各自独立图片的方式要快50%以上。</p><h3 id="合并脚本和样式表"><a href="#合并脚本和样式表" class="headerlink" title="合并脚本和样式表"></a>合并脚本和样式表</h3><p>使用外部的 JS 和 CSS 文件引用的方式，因为这要比直接写在页面中性能要更好一点。</p><p>独立的一个 JS 比用多个 JS 文件组成的页面载入要快38%。</p><p>把多个脚本合并为一个脚本，把多个样式表合并成为一个样式表。</p><p><a href="http://stevesouders.com/hpws/combo-none.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/combo-none.php</a></p><p><a href="http://stevesouders.com/hpws/combo.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/combo.php</a></p><h3 id="图片使用base64编码减少页面请求数"><a href="#图片使用base64编码减少页面请求数" class="headerlink" title="图片使用base64编码减少页面请求数"></a>图片使用base64编码减少页面请求数</h3><p>采用Base64的编码方式将图片直接嵌入到网页中，而不是从外部载入。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"data:image/gif;base64,/9j/4AAqsKZJ....."</span>&gt;</span></div></pre></td></tr></table></figure><p><a href="http://stevesouders.com/hpws/inline-images.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/inline-images.php</a></p><p><a href="http://stevesouders.com/hpws/inline-css-images.php" target="_blank" rel="noopener">http://stevesouders.com/hpws/inline-css-images.php</a></p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 高并发 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（2）：Web资源防盗链</title>
      <link href="/2018/01/11/2/"/>
      <content type="html"><![CDATA[<h1 id="什么是防盗链"><a href="#什么是防盗链" class="headerlink" title="什么是防盗链"></a>什么是防盗链</h1><p>盗链是指在自己的页面上展示一些并不在自己服务器上的内容。</p><p>获得他人服务器上的资源地址，绕过别人的资源展示页面，直接在自己的页面上向最终用户提供此内容。</p><p>常见的是小站盗用大站的图片、音乐、视频、软件等资源。</p><p>通过盗链的方法可以减轻自己服务器的负担，因为真实的空间和流量均是来自别人的服务器。</p><p>防盗链就是防止别人通过一些技术手段绕过本站的资源展示页面，盗用本站的资源，让绕开本站资源展示页面的资源链接失效。</p><h1 id="防盗链的工作原理"><a href="#防盗链的工作原理" class="headerlink" title="防盗链的工作原理"></a>防盗链的工作原理</h1><p>通过 Referer 或者签名，网站可以检测目标网页访问的来源网页，如果是资源文件，则可以跟踪到显示它的网页地址。</p><p>一旦检测到来源不是本站即进行组织或者返回指定的页面。</p><h1 id="Nginx防盗链的实现"><a href="#Nginx防盗链的实现" class="headerlink" title="Nginx防盗链的实现"></a>Nginx防盗链的实现</h1><h2 id="Nginx-Referer"><a href="#Nginx-Referer" class="headerlink" title="Nginx Referer"></a>Nginx Referer</h2><p>Nginx 模块 ngx_http_referer_module 用于阻挡来源非法的域名请求。</p><p>Nginx 指令 valid_referers，全局变量$invalid_referer。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">valid_referers</span> <span class="literal">none</span> | <span class="literal">blocked</span> | server_names| string ...;</div></pre></td></tr></table></figure><p>none: “Referer” 来源头部为空的情况</p><p>blocked: “Referer”来源头部不为空，但是里面的值被代理或者防火墙删除了，这些值都以 <a href="http://或者" target="_blank" rel="noopener">http://或者</a> <a href="https://开头。" target="_blank" rel="noopener">https://开头。</a></p><p>server_names: “Referer” 来源头不包含当前的 server_names</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> ~.*\.(gif|jpg|png|flv|swf|rar|zip)$</div><div class="line">&#123;</div><div class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> maksim.website <span class="regexp">*.maksim.website</span>;</div><div class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">#return 403;</span></div><div class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/http://www.maksim.website/403.jpg</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>针对目录</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> /images/</div><div class="line">&#123;</div><div class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> maksim.website <span class="regexp">*.maksim.website</span>;</div><div class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">#return 403;</span></div><div class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/http://www.maksim.website/403.jpg</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Nginx-HTTPAccessKeyModule-加密签名"><a href="#Nginx-HTTPAccessKeyModule-加密签名" class="headerlink" title="Nginx HTTPAccessKeyModule 加密签名"></a>Nginx HTTPAccessKeyModule 加密签名</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">accesskey</span> <span class="literal">on</span> | <span class="literal">off</span></div><div class="line">accesskey_hashmethod md5 | sha-<span class="number">1</span> </div><div class="line">accesskey_arg GET参数名称</div><div class="line">accesskey_signatrue 加密规则</div></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> ~.*\.(gif|jpg|png|flv|swf|rar|zip)$</div><div class="line">&#123;</div><div class="line">    <span class="attribute">accesskey</span> <span class="literal">on</span></div><div class="line">    accesskey_hashmethod md5</div><div class="line">    accesskey_arg <span class="string">"key"</span></div><div class="line">    accesskey_signatrue <span class="string">"maksim<span class="variable">$remote_addr</span>"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    <span class="comment">//md5(maksim.ip)</span></div><div class="line">    $sign = md5(<span class="string">'maksim'</span>.$_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</div><div class="line"><span class="keyword">echo</span> <span class="string">'&lt;img src="./image/maksim.png?sign='</span>. $sign .<span class="string">'"&gt;'</span>;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>高并发和大流量解决方案（1）：起步</title>
      <link href="/2018/01/10/1/"/>
      <content type="html"><![CDATA[<h1 id="PHP-如何解决网站大流量与高并发的问题"><a href="#PHP-如何解决网站大流量与高并发的问题" class="headerlink" title="PHP 如何解决网站大流量与高并发的问题"></a>PHP 如何解决网站大流量与高并发的问题</h1><h2 id="高并发架构的相关概念"><a href="#高并发架构的相关概念" class="headerlink" title="高并发架构的相关概念"></a>高并发架构的相关概念</h2><h3 id="高并发的概念"><a href="#高并发的概念" class="headerlink" title="高并发的概念"></a>高并发的概念</h3><ul><li><p><strong>并发：</strong>在操作系统中，是指一个时间段中有几个程序都处于已启动运行到运行完毕之间，且这几个程序都是在同一个处理机上运行，但任意一个时刻点上只 有一个程序在处理机上运行。</p><p>上面这一段是摘自百度百科的一段话，但是上面的定义很明显不是我们通常所说的并发，在互联网时代，所讲的并发、高并发，通常是指并发访问。也就是在某一个时间点，有多少个访问同时到来。</p></li><li><p><strong>高并发：</strong> 通常如果一个系统的日 PV 在千万以上，有可能是一个高并发的系统，有的公司完全不走技术路线，全靠机器堆，这不再我们的讨论范围。</p></li></ul><h3 id="高并发中需要关注相关概念"><a href="#高并发中需要关注相关概念" class="headerlink" title="高并发中需要关注相关概念"></a>高并发中需要关注相关概念</h3><ul><li><strong>QPS:</strong>  每秒钟请求或者查询的数量，在互联网领域，指的是每秒响应请求数（指的是HTTP请求）。</li><li><strong>吞吐量：</strong>单位时间内处理的请求数量（通常由QPS与并发数决定）</li><li><strong>响应时间：</strong> 从请求发出到收到响应花费的时间。例如系统处理一个HTTP请求需要 100ms, 这个 100ms 就是系统的响应时间。</li><li><strong>PV：</strong> 综合浏览量（Page View），即页面浏览量或者点击量，一个访客在24小时内访问的页面数量。同一个人浏览你的网站统一页面，只记录一次 PV。</li><li><strong>UV：</strong> 独立访客（UniQue Visitor），即一定时间范围内相同访客多次访问网站，只计算为一个独立访客。</li><li><strong>带宽：</strong>  计算带宽大小需关注两个指标，峰值流量和页面的平均大小</li><li><strong>日网站带宽：</strong> PV/统计时间（换算到秒）*平均页面大小（单位KB）* 8，峰值一般为平均值的倍数，根据实际情况来定。</li><li><strong>压力测试：</strong> 测试服务器能够最大承受的最大并发数和QPS值，对于计算机来说，我们应该知道这台服务器最大能够承受多少QPS，而我们可以通过一天的PV来计算出峰值的QPS，这样我们就可以根据需求进行优化。</li></ul><p><strong>QPS 不等于并发数数量，QPS是每秒HTTP请求数量，并发连接数是系统同时处理的请求数量。</strong></p><p><strong>(总PV数 <em> 80%) / (6小时秒数 </em> 20%) = 峰值每秒请求数量(QPS)</strong>， 80%的访问量集中在20%的时间，那为什么是6个小时呢？</p><p>6个小时主要是做了一个简单的估计，比如说我们访问网站中午两个小时，下午两个小时，晚上两个小时。</p><h3 id="AB-压力测试工具"><a href="#AB-压力测试工具" class="headerlink" title="AB 压力测试工具"></a>AB 压力测试工具</h3><p>常用的性能测试工具：** ab、wrk、http_load、Web Bench、Siege、 Apache Jmeter </p><p>ab 全称是 Apache benchmark，是 Apache 官方推出的工具创建多个并发访问线程，模拟多个访问者同时访问某一URL 地址进行访问。它的测试目标是基于 URL 的，因此，它既可以用来测试 Apache 的负载压力，也可以测试 Nginx、lighthttp、tomact、IIS 等其它 Web 服务器的压力。</p><h4 id="ab-的简单使用"><a href="#ab-的简单使用" class="headerlink" title="ab 的简单使用"></a>ab 的简单使用</h4><p>模拟并发请求100次，总共请求5000次。</p><p>ab -c 100 -n 5000 待测试网站</p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>测试机器与北侧机器分开</li><li>不要对线上服务做压力测试</li><li>观察测试工具 ab 所在机器，以及被测试的前端机的 CPU，内存，网络等都不超过最高限度的75%。</li></ul><h3 id="Q-PS-达到极限"><a href="#Q-PS-达到极限" class="headerlink" title="Q PS 达到极限"></a>Q PS 达到极限</h3><p>随着 QPS 的增长，每个阶段需要根据实际情况来进行优化，优化的方案也与硬件、网络带宽息息相关。</p><h4 id="QPS-达到50"><a href="#QPS-达到50" class="headerlink" title="QPS 达到50"></a>QPS 达到50</h4><p>可以称之为小型网站，一般的服务器都可以应付</p><h4 id="QPS-达到100"><a href="#QPS-达到100" class="headerlink" title="QPS 达到100"></a>QPS 达到100</h4><p>假设关系型数据库的每次请求在0.01秒完成。</p><p>假设单页面只有一个 SQL 查询，那么100QPS 意味着1秒钟完成100个请求，但是此时我们并不能保证数据库查询能完成100次。</p><p><strong>方案：</strong>数据库缓存层、数据库的负载均衡</p><h4 id="QPS-达到800"><a href="#QPS-达到800" class="headerlink" title="QPS 达到800"></a>QPS 达到800</h4><p>假设我们使用百兆带宽，意味着网站出口的实际带宽是8M 左右，假设每个页面只有10K，在这个并发条件下，百兆带宽已经吃完了。</p><p><strong>方案：</strong>CDN 加速、负载均衡</p><h4 id="QPS-达到1000"><a href="#QPS-达到1000" class="headerlink" title="QPS 达到1000"></a>QPS 达到1000</h4><p>假设使用 Memcache 缓存数据库查询数据，每个页面对 Memcache 的请求远大于直接 DB 的请求。</p><p>Memcache 的悲观并发数在2W 左右，但有可能在之前内王带宽已经吃光，表现出不稳定</p><p><strong>方案：</strong>静态 HTML缓存</p><h4 id="QPS-达到2000"><a href="#QPS-达到2000" class="headerlink" title="QPS 达到2000"></a>QPS 达到2000</h4><p>这个级别下，文件系统访问锁都成了灾难。</p><p><strong>方案：</strong>做业务隔离，分布式存储</p><h2 id="高并发解决方案案例"><a href="#高并发解决方案案例" class="headerlink" title="高并发解决方案案例"></a>高并发解决方案案例</h2><h3 id="流量优化"><a href="#流量优化" class="headerlink" title="流量优化"></a>流量优化</h3><ul><li>防盗链处理</li></ul><h3 id="前段优化"><a href="#前段优化" class="headerlink" title="前段优化"></a>前段优化</h3><ul><li>减少 HTTP 请求</li><li>添加异步请求</li><li>启用浏览器缓存和文件压缩</li><li>CDN 加速</li><li>建立独立的图片服务器</li></ul><h3 id="服务端优化"><a href="#服务端优化" class="headerlink" title="服务端优化"></a>服务端优化</h3><ul><li>页面静态化</li><li>并发处理</li><li>队列处理</li></ul><h3 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h3><ul><li>数据库缓存</li><li>分库分表、分区操作</li><li>读写分离</li><li>负载均衡</li></ul><h3 id="Web-服务器优化"><a href="#Web-服务器优化" class="headerlink" title="Web 服务器优化"></a>Web 服务器优化</h3><ul><li>负载均衡（Nginx、LVS）</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>创建型设计模式之抽象工厂</title>
      <link href="/2018/01/09/1/"/>
      <content type="html"><![CDATA[<p>原文地址：<a href="http://designpatternsphp.readthedocs.io" target="_blank" rel="noopener">http://designpatternsphp.readthedocs.io</a></p><p>在软件工程中，创建型设计模式承担着对象创建的职责，尝试创建适合程序上下文的对象，对象创建设计模式的产生是由于软件工程设计的问题，具体说是向设计中增加复杂度，创建型设计模式解决了程序设计中对象创建的问题。</p><h2 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>创建一系列互相关联或依赖的对象时不需要指定将要创建的对象对应的类，因为这些将被创建的对象对应的类都实现了同一个接口。抽象工厂的使用者不需要关心对象的创建过程，它只需要知道这些对象是如何协调工作的。</p><h3 id="UML-图"><a href="#UML-图" class="headerlink" title="UML 图"></a>UML 图</h3><p><img src="http://designpatternsphp.readthedocs.io/zh_CN/latest/_images/uml12.png" alt=""></p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>在 <a href="https://github.com/domnikl/DesignPatternsPHP/tree/master/Creational/AbstractFactory" target="_blank" rel="noopener">GitHub</a> 上查看代码</p><p>AbstractFactory.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * In this case, the abstract factory is a contract for creating some components</div><div class="line"> * for the web. There are two ways of rendering text: HTML and JSON</div><div class="line"> */</div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFactory</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createText</span><span class="params">(string $content)</span>: <span class="title">Text</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>JsonFactory.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonFactory</span> <span class="keyword">extends</span> <span class="title">AbstractFactory</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createText</span><span class="params">(string $content)</span>: <span class="title">Text</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JsonText($content);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>HtmlFactory.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlFactory</span> <span class="keyword">extends</span> <span class="title">AbstractFactory</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createText</span><span class="params">(string $content)</span>: <span class="title">Text</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HtmlText($content);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Text.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>;</div><div class="line"></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Text</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> string</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> $text;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $text)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;text = $text;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>JsonText.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonText</span> <span class="keyword">extends</span> <span class="title">Text</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// do something here</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>HtmlText.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlText</span> <span class="keyword">extends</span> <span class="title">Text</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// do something here</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>\<span class="title">Tests</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>\<span class="title">HtmlFactory</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>\<span class="title">HtmlText</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>\<span class="title">JsonFactory</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Creational</span>\<span class="title">AbstractFactory</span>\<span class="title">JsonText</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractFactoryTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanCreateHtmlText</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $factory = <span class="keyword">new</span> HtmlFactory();</div><div class="line">        $text = $factory-&gt;createText(<span class="string">'foobar'</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(HtmlText::class, $text);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanCreateJsonText</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $factory = <span class="keyword">new</span> JsonFactory();</div><div class="line">        $text = $factory-&gt;createText(<span class="string">'foobar'</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertInstanceOf(JsonText::class, $text);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>DOM本质</title>
      <link href="/2018/01/05/2/"/>
      <content type="html"><![CDATA[<p>抛出问题!</p><ul><li>DOM是那种基本的数据结构？</li><li>DOM操作的常用API都有哪些？</li><li>DOM节点的attr和property有何区别？</li></ul><p>解答问题:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Tove<span class="tag">&lt;/<span class="name">to</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Jani<span class="tag">&lt;/<span class="name">from</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>Don't forget me this weekend!<span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">other</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">other</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="DOM本质"><a href="#DOM本质" class="headerlink" title="DOM本质"></a>DOM本质</h2><p>上面的代码是一段XML，这是一个结构化语言，跟它其同样作用的还有JSON，他们可以用于描述一切可以结构化的数据。</p><p>这段代码快描述了一封信，to收件人，from 来源，title标题，body内容。</p><p>DOM本质上是一个树形结构。我们可以将其理解为，浏览器把拿到的HTML代码，结构化成一个浏览器能够识别且能被js操作的一个模型。</p><p>我们知道HTML本质上就是字符串，计算机处理字符串是一件相当头疼的一件事情，通过DOM，我们就可以将HTML文件抽象成一个树形结构，只要是结构化的数据，计算机处理起来，无论你的逻辑结构有多复杂，他都能够轻松的进行处理。</p><h2 id="获取DOM节点"><a href="#获取DOM节点" class="headerlink" title="获取DOM节点"></a>获取DOM节点</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> div1 = <span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>) <span class="comment">//元素 </span></div><div class="line"><span class="keyword">var</span> divList = <span class="built_in">document</span>.getElementByTagName(<span class="string">'div'</span>) <span class="comment">//集合</span></div><div class="line"><span class="built_in">console</span>.log(divList.length)</div><div class="line"><span class="built_in">console</span>.log(divList[<span class="number">0</span>])</div><div class="line"></div><div class="line"><span class="keyword">var</span> containerList = <span class="built_in">document</span>.getElementsByClassName(<span class="string">'.container'</span>);  <span class="comment">//集合</span></div><div class="line"><span class="keyword">var</span> pList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'p'</span>) <span class="comment">//集合</span></div></pre></td></tr></table></figure><p>上面的代码都是JavaScript的基础API，有的人可能用jQuery或其他的的库时间长了，就把基础API给忘了，或者是基础并不是很牢，一直都在用库，这样的话最好将基础补齐，因为在面试的时候，大多数的面试题都是问的基础。</p><p>在面试的时候有个技巧，不要轻易的撩起用的熟，但是不知道实现原理的东西，比如说你会用jQuery的绑定事件，面试官肯定会问你实现原理。</p><h2 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'p'</span>)</div><div class="line"><span class="keyword">var</span> p = pList[<span class="number">0</span>]</div><div class="line"><span class="built_in">console</span>.log(p.style.width) <span class="comment">//获取样式</span></div><div class="line">p.style.width = <span class="string">'100px;'</span></div><div class="line"><span class="built_in">console</span>.log(p.className)</div><div class="line">p.className = <span class="string">'p1'</span></div><div class="line"></div><div class="line"><span class="comment">//获取nodeName 和 nodeType</span></div><div class="line"><span class="built_in">console</span>.log(p.nodeName)</div><div class="line"><span class="built_in">console</span>.log(p.nodeType)</div></pre></td></tr></table></figure><p>在这里我们需要知道P是个什么东西，它不就是个DOM节点吗？</p><p>其实它本质上就是一个JS对象。上面我们说过DOM的本质是一个JS可识别可操作的。既然本质上是一个对象，我们就可以操作他的属性，那这些属性都是怎么进去的？</p><p>这是浏览器规定的，W3C就是这么规定的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> obj &#123;<span class="attr">x</span>:<span class="number">100</span>, <span class="attr">y</span>:<span class="number">200</span>&#125;;</div><div class="line"><span class="built_in">console</span>.log(obj.x) <span class="comment">// 100</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'p'</span>)[<span class="number">0</span>]</div><div class="line">cosnole.log(p.nodeName); <span class="comment">//p</span></div></pre></td></tr></table></figure><h2 id="Attribute"><a href="#Attribute" class="headerlink" title="Attribute"></a>Attribute</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'p'</span>)</div><div class="line"><span class="keyword">var</span> p = pList[<span class="number">0</span>]</div><div class="line">p.getAttribute(<span class="string">'data-name'</span>)</div><div class="line">p.setAttribute(<span class="string">'data-name'</span>, <span class="string">'maksim'</span>)</div><div class="line">p.getAttribute(<span class="string">'style'</span>)</div><div class="line">p.setAttribute(<span class="string">'style'</span>, <span class="string">'font-size:30px;'</span>)</div></pre></td></tr></table></figure><p>我们在上述代码中该的 <code>data-name</code> 和 <code>style</code> 到底是什么呢？</p><p>其实就是HTML文档里的标签，并不是JavaScript里的对象。这也是两者之间的区别。</p>]]></content>
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>cookie, sessionStorage和localStorage的区别</title>
      <link href="/2018/01/05/1/"/>
      <content type="html"><![CDATA[<p>在HTML5出来之前，只有cookie作为本地存储的一个方法（JavaScript Web API）。</p><h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><ul><li>本身用于客户端和服务器端通信的，</li><li>但是它有本地存储的功能， 于是被“借用”</li><li>使用document.cookie = … 获取和修改即可，用起来特别麻烦</li></ul><p>缺点：</p><ul><li>存储量太小，只有4kb</li><li>所有http请求都带着，会影响获取资源的效率，所以cookie只适合保存很小的数据，如会话标识</li><li>API简单，需要封装才能用document.cookie = …</li><li><p>有效时长根据设定的过期时间而定。</p><p>​</p></li></ul><h2 id="sessionStorage-和localStorage"><a href="#sessionStorage-和localStorage" class="headerlink" title="sessionStorage 和localStorage"></a>sessionStorage 和localStorage</h2><ul><li>HTML5专门为存储而设计，因为不需要像服务端发送数据，所以最大容量5M</li><li>API简单易用：</li><li>localStorage.setItem(key, value); localStorage.getItem(key)</li><li>sessionStorage当关闭浏览器后便会被清除，localStorage则不会，即使关闭浏览器localStorage也会一直存在，直到删除</li><li>sessionStorage不在不同的浏览器窗口中共享，即使是同一个页面；localStorage 在所有同源窗口中都是共享的</li><li>在iOS Safari 隐匿模式下，localStorage.getItem会报错，建议同一使用try-catch</li><li>Web Storage 支持事件通知机制，可以将数据更新的通知发送给监听者</li></ul>]]></content>
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>如何学习 - 读《请停止无效努力》</title>
      <link href="/2017/12/02/1/"/>
      <content type="html"><![CDATA[<p>我们从出生直至死亡都在学习中度过，出生后我们学习如何行走，说话，恋爱，各式各样种样繁多的知识，到死了，我们要学会放下。</p><p>通过阅读《请停止无效努力》一书中就详细的介绍了如何学习，怎样学习更高效，这本书的核心的观点就是<strong>靠意志力学习是幻想</strong>。</p><h2 id="如何快乐地学习"><a href="#如何快乐地学习" class="headerlink" title="如何快乐地学习"></a>如何快乐地学习</h2><ul><li>第一，我们喜欢这个学习内容，或者学习本身。</li><li>第二，我们能够学得好，能够让自己有成就感</li><li>第三，这种学习能够帮我们带来价值</li></ul><h2 id="如何快乐并且有效地持续学习"><a href="#如何快乐并且有效地持续学习" class="headerlink" title="如何快乐并且有效地持续学习"></a>如何快乐并且有效地持续学习</h2><ul><li>第一，按需学习：学习这个东西是否对现阶段有价值。</li><li>第二，调整心态：对待学习的态度，决定了我们是否喜欢它。</li><li>第三，提升元认知策略：每个人有不同的学习风格，了解自己的风格并且调整学习方法，能够大大提高学习效率。</li><li>第四，正确犯错：人类的大脑是从犯错中学习的，能否从错误中学习，决定了我们从学习中获得的成就感还是挫败感。</li></ul><h3 id="成人与孩子对于学习的区别"><a href="#成人与孩子对于学习的区别" class="headerlink" title="成人与孩子对于学习的区别"></a>成人与孩子对于学习的区别</h3><ul><li>第一，自愿</li><li>第二，经验</li><li>第三，自主</li><li>第四，行动</li></ul><p>由于成人与孩子的学习方式不同，综合以上四点，在选择学习内容的时候，我们需要遵循的原则是：</p><ul><li>原则一——有用：对我们现阶段有用的，这个用处不一定是工作或者赚钱，也可以是让人放松等等。</li><li>原则二——匹配：跟我们的经验北京相匹配的，不会太粗浅，也不会太深奥。</li><li>原则三——参与：能够有参与感的，手脚是的学习最好不要参与。</li><li>原则四——应用：可以应用到行动中去的，跟我们的工作、生活相结合的。</li></ul>]]></content>
      
      <categories>
          
          <category> 读书笔记 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>C语言中的内存</title>
      <link href="/2017/10/21/1/"/>
      <content type="html"><![CDATA[<p>C 程序在编译后，会以三种形式使用内存。</p><ul><li>静态变量/全局内存</li></ul><p>静态声明的变量分配在这里，全局变量也会使用这部分内存。这些内存在程序开始运行时分配，直到程序终止才会消失。所有函数都能访问全局变量，静态变量的作用域则局限在定义它们的函数内部。</p><ul><li>自动内存</li></ul><p>这些变量在函数内部声明，并且在函数被调用时才能创建。它们的作用域局限于函数内部，而且在函数被调用才创建。它们的作用域局限于函数内部，热切声明周期限制在函数的执行时间内。</p><ul><li>动态内存</li></ul><p>内存分派在堆上，可以根据需要存放，而且直到释放才消失。指针引用分配的内存，作用域局限于引用内存的指针。</p>]]></content>
      
      <categories>
          
          <category> C/C++ </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（05）：  =与==、===的区别</title>
      <link href="/2017/10/17/1/"/>
      <content type="html"><![CDATA[<p><strong>什么是引用变量？在 PHP 当中，用什么符号定义引用变量？</strong></p><p>在 PHP 中引用意味着通过不同的名字访问相同的变量内容。使用&amp;符号。</p><p><strong>工作原理</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义一个变量</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">1000</span>);</div></pre></td></tr></table></figure><p>PHP 在定义变量的时候，会在内存中开辟出一块内存空间，然后将$a 指向该内存空间。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义变量 b，将 a 变量的值赋值给变量 b</span></div><div class="line">$a = $b;</div></pre></td></tr></table></figure><p>此时在定义 $b 的时候并不会在内存中开辟空间，因为对于 PHP 来说有一个 Copy On Write机制（写时复制），也就是在 $a, $b 修改的时候才会进行 copy。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//对 a 进行修改</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">1000</span>);</div></pre></td></tr></table></figure><p>此时才会开辟一块空间，在 PHP 中我们无法像 C 语言一个做到输出指针地址，所以无法查看内存分配情况，但是我们可以使用<code>memory_get_usage()</code>来查看内存的使用情况。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义一个变量</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">1000</span>);</div><div class="line">var_dump(memory_get_usage());</div><div class="line"><span class="comment">//定义变量 b，将 a 变量的值赋值给变量 b</span></div><div class="line">$a = $b;</div><div class="line">var_dump(memory_get_usage());</div><div class="line"><span class="comment">//对 a 进行修改</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">1000</span>);</div><div class="line">var_dump(memory_get_usage());</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int(<span class="number">369104</span>)<span class="comment">//声明赋值 a</span></div><div class="line">int(<span class="number">369224</span>)<span class="comment">//声明变量 b，将 a 变量的值复制给 b</span></div><div class="line">int(<span class="number">513728</span>)<span class="comment">//写时复制</span></div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义一个变量</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">1000</span>);</div><div class="line">var_dump(memory_get_usage());</div><div class="line"><span class="comment">//定义变量 b，将 a 变量的值赋值给变量 b</span></div><div class="line">$a = &amp;$b;</div><div class="line">var_dump(memory_get_usage());</div><div class="line"><span class="comment">//对 a 进行修改</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">1000</span>);</div><div class="line">var_dump(memory_get_usage());</div></pre></td></tr></table></figure><p>在上一段代码中使用了&amp;引用变量，这个时候就不会再出现重新分配空间的情况了，因为 $b 指向的就是 $a 的内存空间。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//zval 变量容器</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">3</span>);</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div></pre></td></tr></table></figure><p>执行上面的代码就可以看到 zval 结构体</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">a:(refcount=1, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div></pre></td></tr></table></figure><p><strong>refcount:</strong> 引用计数器</p><p><strong>is_ref :</strong>是否引用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//zval 变量容器</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">3</span>);</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div><div class="line"></div><div class="line">$b = $a;</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">a:(refcount=1, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div><div class="line"></div><div class="line">a:(refcount=2, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div></pre></td></tr></table></figure><p>此时 refcount 就变成了2</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//zval 变量容器</span></div><div class="line">$a = range(<span class="number">0</span>, <span class="number">3</span>);</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div><div class="line"></div><div class="line">$b = $a;</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div><div class="line"></div><div class="line"><span class="comment">//修改 a</span></div><div class="line">a = range(<span class="number">0</span>, <span class="number">3</span>);</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">a:(refcount=1, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div><div class="line"></div><div class="line">a:(refcount=2, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div><div class="line"></div><div class="line">a:(refcount=1, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div></pre></td></tr></table></figure><p>到第三步的时候 refcount 恢复到了1，因为 $a 进行了写操作。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$a = range(<span class="number">0</span> ,<span class="number">3</span>);</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div><div class="line"></div><div class="line">$b = &amp;a;</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div><div class="line"></div><div class="line">a = range(<span class="number">0</span>, <span class="number">3</span>);</div><div class="line">xdebug_debug_zval(<span class="string">'a'</span>);</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">a:(refcount=1, is_ref=0)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div><div class="line"></div><div class="line">a:(refcount=2, is_ref=1)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div><div class="line"></div><div class="line">a:(refcount=2, is_ref=1)=array(0 =&gt; (refcount=1, is_ref=0) )=0, 1=&gt;(refcount=1, is_ref=0)=1,2=&gt;(refcount=1, is_ref=0)=2,3=&gt;(refcount=1, is_ref=0)=3)</div></pre></td></tr></table></figure><p>当我们使用unse函数时，需要知道，只会取消引用，不会销毁空间。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$a = <span class="number">1</span>;</div><div class="line">$b = &amp;$a;</div><div class="line"><span class="keyword">unset</span>($b);</div><div class="line"><span class="keyword">echo</span> $a. <span class="string">"\n"</span>;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1</div></pre></td></tr></table></figure><p>对象本身就是引用传递</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> $name = <span class="string">'zhangsan'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$p1 = <span class="keyword">new</span> Person;</div><div class="line">xdebug_debug_zval(<span class="string">'p1'</span>);</div><div class="line">$p2 = $p1;</div><div class="line">xdebug_debug_zval(<span class="string">'p1'</span>);</div><div class="line">$p2-&gt;name = <span class="string">'lisi'</span>;</div><div class="line">xdebug_debug_zval(<span class="string">'p1'</span>);</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">p1: (refcount=1, is_ref=0) = class Person &#123; public $name = (refcount=2, is_ref=0)=&apos;zhangsan&apos;&#125;</div><div class="line">p1: (refcount=2, is_ref=0) = class Person &#123; public $name = (refcount=2, is_ref=0)=&apos;zhangsan&apos;&#125;</div><div class="line">p1: (refcount=2, is_ref=0) = class Person &#123; public $name = (refcount=1, is_ref=0)=&apos;zhangsan&apos;&#125;</div></pre></td></tr></table></figure><p>面试题：</p><p>写出如下程序结果</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">$data = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>];</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">    $value = &amp;$data[$key];</div><div class="line">&#125;</div></pre></td></tr></table></figure><ol><li>程序运行时，每一次循环结束后变量$data 的值是什么？请解释。</li><li>程序执行完成后，变量$data 的值是什么？请解释</li></ol><p>答案:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span></div><div class="line">[a,b,c]</div><div class="line">[b,b,c]</div><div class="line">[b,c,c]</div><div class="line"></div><div class="line"><span class="number">2.</span></div><div class="line">[b,c,c]</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$k=<span class="number">0</span>;</div><div class="line">$v=a;</div><div class="line">$v=&amp;d[<span class="number">0</span>];</div><div class="line"></div><div class="line">$k=<span class="number">1</span>;</div><div class="line">$v=b =&gt; d[<span class="number">0</span>] = b;</div><div class="line">$v=&amp;$d[<span class="number">1</span>];</div><div class="line"></div><div class="line">$k=<span class="number">2</span>;</div><div class="line">$v=c;</div><div class="line">d[<span class="number">1</span>] = c;</div><div class="line">$v=&amp;$d[<span class="number">2</span>];</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（05）：运算符</title>
      <link href="/2017/10/17/2/"/>
      <content type="html"><![CDATA[<h1 id="面试真题"><a href="#面试真题" class="headerlink" title="面试真题"></a>面试真题</h1><h2 id="foo-和-foo-之间的区别"><a href="#foo-和-foo-之间的区别" class="headerlink" title="foo()和@foo()之间的区别"></a>foo()和@foo()之间的区别</h2><h3 id="考点分析"><a href="#考点分析" class="headerlink" title="考点分析"></a>考点分析</h3><ul><li>PHP 的运算符的错误控制符@的使用</li></ul><h3 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h3><ul><li>PHP 所有的运算符考点</li><li>运算符的优先级</li><li>比较运算符</li><li>递增/递减运算符</li><li>逻辑运算符</li></ul><h3 id="错误运算符"><a href="#错误运算符" class="headerlink" title="错误运算符"></a>错误运算符</h3><p>PHP 支持一个错误运算符：@，当将其放置在一个 PHP 表达式之前，该表达式可能产生一个任何错误信息都被忽略。</p><h3 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h3><p>如果看过 PHP 手册应该都知道，在其中有一个表格。</p><table><thead><tr><th>结合方向</th><th>运算符</th><th>附加信息</th></tr></thead><tbody><tr><td>无</td><td>clone new</td><td><a href="http://us3.php.net/manual/zh/language.oop5.cloning.php" target="_blank" rel="noopener">clone</a> 和 <a href="http://us3.php.net/manual/zh/language.oop5.basic.php#language.oop5.basic.new" target="_blank" rel="noopener">new</a></td></tr><tr><td>左</td><td><em>[</em></td><td><a href="http://us3.php.net/manual/zh/function.array.php" target="_blank" rel="noopener">array()</a></td></tr><tr><td>右</td><td><strong>\</strong></td><td><a href="http://us3.php.net/manual/zh/language.operators.arithmetic.php" target="_blank" rel="noopener">算术运算符</a></td></tr><tr><td>右</td><td><em>++</em> <em>–</em> <em>~</em> <em>(int)</em> <em>(float)</em> <em>(string)</em> <em>(array)</em> <em>(object)</em> <em>(bool)</em> <em>@</em></td><td><a href="http://us3.php.net/manual/zh/language.types.php" target="_blank" rel="noopener">类型</a>和<a href="http://us3.php.net/manual/zh/language.operators.increment.php" target="_blank" rel="noopener">递增／递减</a></td></tr><tr><td>无</td><td><em>instanceof</em></td><td><a href="http://us3.php.net/manual/zh/language.types.php" target="_blank" rel="noopener">类型</a></td></tr><tr><td>右</td><td><em>!</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.logical.php" target="_blank" rel="noopener">逻辑运算符</a></td></tr><tr><td>左</td><td><em>** </em>/<em> </em>%*</td><td><a href="http://us3.php.net/manual/zh/language.operators.arithmetic.php" target="_blank" rel="noopener">算术运算符</a></td></tr><tr><td>左</td><td><em>+</em> <em>-</em> <em>.</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.arithmetic.php" target="_blank" rel="noopener">算术运算符</a>和<a href="http://us3.php.net/manual/zh/language.operators.string.php" target="_blank" rel="noopener">字符串运算符</a></td></tr><tr><td>左</td><td><em>&lt;&lt;</em> <em>&gt;&gt;</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.bitwise.php" target="_blank" rel="noopener">位运算符</a></td></tr><tr><td>无</td><td><em>&lt;</em> <em>&lt;=</em> <em>&gt;</em> <em>&gt;=</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.comparison.php" target="_blank" rel="noopener">比较运算符</a></td></tr><tr><td>无</td><td><em>==</em> <em>!=</em> <em>===</em> <em>!==</em> <em>&lt;&gt;</em> <em>&lt;=&gt;</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.comparison.php" target="_blank" rel="noopener">比较运算符</a></td></tr><tr><td>左</td><td><em>&amp;</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.bitwise.php" target="_blank" rel="noopener">位运算符</a>和<a href="http://us3.php.net/manual/zh/language.references.php" target="_blank" rel="noopener">引用</a></td></tr><tr><td>左</td><td><em>^</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.bitwise.php" target="_blank" rel="noopener">位运算符</a></td></tr><tr><td>左</td><td>*\</td><td>*</td><td><a href="http://us3.php.net/manual/zh/language.operators.bitwise.php" target="_blank" rel="noopener">位运算符</a></td></tr><tr><td>左</td><td><em>&amp;&amp;</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.logical.php" target="_blank" rel="noopener">逻辑运算符</a></td></tr><tr><td>左</td><td>*\</td><td>\</td><td>*</td><td><a href="http://us3.php.net/manual/zh/language.operators.logical.php" target="_blank" rel="noopener">逻辑运算符</a></td></tr><tr><td>左</td><td><em>??</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.comparison.php" target="_blank" rel="noopener">比较运算符</a></td></tr><tr><td>左</td><td><em>? :</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.comparison.php#language.operators.comparison.ternary" target="_blank" rel="noopener">ternary</a></td></tr><tr><td>right</td><td><em>=</em> <em>+=</em> <em>-=</em> <strong>=* </strong>*=<em> </em>/=<em> </em>.=<em> </em>%=<em> </em>&amp;=<em> </em>\</td><td>=<em> </em>^=<em> </em>&lt;&lt;=<em> </em>&gt;&gt;=*</td><td><a href="http://us3.php.net/manual/zh/language.operators.assignment.php" target="_blank" rel="noopener">赋值运算符</a></td></tr><tr><td>左</td><td><em>and</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.logical.php" target="_blank" rel="noopener">逻辑运算符</a></td></tr><tr><td>左</td><td><em>xor</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.logical.php" target="_blank" rel="noopener">逻辑运算符</a></td></tr><tr><td>左</td><td><em>or</em></td><td><a href="http://us3.php.net/manual/zh/language.operators.logical.php" target="_blank" rel="noopener">逻辑运算符</a></td></tr></tbody></table><p>上面这一章大表，我们不需要全部记忆，应该着重记忆在面试中经常出现的考点。</p><p><strong>递增/递减  &gt; ! &gt; 算数运算符 &gt; 大小比较 &gt; （不）相等比较 &gt; 引用 &gt; 位运算 (^)&gt; 位运算(|)&gt;逻辑与 &gt; 逻辑或 &gt; 三目 &gt; 赋值 &gt; and &gt; xor &gt; or </strong></p><p><strong>注意</strong></p><ul><li>括号可以增加代码的可读性，推荐使用</li><li>不建议使用 ++、–，因为这样的代码可读性不高，在 swift 中都已经废弃了此类运算符。</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（08）： 开发环境与运行原理</title>
      <link href="/2017/10/17/4/"/>
      <content type="html"><![CDATA[<h1 id="真题：你是否使用过版本控制器，如果有你使用的版本控制器的名称是什么？"><a href="#真题：你是否使用过版本控制器，如果有你使用的版本控制器的名称是什么？" class="headerlink" title="真题：你是否使用过版本控制器，如果有你使用的版本控制器的名称是什么？"></a>真题：你是否使用过版本控制器，如果有你使用的版本控制器的名称是什么？</h1><p>考点：</p><ul><li>版本控制软件</li><li>PHP 的运行原理</li><li>PHP 常见的配置项</li></ul><p>常见的版本控制软件分为集中式和分布式，其中 SVN 就是集中式的，有一个中央服务器，代码编写完成后将代码同步至中央服务器，版本信息只保存在中央服务器。</p><p>Git是目前最流行的分布式的版本控制器，没有中央服务器，所有客户机都有一套完整的版本库信息，对于版本控制的容灾性。</p><h1 id="PHP-的运行原理-NGINX-PHP-fm"><a href="#PHP-的运行原理-NGINX-PHP-fm" class="headerlink" title="PHP 的运行原理 NGINX + PHP-fm"></a>PHP 的运行原理 NGINX + PHP-fm</h1><p><code>CGI</code>，早期的 Web Server 服务只能处理一些简单的 HTMl 文件，随着技术的发展出现了动态语言比如说PHP、Python，如果说我们要处理PHP的话，需要交给PHP解析器去处理，处理完成后需要与Web服务进行通信。为了解决不同语言与Web Server的通信，就出现了 CGI 协议，只要按照 CGI 程序编写程序就能够实现语言解析器和Web Server的通信</p><p><code>FastCGI</code>: 虽然CGI解决PHP和Web Server通信的问题，但是它的效率很低，因为Web Server每接收一个请求都会fork一个CGI进程，然后请求结束后再Kill掉这个进程，如果有一万个、十万个请求就会产生大量的进程，然后在Kill掉，这样一来会浪费掉很多资源。这样 <code>FastCGI</code> 出现了，主要是以 CGI 的改良版本出现的，请求完成后不会kill掉进程，而是保留进程，使这个进程可以处理多个进程，这样就不用fork 进程了，节约了大量的资源。</p><p><code>PHP-FPM</code>:<strong>是PHP的 <code>FastCGI</code> 的进程管理器</strong>，PHP-FPM 是 FastCGI 的一个实现，并且实现了进程管理的功能，其中包括master和work进程，master进程负责监听端口号（默认是9000）接收来自Web Server的请求，work进程有多个，根据FPM的配置进行定义，每个进程都会嵌入一个PHP解析器，也就是PHP代码真正执行的地方。</p><p>NGINX通过反向代理，代理PHP-FPM监听的端口。</p><h1 id="PHP常见的配置项"><a href="#PHP常见的配置项" class="headerlink" title="PHP常见的配置项"></a>PHP常见的配置项</h1><ul><li>register_globals</li><li>allow_url_fopen</li><li>allow_url_include</li><li>date.timezone</li><li>display_errors</li><li>error_reporting</li><li>safe_mode</li><li>upload_max_filesize</li><li>max_file_uploads</li><li>post_max_size</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP基础 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（07）： 写出 PHP 类的权限控制修饰符？</title>
      <link href="/2017/10/17/3/"/>
      <content type="html"><![CDATA[<h1 id="面试真题：写出-PHP-类的权限控制修饰符？"><a href="#面试真题：写出-PHP-类的权限控制修饰符？" class="headerlink" title="面试真题：写出 PHP 类的权限控制修饰符？"></a>面试真题：写出 PHP 类的权限控制修饰符？</h1><ul><li>考点：PHP的类权限控制修饰符</li><li>延伸：面向对象的封装、继承和多态</li><li>延伸：魔术方法</li><li>延伸：设计模式</li></ul><p>这一题的单很简单，就是考察我们的基础知识：<code>public</code>、<code>protected</code>、<code>private</code>。</p><p><code>public</code>：修饰的成员变量拥有最高权限，我们可以在类的内部、外部，子类中使用。</p><p><code>protected</code>：可是在类的内部，类的子类中使用，可以被继承，但是不能在外部使用。</p><p><code>private</code>: 只能在类的内部使用，不能被继承。</p><h2 id="单一继承"><a href="#单一继承" class="headerlink" title="单一继承"></a>单一继承</h2><p>在面试过程中经常会问到PHP的继承模式，这里我们需要注意，PHP是<em><strong>单一继承</strong></em>;</p><h2 id="方法重写"><a href="#方法重写" class="headerlink" title="方法重写"></a>方法重写</h2><p>继承还有<strong>方法重写</strong>，在继承的时候，如果子类存在于父类相同的方法名时，子类会覆盖掉父类的方法，如果不想被子类重写，需要使用 <strong><code>final</code></strong> 关键字！</p><p>如果子类重写父类方法后，需要使用父类该方法的功能，需要使用 <strong><code>parent</code></strong>关键字。</p><h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><p>PHP面试很少回去考多态，但是我们需要了解抽象类和接口的定义。</p><h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><p>下列魔术方法需要我们特别记忆：</p><ul><li>__construct()</li><li>__destruct()</li><li>__call()</li><li>__callStatic()</li><li>__get()</li><li>__set()</li><li>__isset()</li><li>__unset()</li><li>__sleep()</li><li>__wakeup()</li><li>__toString()</li><li>__clone()</li></ul><h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><p>常见的设计模式：工厂模式、单利模式、注册树设计模式、适配器模式、观察者模式和策略模式</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP基础 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（04）：常量以及数据类型</title>
      <link href="/2017/10/16/4/"/>
      <content type="html"><![CDATA[<p><strong>PHP 中字符串可以使用哪三种定义方法以及各自的区别是什么？</strong></p><p>PHP的字符串的定义方式</p><ul><li>单引号</li><li>双引号</li><li>hereDoc 和 newdoc</li></ul><p>单引号的区别</p><ul><li>单引号不能解析变量</li><li>单引号不能解析转义字符，只能解析单引号和反斜线本身</li><li>变量和变量、变量和字符串、字符串和字符串之间可以用<code>.</code>链接</li></ul><p>双引号的区别</p><ul><li>双引号可以解析变量，变量可以使用特殊字符和<code>{}</code>包含</li><li>双引号可以解析所有的转义字符</li><li>也可以使用<code>.连</code>接</li></ul><p>单引号的效率要高于双引号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$str = <span class="string">'abcdef $a g'</span>; <span class="comment">// $a 会被原样输出</span></div><div class="line">$str = <span class="string">"abcdef '&#123;$a&#125;' gh"</span>;<span class="comment">// 不会输出&#123;&#125;只做分割的作用</span></div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$sql = <span class="string">"SELECT * FROM user WHERE name = '$name'"</span>;</div><div class="line"></div><div class="line"><span class="comment">//可以用单引号改写成</span></div><div class="line">$sql = <span class="string">'SELECT * FROM user WHERE name = \''</span>.$name.<span class="string">'\''</span>;</div></pre></td></tr></table></figure><p>Heredoc 和 NewDoc 的区别</p><ul><li>Heredoc 类似于双引号</li><li>Newdoc 类似于单引号</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//HereDoc</span></div><div class="line">$str &lt;&lt;&lt; EoT</div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">EoT;</div><div class="line"></div><div class="line"><span class="comment">//NewDoc</span></div><div class="line">$str &lt;&lt;&lt; <span class="string">'EoT'</span></div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">EoT;</div></pre></td></tr></table></figure><p>浮点类型</p><ul><li>不能用于比较运算当中</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$a = <span class="number">0.1</span>;</div><div class="line">$b = <span class="number">0.7</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($a + $b == <span class="number">0.8</span>) &#123;</div><div class="line">    <span class="comment">//$a + $b == 0.7999</span></div><div class="line">    <span class="keyword">echo</span> <span class="string">'true'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>PHP 在进行计算的时候，会把0.1和0.7交给 CPU 进行计算，CPU 会将浮点型转换为二进制，就会出现损耗。</p><p><strong>布尔类型 FALSE 的七种情况：</strong></p><p>整型0、浮点0.0、布尔 FALSE、空字符串、0字符串、空数组、NULL</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>, <span class="number">0.0</span>, <span class="string">''</span>, <span class="string">'0'</span>, <span class="keyword">false</span>, <span class="keyword">array</span>(), <span class="keyword">NULL</span>  <span class="comment">//if 判断为 FALSE</span></div></pre></td></tr></table></figure><p><strong>超全局数组</strong></p><p>$GLOBALS、$_GET、$_POST、$_REQUEST、$_SESSION、$_COOKIE、$_SERVER、$_FILES、$_ENV</p><ul><li>$_SERVER[‘SERVER_ADDR’]：服务器的 IP 地址_</li><li>$_SERVER[‘SERVER_NAME’]：服务器的名称</li><li>$_SERVER[‘REQUEST_TIME’]：请求时间</li><li>$_SERVER[‘ QUERY_STRING’]：请求参数</li><li>$_SERVER[‘HTTP_REFERER’]: 访问来源</li><li>$_SERVER[‘HTTP_USER_AGENT’]：HTTP_USER_AGENT信息</li><li>$_SERVER[‘REMOTE_ADDR’]：客户端 IP</li><li>$_SERVER[‘REQUEST_URI’]：<a href="http://www.www.com/1" target="_blank" rel="noopener">http://www.www.com/1</a> 后面的1</li><li>$_SERVER[‘PATH_INFO’]：路径部分</li></ul><p><strong>NULL的三种情况</strong></p><p>直接赋值 NULL、未定义的变量、unset 销毁的变量</p><p><strong>常量定义区别</strong></p><ul><li>const 是语言结构更快</li><li>define 是函数</li><li>define 不能用于类常量的定义，const 可以</li></ul><p><strong>预定义常量</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">__FILE__</span>;<span class="keyword">__LINE__</span>;<span class="keyword">__DIR__</span>;<span class="keyword">__FUNCTION__</span>;<span class="keyword">__CLASS__</span>;__TRAIT__;<span class="keyword">__METHOD__</span>;<span class="keyword">__NAMESPACE__</span></div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP基础 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（02）： emtpy、isset、is_null的区别</title>
      <link href="/2017/10/16/2/"/>
      <content type="html"><![CDATA[<p>PHP提供了3个用于测试变量值的函数，分别是isset()、empty()、is_null（从这里就可以看出PHP系统函数变量名命名的混乱，这也是一直被人诟病的地方）.这几个函数均返回布尔值，有时使用不当会造成意想不到的结果。</p><p>比如，用isset()和empty()返回的结果是相反的，但却并非一直如此。</p><p>isset()用来检测一个变量是否已声明且值不为null。只能在变量不是null时返回真。</p><p>empty()用来检测一个变量是否为空，也就是说有如下情况时返回真值：变量是一个空字符串，false，空数组,null,’’,以及被unset删除后的变量。</p><blockquote><p>在PHP5.5之后，empty()函数可以接受任意类型的表达式</p></blockquote><p>is_null()函数用来判断变量内容是否是null，即返回真值的条件仅为变量值是null，值得一提的是，is_null() 是 isset() 的反函数，区别是isset()函数可以应用到未知变量，但is_null()只能针对以声明的变量。</p><table><thead><tr><th>对比项</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>变量值($var)</td><td>isset($var)</td><td>empty($var)</td><td>is_null($var)</td></tr><tr><td>“”（空字符串）</td><td>bool(true)</td><td>bool(true)</td><td>bool(false)</td></tr><tr><td>“ “(空格)</td><td>bool(true)</td><td>bool(false)</td><td>bool(false)</td></tr><tr><td>FALSE</td><td>bool(true)</td><td>bool(true)</td><td>bool(false)</td></tr><tr><td>TRUE</td><td>bool(true)</td><td>bool(false)</td><td>bool(false)</td></tr><tr><td>array()</td><td>bool(true)</td><td>bool(true)</td><td>bool(true)</td></tr><tr><td>NULL</td><td></td><td>bool(true)</td><td>bool(true)</td></tr><tr><td></td><td>bool(true)</td><td>bool(true)</td><td>bool(true)</td></tr><tr><td></td><td>bool(true)</td><td>bool(true)</td><td>bool(true)</td></tr><tr><td></td><td>bool(true)</td><td>bool(true)</td><td>bool(true)</td></tr><tr><td></td><td>bool(true)</td><td>bool(true)</td><td>bool(true)</td></tr><tr><td></td><td>bool(true)</td><td>bool(true)</td><td>bool(true)</td></tr></tbody></table>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（01）： 为什么要省略结束标签</title>
      <link href="/2017/10/16/1/"/>
      <content type="html"><![CDATA[<p>对于PHP编译器来说，脚本的结束标签<code>?&gt;</code>是可选的，在写程序时你可以忽略它。你或许碰见过：在使用include()、require()或输入输出缓冲函数时，页面顶部有时会多空行或者出现<code>“header had send”</code>之类的错误信息，这类问题与结束标签有关。</p><p>省略结束标签适合纯PHP文件。如果是PHP与HTML混合开发，则不可省略。</p><p>忽略结束标签不仅能少些两个字符，而且可以使得我们开发的过程更加顺利。</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP基础 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP 基础面试全覆盖（03）：=与==、===的区别</title>
      <link href="/2017/10/16/3/"/>
      <content type="html"><![CDATA[<p>首先等于号（=）在大多数语言中都是赋值操作；</p><p><code>==</code>和<code>===</code>都是比较运算符，用来比较两个变量间的关系，他们两个都有“等于”的含义，不过<code>===</code>是恒等计算符。两侧数据类型不一致时会返回 false，在官方文档中给出如下：</p><p><code>==</code>如果两侧的变量类型不同时，会转化类型后在进行比较。</p><table><thead><tr><th>例子</th><th>名称</th><th>结果</th></tr></thead><tbody><tr><td>$a == $b</td><td>等于</td><td><strong>TRUE</strong>，如果类型转换后 $a 等于 $b。</td></tr><tr><td>$a === $b</td><td>全等</td><td><strong>TRUE</strong>，如果 $a 等于 $b，并且它们的类型也相同。</td></tr></tbody></table><p>上表摘自 PHP 手册。下面来看一个例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">   $age = <span class="number">18</span>;</div><div class="line">   var_dump($age == <span class="number">18</span>)l    <span class="comment">//bool(true)</span></div><div class="line">   var_dump($age === <span class="number">18</span>);   <span class="comment">//bool(true)</span></div><div class="line">   var_dump($age == <span class="string">'18'</span>);  <span class="comment">//bool(true)</span></div><div class="line">   var_dump($age === <span class="string">'18'</span>); <span class="comment">//bool(false)</span></div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP基础 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>RESTful API架构</title>
      <link href="/2017/10/12/1/"/>
      <content type="html"><![CDATA[<h2 id="RESTFul-是什么？"><a href="#RESTFul-是什么？" class="headerlink" title="RESTFul 是什么？"></a>RESTFul 是什么？</h2><p>RESTful的本质是一种软件架构风格，核心是面向资源，主要用来解决降低开发的复杂性，提高系统的可伸缩性。随着互联网的发展，各种终端层出不穷，手机浏览器，手机 APP 为了节约成本，我们可以使用 RESTful 架构，只需要封装好一套完善的API就可以为多套终端提供服务。</p><p>设计概念和准则</p><ul><li>网络上所有事物都可以被抽象为资源</li><li>每一个资源都有唯一的标识符，对资源的操作不会改变这些标识</li><li>所有的操作都是无状态的</li></ul><p>所谓的资源就是网络上的一个实体，或者说是网络上一个具体的信息。</p><p>HTTP 协议 - URL</p><p>HTTP 是一个属于应用层的协议，特点是简捷、快速</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">schema://host[:port]/path[?query-string][#anchor]</div></pre></td></tr></table></figure><ul><li>schema 指定底层使用的协议（如：http,https）</li><li>host   服务器的 IP 地址或者域名</li><li>port 服务器端口</li><li>path 访问资源的路径</li><li>query-string 发送给 http 服务器的数据<br>   anchor     锚</li></ul><p>HTTP</p><h2 id="RESTful-API的设计"><a href="#RESTful-API的设计" class="headerlink" title="RESTful API的设计"></a>RESTful API的设计</h2><h2 id="一、协议"><a href="#一、协议" class="headerlink" title="一、协议"></a>一、协议</h2><p>API与用户的通信协议，总是使用<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="noopener">HTTPs协议</a>。</p><h2 id="二、域名"><a href="#二、域名" class="headerlink" title="二、域名"></a>二、域名</h2><p>应该尽量将API部署在专用域名之下。</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://api.example.com</div></pre></td></tr></table></figure><p>如果确定API很简单，不会有进一步扩展，可以考虑放在主域名下。</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://example.org/api/</div></pre></td></tr></table></figure><h2 id="三、版本（Versioning）"><a href="#三、版本（Versioning）" class="headerlink" title="三、版本（Versioning）"></a>三、版本（Versioning）</h2><p>应该将API的版本号放入URL。</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://api.example.com/v1/</div></pre></td></tr></table></figure><p>另一种做法是，将版本号放在HTTP头信息中，但不如放入URL方便和直观。<a href="https://developer.github.com/v3/media/#request-specific-version" target="_blank" rel="noopener">Github</a>采用这种做法。</p><h2 id="四、路径（Endpoint）"><a href="#四、路径（Endpoint）" class="headerlink" title="四、路径（Endpoint）"></a>四、路径（Endpoint）</h2><p>路径又称”终点”（endpoint），表示API的具体网址。</p><p>在RESTful架构中，每个网址代表一种资源（resource），所以网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的”集合”（collection），所以API中的名词也应该使用复数。</p><p>举例来说，有一个API提供动物园（zoo）的信息，还包括各种动物和雇员的信息，则它的路径应该设计成下面这样。</p><ul><li><a href="https://api.example.com/v1/zoos" target="_blank" rel="noopener">https://api.example.com/v1/zoos</a></li><li><a href="https://api.example.com/v1/animals" target="_blank" rel="noopener">https://api.example.com/v1/animals</a></li><li><a href="https://api.example.com/v1/employees" target="_blank" rel="noopener">https://api.example.com/v1/employees</a></li></ul><h2 id="五、HTTP动词"><a href="#五、HTTP动词" class="headerlink" title="五、HTTP动词"></a>五、HTTP动词</h2><p>对于资源的具体操作类型，由HTTP动词表示。</p><p>常用的HTTP动词有下面五个（括号里是对应的SQL命令）。</p><ul><li>GET（SELECT）：从服务器取出资源（一项或多项）。</li><li>POST（CREATE）：在服务器新建一个资源。</li><li>PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</li><li>PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</li><li>DELETE（DELETE）：从服务器删除资源。</li></ul><p>还有两个不常用的HTTP动词。</p><ul><li>HEAD：获取资源的元数据。</li><li>OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的。</li></ul><p>下面是一些例子。</p><ul><li>GET /zoos：列出所有动物园</li><li>POST /zoos：新建一个动物园</li><li>GET /zoos/ID：获取某个指定动物园的信息</li><li>PUT /zoos/ID：更新某个指定动物园的信息（提供该动物园的全部信息）</li><li>PATCH /zoos/ID：更新某个指定动物园的信息（提供该动物园的部分信息）</li><li>DELETE /zoos/ID：删除某个动物园</li><li>GET /zoos/ID/animals：列出某个指定动物园的所有动物</li><li>DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物</li></ul><h2 id="六、过滤信息（Filtering）"><a href="#六、过滤信息（Filtering）" class="headerlink" title="六、过滤信息（Filtering）"></a>六、过滤信息（Filtering）</h2><p>如果记录数量很多，服务器不可能都将它们返回给用户。API应该提供参数，过滤返回结果。</p><p>下面是一些常见的参数。</p><ul><li>?limit=10：指定返回记录的数量</li><li>?offset=10：指定返回记录的开始位置。</li><li>?page=2&amp;per_page=100：指定第几页，以及每页的记录数。</li><li>?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序。</li><li>?animal_type_id=1：指定筛选条件</li></ul><p>参数的设计允许存在冗余，即允许API路径和URL参数偶尔有重复。比如，GET /zoo/ID/animals 与 GET /animals?zoo_id=ID 的含义是相同的。</p><h2 id="七、状态码（Status-Codes）"><a href="#七、状态码（Status-Codes）" class="headerlink" title="七、状态码（Status Codes）"></a>七、状态码（Status Codes）</h2><p>服务器向用户返回的状态码和提示信息，常见的有以下一些（方括号中是该状态码对应的HTTP动词）。</p><ul><li>200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</li><li>201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</li><li>202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</li><li>204 NO CONTENT - [DELETE]：用户删除数据成功。</li><li>400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</li><li>401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</li><li>403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</li><li>404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</li><li>406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</li><li>410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</li><li>422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</li><li>500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</li></ul><p>状态码的完全列表参见<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank" rel="noopener">这里</a>。</p><h2 id="八、错误处理（Error-handling）"><a href="#八、错误处理（Error-handling）" class="headerlink" title="八、错误处理（Error handling）"></a>八、错误处理（Error handling）</h2><p>如果状态码是4xx，就应该向用户返回出错信息。一般来说，返回的信息中将error作为键名，出错信息作为键值即可。</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    error: &quot;Invalid API key&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="九、返回结果"><a href="#九、返回结果" class="headerlink" title="九、返回结果"></a>九、返回结果</h2><p>针对不同操作，服务器向用户返回的结果应该符合以下规范。</p><blockquote><ul><li>GET /collection：返回资源对象的列表（数组）</li><li>GET /collection/resource：返回单个资源对象</li><li>POST /collection：返回新生成的资源对象</li><li>PUT /collection/resource：返回完整的资源对象</li><li>PATCH /collection/resource：返回完整的资源对象</li><li>DELETE /collection/resource：返回一个空文档</li></ul></blockquote><h2 id="十、Hypermedia-API"><a href="#十、Hypermedia-API" class="headerlink" title="十、Hypermedia API"></a>十、Hypermedia API</h2><p>RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。</p><p>比如，当用户向api.example.com的根目录发出请求，会得到这样一个文档。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"link"</span>: &#123;</div><div class="line">  <span class="attr">"rel"</span>:   <span class="string">"collection https://www.example.com/zoos"</span>,</div><div class="line">  <span class="attr">"href"</span>:  <span class="string">"https://api.example.com/zoos"</span>,</div><div class="line">  <span class="attr">"title"</span>: <span class="string">"List of zoos"</span>,</div><div class="line">  <span class="attr">"type"</span>:  <span class="string">"application/vnd.yourformat+json"</span></div><div class="line">&#125;&#125;</div></pre></td></tr></table></figure><p>上面代码表示，文档中有一个link属性，用户读取这个属性就知道下一步该调用什么API了。rel表示这个API与当前网址的关系（collection关系，并给出该collection的网址），href表示API的路径，title表示API的标题，type表示返回类型。</p><p>Hypermedia API的设计被称为<a href="http://en.wikipedia.org/wiki/HATEOAS" target="_blank" rel="noopener">HATEOAS</a>。Github的API就是这种设计，访问<a href="https://api.github.com/" target="_blank" rel="noopener">api.github.com</a>会得到一个所有可用API的网址列表。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "current_user_url": "https://api.github.com/user",</div><div class="line">  "authorizations_url": "https://api.github.com/authorizations",</div><div class="line">  // ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>从上面可以看到，如果想获取当前用户的信息，应该去访问<a href="https://api.github.com/user" target="_blank" rel="noopener">api.github.com/user</a>，然后就得到了下面结果。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"message"</span>: <span class="string">"Requires authentication"</span>,</div><div class="line">  <span class="attr">"documentation_url"</span>: <span class="string">"https://developer.github.com/v3"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>上面代码表示，服务器给出了提示信息，以及文档的网址。</p><h2 id="十一、其他"><a href="#十一、其他" class="headerlink" title="十一、其他"></a>十一、其他</h2><p>（1）API的身份认证应该使用<a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">OAuth 2.0</a>框架。</p><p>（2）服务器返回的数据格式，应该尽量使用JSON，避免使用XML。</p><p>引用：</p><p>理解RESTful架构 地址：<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2011/09/restful.html</a></p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MySQL常用存储引擎之Innodb</title>
      <link href="/2017/10/10/cjjrthlg8004qc7rdxewkc5ww/"/>
      <content type="html"><![CDATA[<p>Mysql5.5(5.58)及之后的版本默认的存储引擎由 MyISAM 引擎替换为 Innodb。</p><p>和 MyISAM 存储引擎不同，InnoDB是事务型引擎，也是最重要、使用最广泛的存储引擎。它被设计用来处理大量的短期（short-lived）事务，短期事务大部分情况下是正常提交的，很少会被回滚。InnoDB 的性能和自动崩溃恢复特性，使得它在非实物型存储的需求中也很六星。除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑 innoDB 引擎。</p><p>特点：</p><ul><li>灾难恢复性好</li><li>支持全部四种级别的事务。默认的事务隔离级别是可重复度（Repeatable Read），它的事务支持通过多版本并发控制（MVVC）来提供的</li><li>使用行级锁</li><li>对于 InnoDB 引擎的表，其数据的物理组织形式是簇表（Cluster Table），数据按主键来组织，也就是说主键索引和数据是在一起的，数据主键的顺序物理分布。数据表的另一种常见形式是非簇表，其索引是有序的，而数据时无序的</li><li>实现了缓冲管理，不仅能缓冲索引也能缓冲数据，并且会自动创建散列索引以加快数据的读取。相比之下，MyISAM 只是缓存了索引</li><li>支持外键</li><li>支持热备份</li></ul><p>Innodb 拥有表空间的概念，表中的数据时存储在表空间之中的，具体存储在什么样的表空间之中则由<code>innodb_file_per_table</code>这个参数决定。</p><p>如果值为 <code>ON</code>,会为每个 innodb 表建立一个<code>tablename.ibd</code>的系统文件，如果该参数为<code>OFF</code>时会把数据存储到系统的表空间<code>ibdataX</code></p><p><strong>引用</strong></p><p>《打造扛得住的 MySQL》 慕课网</p><p>《高性能 MySQL》</p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MySQL性能优化（5）：服务器参数对 MYSQL 的影响</title>
      <link href="/2017/09/17/2/"/>
      <content type="html"><![CDATA[<p>人们经常问，“我的服务器有32G内存，12核CPU，怎样配置最好？”很遗憾，问题没有那么简单。服务器的配置应该符合它的工作负载、数据，以及对应需求，并不仅仅看硬件的情况。</p><p>MySQL有大量可以修改的参数——但是不应该随意去修改。通常只需要把基本的配置正确（大部分情况下至于很少的一些参数是真正重要的），应该更多的时间花在schema的优化、索引、以及查询设计上。在正确地配置了MySQL的基本配置项之后，再花力气去修改其他配置项的收益通常就比较小了。</p><p>从另外一方面来说，没用的配置项会导致潜风险的可能更大。我们碰到过不止一个“高度调优”过的服务器不停地彭奎，停止服务或者运行缓慢，结果都是因为错误的配置导致的。</p><p>##　MySQl获取配置信息路径</p><ul><li>命令行参数 <code>mysqld_safe --datadir=/data/sql_data</code></li><li>配置文件 <code>mysqld --help --verbose | grep -A 1 &#39;Default options&#39;</code></li></ul><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20171013153125.png" alt=""></p><p>MySQL会先从<code>/etc/my.cnf</code>文件下读取配置信息，然后是<code>/etc/mysql/my.cnf</code>。</p><p>MySQL配置参数的作用域</p><ul><li>全局参数 <ul><li><code>set global 参数名 = 参数值;</code></li><li><code>set @@global。参数名:=参数值;</code></li></ul></li><li>会话参数<ul><li><code>set [session] 参数名=参数值;</code></li><li><code>set @@session.参数名:=参数值;</code></li></ul></li></ul><p>会话参数在没有被单独指定的时会使用全局参数的值来当做默认值。</p><p>在这里需要注意，如果在服务器运行时修改了变量的全局值，这个值对当前回话和其他任何已经存在的会话是不起作用的，这是因为会话的变量值是在连接创建时从全局值初始化来的。在每次更改之后，应该检查 SHOW GLOBAL VARIABLES 的输出，确认已经按照期望变更了。</p><h2 id="内存配置相关参数"><a href="#内存配置相关参数" class="headerlink" title="内存配置相关参数"></a>内存配置相关参数</h2><p>MySQL对于内存的使用我们可以分为两个类来看。</p><ul><li>无法通过配置参数设置的，如MySQL运行，解析，运行，查询所需要的内存</li><li>可以通过参数配置控制的，各类的缓冲池所需要的内存。</li></ul><p>对内存参数配置之前，我们需要进行考虑：</p><ul><li>确定可以使用内存的上限，最根本的一点是不能超过本身物理内存的。还有一点是系统架构的问题，如果是32位系统，那么单个进程只能设置低于3G的内存空间。</li><li>确定MySQL的每个连接使用的内存，例如排序缓冲和临时表</li><li><p>把剩下的内存全部给 MySQL 的缓存，例如 InnoDB 的缓冲池。</p><ul><li><p>sort_buffer_size</p><ul><li>join_buufer_szie</li><li>read_buffer_size</li><li>read_rnd_buffer_size  </li></ul></li></ul></li></ul><h3 id="确定需要为操作系统保留多少内存"><a href="#确定需要为操作系统保留多少内存" class="headerlink" title="确定需要为操作系统保留多少内存"></a>确定需要为操作系统保留多少内存</h3><p>给操作系统保留的内存还需要保留，在系统中运行的其他所有服务所需要的内存，以及前面提到的我们无法为MySQL进行控制的那一部分内存。</p><p>数据库最好使用专用的服务器，不要与其他服务共用服务器，不可避免的会造成内存的争用，给配置内存带来更多的考虑因素。</p><p>另外也有人喜欢在一台物理服务器上，运行多个MySQL实例，从内存分配上来看这样做也不好，除非是在开发、测试中可以节约服务器成本，但是在生产环境中最好不要运行多个MySQL实例，因为这样也会造成内存和I/O的争用，影响mysql服务的性能。</p><h3 id="如何为缓冲池分配内存"><a href="#如何为缓冲池分配内存" class="headerlink" title="如何为缓冲池分配内存"></a>如何为缓冲池分配内存</h3><p>Innodb_buffer_pool_size，Innodb缓冲区</p><p>总内存-（每个线程所需要的内存*连接数）- 系统保留内存</p><p>手册中建议大家该内存大小应该为服务器内存大小的百分之七十五以上，上面提到了MySQL是如何使用内存的，所以不能简单粗暴的设置成百分之七十五，必须还得考虑其他的一些因素。</p><h4 id="key-buffer-size"><a href="#key-buffer-size" class="headerlink" title="key_buffer_size"></a>key_buffer_size</h4><p>设置这个变量可以一次性为缓冲区(key buffer，也叫键缓存 key cache)分配所指定的空间，然而</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select sum(index_length) from information_schema.tables where engine=&apos;myisam&apos;</div></pre></td></tr></table></figure><h2 id="I-O相关配置参数"><a href="#I-O相关配置参数" class="headerlink" title="I/O相关配置参数"></a>I/O相关配置参数</h2><p>Innodb I/O相关配置</p><h2 id="安全相关配置参数"><a href="#安全相关配置参数" class="headerlink" title="安全相关配置参数"></a>安全相关配置参数</h2><p><code>expire_logs_days</code> 指定自动清理binlog的天数，这个天数的设置，最好能够覆盖两次全备间隔的天数，如果每天都进行全备的话，最好也能够保持7天，这样以备在特殊情况下数据的查找，比如数据出现异常的情况下，就可能会使用到binlog日志进行查找。</p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MySQL性能优化(4)：操作系统优化</title>
      <link href="/2017/09/17/1/"/>
      <content type="html"><![CDATA[<p>影响数据库性能的主要因素有很多，主要包括以下几点：</p><ol><li>服务器硬件</li><li>服务器系统</li><li>数据库存储引擎的选择</li><li>数据库参数配置</li><li>数据库结构设计和SQL语句</li></ol><h1 id="服务器系统"><a href="#服务器系统" class="headerlink" title="服务器系统"></a>服务器系统</h1><p>MySQL本身支持很多操作系统：</p><ul><li>Windows</li><li>FreeBSD</li><li>Solaris</li><li>Linux</li></ul><p>很多人都习惯将开发环境的数据库部署在Windows上，将生产环境的数据库部署在Linux上，这就会导致一个问题，MySQL 的schema存储方式在文件系统上实际是一个目录，<strong>在Windows平台上，大小写是不敏感的</strong>，而在<strong>Linux上大小写是敏感的</strong>，所以这就会导致，数据库和表的名字在Windows是可以运行的，但是当移植到Linux下就会找不到相关数据库和表的错误。</p><h2 id="CentOS系统参数优化"><a href="#CentOS系统参数优化" class="headerlink" title="CentOS系统参数优化"></a>CentOS系统参数优化</h2><p><strong>内核相关参数</strong>（/etc/sysctl.conf）</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"># </div><div class="line">net.core.somaxconn = 65535</div><div class="line">net.core.netdev_max_backlog = 65535</div><div class="line">net.ipv4.tcp_max_syn_backlog = 65535</div><div class="line"></div><div class="line"># TCP连接回收</div><div class="line">net.ipv4.tcp_fin_timeout = 10</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line">net.ipv4.tcp_tw_recycle = 1</div><div class="line"></div><div class="line">net.core.wmen_default = 87380</div><div class="line">net.core.wmen_max = 16777216</div><div class="line">net.core.rmem_default = 87380</div><div class="line">net.core_rmem_max = 1677216</div><div class="line"></div><div class="line">net.ipv4.tcp_keeplive_time = 120</div><div class="line">net.ipv4.tcp_keepalive_intvl = 30</div><div class="line">net.ipv4.tcp_keepalive_probes = 3</div><div class="line"></div><div class="line">kernel.shmmax = 4294967295</div><div class="line"># Linux内核参数最重要的参数之一，用于定义单个共享内存段的最大值</div><div class="line"># 1. 这个参数应该设置的足够大，以便能在一个共享内存段下容纳下整个Innodb缓冲池的大小</div><div class="line"># 这个值的大小对于64位Linux系统，可取的最大值为物理内存值-1byte,建议设置为物理内存的一半，一半取决于Innodb缓冲池的大小即可，可以取物理内存-1byte</div><div class="line"></div><div class="line">vm.swappiness = 0 </div><div class="line"># 这个参数当内存不足时会对性能产生较明显的影响</div><div class="line"># Linux系统内存交换区。</div><div class="line"># 禁用交换分区所带来的风险：</div><div class="line">#1. 降低操作系统的性能</div><div class="line">#2。 容易造成内存溢出，崩溃，或者被操作系统kill掉</div><div class="line"># 在MySQL服务器上保留叫分区还是有必要的额，但是要控制何时使用交换分区，vm.swappiness = 0 ，就是告诉内核除非虚拟内存完全满了，否则就不会使用交换分区</div></pre></td></tr></table></figure><p>增加资源限制（/etc/security/limit.conf），这个文件实际上是Linux PAM也就是插入式认证模块的配置文件。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">* soft nofile 65535</div><div class="line">* hard nofile 65535</div><div class="line"></div><div class="line"># * 表示对所有用户有效</div><div class="line"># soft 指的是当前系统生效的设置</div><div class="line"># hard 表明系统中所设定的最大值</div><div class="line"># nofile 表示所限制的资源是打开文件的额最大数目</div><div class="line"># 65535 就是限制的数量</div><div class="line"># 把可打开的文件数量增加到65535个，以保证可以打开足够多的文件句柄，这个文件的修改需要重启系统后生效</div></pre></td></tr></table></figure><p>磁盘调度策略(/sys/block/devname/queue/scheduler)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cat /sys/block/devname/queue/scheduler</div><div class="line">noop anticipatory deadline [cfq]</div></pre></td></tr></table></figure><p><strong>noop</strong>（电梯式调度策略）<br>NOOP实现了一个FIFO队列，它像电梯的工作方式一样对I/O请求进行组织，当有一个新的请求到来时，它将请求合并到最近的请求之后，以此来保证请求同一个介质。NOOP倾向于饿死读而利于写，因此NOOP对于闪存设备，RAM以及嵌入式是最好的选择。</p><p><strong>deadline</strong>（介质时间调度策略）<br>Deadline确保了在一个截至时间内服务请求，这个截至时间是可调整的，而默认读期限短于写期限。这样就防止了写操作因为不能被读取而饿死的现象。Deadline对数据库类应用是最好的选择。</p><p><strong>anticipatory</strong>（预料I/O调度策略）<br>本质上与Deadline一样，但在最后一次读操作后，要等待6ms，才能继续进行对其他I/O请求进行调度。它会在每个6ms中插入新的I/O操作，而会将一些小写入流合并成一个大写入流，用写入延时换取最大的写入吞吐量。AS适合于写入较多的环境，比如文件服务器，AS对数据库环境表现很差。</p><p>通过下面方法修改磁盘策略：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo  deadline &gt;  /sys/block/devname/queue/scheduler</div></pre></td></tr></table></figure><h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>在Windows环境下，仅有FAT和NTFS两种文件系统，但其实现在只使用NTFS。</p><p>在Linux环境下就不同了，目前主流的文件系统有EXT3、EXT4、XFS。这三种文件系统都带有日志，安全性可以得到保证，江湖传闻XFS新更能更好。</p><p>EXT3/4系统的挂在参数(/etc/fstab)</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 日志写入</div><div class="line">data = writeback | ordered | jouranl</div><div class="line">noatime, nodiratime</div><div class="line">/dev/sda1/ext4 noatime,nodiratime,data=writeback 1 1</div></pre></td></tr></table></figure><p>writeback 只有元数据写入到日志，这是最快的一种配置，因为 innodb 有自己的日志，所以writeback对于 innodb 是最好的选择。</p><p>ordered </p><p>journal 提供了院子</p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MYSQL性能优化（6）：存储引擎的选择</title>
      <link href="/2017/09/17/2/"/>
      <content type="html"><![CDATA[<h1 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h1><p>MyISAM存储引擎是MySQL5.5之前版本默认的存储引擎，由于这个原因，现在还有大量的数据库在使用MyISAM的表。</p><p>同时它也是MySQL大部分系统表和临时表使用的而存储引擎，这个临时表并非是我们使用<code>CREATE TEMPORARY TABLE</code>所建立的临时表。</p><p>使用<code>CREATE TEMPORARY TABLE</code>语句创建的临时表，我们可以使用MySQL各种存储引擎的，这里所说的临时表指的是在排序、分组等操作中，当当数量超过一定大小后，由查询优化器所建立的磁盘临时表。</p><p>MyISAM存储引擎表由MYD和MYI组成。</p><p>在这里，我们建立一个myIsam的表，并且存储引擎使用了MyISAM。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`myIsam`</span> (</div><div class="line"><span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line"><span class="string">`c1`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></div><div class="line">)<span class="keyword">ENGINE</span>= MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure><p>下图为MyISAM在文件系统上的存储方式：</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20171013110625.png" alt=""></p><p>以frm为扩展名存储的文件并非是MyISAM存储引擎独有，它是用于记录表的结构。MyISAM表可以存储的记录数，一般首选治愈可用磁盘空间，或者是操作系统单个文件最大尺寸的限制。</p><p>作为MySQL最早的存储引擎之一，MyISAM有一些已经开发出来很多年的特性，可以满足用户的实际需求。</p><p><strong>加锁与并发</strong></p><ul><li>MyISAM使用的是表级锁，进行读取操作时会对需要读到的所有表加共享锁，写入时则会对表加排他锁。但是在表有读取查询的同时，可以往表中插入新的记录，这也被称之为并发插入，CONCURRENT INSERT</li></ul><p><strong>修复</strong> </p><ul><li>对于MyISAM表，MySQL可以手工或者自动执行检查和修复操作，但是此处的修复和事务恢复以及崩溃恢复并不是一个概念，执行表的修复可能导致数据的丢失，而且修复操作时非常慢的。可以通过CHECK TABLE table检查表的错误，如果存在错误可以通过REPAIR TABLE table进行修复。在MySQL服务器处于<strong>关闭状态</strong>时，可以通过myisamcheck命令工具进行检查和恢复，切记是处于<strong>关闭状态</strong>。</li></ul><p><strong>索引</strong></p><ul><li>对于MyISAM表，即使是BLOG和TEXT等长字段，也可以基于前500个字符创建索引，而且MyISAM也支持全文索引。</li><li>延迟更新索引（Delayed Key Write）创建MyISAM表的时候，如果制定了DELAY_KEY_WRITE选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区(in-memory key buffer)，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃的时候会造成索引损坏，需要执行修复操作。此属性可以再全局设置，也可以为单个表设置。</li></ul><p><strong>压缩</strong></p><ul><li>如果表在创建并导入数据以后，不会再进行修改操作，可以使用myisampa对表进行压缩（打包）。压缩表不能进行修改，除非解除压缩，压缩表可以极大地减少磁盘空间占用，因此也可以减少磁盘I/O，从而提升性能，压缩表支持索引，但索引也是只读的。</li><li>压缩时表中的记录是独立压缩的，所以读取单行的时候不需要去解压整个表。</li></ul><h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><ul><li>版本&lt;MySYQL5.0时默认表大小为4G，如存储大表则需要修改MAX_Rows和AVG_ROW_LENGTH这两个参数，调整后表会进行重建，这需要很长的时间。</li><li>版本 &gt; 5.0时默认支持256TB </li></ul><p>适用场景：</p><ul><li>非事务性应用</li><li>只读类应用</li><li>空间类应用（在5.7之前，MyISAM是唯一支持空间函数的存储引擎）</li></ul><h1 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h1><p>Mysql5.5(5.58)及之后的版本默认的存储引擎由 MyISAM 引擎替换为 Innodb。</p><p>和 MyISAM 存储引擎不同，InnoDB是事务型引擎，也是最重要、使用最广泛的存储引擎。它被设计用来处理大量的短期（short-lived）事务，短期事务大部分情况下是正常提交的，很少会被回滚。InnoDB 的性能和自动崩溃恢复特性，使得它在非实物型存储的需求中也很六星。除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑 innoDB 引擎。</p><p>特点：</p><ul><li>灾难恢复性好</li><li>支持全部四种级别的事务。默认的事务隔离级别是可重复度（Repeatable Read），它的事务支持通过多版本并发控制（MVVC）来提供的</li><li>使用行级锁</li><li>对于 InnoDB 引擎的表，其数据的物理组织形式是簇表（Cluster Table），数据按主键来组织，也就是说主键索引和数据是在一起的，数据主键的顺序物理分布。数据表的另一种常见形式是非簇表，其索引是有序的，而数据时无序的</li><li>实现了缓冲管理，不仅能缓冲索引也能缓冲数据，并且会自动创建散列索引以加快数据的读取。相比之下，MyISAM 只是缓存了索引</li><li>支持外键</li><li>支持热备份</li></ul><p>Innodb 拥有表空间的概念，表中的数据时存储在表空间之中的，具体存储在什么样的表空间之中则由<code>innodb_file_per_table</code>这个参数决定。</p><p>如果值为 <code>ON</code>,会为每个 innodb 表建立一个<code>tablename.ibd</code>的系统文件，如果该参数为<code>OFF</code>时会把数据存储到系统的表空间<code>ibdataX</code></p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MySQL性能优化之大事务对MySQL性能带来的影响</title>
      <link href="/2017/09/16/1/"/>
      <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在我们的日常开发过程当中，为了保持数据的一致性，多多少少都会用到事务。</p><p>当面对大量数据时，使用事务一定要谨小慎微，因为一旦编写的事务中设计的数据量过大，就会严重的影响系统性能，如果操作的数据量特别巨大，则会造成服务器的阻塞，导致业务逻辑无法访问。</p><h3 id="什么是事务？"><a href="#什么是事务？" class="headerlink" title="什么是事务？"></a>什么是事务？</h3><p>在了解大事务对 MySQL 性能带来的影响之前，我们首先要了解什么是事务，事务又起到了什么样的作用：</p><ol><li><p>事务是关系型数据库系统区分于其他一切文件系统的重要特性，举例说明，对于文件系统来说，为了保证两个文件的一致，在我们修改完一个文件后，系统突然崩溃，这样文件系统在恢复后就很难保持系统的一致了，而数据库系统中，由于使用了事务，在数据库崩溃后，我们可以恢复数据库中的数据，使其保证数据的一致性。</p></li><li><p>事务是一组具有原子性的SQL语句，或是一个单独的工作单元，事务处理中只有两种可能性，事务处理成功，事务处理失败，一旦失败，数据库就会回滚到原始状态。</p></li></ol><p>事务要符合：原子性、一致性、隔离性、持久性</p><h4 id="事务的原子性（ATOMICITY）"><a href="#事务的原子性（ATOMICITY）" class="headerlink" title="事务的原子性（ATOMICITY）"></a>事务的原子性（ATOMICITY）</h4><p>定义：一个事务必须被诗作为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交完成，要么全部失败，对于一个事物来说，不可能只执行其中的一部分操作。</p><p>举个例子（银行），我们有两个账户，一个是理财账户，另外一个是活期存款账户，现在需要从理财账户中转出2000RMB到活期存款账户中，我们需要经过以下步骤。</p><ol><li>检查理财账户中的余额是否高于2000RMB</li><li>从理财账户的余额中减去2000RMB</li><li>在活期存款账户中增加2000RM</li></ol><p>以上步骤必须作为一个整体一起完成，如果运行到第二步骤时系统崩溃，如果没有事务原子性这一特性，用户将损失两千元，这是无法接受的一件事情。</p><p>在事务中执行到第二步崩溃时，在系统恢复后，在日志中有没有完成提交的事务，系统就会回滚，避免了用户的损失。</p><p>整个事务中所有操作要么全部提交成功，要么全部失败回滚。</p><h4 id="事务的一致性（CONSISTENCY）"><a href="#事务的一致性（CONSISTENCY）" class="headerlink" title="事务的一致性（CONSISTENCY）"></a>事务的一致性（CONSISTENCY）</h4><p>定义：一致性是指事务将数据库从一种一致性状态转换到另外一种一致性状态，在事务开始之前和事务结束后数据库中数据的完整性没有被破坏。</p><h4 id="事务的隔离性（ISOLATION）"><a href="#事务的隔离性（ISOLATION）" class="headerlink" title="事务的隔离性（ISOLATION）"></a>事务的隔离性（ISOLATION）</h4><p>定义： 隔离性要求一个事务对数据库中数据的修改，在未提交完成前对于其他事务是不可见的。</p><p>SQL标准中定义的四种隔离级别</p><ul><li>未提交读（READ UNCOMMITED）</li><li>已提交读（READ COMMITED）</li><li>可重复读（REPEATABLE READ）</li><li>可串行化（SERIALIZABLE）</li></ul><h4 id="事务的持久性（DURABILITY）"><a href="#事务的持久性（DURABILITY）" class="headerlink" title="事务的持久性（DURABILITY）"></a>事务的持久性（DURABILITY）</h4><p>定义：一旦事务提交，则其所做的修改就会永久</p><p>的保存到数据库中，即使此时系统崩溃，已经提交的修改数据也不会丢失。</p><h3 id="什么是大事务"><a href="#什么是大事务" class="headerlink" title="什么是大事务"></a>什么是大事务</h3><p>定义：运行时间比较长，操作数据比较多的事务。</p><p>余额宝这样的理财产品，每天都会计算前一天的理财收入所得，如果在一个事务中对所有的用户的理财收入都进行计算，并更新到用户余额中，这样数以亿计的用户余额的更新就要数个小时，而且一旦中间出现问题就会回滚，时间会更长。</p><p>这时一旦出现问题，数据库就会加锁，造成用户无法使用余额的问题。</p><p>风险：</p><ol><li>锁定太多的数据，造成大量的阻塞和锁超时，对于innodb为了保证数据的一致性，虽然是行级锁，但是也会把所有相关的记录都加上锁。</li><li>回滚所需要的时间比较长，回滚时数据仍然会被锁定。</li><li>执行时间长，容易造成主从延迟。</li></ol><h3 id="如何处理大事务"><a href="#如何处理大事务" class="headerlink" title="如何处理大事务"></a>如何处理大事务</h3><ol><li>避免一次处理太多数据,当面临成百上千万的数据量时，我们最好分批进行处理，例如每一个事务处理一万条数据。</li><li>移出不必要在事务中的SELECT操作。</li></ol>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MySQL性能优化（5）：MySQL体系结构</title>
      <link href="/2017/09/16/5/"/>
      <content type="html"><![CDATA[<p>数据库产品的架构一般可以分为应用层、逻辑层、物理层，对于MySQL，同样可以理解为如下3个层次。</p><p><img src="http://ogxeww23n.bkt.clouddn.com/http://images2015.cnblogs.com/blog/676456/201707/676456-20170722164214340-166686649.jpg210050572965263.gif" alt="img"></p><p>其中<code>Connectors</code>可以理解为各种客户端、 应用服务； <code>Connection Pool</code>可以理解为<strong>应用层</strong>，负责和客户端、用户进行交互，需要和不同的客户端（<code>PHP</code>,<code>Java</code>,<code>C API</code>,<code>.Net</code>以及<code>ODBC</code>,<code>JDBC</code>等等）和中间服务器进行交互，这一层主要完成的是链接处理，授权认证，和安全等一些功能，连接到<code>MySQL</code>的客户端在其进程中，都会有一个独立的线程，连接的查询只会在这个登录线程中进行查询。</p><p><code>Management Services&amp;Utilities</code>、<code>SQL Interface</code>、 <code>Parser</code>、 <code>Optimizer</code>、 <code>Caches&amp;Buffers</code>、 <code>Pluggable Storage Engines</code>可以理解为数据库的大脑——<strong>逻辑层</strong>。</p><p>负责具体的查询处理、事务处理、存储管理、恢复管理，以及其他附加功能。查询处理器负责查询的解析、执行。当接收到客户端的查询时，数据库会分配一个县城来处理它。先友查询处理器（优化器）生成执行计划，然后交由计划执行器来执行，执行器有时需要访问更底层的事务管理器、存储管理器来操作数据，事务管理器、存储管理器主要负责事务控制、并发控制、存储管理。在其中，将由事务管理来保证“<code>ACID</code>”特性，通过锁管理器来控制并发，由日志管理器来确保数据持久化，存储故那里器一般还包括一个缓冲管理器，有它来确定磁盘和缓存之间的数据传输。</p><p>根据上面的架构图，我们可以看到在逻辑层中<code>Pluggable Storage Engines</code></p><p>这是MySQL服务逻辑架构中的第三层，是MySQL的存储引擎，MySQL提供出了存储引擎接口，第三方可以根据自己的业务逻辑需求开发自己的存储引擎，Innodb起初就是由Innobase Oy公司所开发，2006年5月被甲骨文公司并购。</p><p>服务器通过API与存储引擎通信，这些接口屏蔽了不同存储引擎之间的差异，使得这些差异对上层的查询过程透明。存储引擎API包含几十个底层函数，用于执行诸如“开始一个事务”或者“根据主键提取一行记录”等操作，但存储引擎不会去解析SQL，不同存储引擎之间也不会相互通信，而只是简单地相应上层和服务的请求。</p><blockquote><p>注意：存储引擎是针对于表的而不是针对于库的，不同的表可以使用不同的引擎；</p></blockquote><p> 最下方的Files&amp;Logs可以理解为物理层，实际物理磁盘（存储）上的数据库文件，比如数据文件、日志文件等等。</p><p>引用：</p><p>《MySQL DBA修炼之道》 作者陈晓勇  出版社：华章图书</p><p>《打造扛得住的MySQL》 电子工业出版社</p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MySQL性能优化（3）：服务器硬件对 MYSQL 带来的影响</title>
      <link href="/2017/09/16/3/"/>
      <content type="html"><![CDATA[<p>影响数据库性能的主要因素有很多，主要包括以下几点：</p><ol><li>服务器硬件</li><li>服务器系统</li><li>数据库存储引擎的选择</li><li>数据库参数配置</li><li>数据库结构设计和SQL语句</li></ol><h1 id="服务器硬件："><a href="#服务器硬件：" class="headerlink" title="服务器硬件："></a>服务器硬件：</h1><p>每当大促或者一些活动的时候，我们监控系统时会发现，CPU和可用内存的资源都是很紧张的，特别对于一些计算密集型的应用，CPU的资源可能会变成系统的瓶颈。</p><p>当我们工作所需要的热数据的大小大于可用内存大小的时候，IO系统就会变成我们的瓶颈。</p><p>网络也算是一种IO，它对于性能的影响往往发生在大量的数据被查询时，特别是使用MemCache这类缓存系统时，当缓存大量失效时，就会造成大量的网络传输从而影响服务性能。</p><p>当发生这类问题的时候，我们可以升级I/O子系统，来增加大量的内存。</p><h2 id="如何选择CPU？"><a href="#如何选择CPU？" class="headerlink" title="如何选择CPU？"></a>如何选择CPU？</h2><h4 id="我们是选择更多的CPU，还是更快的CPU？"><a href="#我们是选择更多的CPU，还是更快的CPU？" class="headerlink" title="我们是选择更多的CPU，还是更快的CPU？"></a>我们是选择更多的CPU，还是更快的CPU？</h4><p>Intel Xeon E7-8890 v2</p><p>主频2.5GHz 核心数量：18核36线程</p><p>正常情况下，这两点我们都想要，但是现实是残酷的，44499RMB的价格，并不是所有公司都能够接受的。</p><p>首先，我们需要考虑几个问题。</p><p>####我们的应用是CPU密集型的应用吗？</p><p>如果是CPU密集型的应用要加快SQL的处理速度，显然我们需要的是更快的CPU而不是核心较多的CPU。</p><p>值得注意的是，MySQL目前还不支持多CPU对同一SQL并发处理。</p><p>也就是说，一条SQL只能使用一颗CPU来进行处理，多颗CPU对于一条SQL的处理效率是没有帮助的。</p><p>我们系统的并发量如何？</p><p>虽然单个SQL无法利用到多个CPU资源，如果要提高系统的吞吐量和并发处理量呢？</p><p>这时我们就需要CPU越多越好。</p><p>在Web应用中，CPU的数量就要比频率要重要一些。</p><p>我们所使用的MySQL版本也会决定如何选择CPU，老版本的MySQL对于多核CPU的支持并不好，5.0之前的版本限制是非常严重的，5.6、5.7对多核CPU的支持已经有了很好的改善。</p><h4 id="选择32位还是64位的CPU？"><a href="#选择32位还是64位的CPU？" class="headerlink" title="选择32位还是64位的CPU？"></a>选择32位还是64位的CPU？</h4><p>这个问题已经是多余的了，目前64位已经是默认配置了，而且MySQL对于64位CPU的支持已经很好了。</p><p>不过值得注意的是，<strong>在64位CPU上使用32位操作系统</strong>，意味着我们不能使用大的内存，任何一个单独的进程都不能寻址到4G以上的内存，MySQL是一个单线程的服务，这样就会对MySQL的性能造成极大的影响。</p><h2 id="内存、更大更快？"><a href="#内存、更大更快？" class="headerlink" title="内存、更大更快？"></a>内存、更大更快？</h2><p>内存的大小直接影响数据库的性能，目前内存的IO效率要远远高于磁盘，所以把数据缓存到内存中可以大大提高数据库性能。</p><p>MyISAM会把索引缓存到内存中，数据放到系统上进行缓存。</p><p>InnoDB会在内存上同时缓存索引和数据，所以可以提高运行效率</p><p>内存的确是越多越好，可是数据库的性能影响也是有限的，并不能无限增加性能，数据库可以利用的内存是有限的。</p><p>当所有的数据都被缓存到内后，再增加内存大小就变成没有意义的了。</p><p>如果我们的数据的大小是100G，内存是64G，我们可以通过扩展内存到128G来扩大数据库的缓冲区来提高数据库性能。</p><p>可是如果此时内存以经256G了，并且数据库的缓存池大小已经达到了196G的情况下，就不能指望增加内存来提高数据库心梗了。</p><p>多余的内存可以增加操作系统等其他服务的性能。</p><p>缓存虽然不能避免磁盘的写操作，但是可以起到延缓作用，把多次写入变成一次写入。</p><p>###　内存的选择？</p><p>内存的频率越高读取也就越快，应该选择主板所支持的最高主频，组成购买升级，每个通道的内存最高相同品牌、颗粒、频率、电压、校验技术和型号。单条容量要尽可能的大。</p><p>根据数据库大小选择内存，例如现在热数据有100G，那么我们就可以选择128G的内存。但是还有一个问题，那就是数据的增长率，为了避免短时间内多次升级硬件，可以选择更大一些的内存。</p><p>##I/O子系统（磁盘的配置和选择）</p><p>虽然内存对数据库的性能影响很重要，通过增加内存大小可以解决大部分性能问题，但是并不能忽视I/O子系统对性能影响。</p><p>有时我们需要以牺牲内存为代价提高I/O子系统的性能，因为无论如何最终，数据都要通过磁盘来进行持久化的存储。</p><p>目前主流的四种磁盘配置：</p><ol><li>使用传统机器磁盘</li><li>使用RAID增强传统机器磁盘</li><li>使用固态存储SSD和PCIe卡</li><li>使用网络存储NAS和SAN</li></ol><h3 id="传统机器硬盘"><a href="#传统机器硬盘" class="headerlink" title="传统机器硬盘"></a>传统机器硬盘</h3><p>传统机器磁盘是目前最常见的选择，使用最多，这类磁盘价格低，存储空间大，但是读、写速度较慢，传统机器硬盘的读、写效率取决于它的存储机制。</p><p>传统机器硬盘读取数据的过程：</p><ol><li>移动磁头到磁盘表面的正确位置</li><li>等待磁盘旋转，使所需的数据在磁头之下</li><li>等待磁盘旋转过去，所有所需的数据都被磁头读取</li></ol><p>磁盘执行这些操作有多快，也就决定了磁盘的读取速度，第1,2步骤被称之为访问时间，第3步称之为传输速度。</p><p>如何选择传统机器硬盘</p><ol><li>存储容量</li><li>传输速度</li><li>访问时间</li><li>主轴转速</li><li>物理尺寸</li></ol><h3 id="RAID增强机器硬盘的性能"><a href="#RAID增强机器硬盘的性能" class="headerlink" title="RAID增强机器硬盘的性能"></a>RAID增强机器硬盘的性能</h3><p>首先我们要知道什么是RAID，RAID是磁盘冗余队列的简称（Redundant Arrays of independent Disks）简单来说RAID的作用就是可以把多个容量较小的磁盘组成一组容量更大的磁盘，并提供数据冗余保证数据完整性的技术。</p><h4 id="数据库中使用的RAID-0级别："><a href="#数据库中使用的RAID-0级别：" class="headerlink" title="数据库中使用的RAID 0级别："></a>数据库中使用的RAID 0级别：</h4><p><strong>RAID 0</strong>是最早出现的RAID模式，也称之为数据条带，是组建磁盘阵列中<strong>最简单</strong>的一种形式，只需要两块以上的硬盘即可，<strong>成本低</strong>，可以提高整个磁盘的性能和吞吐量。RAID 0<strong>没有提供冗余或错误修复能力</strong>，但是实现成本是最低的。</p><p><img src="http://www.maixj.net/wp-content/uploads/2015/02/raid0.png" alt="RAID 0"></p><p>RAID 0 就是多个独立的磁盘串联到一起，比如有三块300G的磁盘组合到一起，就可以组成一块900G的磁盘，在写入时可以并发同时对三块磁盘进行写入，理论上写入效率就是普通磁盘的三倍。</p><p>RAID 0可能是性价比最高的解决方案，但是如果考虑到数据的恢复、可靠性因素，RAID 0就变成了一种成本最高的一种解决方案。</p><p>因为在RAID 0 中数据没有冗余，数据损坏的几率要比单块磁盘的几率还要高，因为RAID 0中任意一块磁盘损坏了，都会造成数据丢失。</p><p>所以RAID 0比较适合于不担心数据丢失的情况，比如可以随时从其他数据库克隆的备存，或者是一次性使用的数据。</p><h4 id="数据库中使用的RAID-1级别"><a href="#数据库中使用的RAID-1级别" class="headerlink" title="数据库中使用的RAID 1级别"></a>数据库中使用的RAID 1级别</h4><p><strong>RAID 1</strong>又称磁盘镜像，原理是把一块磁盘的数据镜像到另一个磁盘上，也就是说数据写入一块磁盘的同事，会在另一块限制的磁盘上生成镜像文件，在不影响性能的情况下最大限度的保证系统的可靠性和可修复性。</p><p><img src="http://www.maixj.net/wp-content/uploads/2015/02/raid1.jpg" alt="RAID 1"></p><p>RAID 1当一块硬盘失效时，系统会忽略该硬盘，转而使用剩余的镜像盘来读取数据，拥有很好的冗余能力，虽然这样对数据的安全性而言是绝对安全的，但是却似的成本增加，磁盘的利用率仅有百分之五十，以4块300G的硬盘而言，能够利用的空间仅有600G，出现故障后的RAID系统也不在可靠了，应当及时更换损坏的硬盘，否则其他的镜像盘也出现问题了，会导致系统的崩溃。</p><p>更换硬盘后需要很长的时间同步镜像，虽然对数据的访问不会受到影响，但是对整个系统的性能是会有所下降的。</p><p>RAID 1在读的速度上要比RAID 0快。</p><p>####数据库中使用的RAID 5级别</p><p>RAID 5又称之为分布式奇偶校验磁盘阵列，通过分布式奇偶校验块把数据分散到多个磁盘上，这样如果任何一个盘数据失效，都可以从奇偶校验块中重建。但是如果两块磁盘失效，则整个卷的数据都无法恢复。</p><p><img src="http://www.maixj.net/wp-content/uploads/2015/02/raid5.gif" alt="RAID 5"></p><p>在RAID 5上随机比较慢，因为每次写都需要两次读和两次写，以计算校验位的数值，比较适合以读为主的数据库业务。</p><p>最大的性能问题，发生在磁盘失效的时候，因为数据需要重新分布到其他磁盘上，这样会严重影响数据库性能，如果要使用RAID 5的话，最好使用在从服务器上。</p><h4 id="数据库中使用的RAID-10级别"><a href="#数据库中使用的RAID-10级别" class="headerlink" title="数据库中使用的RAID 10级别"></a>数据库中使用的RAID 10级别</h4><p>RAID 10又称分片的镜像，她是对磁盘先做RAID 1之后对两组RAID 1的磁盘再做RAID 0，所以对读写都有良好的性能，相对于RAID 5重建起来更简单，速度也更快。</p><p><img src="http://www.maixj.net/wp-content/uploads/2015/02/raid01.jpg" alt="RAID 10"></p><h4 id="RAID级别的选择"><a href="#RAID级别的选择" class="headerlink" title="RAID级别的选择"></a>RAID级别的选择</h4><table><thead><tr><th style="text-align:center">等级</th><th style="text-align:center">特点</th><th style="text-align:center">是否冗余</th><th style="text-align:center">盘数</th><th style="text-align:center">读</th><th style="text-align:center">写</th></tr></thead><tbody><tr><td style="text-align:center">RAID 0</td><td style="text-align:center">便宜，快速，危险</td><td style="text-align:center">无</td><td style="text-align:center">N</td><td style="text-align:center">快</td><td style="text-align:center">快</td></tr><tr><td style="text-align:center">RAID 1</td><td style="text-align:center">高速读，简单，安全</td><td style="text-align:center">有</td><td style="text-align:center">2</td><td style="text-align:center">快</td><td style="text-align:center">慢</td></tr><tr><td style="text-align:center">RAID 5</td><td style="text-align:center">安全，成本这种</td><td style="text-align:center">有</td><td style="text-align:center">N+1</td><td style="text-align:center">快</td><td style="text-align:center">取决于最慢的盘</td></tr><tr><td style="text-align:center">RAID 10</td><td style="text-align:center">贵，告诉，安全</td><td style="text-align:center">有</td><td style="text-align:center">2N</td><td style="text-align:center">快</td><td style="text-align:center">快</td></tr></tbody></table><h3 id="固态存储"><a href="#固态存储" class="headerlink" title="固态存储"></a>固态存储</h3><ol><li>拥有更好的随机读写性能。</li><li>能够更好的支持并发</li><li>更容易损坏</li></ol><p>在数据库存储中，我们常用的固态存储设备是SSD和PCI-E SSD。</p><h4 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h4><ol><li>使用SATA接口，可以替换传统磁盘而无需任何改变 </li><li>SATA接口的SSD同样支持RAID技术</li></ol><h4 id="PCI-E-SSD"><a href="#PCI-E-SSD" class="headerlink" title="PCI-E SSD"></a>PCI-E SSD</h4><ol><li>无法使用SATA接口，需要独特的驱动和配置</li><li>价格相比SSD要贵，但是性能比SSD更好</li></ol><p>PCI-E会占用服务器的内存。</p><h4 id="固态存储的使用场景"><a href="#固态存储的使用场景" class="headerlink" title="固态存储的使用场景"></a>固态存储的使用场景</h4><ol><li><p>适用于存在大量随机I/O的场景</p></li><li><p>使用于解决单线程负载的I/O场景</p><p>如果只有一块固态存储设备我们更应该将其放在从服务器上，因为从服务器是单线程的，而主DB是多线程的写入，为了产生更少的延迟，我们应该增加从服务器的I/O性能，而且由于固态设备易损耗，在主服务器上使用存在一定的安全隐患。</p></li></ol><h3 id="网络存储SAN和NAS"><a href="#网络存储SAN和NAS" class="headerlink" title="网络存储SAN和NAS"></a>网络存储SAN和NAS</h3><p><strong>SAN</strong>(Storage Area Network)和<strong>NAS</strong>(Network-Attached Storage)是两种外部文件存储设备加载到服务器上的方法</p><p>SAN设备通过光纤连接到服务器，设备通过块接口访问，服务器可以将其当做硬盘使用。</p><p>NAS设备使用网络连接，通过基于文件的协议如NFS或SMB来访问。</p><h4 id="网络存储适用的场景"><a href="#网络存储适用的场景" class="headerlink" title="网络存储适用的场景"></a>网络存储适用的场景</h4><p>网络存储在随机I/O比较差，并不适合MySQL数据库存储数据，有一些人认为可以使用网络存储实现服务的高可用性，比如两台服务器挂在同一网络环境下的磁盘，当主服务器可以由主备服务器来接管磁盘来提供服务，提高系统的可用性。</p><p>虽然能够在一定条件下能够提高系统的可用性，可是却是以牺牲性能为代价，而且，一旦网络存储设备出现问题，则需要更多的时间进行恢复。</p><p>不过，我们可以利用网络存储设备来存储数据库的备份文件，当一台独立服务器出现故障，短时间内无法恢复的情况下，可以利用网络存储设备上存储的备份文件恢复是实例。</p><h3 id="网络接口设备对数据库性能的影响"><a href="#网络接口设备对数据库性能的影响" class="headerlink" title="网络接口设备对数据库性能的影响"></a>网络接口设备对数据库性能的影响</h3><ol><li>网络带宽对性能的影响</li><li>网络质量对性能的影响</li></ol><p>建议</p><ul><li>采用高性能和高贷款的网络设备和交换机</li><li>对多个网卡进行绑定，增强可用性和带宽</li><li>尽可能的进行网络隔离</li></ul><h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>CPU</p><ul><li>64位的CPU一定要工作在64位的系统下</li><li>对于并发比较高的场景CPU的数量比频率更重要</li><li>对于CPU密集性场景和复杂SQL则频率越高越好</li></ul><p>内存</p><ul><li>选择主板所能使用的最高频率的内存</li><li>内存的大小对性能很重要，所以尽可能的大</li></ul><p>I/O子系统</p><ul><li>PCie -&gt; SSD -&gt; Raid10 &gt; 磁盘 -&gt; SAN</li></ul>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>MYSQL性能优化（2）：大表对MySQL带来的影响</title>
      <link href="/2017/09/16/2/"/>
      <content type="html"><![CDATA[<h3 id="什么样的表才可以被称之为大表"><a href="#什么样的表才可以被称之为大表" class="headerlink" title="什么样的表才可以被称之为大表?"></a>什么样的表才可以被称之为大表?</h3><p>所谓的大表都是相对而言的，对不同的存储引擎都有不同的限制，Innodb并没有定义每张表的最大行数，只要物理磁盘允许，我们就可以将数据存入数据库中。</p><p>在实际使用过程中，当数据量超过千万行之后，就会对数据库的性能造成影响。</p><ul><li>记录行数巨大，单表超过前往行</li><li>表数据文件巨大，表数据文件超过10G </li></ul><p>当然这也是相对的，也要跟我们的业务场景，磁盘 IO情况而定，如果这个表只是用来记录日志的，只有INSERT、SELECT 操作，而几乎没有 UPDATE 和 DELETE的操作，就算是超过了千万行，对我们的业务操作也没有太大的影响。</p><p>但是也有例外的情况，如果我们要对超过10G 的日志表追加列，如果这个时候，这个表被同步到N台服务器上后，就会变成一场灾难。</p><h4 id="大表对查询的影响"><a href="#大表对查询的影响" class="headerlink" title="大表对查询的影响"></a>大表对查询的影响</h4><p>慢查询：很难在一定的时间内过滤出所需要的重要数据。</p><h4 id="大表对-DDL-操作的影响："><a href="#大表对-DDL-操作的影响：" class="headerlink" title="大表对 DDL 操作的影响："></a>大表对 DDL 操作的影响：</h4><p>建立索引需要很长的时间。</p><p>风险： </p><ul><li>MYSQL 版本 &lt; 5.5 建立索引会锁表</li><li>MYSQL 版本 &gt;= 5.5 虽然不会锁表但会引起长时间的主从延迟</li></ul><h4 id="修改表结构需要长时间锁表"><a href="#修改表结构需要长时间锁表" class="headerlink" title="修改表结构需要长时间锁表"></a>修改表结构需要长时间锁表</h4><p>风险： 会造成长时间的主从延迟，由于主从复制的机制都是现在主库上完成操作，再传输到从库上，在执行相同操作，如果在主库上需要使用480s 的时间来完成 DDL 操作，在从服务器上至少也需要480s。</p><h4 id="影响正常数据库操作。"><a href="#影响正常数据库操作。" class="headerlink" title="影响正常数据库操作。"></a>影响正常数据库操作。</h4><p>进行 DDL 时会被锁表，这样一来就会造成堵塞，在这一个阶段，数据库连接数会被激增，一旦数据库连接数被沾满，前台就会出现500错误。</p><h3 id="如何处理数据库中的大表"><a href="#如何处理数据库中的大表" class="headerlink" title="如何处理数据库中的大表"></a>如何处理数据库中的大表</h3><h4 id="分库分表把一张大表分成多个小表"><a href="#分库分表把一张大表分成多个小表" class="headerlink" title="分库分表把一张大表分成多个小表"></a>分库分表把一张大表分成多个小表</h4><p>难点： </p><p><strong>1.分表主键的选择。</strong></p><p>这个往往根据业务的不同，有多种分表的方式，比如对于订单表来说，可以根据订单号分表，也可以根据供应商和地区域来进行分表，选择合适的分区键对于后期的分表是十分重要的。</p><p><strong>2.分表后跨分区数据的查询和统计</strong></p><p>不要认为选择了好的分区键后就不需要跨分区进行查询了，好的分区键只能尽量避免跨分区查询。</p><h4 id="大表的历史数据归档"><a href="#大表的历史数据归档" class="headerlink" title="大表的历史数据归档"></a>大表的历史数据归档</h4><p>使用这种方法，可以减少对前后端业务的影响，因为表结构并没有发生变化，一切的程序都可以正常的使用，对于历史订单可以开放一个接口。</p><p>而且归档表可以跟正在使用的表放在不同的服务器上，一方面减少了热数据所在服务器的表容量，同时也减少了服务器的查询压力，对于后端业务而言，应该是已经完成相关操作和统计的历史数据。</p><p>难点：</p><ol><li><p>归档时间点的选择。</p></li><li><p>如何进行归档操作，对于大表的增删改查都要十分的小心，既然我们要归档，就要把要归档的数据从数据库中移除，从一个上亿行的数据表中移出上百万行的时候，就要注意方式了，轻则会产生主从延迟，严重会产生大量的阻塞。</p></li></ol>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MySQL主从数据库</title>
      <link href="/2017/09/10/1/"/>
      <content type="html"><![CDATA[<h2 id="什么是mysql主从同步？"><a href="#什么是mysql主从同步？" class="headerlink" title="什么是mysql主从同步？"></a>什么是mysql主从同步？</h2><p>当master(主)库的数据发生变化的时候，变化会实时的同步到slave(从)库。</p><p>##主从同步有什么好处？</p><ul><li>水平扩展数据库的负载能力。</li><li>容错，高可用。Failover(失败切换)/High Availability</li><li>数据备份。</li></ul><h2 id="主从同步的原理是什么？"><a href="#主从同步的原理是什么？" class="headerlink" title="主从同步的原理是什么？"></a>主从同步的原理是什么？</h2><p>首先我们来了解<strong>master-slave</strong>的体系结构。</p><p>如下图：<br><img src="https://segmentfault.com/img/remote/1460000008663004?w=601&amp;h=152" alt="img"></p><p>不管是delete、update、insert，还是创建函数、存储过程，所有的操作都在master上。<br>当master有操作的时候,slave会快速的接收到这些操作，从而做同步。</p><p>但是，这个机制是怎么实现的呢？</p><blockquote><p>在master机器上，主从同步事件会被写到特殊的log文件中(binary-log);<br>在slave机器上，slave读取主从同步事件，并根据读取的事件变化，在slave库上做相应的更改。</p></blockquote><p>如此，就实现了主从同步了！</p><p>下面我们来详细的了解。</p><h3 id="主从同步事件有哪些"><a href="#主从同步事件有哪些" class="headerlink" title="主从同步事件有哪些"></a>主从同步事件有哪些</h3><p>上面说到：</p><blockquote><p>在master机器上，主从同步事件会被写到特殊的log文件中(binary-log);</p></blockquote><p>主从同步事件有3种形式:statement、row、mixed。</p><ul><li>statement：会将对数据库操作的sql语句写入到binlog中。</li><li>row：会将每一条数据的变化写入到binlog中。</li><li>mixed：statement与row的混合。Mysql决定什么时候写statement格式的，什么时候写row格式的binlog。</li></ul><h3 id="在master机器上的操作"><a href="#在master机器上的操作" class="headerlink" title="在master机器上的操作"></a>在master机器上的操作</h3><ul><li>当master上的数据发生改变的时候，该事件(insert、update、delete)变化会按照顺序写入到binlog中。</li></ul><h4 id="binlog-dump线程"><a href="#binlog-dump线程" class="headerlink" title="binlog dump线程"></a>binlog dump线程</h4><ul><li>当slave连接到master的时候，master机器会为slave开启binlog dump线程。</li><li>当master 的 binlog发生变化的时候，binlog dump线程会通知slave，并将相应的binlog内容发送给slave。</li></ul><h3 id="在slave机器上的操作"><a href="#在slave机器上的操作" class="headerlink" title="在slave机器上的操作"></a>在slave机器上的操作</h3><p>当主从同步开启的时候，slave上会创建2个线程。</p><ul><li>I/O线程。该线程连接到master机器，master机器上的<strong>binlog dump线程</strong>会将binlog的内容发送给该<strong>I/O线程</strong>。该<strong>I/O线程</strong>接收到binlog内容后，再将内容写入到本地的relay log。</li><li>SQL线程。该线程读取I/O线程写入的relay log。并且根据relay log的内容对slave数据库做相应的操作。</li></ul><h3 id="如何在master、slave上查看上述的线程？"><a href="#如何在master、slave上查看上述的线程？" class="headerlink" title="如何在master、slave上查看上述的线程？"></a>如何在master、slave上查看上述的线程？</h3><p>使用<code>SHOW PROCESSLIST</code>命令可以查看。</p><p>如图，在master机器上查看binlog dump线程。<br><img src="https://segmentfault.com/img/remote/1460000008663005?w=604&amp;h=448" alt="img"></p><p>如图，在slave机器上查看I/O、SQL线程。<br><img src="https://segmentfault.com/img/remote/1460000008663006?w=626&amp;h=592" alt="img"></p><h2 id="讲了这么多，一图以蔽之"><a href="#讲了这么多，一图以蔽之" class="headerlink" title="讲了这么多，一图以蔽之"></a>讲了这么多，一图以蔽之</h2><p><img src="https://segmentfault.com/img/remote/1460000008663007?w=630&amp;h=568" alt="img"></p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">os:ubuntu16.04</div><div class="line">mysql:5.7.17</div><div class="line"></div><div class="line">master IP:192.168.33.22</div><div class="line">slave  IP:192.168.33.33</div></pre></td></tr></table></figure><h3 id="master机器上的操作"><a href="#master机器上的操作" class="headerlink" title="master机器上的操作"></a>master机器上的操作</h3><h4 id="1、更改配置文件"><a href="#1、更改配置文件" class="headerlink" title="1、更改配置文件"></a>1、更改配置文件</h4><p>我们找到文件 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>。<br>配置如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bind-address = 192.168.33.22 #your master ip</div><div class="line">server-id = 1 #在master-slave架构中，每台机器节点都需要有唯一的server-id</div><div class="line">log_bin = /var/log/mysql/mysql-bin.log #开启binlog</div></pre></td></tr></table></figure><h4 id="2、重启MySQL"><a href="#2、重启MySQL" class="headerlink" title="2、重启MySQL"></a>2、重启MySQL</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart mysql</div></pre></td></tr></table></figure><h4 id="3、创建主从同步的mysql-user。"><a href="#3、创建主从同步的mysql-user。" class="headerlink" title="3、创建主从同步的mysql user。"></a>3、创建主从同步的mysql user。</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> mysql -u root -p</div><div class="line">Password:</div><div class="line"><span class="meta"></span></div><div class="line">##创建slave1用户，并指定该用户只能在主机192.168.33.33上登录。</div><div class="line"><span class="meta">mysql&gt;</span> CREATE USER 'slave1'@'192.168.33.33' IDENTIFIED BY 'slavepass';</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"><span class="meta"></span></div><div class="line">##为slave1赋予REPLICATION SLAVE权限。</div><div class="line"><span class="meta">mysql&gt;</span> GRANT REPLICATION SLAVE ON *.* TO 'slave1'@'192.168.33.33';</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure><h4 id="4、为MYSQL加读锁"><a href="#4、为MYSQL加读锁" class="headerlink" title="4、为MYSQL加读锁"></a>4、为MYSQL加读锁</h4><p>为了主库与从库的数据保持一致，我们先为mysql加入读锁，使其变为只读。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure><h4 id="5、记录下来MASTER-REPLICATION-LOG-的位置"><a href="#5、记录下来MASTER-REPLICATION-LOG-的位置" class="headerlink" title="5、记录下来MASTER REPLICATION LOG 的位置"></a>5、记录下来MASTER REPLICATION LOG 的位置</h4><p>该信息稍后会用到。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW MASTER STATUS;</div><div class="line">+------------------+----------+--------------+------------------+-------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+------------------+----------+--------------+------------------+-------------------+</div><div class="line">| mysql-bin.000001 |      613 |              |                  |                   |</div><div class="line">+------------------+----------+--------------+------------------+-------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure><h4 id="6、将master-DB中现有的数据信息导出"><a href="#6、将master-DB中现有的数据信息导出" class="headerlink" title="6、将master DB中现有的数据信息导出"></a>6、将master DB中现有的数据信息导出</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mysqldump -u root -p --all-databases --master-data &gt; dbdump.sql</div></pre></td></tr></table></figure><h4 id="7、接触master-DB的读锁"><a href="#7、接触master-DB的读锁" class="headerlink" title="7、接触master DB的读锁"></a>7、接触master DB的读锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; UNLOCK TABLES;</div></pre></td></tr></table></figure><h4 id="8、将步骤6中的dbdump-sql文件copy到slave"><a href="#8、将步骤6中的dbdump-sql文件copy到slave" class="headerlink" title="8、将步骤6中的dbdump.sql文件copy到slave"></a>8、将步骤6中的dbdump.sql文件copy到slave</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp dbdump.sql ubuntu@192.168.33.33:/home/ubuntu</div></pre></td></tr></table></figure><h3 id="slave机器上的操作"><a href="#slave机器上的操作" class="headerlink" title="slave机器上的操作"></a>slave机器上的操作</h3><h4 id="1、更改配置文件-1"><a href="#1、更改配置文件-1" class="headerlink" title="1、更改配置文件"></a>1、更改配置文件</h4><p>我们找到文件 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>。<br>更改配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bind-address = 192.168.33.33 #your slave ip</div><div class="line">server-id = 2 #master-slave结构中，唯一的server-id</div><div class="line">log_bin = /var/log/mysql/mysql-bin.log #开启binlog</div></pre></td></tr></table></figure><h4 id="2、重启mysql，以使配置文件生效"><a href="#2、重启mysql，以使配置文件生效" class="headerlink" title="2、重启mysql，以使配置文件生效"></a>2、重启mysql，以使配置文件生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart mysql</div></pre></td></tr></table></figure><h4 id="3、导入从master-DB。-导出的dbdump-sql文件，以使master-slave数据一致"><a href="#3、导入从master-DB。-导出的dbdump-sql文件，以使master-slave数据一致" class="headerlink" title="3、导入从master DB。 导出的dbdump.sql文件，以使master-slave数据一致"></a>3、导入从master DB。 导出的dbdump.sql文件，以使master-slave数据一致</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mysql -u root -p &lt; /home/ubuntu/dbdump.sql</div></pre></td></tr></table></figure><h4 id="4、使slave与master建立连接，从而同步"><a href="#4、使slave与master建立连接，从而同步" class="headerlink" title="4、使slave与master建立连接，从而同步"></a>4、使slave与master建立连接，从而同步</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ mysql -u root -p</div><div class="line">Password:</div><div class="line"></div><div class="line">mysql&gt; STOP SLAVE;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; CHANGE MASTER TO</div><div class="line">    -&gt; MASTER_HOST=&apos;192.168.33.22&apos;,</div><div class="line">    -&gt; MASTER_USER=&apos;slave1&apos;,</div><div class="line">    -&gt; MASTER_PASSWORD=&apos;slavepass&apos;,</div><div class="line">    -&gt; MASTER_LOG_FILE=&apos;mysql-bin.000001&apos;,</div><div class="line">    -&gt; MASTER_LOG_POS=613;</div><div class="line">Query OK, 0 rows affected, 2 warnings (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; START SLAVE;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure><p><code>MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;</code>与<code>MASTER_LOG_POS=613</code>的值，是从上面的 <code>SHOW MASTER STATUS</code> 得到的。</p><p>经过如此设置之后，就可以进行master-slave同步了~</p><h2 id="PHP代码实现数据库读写分离"><a href="#PHP代码实现数据库读写分离" class="headerlink" title="PHP代码实现数据库读写分离"></a>PHP代码实现数据库读写分离</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Db</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> $res;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($sql)</span></span></div><div class="line">    &#123;</div><div class="line">        $querystr = strtolower(trim(substr($sql,<span class="number">0</span>,<span class="number">6</span>)));</div><div class="line">        <span class="comment">//如果是select，就连接slave服务器</span></div><div class="line">        <span class="keyword">if</span>($querystr == <span class="string">'select'</span>)</div><div class="line">        &#123;</div><div class="line">            $res=<span class="keyword">$this</span>-&gt;slave_select($sql);</div><div class="line">            <span class="keyword">$this</span>-&gt;res=$res;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//如果不是select，就连接master服务器</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            $res=<span class="keyword">$this</span>-&gt;master_change($sql);</div><div class="line">            <span class="keyword">$this</span>-&gt;res=$res;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * slave从库返回sql查询结果</div><div class="line">     * <span class="doctag">@param</span> $sql</div><div class="line">     * <span class="doctag">@return</span> array</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">slave_select</span><span class="params">($sql)</span></span>&#123;</div><div class="line">        <span class="comment">//该处只是随机获取slave节点的ip，当然，还可以采用其他算法获取slave_ip</span></div><div class="line">        $slave_server=<span class="keyword">$this</span>-&gt;get_slave_ip();</div><div class="line">        $dsn=<span class="string">"mysql:host=$slave_server;dbname=test"</span>;</div><div class="line">        $user=<span class="string">'root'</span>;</div><div class="line">        $pass=<span class="string">'123456'</span>;</div><div class="line">        $dbh=<span class="keyword">new</span> PDO($dsn, $user, $pass);</div><div class="line">        <span class="keyword">return</span> $dbh-&gt;query($sql)-&gt;fetchAll(PDO::FETCH_ASSOC);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**master主库返回sql执行结果</span></div><div class="line">     * <span class="doctag">@param</span> $sql</div><div class="line">     * <span class="doctag">@return</span> int</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">master_change</span><span class="params">($sql)</span></span>&#123;</div><div class="line">        $master_server=<span class="string">'192.168.33.22'</span>;</div><div class="line">        $dsn=<span class="string">"mysql:host=$master_server;dbname=test"</span>;</div><div class="line">        $user=<span class="string">'root'</span>;</div><div class="line">        $pass=<span class="string">'123456'</span>;</div><div class="line">        $dbh=<span class="keyword">new</span> PDO($dsn, $user, $pass);</div><div class="line">        <span class="keyword">return</span> $dbh-&gt;exec($sql);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 随机获取slave-ip</div><div class="line">     * <span class="doctag">@return</span> mixed</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_slave_ip</span><span class="params">()</span></span>&#123;</div><div class="line">        $slave_ips=[<span class="string">'192.168.33.33'</span>,<span class="string">'192.168.33.44'</span>];</div><div class="line">        $count=count($slave_ips)<span class="number">-1</span>;</div><div class="line">        $random_key=mt_rand(<span class="number">0</span>,$count);</div><div class="line">        <span class="keyword">return</span> $slave_ips[$random_key];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取结果</div><div class="line">     * <span class="doctag">@return</span> int</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_res</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$sql1 = <span class="string">"select * from t1"</span>;</div><div class="line">$sql2 = <span class="string">"insert into t1 (name) values ('haha')"</span>;</div><div class="line">$sql3 = <span class="string">"delete from t1 where id=1"</span>;</div><div class="line">$sql4 = <span class="string">"update t1 set name='Jerry' where id=2"</span>;</div><div class="line"></div><div class="line">$db = <span class="keyword">new</span> Db($sql1);</div><div class="line"><span class="comment">//$db = new Db($sql2);</span></div><div class="line"><span class="comment">//$db = new Db($sql3);</span></div><div class="line"><span class="comment">//$db = new Db($sql4);</span></div><div class="line"></div><div class="line">var_dump($db-&gt;get_res());</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>法律结构条、款、项、目</title>
      <link href="/2017/09/05/1/"/>
      <content type="html"><![CDATA[<p>公司的新项目上线了，我们要为律师团队开发一套内部系统，其中包括爬虫抓来的问答、法律条款的检索。</p><p>而法律条文不能直接以文章的形式存储，因为后期可能会涉及到法律条文的引用，例如：</p><p><em>《烟草专卖法》第二条第二款</em></p><p>一般来讲，一件(部)法律由章、节、条、款、项、目组成，个别重要的法典还分编。</p><p>编、章、节是对法条的归类，所以，在适用法律时只需引用到条、款、项、目即可，无需指出该条所在的编、章、节。因此，弄懂法律规范中条、款、项、目的含义，在执法活动中正确适用法律规范的条、款、项、目，对于规范执法行为，提高执法质量是大有益处的。</p><h2 id="一、“条”"><a href="#一、“条”" class="headerlink" title="一、“条”"></a>一、“条”</h2><h3 id="1-条的概念"><a href="#1-条的概念" class="headerlink" title="1. 条的概念"></a>1. 条的概念</h3><p>法律规范的“条”，又称“法条”，是组成法律规范的基本单位。一部法律，都是由若干法条组成的。如《烟草专卖法》由46个法条组成，《烟草专卖法实施条例》由70个法条组成。</p><p>法律规范的“条”，是法律规范对某一个具体法律问题的完整规定，如：</p><blockquote><p>《烟草专卖法》第三十条  违反本规定擅自收购烟叶的，由烟草专卖行政主管部门处以罚款，并按照国家规定的价格收购违法收购的烟叶；数量巨大的，没收违法收购的烟叶和违法所得。</p></blockquote><p> 这一条就是对擅自收购烟叶法律责任的完整规定。</p><p>###　2. 条的书写</p><p>​    一般来讲，条的数目的书写应使用中文，如《烟草专卖法》第三十条。但也有使用阿拉伯数字的，如《烟草专卖法》第30条。</p><p>​    执法活动中，对一个涉法问题作出决定时，可能要适用多个法条。如对无证运输的人进行处罚时，应同时适用《烟草专卖法》第三十一条第一款、《条例》第五十五条第一项和第六十九条的规定。</p><h2 id="二、“款”"><a href="#二、“款”" class="headerlink" title="二、“款”"></a>二、“款”</h2><h3 id="1-款的概念。"><a href="#1-款的概念。" class="headerlink" title="1. 款的概念。"></a>1. 款的概念。</h3><p> “款”是“条”的组成部分。在一般情况下，每一款都是一个独立的内容或是对其前一款内容的补充表述。如：</p><blockquote><p>《烟草专卖法》第二条　</p><p>本法所称烟草专卖品是指卷烟、雪茄烟、烟丝、复烤烟叶、烟叶、卷烟纸、滤嘴棒、烟用丝束、烟草专用机械。</p><p><em>卷烟、雪茄烟、烟丝复烤烟叶统称烟草制品。</em></p></blockquote><p>《烟草专卖法》第二条有二款。其中第一款界定了烟草专卖品的范围，第二款进一步界定了烟草制品的范围。</p><h3 id="2-款的表现形式。"><a href="#2-款的表现形式。" class="headerlink" title="2. 款的表现形式。"></a>2. 款的表现形式。</h3><p>“款”的表现形式为条中的自然段，每个自然段为一款。</p><p>“款”前不冠以数字以排列其顺序。如《烟草专卖法》第二条的两款，款前均无数字。有数字排列的不称为款。如：</p><blockquote><p>《条例》第七条取得烟草专卖生产企业许可证，应当具备下列条件：</p><p>(一)有与生产烟草专卖品相适应的资金；</p><p>(二)有生产烟草专卖品所需要的技术、设备条件；</p><p>(三)符合国家烟草行业的产业政策要求；</p><p>(四)国务院烟草专卖行政主管部门规定的其他条件。</p></blockquote><p>上条第一段冒号下为：(一) 有与生产烟草专卖品相适应的资金。该段文字虽然是另起一行，但因为上段结束符号是冒号，本段开始前有(一)，因此，该段文字不视为是一个自然段，也不能认为其是一款。</p><h3 id="3-关于款的数目的书写。"><a href="#3-关于款的数目的书写。" class="headerlink" title="3. 关于款的数目的书写。"></a>3. 关于款的数目的书写。</h3><p>款的数目的书写一般应当使用中文，不用阿拉伯数字。如《烟草专卖法》第二条第二款，不写作《烟草专卖法》第二条第2款。</p><h3 id="4-款的适用"><a href="#4-款的适用" class="headerlink" title="4. 款的适用"></a>4. 款的适用</h3><p> 款一般可以独立适用，如《烟草专卖法》第二条第二款，但也有例外的，但与烟草专卖有关的法律法规中少见。</p><p>一个法条有两款或者两款以上的，应当适用到款。一个法条只有一款的，应当直接适用该法条，不应称作该条第一款，如：</p><blockquote><p>《条例》第三条烟草专卖品中的烟丝是指用烟叶、复烤烟叶、烟草薄片为原料加工制成的丝、末、粒状商品。</p></blockquote><p>在引用时，就应该写作“根据《实施条例》第三条”，而不是“根据《实施条例》第三条第一款”。</p><p>参照最高人民法院《关于引用法律、法令等所列条、款、项,目顺序的通知》，如果某一条下面没有分款而直接分列几项的，就不要加“第一款”，例如《条例》第七条只有（一）（二）（三）三项，就不要写“第七条第一款第一项”，而直接写“第七条第一项”。</p><h3 id="三、“项”"><a href="#三、“项”" class="headerlink" title="三、“项”"></a>三、“项”</h3><h3 id="1-项的概念"><a href="#1-项的概念" class="headerlink" title="1. 项的概念"></a>1. 项的概念</h3><p> 一般来讲，“项”是以列举的形式对前段文字的说明。如：</p><blockquote><p>《条例》第四十九条烟草专卖行政主管部门查处违反《烟草专卖法》和本条例的案件时，可以行使下列职权：</p><p>(一)询问违法案件的当事人、嫌疑人和证人；</p><p>(二)检查违法案件当事人的经营场所，依法对违法生产或者经营的烟草专卖品进行处理；</p><p>(三)查阅、复制与违法活动有关的合同、发票、账册、单据、记录、文件、业务函电和其他资料。</p></blockquote><p>​    该条的三个项是对前段文字中“下列职权”的列举式说明。</p><h3 id="2-项的表现形式"><a href="#2-项的表现形式" class="headerlink" title="2. 项的表现形式"></a>2. 项的表现形式</h3><p>含有项的法条，其前段文字中一般都有“下列”二字或相应的文字表述。“项”前冠以数字以对列举的内容进行排列。如《条例》四十九条，各项前都冠以(一)、(二)、(三)等数字，而且这些数字只能以中文数字加括号的形式出现。</p><h3 id="3-项的数目的书写"><a href="#3-项的数目的书写" class="headerlink" title="3. 项的数目的书写"></a>3. 项的数目的书写</h3><p>项的数目的书写一般应当使用中文加括号，不用阿拉伯数字。如《条例》第四十九条第（三）项，不写作《条例》第四十九条第3项。</p><h3 id="4-项的适用"><a href="#4-项的适用" class="headerlink" title="4. 项的适用"></a>4. 项的适用</h3><p>对含有项的法条，适用时应当适用到项；如对无证运输的处罚，应当适用《条例》第五十五条第(一)项。适用到项，是对被处罚的无证运输行为性质和情节的一种界定。如果不适用到项，该无证运输的行为就不知是四种行为之中的哪一种行为，有适用法律不准确之嫌。</p><p>根据立法技术的不同需要，“项”可以依附于条，也可以依附于款。即条中可以有项，款中也可以有项。</p><h3 id="四、“目”"><a href="#四、“目”" class="headerlink" title="四、“目”"></a>四、“目”</h3><h3 id="1-目的概念"><a href="#1-目的概念" class="headerlink" title="1. 目的概念"></a>1. 目的概念</h3><p> “目”隶属于项，是法律规范中最小的单位。“目”的特性与作用与“项”相似，不同的是项对条或款的列举式说明，而“目”是对项的列举式说明。如《条例》第五十五条第(二)项：</p><blockquote><p>(二)有下列情形之一的，没收违法运输的烟草专卖品和违法所得：</p><ol><li>非法运输的烟草专卖品价值超过5万元或者运输卷烟数量超过100件（每1万支为1件）的；</li><li>被烟草专卖行政主管部门处罚两次以上的；</li><li>抗拒烟草专卖行政主管部门的监督检查人员依法实施检查的；</li><li>非法运输走私烟草专卖品的；</li><li>运输无烟草专卖生产企业许可证的企业生产的烟草专卖品的；</li><li>利用伪装非法运输烟草专卖品的；</li><li>利用特种车辆运输烟草专卖品逃避检查的；</li><li>其他非法运输行为，情节严重的。</li></ol></blockquote><p>​    这八种情形，就是该项的八个目，列举没收违法运输的烟草专卖品和违法所得的八种情况。</p><h3 id="2-目的表现形式"><a href="#2-目的表现形式" class="headerlink" title="2. 目的表现形式"></a>2. 目的表现形式</h3><p>​    目的前面冠以阿拉伯数字，并在阿拉伯数字后加点(在具体引用法条的目时，只注明阿拉伯数字，无须加点)，例如《条例》第五十五条第(二)项第7目。</p><h3 id="3-目的适用"><a href="#3-目的适用" class="headerlink" title="3. 目的适用"></a>3. 目的适用</h3><p>如果某个法条或款的内容有“项”，而“项”下还有“目”的，在适用法律时就应当适用到“目”。如烟草专卖局在对非法运输走私烟草专卖品的行为进行处罚时，就应当适用《条例》第五十五条第(二)项第4目。当然，如果既非法运输走私烟草专卖品又利用特种车辆运输逃避检查，在作出处罚决定时就应同时适用相应的两个目。</p>]]></content>
      
      <categories>
          
          <category> 随笔 </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>一本深入学习PHP内核的书 -《PHP internals Book》</title>
      <link href="/2017/08/20/10/"/>
      <content type="html"><![CDATA[<p>今天给大家介绍一本 PHP 扩展开发相关的书籍<a href="http://www.phpinternalsbook.com/" target="_blank" rel="noopener">《PHP internals Book》</a>，这本书是几个PHP开发人员之间的协作努力，可以更好地记录和描述PHP内部的工作原理。</p><p>《PHP internals Book》 有三个主要目标：</p><ul><li>记录和描述PHP内部工作原理。</li><li>记录并描述如何使用扩展扩展语言。</li><li>记录并描述如何与社区进行交互以开发PHP本身。</li></ul><p>《PHP internals Book》 主要面向具有C编程语言经验的开发人员。然而，尽管如此，我们将尝试提炼信息并对其进行总结，以便不了解C的开发人员仍然能够理解内容。</p><p>但是，让我们坚持。如果您不知道C语言，您将无法实现高效，稳定（任何平台下的崩溃），性能和实用性。以下是有关C语言本身，生态系统和构建工具以及操作系统API的一些非常好的在线资源：</p><ul><li><a href="http://www.tenouk.com/" target="_blank" rel="noopener">http://www.tenouk.com/</a></li><li><a href="https://en.wikibooks.org/wiki/C_Programming" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/C_Programming</a></li><li><a href="http://c-faq.com/" target="_blank" rel="noopener">http://c-faq.com/</a></li><li><a href="https://www.gnu.org/software/libc/" target="_blank" rel="noopener">https://www.gnu.org/software/libc/</a></li><li><a href="http://www.faqs.org/docs/Linux-HOWTO/Program-Library-HOWTO.html" target="_blank" rel="noopener">http://www.faqs.org/docs/Linux-HOWTO/Program-Library-HOWTO.html</a></li><li><a href="http://www.iecc.com/linker/linker10.html" target="_blank" rel="noopener">http://www.iecc.com/linker/linker10.html</a></li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Invert a Binary Tree</title>
      <link href="/2017/08/13/2/"/>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">     4                          4</div><div class="line">   /    \                     /    \</div><div class="line">  2      7         to        7      2 </div><div class="line"> / \    /  \                / \    /  \</div><div class="line">1   3  6    9              9   6  3    1</div></pre></td></tr></table></figure><p>解答：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Definition for a binary tree node.</div><div class="line"> * strcut TreeNode &#123;</div><div class="line"> *     int val;</div><div class="line"> *     TreeNode *left;</div><div class="line"> *     TreeNode *right;</div><div class="line"> *     TreeNode (index x) : val(x), left(NULL), right(NULL) &#123;&#125;</div><div class="line"> * &#125;</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">    <span class="function">TreeNode *<span class="title">invertTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>)</div><div class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">        TreeNoe * tmpNode = root-&gt;left;</div><div class="line">        root-&gt;left = invertTree(root-&gt;right);</div><div class="line">        root-&gt;right = invertTree(tmpNode);</div><div class="line">        <span class="keyword">return</span> root; </div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>利用的递归这个概念，短短几行就完成了一个翻转二叉树，只是在翻转二叉树的左右子数。</p>]]></content>
      
      <categories>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++,算法 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>算法笔试入门题目Memmove</title>
      <link href="/2017/08/13/1/"/>
      <content type="html"><![CDATA[<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memmove</span> <span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">const</span> <span class="keyword">void</span> *src, <span class="keyword">size_t</span> n)</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">//implementation here</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这是 C 语言中的一个库函数，他的功能是吧内存中一块内容从src拷贝到dest，固定的长度是n。</p><p>这是笔试中的一个入门体</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memmove</span> <span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">const</span> <span class="keyword">void</span> *scr, <span class="keyword">size_t</span> n)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">char</span> *p1 = dest;</div><div class="line"><span class="keyword">char</span> *p2 = src;</div><div class="line"></div><div class="line"><span class="keyword">while</span> (*p2 != \<span class="number">0</span>)</div><div class="line">*p1++ = *p2++;</div><div class="line"></div><div class="line"><span class="keyword">return</span> p1;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>上面的这份代码，可以完成要求，可是却存在一些问题，我们先来看一下，C语言中的一些让人进场不会注意到的陷阱。</p><ul><li>内存重叠的处理，从一个指针，它指向的内存地址，拷贝到另外一个地址，那么有没有可能是完全重合，或者有一部分是重合的。</li><li>临时变量太多 或者没有安全释放</li><li>没有测试内存越界，size 是否小于零，指针是否为空？</li><li>指针操作熟悉</li></ul><p>内存是否重叠？</p><p><img src="http://ogxeww23n.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-08-13%2014.45.22.png" alt="内存重叠">)</p><p>正确的写法</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memmove</span> <span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">const</span> <span class="keyword">void</span> *scr, <span class="keyword">size_t</span> n)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">char</span> *p1 = dest;</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *p2 = src;<span class="comment">//o用常量表示src</span></div><div class="line"></div><div class="line"><span class="comment">//判断src 和 dest 的位置关系</span></div><div class="line"><span class="keyword">if</span>  (p2 &lt; p1) &#123; </div><div class="line">p2 += n;</div><div class="line">p1 += n;</div><div class="line"><span class="keyword">while</span> (n-- != <span class="number">0</span>) </div><div class="line">*--p1 = *--p2;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">while</span> (n-- != <span class="number">0</span>) &#123;</div><div class="line">*p1++ = *p2++;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> p1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Array&amp;String算法</title>
      <link href="/2017/08/12/1/"/>
      <content type="html"><![CDATA[<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Returns the position of the first occurrence of string target in string source or -1 if target is not part of source.</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">strStr</span> <span class="params">(String source, String target)</span> </span>&#123;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>希望在 <code>string</code> 里面寻找<code>target</code>，如果找到一个完全匹配的话，就返回他所在的位置，如果不存在就返回<code>-1</code>;</p><h1 id="字符串匹配"><a href="#字符串匹配" class="headerlink" title="字符串匹配"></a>字符串匹配</h1><p>两种比较容易实现的字符串比较算法。</p><p>假设在长度为 n的沐川中匹配长度为 m的子串。</p><p><code>Brute-Force</code> 算法： 顺序遍历母串，将每个字符作为匹配的起始字符，判断是否匹配子串。时间复杂度 O(m*n)</p><p><em>Brute-Force</em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">StrStr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">const</span> <span class="keyword">char</span> *target)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(!*target) <span class="keyword">return</span> str;</div><div class="line">    <span class="keyword">char</span> *p1 = (<span class="keyword">char</span> *)str;</div><div class="line">    <span class="keyword">while</span>(*p1) &#123;</div><div class="line">        <span class="keyword">char</span> *p1Begin = p1, *p2 = (<span class="keyword">char</span>*)target;</div><div class="line">        <span class="keyword">while</span>(*p1 &amp;&amp; *p2 &amp;&amp; *p1 == *p2) &#123;</div><div class="line">            p1++;</div><div class="line">            p2++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!*p2)<span class="comment">//发现p2走到了末尾，就意味着有匹配到的字符串，那么直接返回p1Begin;所记录的位置</span></div><div class="line">            <span class="keyword">return</span> p1Begin;</div><div class="line">        p1 = p1Begin + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> C/C++ </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Linux 和 GNU 工程</title>
      <link href="/2017/08/10/3/"/>
      <content type="html"><![CDATA[<p>每天都有许多计算机用户使用一个被改动过的GNU 系统 (18k 字节)，但是他们并没有意识到它。 经过一系列的事件，现在被广泛使用的 GNU 版本则经常被称作“Linux”，可是许多用户并不了解与之相关的 GNU 工程。</p><p>Linux 确实存在；它是一个内核，许多人都在使用它。但是你不能仅使用内核本身。内核只有作为整个系统的一个部分才有用处。Linux 是和 GNU 操作系统结合在一起使用：系统本身是 GNU，与 Linux 作为内核一起工作。</p><p>许多用户没有并不完全了解 Linux 内核和被称作“Linux”的整个系统的区别。而不加区别地使用这个名字并不能对理解有帮助。</p><p>程序员一般都知道 Linux 是一个内核。但是因为他们也听到整个系统被称作“Linux”，他们会根据名字去想象历史。比如，很多人认为当 Linus Torvalds 完成了内核后，他的朋友四处寻找其他的自由软件，而且所有的可以被组装成一个类似 Unix 系统的程序都是现成的。</p><p>他们的发现不是巧合 – 这就是 GNU 系统。 可用的自由软件加在一起就组成了一个完整的系统，这是由于自 1984 年就开始的 GNU 工程一直在为此努力。GNU 宣言(31k 字节) 早已设立了开发一个类似 Unix 的自由系统的目标，称作 GNU。GNU 工程的最初公告 也勾画了 GNU 系统的原始提纲。在 Linux 被编写时，这个系统几乎已经完成。</p><p>大多数自由软件的工程都是为了特定的工作开发特定的程序。比方说，Linus Torvalds 编写类似 Unix 的内核(Linux); Donald Knuth 编写一个文本格式化工具(TeX); Bob Scheifler 开发一个窗口系统(X Window System)。对于这项工程编写的程序都作出了贡献，对这些贡献进行评估是很自然的。</p><p>如果以这种方法来衡量对 GNU 工程的贡献，我们会得出什么结论？一个 CD-ROM的提供商发现在他们的“Linux 发行版”中，GNU 软件 占最大的比重，大约占全部源代码的 28% ，而且这还包括一些关键的部件，没有这些部件，系统就无法工作。Linux 本身占大约 3%。所以如果你要根据程序的作者来选择一个名字的话，最合适的选择是“GNU”。</p><p>但是我们不认为这是一个解决问题的适当方法。GNU 工程以前不是，现在也不是一个开发某个软件包的工程。它不是一个 开发 C 编译器的工程, 尽管我们做了。它也不是一个开发一个文本编辑器的工程，尽管我们也做了。GNU 工程的目标是开发一个完全自由的类似 Unix 的系统: GNU。</p><p>许多人已经为系统中的自由软件作出了重大贡献，他们都应该获得荣誉。但 GNU 是一个系统而不是一些实用程序的组合的原因是，GNU 工程的最初目标就是做一个完整系统。我们曾经为完成一个完整的系统做了一个所需程序清单，而且我们有系统地寻找，编写这些程序，并且寻找别人编写清单上的每一个程序。我们编写了关键的但是十分枯燥的主要部件，比如汇编语言和连接器，因为这是系统所必需的。除了编程工具，一个完整的系统还需要更多的东西， Bourne Again SHell 程序, PostScript 解释器 Ghostscript, 和 GNU C 库 同样是很重要的。</p><p>到了 90 年代初期，我们曾经把除了内核以外的东西放到一起组成了一个系统（我们同时也在做内核的工作）称为 GNU Hurd, 运行在 Mach 上)。开发这个内核比我们想象的要难得多，我们现在仍然在 为此工作。</p><p>庆幸的是，你不必再等了，因为 Linux 开发成功。当 Linus Torvalds 写成了 Linux，他填补了一个重要的空白。人们可以将 Linux 和 GNU 系统组成一个完整的自由系统：基于 Linux 的 GNU 系统（或简称为 GNU/Linux 系统）。</p><p>把它们组合到一起听起来很容易，但是这并不是一个简单的工作。 GNU C 库 (简称 glibc) 需要作大量的修改。集成到一个完整的发行系统中也是一项很大的工作。它需要对如何安装和启动系统进行定位 – 这个问题直到现在还在完善，因为我们还没有抓住要点。那些开发了不同的发行系统的人们作出了巨大贡献。</p><p>除了 GNU，还有一个独立进行的工程开发了一个自由的类似 Unix 的操作系统。这个系统被称为 BSD，它是由 UC Berkeley 开发的。 在 GNU 工程的鼓舞下，BSD 的开发者开始进行他们自己的自由软件的开发工作，并时常受到 GNU 人士的鼓励，但是他们的实际工作与 GNU 差别不大。今天 BSD 系统采用一些 GNU 软件，就象不同版本的 GNU 系统也采用 BSD 的软件一样。总的说来，它们是两套独立开发的不同的系统。今天一个免费的操作系统几乎都是采用 GNU 或 BSD 系统的一个派生版本。</p><p>GNU 工程支持 GNU/Linux 系统，就象支持 GNU 系统一样 – 包括资金的支持。我们为重写与 Linux 相关的 GNU C 库提供资金，以至于它们现在可以很好地集成在一起，直到最新版本的 GNU/Linux 仍在使用这个库而无需修改。我们也为早期 Debian GNU/Linux 的开发提供资金。</p><p>今天我们的绝大多数的工作都在基于 Linux 的 GNU 系统上完成，我们希望你也如此。但是请不要含糊地使用 Linux 而使公众迷惑。Linux 是内核，系统的关键部件之一。系统或多或少实际上都应该是 GNU 系统，再加上 Linux。当你在讨论到这个组合系统时，请使用 “GNU/Linux”。</p><p>如果要为 GNU/Linux 作链接，本页和 <a href="http://www.gnu.org/gnu/the-gnu-project.html" target="_blank" rel="noopener">http://www.gnu.org/gnu/the-gnu-project.html</a> 都是很好的选择。如果你想为 Linux（内核）作链接，<a href="http://www.kernel.org/是一个很好" target="_blank" rel="noopener">http://www.kernel.org/是一个很好</a> URL。</p><p>本文摘 <a href="https://www.gnu.org/gnu/linux-and-gnu.html" target="_blank" rel="noopener">https://www.gnu.org/gnu/linux-and-gnu.html</a></p><p>Copyright 1997, 1998 Richard Stallman</p><p>中文翻译：白若玉<br>翻译校正：刘昭宏</p><p>全文在保证完整性的前提下可以在任意媒体转载 - 须保留此标注。</p><p>Updated: 30 Nov 2000 paulv</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux,GNU </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Virtualbox下安装 CentOS  minimal 后设置上网</title>
      <link href="/2017/08/10/2/"/>
      <content type="html"><![CDATA[<p>在虚拟机中以minimal安装 CentOS 后无法上网，因为CentOS的默认网卡未激活。</p><p>可以设置 </p><p>文件 /etc/sysconfig/network-scripts/ifcfg-enp0s3</p><p> 将 <code>ONBOOT=no</code> 改为 <code>ONBOOT=yes</code></p><p> 保存后重启网卡： <code>service network restart</code></p><p> 这样就可以上网了，我用的是桥接模式。</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux,Centos </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CentOS中Live、netinstall、minimal、DVD 等版本的区别</title>
      <link href="/2017/08/10/1/"/>
      <content type="html"><![CDATA[<p><code>LiveCD</code> 和<code>LiveDVD</code> 是可以直接光盘运行的胸痛，但不能安装，两者差别在于容量大小，DVD 包含的软件要多一些。</p><p><code>netinstall</code> 用于网络安装和系统救援的镜像文件。</p><p><code>minimal</code> 这个镜像文件用于安装一个非常基本的 CentOS系统,包含了一些基本所需的最小安装包。</p><p><code>DVD</code> 镜像包含了完整的发布版，可以用于安装完整的 CentOS 系统。</p>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux,Centos </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MySQL索引</title>
      <link href="/2017/08/06/1/"/>
      <content type="html"><![CDATA[<p>数据库索引，是数据库管理系统中一个排序的数据结构，用于协助快速查询、更新数据库表中的数据。它类似于书本上的索引，通过索引可以更便捷地找到书里面的内容而不需要查阅整本书。对于海量数据的检索，索引往往是最有效的。</p><p>目前MySQL主要支持的几种索引有:B树索引(B-tree)、散列索引(hash)、空间索引(R-tree)和全文索引(full-text)。如果没有特别指明，本书指的就是B-Tree索引。由于索引是在存储引擎层实现的，所以不同的存储引擎的索引实现会有一些差异。以下所述的是一些较通用的索引知识。</p><p>逻辑上又可以分为:单列索引、复合索引(多列索引)、唯一(Unique)索引和非唯一(Non Unique)索引。</p><p>如果索引键值的逻辑顺序与索引所服务的表中相应行的物理顺序相同，那么该索引被称为簇索引(cluster index)，也称为聚集索引、聚簇索引，也就是说数据和索引(B+树)在一起，记录被真实地保存在索引的叶子中，簇索引也称为索引组织表，反之为非聚集索引。我们常用的InnoDB表其实使用的就是聚集索引。</p><p>簇索引是一个很重要的概念，InnoDB作为最常使用的引擎，只有在熟悉了它的数据存储方式之后，才可能有针对性地对它进行调优。</p><p>簇索引的一些优点如下。</p><ul><li>将相关的的数据保持在一起，叶子节点内可保存相邻近的记录。·因为索引和数据存储在一起，所以查找数据通常比非簇索引更快。由于主键是有序的，很显然，对于InnoDB表，最高效的存取方式是按主键存取唯一记录或进行小范围的主键扫描。  如果充分利用簇索引，它可以极大地提升性能，但簇索引也有许多不足之处。</li><li>簇索引对I/O密集型的负荷性能提升最佳，但如果数据是在内存中(访问次序不怎么重要)，那么簇索引并没有明显益处。</li><li>插入操作很依赖于插入的顺序，按primary key的顺序插入是最快的。</li><li>更新簇索引列的成本比较高，因为InnoDB不得不将更新的行移动到新的位置。</li><li>全表扫描的性能不佳，尤其是数据存储得不那么紧密时，或者因为页分裂(page split)而导致物理存储不连续。</li><li>二级索引的叶节点中存储了主键索引的值，如果主键采用的是较长的字符，那么索引可能会很大，且通过二级索引查找数据也需要进行两次索引查找。</li></ul>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>在Mac上编译安装线程安全的PHP7.2</title>
      <link href="/2017/08/05/1/"/>
      <content type="html"><![CDATA[<p>因为项目需求后期可能会需要使用到进程守护和消息队列，于是上网查了一下，看到<a href="http://netkiller.github.io/php/index.html" target="_blank" rel="noopener">Netkiller <em>PHP 手札</em></a>中有介绍到PHP使用 Pthread实现优雅守护进程的方法。</p><p>可是由于我本地的 PHP 是使用brew进行安装的，在 Linux 下使用 yum或者 apt进行安装的 PHP 同样不支持线程安全。</p><p>于是开始折腾起来，将 PHP 卸载掉后使用编译进行重新安装，开启<code>--enable-maintainer-zts</code> 后在编译过程中遇到了 Clang 报错，经过了一番 Google、百度过后，原来是编译器在作怪。Mac 由于 Xcode 的原因，默认使用的编译器是 Clang，在编译到 pthread 的时候，就会报错。</p><p>解决方法也很简单，在./configure 命令的最后加上 CC=gcc ，告诉make 我要使用 GCC 编译器进行编译即可。</p><p>其实在日常的开发中PHP开发者，很少会接触到多线程这一块。甚至有的PHP 开发者都搞不清楚什么是线程、进程和协程。</p><p>那是因为在 Web 开发中根本使用不了多线程，因为 PHP 本身并不提供多线程API，其多线程的支持是由 Pthread 扩展提供的，而 Pthread 扩展的文档中有说明：</p><blockquote><p><strong>Warning</strong>    不可以在 web 服务器环境中使用 pthreads 扩展，PHP 多线程开发仅限于命令行模式的应用。</p></blockquote><p>Windows版的PHP从版本5.2.1开始有Thread Safe(线程安全)和None Thread Safe(NTS，非线程安全)之分，这两者不同在于何处？到底应该用哪种？</p><p>从2000年 10月20日发布的第一个Windows版的PHP3.0.17开始的都是线程安全的版本，这是由于与Linux/Unix系统是采用多进程的工作方式不同的导致的。</p><p>Windows系统是采用多线程的工作方式。如果在IIS下以CGI方式运行PHP会非常慢，这是由于CGI模式是建立在多进程的基础之上的，而非多线程。一般我们会把PHP配置成以ISAPI的方式来运行，ISAPI是多线程的方式，这样就快多了。</p><p>但存在一个问题，很多常用的PHP扩展是以 Linux/Unix的多进程思想来开发的，这些扩展在ISAPI的方式运行时就会出错搞垮IIS。因此在IIS下CGI模式才是PHP运行的最安全方式，但CGI模式对于每个HTTP请求都需要重新加载和卸载整个PHP环境，其消耗是巨大的。</p><p>为了兼顾IIS下PHP的效率和安全，微软 给出了FastCGI的解决方案。FastCGI可以让PHP的进程重复利用而不是每一个新的请求就重开一个进程。同时FastCGI也可以允许几个进程同时执行。这样既解决了CGI进程模式消耗太大的问题，又利用上了CGI进程模式不存在线程安全问题的优势。</p><p>因此，如果是使用ISAPI 的方式来运行PHP就必须用Thread Safe(线程安全)的版本；而用FastCGI模式运行PHP的话就没有必要用线程安全检查了，用None Thread Safe(NTS，非线程安全)的版本能够更好的提高效率。</p><p>从上面这段描述我们可以清楚的知道，如果不是使用 ISAPI 的话，不使用多线程特性，那么基本上就用不Thread Safe。</p><p>查看自己的 PHP版本是否是线程安全你的只需要在命令行中输入 <code>PHP -v</code>查看 PHP 的版本即可，如下：</p><p><img src="http://www.maksim.website/images/threadsafe.png" alt="线程安全"></p><p><strong>引用：</strong></p><p><em>PHP线程安全和非线程安全有什么区别</em>  <a href="http://www.cnblogs.com/T8881/p/6397264.html" target="_blank" rel="noopener">http://www.cnblogs.com/T8881/p/6397264.html</a></p><p><em>PHP Internals Book（《PHP内部书》PHP 内核开发者合著)</em> <a href="http://www.phpinternalsbook.com/index.html" target="_blank" rel="noopener">http://www.phpinternalsbook.com/index.html</a></p><p><em>PHP运行模式</em> <a href="http://www.cnblogs.com/xia520pi/p/3914964.html" target="_blank" rel="noopener">http://www.cnblogs.com/xia520pi/p/3914964.html</a></p><p><em>Netkiller <em>PHP 手札</em></em> <a href="http://netkiller.github.io/php/index.html" target="_blank" rel="noopener">http://netkiller.github.io/php/index.html</a></p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多线程,PHP7.2,编译安装,GCC </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>在SQL中使用变量</title>
      <link href="/2017/08/05/2/"/>
      <content type="html"><![CDATA[<p>MySQL 李的变量可分为用户变量和系统变量</p><p><strong>1. 用户变量</strong></p><p>MySQL允许用户在语句中自定义变量，对于用户变量的值，可以先保存在用户变量中，然后在引用它；这样就可以将值从一个语句传到另外一个语句。</p><p>用户变量与连接有关。一个客户端定义的变量不能被其他客户端看到货使用。当客户端退出时，该客户端连接的所有变量将自动释放。这点不同于在函数或存储过程中通过 <code>DECLAER</code> 药监局声明的局部变量，局部变量的生存周期在它被声明的“<code>BEGIN...END</code>”块内。</p><p>用户变量的表现形式为：@var_name</p><p>设置用户变量的一个途径是执行 SET 语句，语法如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> @var_name= expr[, @var_name= expr] ...</div></pre></td></tr></table></figure><p>对于SET，可以使用“=”或“:=”作为分配符。分配给每个变量的expr可以为整数、实数、字符串或NULL值。如:</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET @t1=0, @t2=0, @t3=0;</div></pre></td></tr></table></figure><p>或</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> @minMid=(<span class="keyword">select</span> <span class="keyword">min</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> table_name) ;</div></pre></td></tr></table></figure><p><strong>2.系统变量</strong></p><p>MySQL服务器维护着两种系统变量:</p><ul><li>全局变量影响MySQL服务的整体运行方式</li><li>会话变量影响具体客户端连接的操作</li></ul><p>当服务器启动时，它将所有全局变量初始化为默认值。这些默认值可以在选项文件中或在命令行中对指定的选项进行更改。服务器启动后，通过连接服务器并执行<code>SET</code> <code>GLOBAL var_name</code>语句，可以动态更改这些全局变量。要想更改全局变量，必须具有<code>SUPER</code>权限。</p><p>服务器还为每个连接的客户端维护一系列的会话变量。在连接时使用相应全局变量的当前值对客户端的会话变量进行初始化。对于动态会话变量，客户端可以通过<code>SET SESSION var_name</code>语句更改它们。设置会话变量不需要特殊权限，但客户端只能更改自己的会话变量，而不能更改其他客户端的会话变量。</p><p>访问全局变量的任何客户端都可以看见对全局变量所做的更改。然而，它只影响更改后连接的客户的相应会话变量，而不会影响目前已经连接的客户端的会话变量(即使客户端执行<code>SET GLOBAL</code>语句也不影响)。</p><p>也就是说，如果你的连接是短连接，那么修改全局变量后，客户端有重连的操作，就会立刻影响到客户端。而对于长连接、连接池来说，连接可能一直在MySQL里没有被销毁，也就不会有重连的操作，所以这种情况下对全局变量的修改一般不会影响到客户端。</p><p>可以使用如下几种语法形式来设置或检索全局变量或会话变量(下面的例子使用<code>sort_buffer_size</code>作为示例变量名)。</p><p>要想设置一个<code>GLOBAL</code>变量的值，可使用下面的语法。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET GLOBAL sort_buffer_size=value; </div><div class="line">mysql&gt; SET @@global.sort_buffer_size=value;</div></pre></td></tr></table></figure><p>要想设置一个SESSION变量的值，可使用下面的语法。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SESSION sort_buffer_size=value; </div><div class="line">mysql&gt; SET @@session.sort_buffer_size=value; </div><div class="line">mysql&gt; SET sort_buffer_size=value;</div></pre></td></tr></table></figure><p>如果设置变量时不指定<code>GLOBAL</code>、<code>SESSION</code>或<code>LOCAL</code>，则默认使用<code>SESSION</code>。</p><p>要想检索一个<code>GLOBAL</code>变量的值，可使用下面的语法。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT @@global.sort_buffer_size;</div><div class="line">mysql&gt; SHOW GLOBAL VARIABLES LIKE 'sort_buffer_size';</div></pre></td></tr></table></figure><p>要想检索一个SESSION变量的值，可使用下面的语法。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT @@sort_buffer_size;</div><div class="line">mysql&gt; SELECT @@session.sort_buffer_size; mysql&gt; SHOW VARIABLES LIKE 'sort_buffer_size';</div></pre></td></tr></table></figure><p>当用<code>SELECT@@var_name</code>搜索一个变量时(也就是说，不指定<code>GLOBAL</code>、<code>SESSION</code>)，MySQL会返回<code>SESSION</code>值(如果存在<code>SESSION</code>变量的话)，否则返回<code>GLOBAL</code>值。</p><p>对于<code>SHOW VARIABLES</code>，如果不指定<code>GLOBAL</code>、<code>SESSION的</code>话，MySQL会返回SESSION值。</p><p>引用</p><p>《MySQLDBA 修炼之道》 作者：陈晓勇</p><p><a href="https://dev.mysql.com/doc/refman/5.7/en/user-variables.html" target="_blank" rel="noopener">MySQL 官方文档 9.4 User-Defined Variables</a></p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>你真的知道什么是数据库吗? 读《修炼之道：数据库管理员的第一本书》</title>
      <link href="/2017/08/04/601/"/>
      <content type="html"><![CDATA[<p>“数据库基础”可不是一件小事。问题是，有时人们认为他们知道的很多。</p><p>例如，这个问题:什么是数据库?</p><p>我敢说大多数的人相信他们知道这个问题的答案。但其中一部分人(或者很多)都会答错。SQL Server 不是数据库，它只是一种 DBMS(数据库管理系统)。你可以使用 SQL Server 来创建数据库，但 SQL Server 本身不是一种数据库。</p><p>那么，什么是数据库?数据库是一种有组织的数据存储，其中的数据可以通过指定的数据元素(比如，字段、记录和文件)来访问(详见图 1-1)。</p><p><img src="http://www.maksim.website/images/whatis.png" alt="数据库"></p><p>数据库是一种有组织的数据存储，其中的数据可以通过指定的数据元素来访问。</p><p>DBMS 是一种使终端用户或程序员能够共享数据的软件。它提供了一套操作数据库的系</p><p>统性方法:创建、更新、检索和存储信息。DBMS 通常还负责数据完整性、数据安全性、数据访问控制和优化、自动回退、重起和恢复。</p><p>对外行人来说，你可以把数据库想象成一个文件夹，把 DBMS 想象成文件柜，且所容纳的所有文件都贴有标签。DBMS 管理着数据库，通过 DBMS 来实现和访问数据库实例。所以说，DB2、Oracle 和 SQL Server 都是数据库管理系统。工资单应用使用工资单的数据库，该数据库可以使用 DB2、Oracle 或者 SQL Server 来实现。</p><p>摘自DBA 《修炼之道：数据库管理员的第一本书》</p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>利用 MySQL 权限机制设置用户权限</title>
      <link href="/2017/08/04/600/"/>
      <content type="html"><![CDATA[<p>MySQL 权限控制包含如下两个阶段。</p><p>阶段1： 服务器检测是否允许你链接。</p><p>阶段2： 假定你能连接，服务器将检测你发出的每一个请求，查看你是否有足够的权限实施它。例如你从数据库表中选择（SELECT）行或从数据库中删除表，那么服务器要确定你是否对表有SELECT权限或对数据库有DROP权限。</p><p>MySQL是通过用户名、密码、IP(主机名)3个要素来验证用户的。当你想要访问MySQL服务器时，MySQL客户端程序一 般会要求你指定如下参数。</p><ul><li>MySQL服务器的IP(主机名)，</li><li>端口</li><li>用户名</li><li>密码 </li></ul><p>以下是连接MySQL服务器的一个示例，你需要以实际的IP、端口、用户名、密码代替相应的内容。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -h host_ip_address -u user_name -pyour_password -P server_port</div></pre></td></tr></table></figure><p>一般在生产环境下，程序账号有增加、删除、查询、修改这4项功能即可。</p><p>如下命令用于赋予查询、插入、修改、删除权限，并进行密码设置。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span> <span class="keyword">on</span> db_name.* <span class="keyword">to</span> user_name@ <span class="string">'10.%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'password'</span>;</div></pre></td></tr></table></figure><p>如下命令用于回收上面所赋予的权限。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">revoke</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span> <span class="keyword">on</span> db_name.* <span class="keyword">from</span> user_name@ <span class="string">'10.%'</span>;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP7 微信支付不能回调，让我们的团队损失1.00CNY。</title>
      <link href="/2017/07/14/cjjrthlew002uc7rd9k3ztarf/"/>
      <content type="html"><![CDATA[<p>公司目前正在使用一套基于 TP5的开源商城，在线上测试过程中碰到了一个问题，微信支付完成后无法进行回调更新订单状态，简单点说就是钱没了，啥也没得到。</p><p><code>What？</code>这可是一个无法容忍的错误。</p><p>原本以为是微信支付配置环节出了问题，于是便去查看微信官网给出的帮助手册，又顺着流程走了一边，信心满满的又测试了一边，结果尴尬了，又损失了0.01人民币。</p><p>反复确认流程后，确认并不是配置的问题，于是便开始了百度，原来这一切都是在微信官网给出的SDK中的一段代码惹的祸，就这么一段代码让我们团队损失了接近1人民币。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取通知的数据</span></div><div class="line">$xml = $GLOBALS[<span class="string">'HTTP_RAW_POST_DATA'</span>];  <span class="comment">//  WxPay.Api.php  414 line</span></div></pre></td></tr></table></figure><p>这段代码如果放在PHP7之前的版本是不会有任何问题的，但是在 PHP7版本中却已经<strong>废除</strong>了 <code>HTTP\_RAW\_POST\_DATA</code>    。</p><p>在官方文档中给了说明：</p><blockquote><p><strong>Warning</strong> This feature was DEPRECATED in PHP 5.6.0, and REMOVED as of PHP 7.0.0.</p></blockquote><p>在<code>PHP5.6.0</code>发布的时候，就已经不推荐只用这种方法，于是在PHP 社区在开发 PHP7.0的时候直接就将其废弃掉了。</p><p>而官方也给出了替代的方案，那就是<code>php://input</code></p><p><code>php://input</code> 是个可以访问请求的原始数据的只读流。 </p><p><code>POST</code> 请求的情况下，最好使用 <code>php://input</code> 来代替 <code>$HTTP\_RAW\_POST\_DATA</code>，因为它不依赖于特定的<code>php.ini</code>指令。 </p><p> 而且，这样的情况下 <code>$HTTP\_RAW\_POST\_DATA</code> 默认没有填充， 比激活 <code>always\_populate\_raw\_post\_data</code>潜在需要更少的内存。 <code>enctype=&quot;multipart/form-data&quot;</code> 的时候 <code>php://input</code> 是无效的。</p><blockquote><p><code>Note</code>: 在 PHP 5.6 之前 php://input 打开的数据流只能读取一次； 数据流不支持 seek 操作。 不过，依赖于 SAPI 的实现，请求体数据被保存的时候， 它可以打开另一个 php://input 数据流并重新读取。 通常情况下，这种情况只是针对 POST 请求，而不是其他请求方式，比如 PUT 或者 PROPFIND。 </p></blockquote><p>于是我将这段代码改为了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取通知的数据</span></div><div class="line">$xml = file_get_contents(<span class="string">"php://input"</span>); <span class="comment">//  WxPay.Api.php  414 line</span></div></pre></td></tr></table></figure><p>最后我又以0.01人民币的代价确认修复了这个 BUG。</p><p><code>PHP7:&quot;怪我喽，让你经常看文档，哼！&quot;</code></p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wechat pay,php, php7, php://input </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>人人都懂设计模式</title>
      <link href="/2017/07/14/1/"/>
      <content type="html"><![CDATA[<blockquote><p>英文：kamranahmedse，</p><p>编译：伯乐在线 - Justin_YGG</p></blockquote><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>设计模式用于解决反复出现的问题，是解决特定问题的指导方针。设计模式不是在应用中引用的类、package 或者库，而是在某些特定场景下解决特定问题的指导方针。</p><p>设计模式用于解决反复出现的问题，是解决某些特定问题的指导方针。</p><p>维基百科中这样描述设计模式：</p><blockquote><p>在软件工程中，设计模式是针对软件设计中普遍存在（反复出现）的各种问题，所提出的可复用型解决方案。设计模式并不直接完成代码的编写，而是描述在不同情况下如何解决问题。</p></blockquote><h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><ul><li>设计模式并非解决所有问题的银弹。</li><li>不要强制使用设计模式，否则结果可能适得其反。谨记：设计模式是用来解决问题的，而不是来寻找问题的，不要过度思考。</li><li>如果在对的地方对的时机使用设计模式，它会是你的救世主。反之，将会一团糟。</li></ul><p>另注：下面的示例代码是用 PHP7 实现的，因为概念是一样的，所以语言并不会阻碍你理解设计模式。其他语言版本的实现正在进行中。</p><h1 id="设计模式分类"><a href="#设计模式分类" class="headerlink" title="设计模式分类"></a>设计模式分类</h1><ul><li>创建型模式</li><li>结构型模式</li><li>行为型模式</li></ul><h1 id="创建型模式"><a href="#创建型模式" class="headerlink" title="创建型模式"></a>创建型模式</h1><ul><li>概述</li></ul><p>创建型模式专注于如何初始化对象 。</p><ul><li>维基百科</li></ul><p>在软件工程中，创建型模式是处理对象创建的设计模式，试图根据实际情况使用合适的方式创建对象。基本的对象创建方式可能会导致设计上的问题，或增加设计的复杂度。创建型模式通过以某种方式控制对象的创建来解决这些问题。</p><ul><li>分类<ul><li>简单工厂模式</li><li>工厂方法模式</li><li>抽象工厂模式</li><li>生成器模式</li><li>原型模式</li><li>单例模式</li></ul></li></ul><h3 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h3><ul><li>现实生活示例</li></ul><p>想象一下，你正在建造一座房子而且需要几扇房门，如果每次需要房门的时候，不是用工厂制造的房门，而是穿上木匠服，然后开始自己制造房门，将会搞得一团糟。</p><ul><li>概述</li></ul><p>简单工厂模式只是为客户端创建实例，而不将任何实例化逻辑暴露给客户端。</p><ul><li>维基百科</li></ul><p>在面向对象程序设计中，工厂通常是一个用来创建其他对象的对象。通常来讲，工厂是指某个功能或方法，此功能或方法返回不同类型的对象或者类的某个方法调用，返回的东西看起来是「新的」。</p><ul><li>程序示例</li></ul><p>首先是房门的接口和实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWidth</span><span class="params">()</span>: <span class="title">float</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span><span class="params">()</span>: <span class="title">float</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WoodenDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $width;</div><div class="line">    <span class="keyword">protected</span> $height;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float width, float height)</span></span></div><div class="line">    &#123;</div><div class="line">        this-&gt;width = width;</div><div class="line"></div><div class="line">        this-&gt;height = height;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWidth</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;width;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line"></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;height;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是生产房门的工厂</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoorFactory</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">(width, height)</span>: <span class="title">Door</span></span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WoodenDoor(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>这样使用</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$door = DoorFactory::makeDoor(<span class="number">100</span>, <span class="number">200</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">'Width: '</span> . $door-&gt;getWidth();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">'Height: '</span> . $door-&gt;getHeight();</div></pre></td></tr></table></figure><ul><li>何时使用？</li></ul><p>如果创建对象不仅仅是一些变量的初始化，还涉及某些逻辑，那么将其封装到一个专用工厂中取代随处使用的重复代码是有意义的。</p><h3 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h3><ul><li>现实生活示例</li></ul><p>考虑招聘经理的情况。一个人不可能应付所有职位的面试，对于空缺职位，招聘经理必须委派不同的人去面试。</p><ul><li>概述</li></ul><p>工厂方法模式提供了一种将实例化逻辑委托给子类的方法。</p><ul><li>维基百科</li></ul><p>在基于类的编程中，工厂方法模式是一种使用了工厂方法的创建型设计模式，在不指定对象具体类型的情况下，处理创建对象的问题。创建对象不是通过调用构造器而是通过调用工厂方法（在接口中指定工厂方法并在子类中实现或者在基类中实现，随意在派生类中重写）来完成。</p><ul><li>程序示例</li></ul><p>以上述招聘经理为例，首先给出一个面试官接口及实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interviewer</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">askQuestions</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Developer</span> <span class="keyword">implements</span> <span class="title">Interviewer</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">askQuestions</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">echo</span> <span class="string">'Asking about design patterns!'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommunityExecutive</span> <span class="keyword">implements</span> <span class="title">Interviewer</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">askQuestions</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Asking about community building'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后创建 HiringManager</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HiringManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Factory method</span></div><div class="line"></div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInterviewer</span><span class="params">()</span>: <span class="title">Interviewer</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">takeInterview</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $interviewer = <span class="keyword">$this</span>-&gt;makeInterviewer();</div><div class="line">        $interviewer-&gt;askQuestions();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>现在，任何子类都可以继承 HiringManager 并委派相应的面试官</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DevelopmentManager</span> <span class="keyword">extends</span> <span class="title">HiringManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInterviewer</span><span class="params">()</span>: <span class="title">Interviewer</span></span></div><div class="line"></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Developer();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MarketingManager</span> <span class="keyword">extends</span> <span class="title">HiringManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInterviewer</span><span class="params">()</span>: <span class="title">Interviewer</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommunityExecutive();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>这样使用</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$devManager = <span class="keyword">new</span> DevelopmentManager();</div><div class="line">$devManager-&gt;takeInterview(); <span class="comment">// Output: Asking about design patterns</span></div><div class="line"></div><div class="line">$marketingManager = <span class="keyword">new</span> MarketingManager();</div><div class="line">$marketingManager-&gt;takeInterview(); <span class="comment">// Output: Asking about community building.</span></div></pre></td></tr></table></figure><ul><li>何时使用？</li></ul><p>类中的一些常见处理需要在运行时动态决定所需的子类，换句话说，当客户端不知道可能需要的确切子类时，使用工厂方法模式。</p><h3 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h3><ul><li>现实生活示例</li></ul><p>扩展一下简单工厂模式中的房门例子。基于所需，你可能需要从木门店获取木门，从铁门店获取铁门或者从相关的门店获取 PVC 门。进一步讲，你可能需要不同种类的专家来安装房门，比如木匠安装木门，焊接工安装铁门等等。正如你所料，房门有了依赖，木门需要木匠，铁门需要焊接工。</p><ul><li>概述</li></ul><p>一组工厂的工厂：将相关或者互相依赖的单个工厂聚集在一起，而不指定这些工厂的具体类。</p><ul><li>维基百科</li></ul><p>抽象工厂模式提供了一种方式，这种方式可以封装一组具有共同主题的个体工厂，而不指定这些工厂的具体类。</p><ul><li>编程示例</li></ul><p>以上述房门为例，首先给出 Door 接口和一些实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WoodenDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'I am a wooden door'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IronDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'I am an iron door'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后根据每种房门类型给出对应的安装专家</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DoorFittingExpert</span></span></div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welder</span> <span class="keyword">implements</span> <span class="title">DoorFittingExpert</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line"></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'I can only fit iron doors'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Carpenter</span> <span class="keyword">implements</span> <span class="title">DoorFittingExpert</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'I can only fit wooden doors'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>现在抽象工厂可以将相关的对象组建在一起，也就是说，木门工厂会生成木门并提供木门安装专家，铁门工厂会生产铁门并提供铁门安装专家。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DoorFactory</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">()</span>: <span class="title">Door</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeFittingExpert</span><span class="params">()</span>: <span class="title">DoorFittingExpert</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Wooden factory to return carpenter and wooden door</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WoodenDoorFactory</span> <span class="keyword">implements</span> <span class="title">DoorFactory</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">()</span>: <span class="title">Door</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WoodenDoor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeFittingExpert</span><span class="params">()</span>: <span class="title">DoorFittingExpert</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Carpenter();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"> </div><div class="line"><span class="comment">// Iron door factory to get iron door and the relevant fitting expert</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IronDoorFactory</span> <span class="keyword">implements</span> <span class="title">DoorFactory</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">()</span>: <span class="title">Door</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IronDoor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeFittingExpert</span><span class="params">()</span>: <span class="title">DoorFittingExpert</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Welder();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>这样使用</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$woodenFactory = <span class="keyword">new</span> WoodenDoorFactory();</div><div class="line"></div><div class="line">$door = $woodenFactory-&gt;makeDoor();</div><div class="line"></div><div class="line">$expert = $woodenFactory-&gt;makeFittingExpert();</div><div class="line"></div><div class="line">$door-&gt;getDescription();  <span class="comment">// Output: I am a wooden door</span></div><div class="line"></div><div class="line">$expert-&gt;getDescription(); <span class="comment">// Output: I can only fit wooden doors</span></div><div class="line"> </div><div class="line"></div><div class="line"><span class="comment">// Same for Iron Factory</span></div><div class="line"></div><div class="line">$ironFactory = <span class="keyword">new</span> IronDoorFactory();</div><div class="line"></div><div class="line">$door = $ironFactory-&gt;makeDoor();</div><div class="line"></div><div class="line">$expert = $ironFactory-&gt;makeFittingExpert();</div><div class="line"></div><div class="line">$door-&gt;getDescription();  <span class="comment">// Output: I am an iron door</span></div><div class="line"></div><div class="line">$expert-&gt;getDescription(); <span class="comment">// Output: I can only fit iron doors</span></div></pre></td></tr></table></figure><p>正如你看到的，木门工厂将木匠和木门封装在一起，同样地，铁门工厂将铁门和焊接工封装在一起。这样就可以帮助我们确保，对于每一扇生产出来的门，都能搭配正确的安装工。</p><ul><li>何时使用？</li></ul><p>当存在相关的依赖并涉及到稍复杂的创建逻辑时，使用抽象工厂模式。</p><h3 id="生成器模式"><a href="#生成器模式" class="headerlink" title="生成器模式"></a>生成器模式</h3><ul><li>现实生活示例</li></ul><p>想象一下你在 Hardee’s 餐厅点了某个套餐，比如「大 Hardee 套餐」，然后工作人员会正常出餐，这是简单工厂模式。但是在很多情况下，创建逻辑可能涉及到更多步骤。比如，你想要一个定制的 Subway 套餐，对于你的汉堡如何制作有几个选项可供选择，比如你想要什么类型的酱汁？你想要什么奶酪？ 在这种情况下，建造者模式便可以派上用场。</p><ul><li>概述</li></ul><p>允许创建不同风格的对象，同时避免构造器污染。当创建多种风格的对象时或者创建对象时涉及很多步骤，可以使用生成器模式。</p><ul><li>维基百科</li></ul><p>生成器模式是一种对象创建软件设计模式，其目的是找到重叠构造器反面模式的解决方案。</p><p>既然提到了，那我就补充一下什么是重叠构造器反面模式。 我们时不时地会看到如下构造函数：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($size, $cheese = true, $pepperoni = true, $tomato = false, $lettuce= true)</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>正如你看到的，构造器参数的数量可能会迅速失控，并且参数的排列可能让人难以理解。 如果将来要添加更多选项，此参数列表可能会不断增长，这被称为重叠构造器反面模式。</p><p><strong>程序示例</strong></p><p>理想之选是使用生成器模式，首先给出汉堡类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Burger</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $size;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $cheese = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $pepperoni = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $lettuce = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $tomato = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BurgerBuilder $builder)</span></span></div><div class="line"></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;size = $builder-&gt;size;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;cheese = $builder-&gt;cheese;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;pepperoni = $builder-&gt;pepperoni;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;lettuce = $builder-&gt;lettuce;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;tomato = $builder-&gt;tomato;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是 builder</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BurgerBuilder</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> $size;</div><div class="line">    <span class="keyword">public</span> $cheese = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">public</span> $pepperoni = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">public</span> $lettuce = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">public</span> $tomato = <span class="keyword">false</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(int $size)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;size = $size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addPepperoni</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;pepperoni = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addLettuce</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;lettuce = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addCheese</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;cheese = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addTomato</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;tomato = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">()</span>: <span class="title">Burger</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Burger(<span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>这样使用</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$burger = (<span class="keyword">new</span> BurgerBuilder(<span class="number">14</span>))</div><div class="line"></div><div class="line">                    -&gt;addPepperoni()</div><div class="line"></div><div class="line">                    -&gt;addLettuce()</div><div class="line"></div><div class="line">                    -&gt;addTomato()</div><div class="line"></div><div class="line">                    -&gt;build();</div></pre></td></tr></table></figure><ul><li>何时使用？</li></ul><p>当需要构建不同风格的对象，同时需要避免构造器重叠时使用生成器模式。与工厂模式的主要区别在于：当创建过程一步到位时，使用工厂模式，而当创建过程需要多个步骤时，使用生成器模式。</p><h3 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h3><ul><li>现实生活示例</li></ul><p>还记得多莉吗？那只克隆羊。这里不深入细节，关键点在于克隆。</p><ul><li>概述</li></ul><p>基于现有对象通过克隆创建对象。</p><ul><li>维基百科</li></ul><p>在软件开发过程中，原型模式是一种创建型设计模式。当要创建的对象类型由原型实例确定时，将通过克隆原型实例生成新对象。</p><p>简言之，原型模式允许你创建现有对象的副本并根据需要进行修改，而不是从头开始创建对象并进行设置。</p><ul><li>编程示例</li></ul><p>使用 PHP 的 clone 方法可以轻松实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sheep</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $name;</div><div class="line">    <span class="keyword">protected</span> $category;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string name, string category = <span class="string">'Mountain Sheep'</span>)</span></span></div><div class="line">    &#123;</div><div class="line">        this-&gt;name = name;</div><div class="line"></div><div class="line">        this-&gt;category = category;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setName</span><span class="params">(string $name)</span></span></div><div class="line">    &#123;</div><div class="line">        this-&gt;name = name;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setCategory</span><span class="params">(string $category)</span></span></div><div class="line">    &#123;</div><div class="line">        this-&gt;category = category;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCategory</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;category;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可以像下面这样克隆</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$original = <span class="keyword">new</span> Sheep(<span class="string">'Jolly'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $original-&gt;getName(); <span class="comment">// Jolly</span></div><div class="line"></div><div class="line"><span class="keyword">echo</span> $original-&gt;getCategory(); <span class="comment">// Mountain Sheep</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Clone and modify what is required</span></div><div class="line"></div><div class="line">cloned = <span class="keyword">clone</span> original;</div><div class="line"></div><div class="line">$cloned-&gt;setName(<span class="string">'Dolly'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $cloned-&gt;getName(); <span class="comment">// Dolly</span></div><div class="line"></div><div class="line"><span class="keyword">echo</span> $cloned-&gt;getCategory(); <span class="comment">// Mountain sheep</span></div></pre></td></tr></table></figure><p>此外，你可以使用魔术方法 **clone 来修改克隆行为。</p><ul><li>何时使用</li></ul><p>当需要创建一个与已有对象类似的对象，或者当创建对象的成本比克隆更高时，使用原型模式。</p><h3 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h3><ul><li>现实生活示例</li></ul><p>一个国家同一时间只能有一位总统。只要使命召唤，这个总统就必须采取行动。 这里的总统就是一个单例。</p><ul><li>概述</li></ul><p>确保特定类的对象只被创建一次。</p><ul><li>维基百科</li></ul><p>在软件工程中，单例模式是一种软件设计模式，用来限制类初始化为对象。当恰恰只需要一个对象来协调整个系统的功能时，单例模式非常有用。</p><p>实际上，单例模式被认为是反模式，应该避免过度使用。 单例模式并非不好，可能有时候很有用，但应谨慎使用，因为它在你的应用程序中引入了全局状态，一处更改可能会影响其他地方，并且可能会变得很难调试。 另外不好的一点是单例模式会使代码紧耦合，单例也很难mock。</p><ul><li>编程示例</li></ul><p>要创建一个单例，需要将构造函数设为 private，禁用克隆，禁用扩展名，并创建静态变量来容纳实例</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">President</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $instance;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Hide the constructor</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span>: <span class="title">President</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>::$instance) &#123;</div><div class="line">            <span class="keyword">self</span>::$instance = <span class="keyword">new</span> <span class="keyword">self</span>();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$instance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Disable cloning</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Disable unserialize</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>这样使用</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$president1 = President::getInstance();</div><div class="line">$president2 = President::getInstance();</div><div class="line">var_dump(president1 === president2); <span class="comment">// true</span></div></pre></td></tr></table></figure><h2 id="结构型设计模式"><a href="#结构型设计模式" class="headerlink" title="结构型设计模式"></a>结构型设计模式</h2><ul><li>概述</li></ul><p>结构型设计模式主要关注对象组合，换句话说，关注实体之间如何互相使用。 或者还有另外一个解释，结构型设计模式有助于回答“如何构建软件组件？”</p><ul><li>维基百科</li></ul><p>在软件工程中，结构型设计模式是借由一以贯之的方式来了解元件间的关系，从而简化设计的一种设计模式。</p><ul><li>分类<ul><li>适配器模式</li><li>桥接模式</li><li>组合模式</li><li>修饰模式</li><li>外观模式</li><li>享元模式</li><li>代理模式</li></ul></li></ul><h3 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h3><ul><li>现实生活示例</li></ul><p>考虑这样一个场景，你的存储卡中有一些照片，你需要将其传输到计算机。为此，你需要某种与计算机端口兼容的适配器，以便将存储卡连接到计算机上。在这种情况下，读卡器就是适配器。另外一个例子就是大名鼎鼎的电源适配器：一个三脚插头不能连接到双插头插座，需要使用电源适配器使其与双插头插座兼容。另外一个例子是译者将一个人说的话翻译给另一个人。</p><ul><li>概述</li></ul><p>适配器模式可以将不兼容的对象包装成适配器来适配其它类。</p><ul><li>维基百科</li></ul><p>在软件工程中，适配器模式是允许将现有类的接口用作另一个类接口的软件设计模式。它通常用于现有类与其他类的协作，而无需修改现有类的代码。</p><p><strong>- 程序示例</strong></p><p>考虑一个游戏场景，有一个猎人，他狩猎狮子。</p><p>首先给出<code>Lion</code>接口，所有种类的狮子都要实现这个接口。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AfricanLion</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsianLion</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>猎人希望可以狩猎任何实现 <code>Lion</code> 接口的狮子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hunter</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hunt</span><span class="params">(Lion $lion)</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="结构型设计模式-1"><a href="#结构型设计模式-1" class="headerlink" title="结构型设计模式"></a>结构型设计模式</h1><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>结构型设计模式主要关注对象组合，换句话说，关注实体之间如何互相使用。 或者还有另外一个解释，结构型设计模式有助于回答“如何构建软件组件？”</p><h4 id="维基百科"><a href="#维基百科" class="headerlink" title="维基百科"></a>维基百科</h4><p>在软件工程中，结构型设计模式是借由一以贯之的方式来了解元件间的关系，从而简化设计的一种设计模式。</p><p><strong>分类</strong></p><ul><li>适配器模式</li><li>桥接模式</li><li>组合模式</li><li>修饰模式</li><li>外观模式</li><li>享元模式</li><li>代理模式</li></ul><h3 id="适配器模式-1"><a href="#适配器模式-1" class="headerlink" title="适配器模式"></a>适配器模式</h3><h4 id="现实生活示例"><a href="#现实生活示例" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>考虑这样一个场景，你的存储卡中有一些照片，你需要将其传输到计算机。为此，你需要某种与计算机端口兼容的适配器，以便将存储卡连接到计算机上。在这种情况下，读卡器就是适配器。另外一个例子就是大名鼎鼎的电源适配器：一个三脚插头不能连接到双插头插座，需要使用电源适配器使其与双插头插座兼容。另外一个例子是译者将一个人说的话翻译给另一个人。</p><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><p>适配器模式可以将不兼容的对象包装成适配器来适配其它类。</p><h4 id="维基百科-1"><a href="#维基百科-1" class="headerlink" title="维基百科"></a>维基百科</h4><p>在软件工程中，适配器模式是允许将现有类的接口用作另一个类接口的软件设计模式。它通常用于现有类与其他类的协作，而无需修改现有类的代码。</p><p><strong>程序示例</strong></p><p>考虑一个游戏场景，有一个猎人，他狩猎狮子。</p><p>首先给出 <code>Lion</code> 接口，所有种类的狮子都要实现这个接口。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AfricanLion</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsianLion</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>猎人希望可以狩猎任何实现 <code>Lion</code> 接口的狮子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hunter</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hunt</span><span class="params">(Lion $lion)</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>现在我们假定猎人在游戏中也可以狩猎<code>野狗</code>。但是目前我们无法实现，因为狗是通过其他接口实现。为了让猎人可以狩猎野狗，我们需要创建一个适配器，来兼容这种情况。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This needs to be added to the game</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WildDog</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bark</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Adapter around wild dog to make it compatible with our game</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WildDogAdapter</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $dog;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(WildDog $dog)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;dog = $dog;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;dog-&gt;bark();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样，在游戏中通过 <code>WildDogAdapter</code> 就可以使用 <code>WildDog</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$wildDog = <span class="keyword">new</span> WildDog();</div><div class="line">$wildDogAdapter = <span class="keyword">new</span> WildDogAdapter($wildDog);</div><div class="line"></div><div class="line">$hunter = <span class="keyword">new</span> Hunter();</div><div class="line">$hunter-&gt;hunt($wildDogAdapter);</div></pre></td></tr></table></figure><h3 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h3><h4 id="现实生活示例-1"><a href="#现实生活示例-1" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>假如你有一个网站，上面有不同的网页，并且允许用户更改主题。你会如何实现呢？是为每个页面的各个主题创建多个副本，还是创建单独的主题，并根据用户的偏好来加载主题呢？桥接模式可以帮你实现后者。</p><p>不使用桥接模式</p><p><a href="http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146.png" target="_blank" rel="noopener"><img src="http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146-300x221.png" alt="2"></a></p><p><a href="http://jbcdn2.b0.upaiyun.com/2017/04/6b0ea9d009344ad2311de1dfcdadcec0.png" target="_blank" rel="noopener"><img src="http://jbcdn2.b0.upaiyun.com/2017/04/6b0ea9d009344ad2311de1dfcdadcec0-300x221.png" alt="1"></a></p><p>使用桥接模式</p><p><a href="http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146.png" target="_blank" rel="noopener"><img src="http://jbcdn2.b0.upaiyun.com/2017/04/4b4f6fd843a5bfc7ee4880c5c9a71146-300x221.png" alt="2"></a></p><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>桥接模式主打的是组合优于继承。实现细节从对象的层次结构推送给具有单独层次结构的另一个对象。</p><h4 id="维基百科-2"><a href="#维基百科-2" class="headerlink" title="维基百科"></a>维基百科</h4><p>桥接模式是软件工程中使用的设计模式，旨在“将抽象与实现分离，使得两者可以独立变化”</p><p><strong>程序示例</strong></p><p>以上面提到的网页为例，下面是 <code>WebPage</code> 的结构</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WebPage</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Theme $theme)</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">About</span> <span class="keyword">implements</span> <span class="title">WebPage</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $theme;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Theme $theme)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;theme = $theme;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"About page in "</span> . <span class="keyword">$this</span>-&gt;theme-&gt;getColor();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Careers</span> <span class="keyword">implements</span> <span class="title">WebPage</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $theme;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Theme $theme)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;theme = $theme;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Careers page in "</span> . <span class="keyword">$this</span>-&gt;theme-&gt;getColor();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>独立的 <code>主题</code> 结构</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Theme</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DarkTheme</span> <span class="keyword">implements</span> <span class="title">Theme</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Dark Black'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LightTheme</span> <span class="keyword">implements</span> <span class="title">Theme</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Off white'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AquaTheme</span> <span class="keyword">implements</span> <span class="title">Theme</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Light blue'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>都是两层结构</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$darkTheme = <span class="keyword">new</span> DarkTheme();</div><div class="line"></div><div class="line">$about = <span class="keyword">new</span> About($darkTheme);</div><div class="line">$careers = <span class="keyword">new</span> Careers($darkTheme);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $about-&gt;getContent(); <span class="comment">// "About page in Dark Black";</span></div><div class="line"><span class="keyword">echo</span> $careers-&gt;getContent(); <span class="comment">// "Careers page in Dark Black";</span></div></pre></td></tr></table></figure><h3 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h3><h4 id="现实生活示例-2"><a href="#现实生活示例-2" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>每个公司都是由员工组成，每个员工都有一些共同特征比如薪资以及所承担的某些责任，会或者不会向其他人汇报工作，有或者没有下属等。</p><h4 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h4><p>组合模式让客户端以统一的方式对待各个对象。</p><h4 id="维基百科-3"><a href="#维基百科-3" class="headerlink" title="维基百科"></a>维基百科</h4><p>在软件工程中，组合模式是一种分治设计模式。组合模式对待一组对象的处理方式与对待对象的单个实例相同。组合的意图是将对象“组合”成树状结构以呈现<strong>部分-整体</strong>的层次结构。实现组合模式可以使客户端能够均匀地处理单个对象和组合。</p><p><strong>程序示例</strong></p><p>以上面提到的员工为例，下面是不同的员工类型</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Employee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, float $salary)</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span>: <span class="title">string</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setSalary</span><span class="params">(float $salary)</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSalary</span><span class="params">()</span>: <span class="title">float</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRoles</span><span class="params">()</span>: <span class="title">array</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Developer</span> <span class="keyword">implements</span> <span class="title">Employee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $salary;</div><div class="line">    <span class="keyword">protected</span> $name;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, float $salary)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;name = $name;</div><div class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span>: <span class="title">string</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setSalary</span><span class="params">(float $salary)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSalary</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRoles</span><span class="params">()</span>: <span class="title">array</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;roles;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Designer</span> <span class="keyword">implements</span> <span class="title">Employee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $salary;</div><div class="line">    <span class="keyword">protected</span> $name;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, float $salary)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;name = $name;</div><div class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span>: <span class="title">string</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setSalary</span><span class="params">(float $salary)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSalary</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRoles</span><span class="params">()</span>: <span class="title">array</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;roles;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>包含几种不同类型员工的公司</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Organization</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $employees;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addEmployee</span><span class="params">(Employee $employee)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;employees[] = $employee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNetSalaries</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line">    &#123;</div><div class="line">        $netSalary = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;employees <span class="keyword">as</span> $employee) &#123;</div><div class="line">            $netSalary += $employee-&gt;getSalary();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $netSalary;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后可以这样调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Prepare the employees</span></div><div class="line">$john = <span class="keyword">new</span> Developer(<span class="string">'John Doe'</span>, <span class="number">12000</span>);</div><div class="line">$jane = <span class="keyword">new</span> Designer(<span class="string">'Jane Doe'</span>, <span class="number">15000</span>);</div><div class="line"></div><div class="line"><span class="comment">// Add them to organization</span></div><div class="line">$organization = <span class="keyword">new</span> Organization();</div><div class="line">$organization-&gt;addEmployee($john);</div><div class="line">$organization-&gt;addEmployee($jane);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"Net salaries: "</span> . $organization-&gt;getNetSalaries(); <span class="comment">// Net Salaries: 27000</span></div></pre></td></tr></table></figure><h3 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h3><h4 id="现实生活示例-3"><a href="#现实生活示例-3" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>想象一下，你在经营一家提供多种服务的汽车服务站。现在如何计算收费帐单呢？选择一项服务，并动态地向其添加价格，直到获得最终成本。这里每种类型的服务就是装饰器。</p><h4 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h4><p>通过将对象包装在装饰器类的对象中，装饰器模式可以在运行时动态地更改对象的行为。</p><h4 id="维基百科-4"><a href="#维基百科-4" class="headerlink" title="维基百科"></a>维基百科</h4><p>装饰器模式，是面向对象编程领域中，一种动态地或静态地往一个类中添加新行为而不影响相同类中其他对象的设计模式。装饰器模式对于遵守单一责任原则通常是有用的，因为它允许在具有独特领域的类之间划分功能。</p><p><strong>程序示例</strong></p><p>我们以咖啡为例，首先我们通过咖啡接口实现一个简单咖啡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Coffee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Simple coffee'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>我们希望代码可扩展，以允许选项在需要时进行修改。 增加一些附加项（装饰器）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MilkCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $coffee;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Coffee $coffee)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;coffee = $coffee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getCost() + <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getDescription() . <span class="string">', milk'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhipCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $coffee;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Coffee $coffee)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;coffee = $coffee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getCost() + <span class="number">5</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getDescription() . <span class="string">', whip'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VanillaCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $coffee;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Coffee $coffee)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;coffee = $coffee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getCost() + <span class="number">3</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getDescription() . <span class="string">', vanilla'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>下面我们来做杯咖啡吧</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$someCoffee = <span class="keyword">new</span> SimpleCoffee();</div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 10</span></div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee</span></div><div class="line"></div><div class="line">$someCoffee = <span class="keyword">new</span> MilkCoffee($someCoffee);</div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 12</span></div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee, milk</span></div><div class="line"></div><div class="line">$someCoffee = <span class="keyword">new</span> WhipCoffee($someCoffee);</div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 17</span></div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee, milk, whip</span></div><div class="line"></div><div class="line">$someCoffee = <span class="keyword">new</span> VanillaCoffee($someCoffee);</div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 20</span></div><div class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee, milk, whip, vanilla</span></div></pre></td></tr></table></figure><h3 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a>外观模式</h3><h4 id="现实生活示例-4"><a href="#现实生活示例-4" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>请问你会如何打开计算机呢？你会回答：“按电源键就行！”。你会这样想是因为你在使用计算机对外提供的简易接口，但是在内部，计算机完成了很多工作后才得以启动，这种复杂子系统的简单接口就是外观模式。</p><h4 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h4><p>外观模式提供了一个简化复杂系统的简单接口。</p><h4 id="维基百科-5"><a href="#维基百科-5" class="headerlink" title="维基百科"></a>维基百科</h4><p>外观模式是指针对像类库这种大体积代码提供简化接口的对象。</p><p><strong>程序示例</strong></p><p>以上面提到的计算机为例，给出计算机类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getElectricShock</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Ouch!"</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeSound</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Beep beep!"</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showLoadingScreen</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Loading.."</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bam</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Ready to be used!"</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">closeEverything</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Bup bup bup buzzzz!"</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sooth</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Zzzzz"</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pullCurrent</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Haaah!"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>下面是计算机的外观</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputerFacade</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $computer;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Computer $computer)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;computer = $computer;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOn</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;getElectricShock();</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;makeSound();</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;showLoadingScreen();</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;bam();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOff</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;closeEverything();</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;pullCurrent();</div><div class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;sooth();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可以这样使用外观模式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$computer = <span class="keyword">new</span> ComputerFacade(<span class="keyword">new</span> Computer());</div><div class="line">$computer-&gt;turnOn(); <span class="comment">// Ouch! Beep beep! Loading.. Ready to be used!</span></div><div class="line">$computer-&gt;turnOff(); <span class="comment">// Bup bup buzzz! Haah! Zzzzz</span></div></pre></td></tr></table></figure><h3 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h3><h4 id="现实生活示例-5"><a href="#现实生活示例-5" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>你是否在某个摊位上喝过茶？店主总是会多做一些茶，以预留给其他顾客，以此来节省资源比如燃气。享元模式所讲的就是共享。</p><h4 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h4><p>享元模式通过相似对象之间尽可能的资源共享，来最小化内存使用或计算开销。</p><h4 id="维基百科-6"><a href="#维基百科-6" class="headerlink" title="维基百科"></a>维基百科</h4><p>在计算机编程中，享元模式是一种软件设计模式。享元模式是通过与其他类似对象共享尽可能多的数据来最小化内存使用的对象; 当简单的重复对象过多占用内存时，可以通过享元模式来处理大量相似对象的情况。</p><p><strong>程序示例</strong></p><p>以茶为例，首先定义茶的种类及茶具</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Anything that will be cached is flyweight.</span></div><div class="line"><span class="comment">// Types of tea here will be flyweights.</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">KarakTea</span></span></div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="comment">// Acts as a factory and saves the tea</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeaMaker</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $availableTea = [];</div><div class="line"> </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($preference)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;availableTea[$preference])) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;availableTea[$preference] = <span class="keyword">new</span> KarakTea();</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;availableTea[$preference];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后定义茶店来接单及提供服务</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeaShop</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $orders;</div><div class="line">    <span class="keyword">protected</span> $teaMaker;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(TeaMaker $teaMaker)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;teaMaker = $teaMaker;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">takeOrder</span><span class="params">(string $teaType, int $table)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;orders[$table] = <span class="keyword">$this</span>-&gt;teaMaker-&gt;make($teaType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serve</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;orders <span class="keyword">as</span> $table =&gt; $tea) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"Serving tea to table# "</span> . $table;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>下面可以这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$teaMaker = <span class="keyword">new</span> TeaMaker();</div><div class="line">$shop = <span class="keyword">new</span> TeaShop($teaMaker);</div><div class="line"></div><div class="line">$shop-&gt;takeOrder(<span class="string">'less sugar'</span>, <span class="number">1</span>);</div><div class="line">$shop-&gt;takeOrder(<span class="string">'more milk'</span>, <span class="number">2</span>);</div><div class="line">$shop-&gt;takeOrder(<span class="string">'without sugar'</span>, <span class="number">5</span>);</div><div class="line"></div><div class="line">$shop-&gt;serve();</div><div class="line"><span class="comment">// Serving tea to table# 1</span></div><div class="line"><span class="comment">// Serving tea to table# 2</span></div><div class="line"><span class="comment">// Serving tea to table# 5</span></div></pre></td></tr></table></figure><h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><h4 id="现实生活示例-6"><a href="#现实生活示例-6" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>有没有过使用门禁卡进门的经历呢？打开门的方法有多种，既可以使用门禁卡，也可以按下门上的安全按钮。门的主要功能是打开，但在其上添加一个代理，便可以给门添加一些功能。下面的代码示例可以给出更好的解释。</p><h4 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h4><p>使用代理模式，一个类可以代理另外一个类的功能。</p><h4 id="维基百科-7"><a href="#维基百科-7" class="headerlink" title="维基百科"></a>维基百科</h4><p>一个代理，其最一般的形式，是一个作为其他类接口的类。代理是由客户端调用的包装器或代理对象，用来访问幕后的真实服务对象。使用代理可以简单地向真实对象做转发，或者可以提供额外的逻辑。在代理模式中，可以提供额外的功能，例如当在真实对象上的操作是资源密集型时进行缓存，或者在调用真实对象的操作之前进行预处理。</p><p><strong>程序示例</strong></p><p>以安全门为例，首先给出安全门接口及实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LabDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Opening lab door"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Closing the lab door"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后使用代理来确保门的安全</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Security</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $door;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Door $door)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;door = $door;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($password)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;authenticate($password)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;door-&gt;open();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"Big no! It ain't possible."</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($password)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> $password === <span class="string">'$ecr@t'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;door-&gt;close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可以这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$door = <span class="keyword">new</span> Security(<span class="keyword">new</span> LabDoor());</div><div class="line">$door-&gt;open(<span class="string">'invalid'</span>); <span class="comment">// Big no! It ain't possible.</span></div><div class="line"></div><div class="line">$door-&gt;open(<span class="string">'$ecr@t'</span>); <span class="comment">// Opening lab door</span></div><div class="line">$door-&gt;close(); <span class="comment">// Closing lab door</span></div></pre></td></tr></table></figure><p>另一个例子是实现某种数据映射器。例如，我最近使用这种模式为 MongoDB 做了一个 ODM（对象数据映射器），其中我使用魔术方法<code>__call（）</code> 在 mongo 类上编写代理。所有的方法调用被代理到原始的 mongo 类，并且检索的结果原样返回，但如果调用 <code>find</code> 或 <code>findOne</code>，数据会被映射到所需的类对象，并且返回了对象而不是<code>Cursor</code>。</p><h1 id="行为型模式"><a href="#行为型模式" class="headerlink" title="行为型模式"></a>行为型模式</h1><h3 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h3><p>行为型设计模式关心对象之间的责任分配。与结构型设计模式不同的是，行为型设计模式不仅仅指定结构，而且还概述了它们之间的消息传递/通信的模式。或者换句话说，行为型模式帮助回答了“软件组件是如何运行的？”</p><h3 id="维基百科-8"><a href="#维基百科-8" class="headerlink" title="维基百科"></a>维基百科</h3><p>在软件工程中，行为型设计模式为设计模式的一种类型，用来识别对象之间的常用交流模式并加以实现。如此，可以在交流时增强灵活性。</p><p><strong>分类</strong></p><ul><li>责任链模式</li><li>命令模式</li><li>迭代器模式</li><li>中介者模式</li><li>备忘录模式</li><li>观察者模式</li><li>访问者模式</li><li>策略模式</li><li>状态模式</li><li>模板方法模式</li></ul><h3 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h3><h4 id="现实生活示例-7"><a href="#现实生活示例-7" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>例如，你的帐户中有三种付款方式（A，B 和 C）; 每种方式付款额不同。 A 可支付 100 美元，B 可支付 300 美元，C 可支付 1000 美元，支付的优先级为 A-&gt;B-&gt;C。现在想要购买价值 210 美元的东西。使用责任链模式，首先将检查帐户 A 是否可以进行购买，如果可以购买，链条将被破坏。如果不能购买，将继续检查账号 B 是否可以购买，如果可以购买，链条将被破坏，否则请求将继续转发，直到找到合适的处理程序。这里的 A、B 和 C 就是责任链的链条，整个现象就是责任链模式。</p><h4 id="概述-9"><a href="#概述-9" class="headerlink" title="概述"></a>概述</h4><p>责任链模式有助于建立一个对象链。请求从一端进入，在对象之间转发，直到找到合适的处理程序。</p><h4 id="维基百科-9"><a href="#维基百科-9" class="headerlink" title="维基百科"></a>维基百科</h4><p>责任链模式是面向对象程序设计的一种软件设计模式，它包含了一些命令对象和一系列的处理对象。每一个处理对象决定它能处理哪些命令对象，不能处理的命令对象传递给该链中的下一个处理对象。</p><p><strong>程序示例</strong></p><p>以上面的支付账号为例，首先给出账户基类，包含链接账号的逻辑以及一些不同类型的账户</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $successor;</div><div class="line">    <span class="keyword">protected</span> $balance;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setNext</span><span class="params">(Account $account)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;successor = $account;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pay</span><span class="params">(float $amountToPay)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;canPay($amountToPay)) &#123;</div><div class="line">            <span class="keyword">echo</span> sprintf(<span class="string">'Paid %s using %s'</span> . PHP_EOL, $amountToPay, get_called_class());</div><div class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;successor) &#123;</div><div class="line">            <span class="keyword">echo</span> sprintf(<span class="string">'Cannot pay using %s. Proceeding ..'</span> . PHP_EOL, get_called_class());</div><div class="line">            <span class="keyword">$this</span>-&gt;successor-&gt;pay($amountToPay);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'None of the accounts have enough balance'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">canPay</span><span class="params">($amount)</span>: <span class="title">bool</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;balance &gt;= $amount;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> <span class="keyword">extends</span> <span class="title">Account</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $balance;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $balance)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;balance = $balance;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Paypal</span> <span class="keyword">extends</span> <span class="title">Account</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $balance;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $balance)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;balance = $balance;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bitcoin</span> <span class="keyword">extends</span> <span class="title">Account</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $balance;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $balance)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;balance = $balance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后通过上面定义的链接（即 Bank, Paypal, Bitcoin）形成责任链</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Let's prepare a chain like below</span></div><div class="line"><span class="comment">//      $bank-&gt;$paypal-&gt;$bitcoin</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// First priority bank</span></div><div class="line"><span class="comment">//      If bank can't pay then paypal</span></div><div class="line"><span class="comment">//      If paypal can't pay then bit coin</span></div><div class="line"></div><div class="line">$bank = <span class="keyword">new</span> Bank(<span class="number">100</span>);          <span class="comment">// Bank with balance 100</span></div><div class="line">$paypal = <span class="keyword">new</span> Paypal(<span class="number">200</span>);      <span class="comment">// Paypal with balance 200</span></div><div class="line">$bitcoin = <span class="keyword">new</span> Bitcoin(<span class="number">300</span>);    <span class="comment">// Bitcoin with balance 300</span></div><div class="line"></div><div class="line">$bank-&gt;setNext($paypal);</div><div class="line">$paypal-&gt;setNext($bitcoin);</div><div class="line"></div><div class="line"><span class="comment">// Let's try to pay using the first priority i.e. bank</span></div><div class="line">$bank-&gt;pay(<span class="number">259</span>);</div><div class="line"></div><div class="line"><span class="comment">// Output will be</span></div><div class="line"><span class="comment">// ==============</span></div><div class="line"><span class="comment">// Cannot pay using bank. Proceeding ..</span></div><div class="line"><span class="comment">// Cannot pay using paypal. Proceeding ..:</span></div><div class="line"><span class="comment">// Paid 259 using Bitcoin!</span></div></pre></td></tr></table></figure><h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><h4 id="现实生活示例-8"><a href="#现实生活示例-8" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>一个典型的例子是你在餐厅点菜，你（即客户）向服务员（即 Invoker）点餐（即命令），服务员只需将需求转达给会烹饪的厨师。 另外一个例子是你（即客户端）使用遥控器（Invoker）打开（即命令）电视机（即接收器）。</p><h4 id="概述-10"><a href="#概述-10" class="headerlink" title="概述"></a>概述</h4><p>命令模式允许将操作封装在对象中，其背后的关键思想是提供客户端与接收器分离的方法。</p><h4 id="维基百科-10"><a href="#维基百科-10" class="headerlink" title="维基百科"></a>维基百科</h4><p>在面向对象程序设计的范畴中，命令模式是一种行为型设计模式。将所有需要的信息封装到对象中，用于之后的动作（action）或者事件触发。被封装的信息包括方法名以及拥有方法及参数的对象。</p><p><strong>程序示例</strong></p><p>首先给出一个接收器，实现了可能会执行的动作：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Receiver</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bulb</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOn</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Bulb has been lit"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOff</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Darkness!"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后给出一个接口，（Bulb）中的每个命令都要实现这个接口，得到一组命令集：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Command</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">undo</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redo</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Command</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TurnOn</span> <span class="keyword">implements</span> <span class="title">Command</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $bulb;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Bulb $bulb)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;bulb = $bulb;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOn();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">undo</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOff();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redo</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TurnOff</span> <span class="keyword">implements</span> <span class="title">Command</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $bulb;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Bulb $bulb)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;bulb = $bulb;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOff();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">undo</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOn();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redo</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是Invoker，客户端将与之交互以处理各种命令：</p><table><thead><tr><th>12345678</th><th>// Invokerclass RemoteControl{    public function submit(Command $command)    {        $command-&gt;execute();    }}</th></tr></thead><tbody><tr><td></td></tr></tbody></table><p>最后来看一下如何在客户端中使用：</p><table><thead><tr><th>12345678</th><th>$bulb = new Bulb(); $turnOn = new TurnOn($bulb);$turnOff = new TurnOff($bulb); $remote = new RemoteControl();$remote-&gt;submit($turnOn); // Bulb has been lit!$remote-&gt;submit($turnOff); // Darkness!</th></tr></thead><tbody><tr><td></td></tr></tbody></table><p>命令模式也可用于实现基于事务的系统。在执行命令时，需要持续保存命令的历史，如果最后一条命令成功执行，皆大欢喜，否则遍历历史记录，并对所有执行过的命执行<code>撤销</code>。</p><h3 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h3><h4 id="现实生活示例-9"><a href="#现实生活示例-9" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>老式的无线电设备将是一个很好的迭代器示例，用户可以在某个频道上启动，然后使用下一个或上一个按钮来切换频道。或者以 MP3 播放器或电视机为例，你可以按下一个按钮和上一个按钮进行连续的频道切换。换句话说，它们都提供了一个界面来遍历相应的频道，歌曲或广播电台。</p><h4 id="概述-11"><a href="#概述-11" class="headerlink" title="概述"></a>概述</h4><p>迭代器模式提供了一种方法，可以访问对象的元素而不暴露底层实现。</p><h4 id="维基百科-11"><a href="#维基百科-11" class="headerlink" title="维基百科"></a>维基百科</h4><p>在面向对象程序设计中，迭代器模式是一种设计模式，其中迭代器用于遍历容器并访问容器的元素。迭代器模式将算法与容器解耦; 在某些情况下，算法是特定容器必需的，因此不能解耦。</p><p><strong>程序示例</strong></p><p>通过PHP，使用 SPL（PHP标准库）可以轻松实现迭代器模式，以上述收音机为例，首先给出 <code>RadioStation</code> 类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RadioStation</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $frequency;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $frequency)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;frequency = $frequency;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFrequency</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;frequency;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是 迭代器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Countable</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Iterator</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StationList</span> <span class="keyword">implements</span> <span class="title">Countable</span>, <span class="title">Iterator</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/** [<span class="doctag">@var</span>](http://www.jobbole.com/members/variable) RadioStation[] $stations */</span></div><div class="line">    <span class="keyword">protected</span> $stations = [];</div><div class="line"></div><div class="line">    <span class="comment">/** [<span class="doctag">@var</span>](http://www.jobbole.com/members/variable) int $counter */</span></div><div class="line">    <span class="keyword">protected</span> $counter;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addStation</span><span class="params">(RadioStation $station)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;stations[] = $station;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">removeStation</span><span class="params">(RadioStation $toRemove)</span></span></div><div class="line">    &#123;</div><div class="line">        $toRemoveFrequency = $toRemove-&gt;getFrequency();</div><div class="line">        <span class="keyword">$this</span>-&gt;stations = array_filter(<span class="keyword">$this</span>-&gt;stations, <span class="function"><span class="keyword">function</span> <span class="params">(RadioStation $station)</span> <span class="title">use</span> <span class="params">($toRemoveFrequency)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> $station-&gt;getFrequency() !== $toRemoveFrequency;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">()</span>: <span class="title">int</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> count(<span class="keyword">$this</span>-&gt;stations);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span><span class="params">()</span>: <span class="title">RadioStation</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;stations[<span class="keyword">$this</span>-&gt;counter];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;counter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;counter++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rewind</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;counter = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span>: <span class="title">bool</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;stations[<span class="keyword">$this</span>-&gt;counter]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可以这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$stationList = <span class="keyword">new</span> StationList();</div><div class="line"></div><div class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">89</span>));</div><div class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">101</span>));</div><div class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">102</span>));</div><div class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">103.2</span>));</div><div class="line"></div><div class="line"><span class="keyword">foreach</span>($stationList <span class="keyword">as</span> $station) &#123;</div><div class="line">    <span class="keyword">echo</span> $station-&gt;getFrequency() . PHP_EOL;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$stationList-&gt;removeStation(<span class="keyword">new</span> RadioStation(<span class="number">89</span>)); <span class="comment">// Will remove station 89</span></div></pre></td></tr></table></figure><h3 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h3><h4 id="现实生活示例-10"><a href="#现实生活示例-10" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>典型的例子是你通过手机与他人通话，你与通话者之间有一个网络供应商，对话将通过供应商传递而非直接传递。这种情况下网络供应商就是中介者。</p><h4 id="概述-12"><a href="#概述-12" class="headerlink" title="概述"></a>概述</h4><p>中介者模式添加了第三方对象（称为中介者）来控制两个对象（称为 colleague）之间的交互。中介者模式有助于减少通信类之间的耦合，因为类之间无需知道对方的实现。</p><h4 id="维基百科-12"><a href="#维基百科-12" class="headerlink" title="维基百科"></a>维基百科</h4><p>在软件工程中，中介者模式包装了一系列对象相互作用的方式。这种模式被认为是一种行为模式，因为它可以改变程序的运行时行为。</p><p><strong>程序示例</strong></p><p>下面是一个最简单的用户（即 colleague）在聊天室（中介者）中互相发送消息的示例</p><p>首先给出中介者及聊天室</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ChatRoomMediator</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">(User $user, string $message)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Mediator</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatRoom</span> <span class="keyword">implements</span> <span class="title">ChatRoomMediator</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">(User $user, string $message)</span></span></div><div class="line">    &#123;</div><div class="line">        $time = date(<span class="string">'M d, y H:i'</span>);</div><div class="line">        $sender = $user-&gt;getName();</div><div class="line"></div><div class="line">        <span class="keyword">echo</span> $time . <span class="string">'['</span> . $sender . <span class="string">']:'</span> . $message;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是用户即 colleague</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> $name;</div><div class="line">    <span class="keyword">protected</span> $chatMediator;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, ChatRoomMediator $chatMediator)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;name = $name;</div><div class="line">        <span class="keyword">$this</span>-&gt;chatMediator = $chatMediator;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($message)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;chatMediator-&gt;showMessage(<span class="keyword">$this</span>, $message);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>用法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$mediator = <span class="keyword">new</span> ChatRoom();</div><div class="line"></div><div class="line">$john = <span class="keyword">new</span> User(<span class="string">'John Doe'</span>, $mediator);</div><div class="line">$jane = <span class="keyword">new</span> User(<span class="string">'Jane Doe'</span>, $mediator);</div><div class="line"></div><div class="line">$john-&gt;send(<span class="string">'Hi there!'</span>);</div><div class="line">$jane-&gt;send(<span class="string">'Hey!'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Output will be</span></div><div class="line"><span class="comment">// Feb 14, 10:58 [John]: Hi there!</span></div><div class="line"><span class="comment">// Feb 14, 10:58 [Jane]: Hey!</span></div></pre></td></tr></table></figure><h3 id="备忘录模式"><a href="#备忘录模式" class="headerlink" title="备忘录模式"></a>备忘录模式</h3><h4 id="现实生活示例-11"><a href="#现实生活示例-11" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>以计算器（即发起者）为例，每当执行一些计算时，最后一次计算结果将保存在内存中（即备忘录），以便数据可以恢复，也可以使用某些操作按钮（即临时代理）来恢复数据。</p><h4 id="概述-13"><a href="#概述-13" class="headerlink" title="概述"></a>概述</h4><p>备忘录模式以一种稍后可平滑恢复的方式捕捉并存储对象的当前状态。</p><h4 id="维基百科-13"><a href="#维基百科-13" class="headerlink" title="维基百科"></a>维基百科</h4><p>备忘录模式是一种软件设计模式，可以将对象恢复到之前的状态（通过回滚来撤销）</p><p>需要提供撤销操作时，备忘录模式通常很有用。</p><p><strong>程序示例</strong></p><p>首先给出可以存储编辑器状态的备忘录对象</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EditorMemento</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $content;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $content)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;content = $content;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;content;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是使用备忘录对象的编辑器及发起者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Editor</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $content = <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">type</span><span class="params">(string $words)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;content = <span class="keyword">$this</span>-&gt;content . <span class="string">' '</span> . $words;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;content;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EditorMemento(<span class="keyword">$this</span>-&gt;content);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">restore</span><span class="params">(EditorMemento $memento)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;content = $memento-&gt;getContent();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$editor = <span class="keyword">new</span> Editor();</div><div class="line"></div><div class="line"><span class="comment">// Type some stuff</span></div><div class="line">$editor-&gt;type(<span class="string">'This is the first sentence.'</span>);</div><div class="line">$editor-&gt;type(<span class="string">'This is second.'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Save the state to restore to : This is the first sentence. This is second.</span></div><div class="line">$saved = $editor-&gt;save();</div><div class="line"></div><div class="line"><span class="comment">// Type some more</span></div><div class="line">$editor-&gt;type(<span class="string">'And this is third.'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Output: Content before Saving</span></div><div class="line"><span class="keyword">echo</span> $editor-&gt;getContent(); <span class="comment">// This is the first sentence. This is second. And this is third.</span></div><div class="line"></div><div class="line"><span class="comment">// Restoring to last saved state</span></div><div class="line">$editor-&gt;restore($saved);</div><div class="line"></div><div class="line">$editor-&gt;getContent(); <span class="comment">// This is the first sentence. This is second.</span></div></pre></td></tr></table></figure><h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h3><h4 id="现实生活示例-12"><a href="#现实生活示例-12" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>一个很好的例子是，求职者订阅了一些招聘网站，每当有匹配的工作机会时，求职者就会收到通知。</p><h4 id="概述-14"><a href="#概述-14" class="headerlink" title="概述"></a>概述</h4><p>定义了对象之间的依赖，一旦其中一个对象的状态发生改变，依赖它的对象都会收到通知。</p><h4 id="维基百科-14"><a href="#维基百科-14" class="headerlink" title="维基百科"></a>维基百科</h4><p>观察者模式是软件设计模式的一种。在此种模式中，一个目标对象管理所有相依于它的观察者对象，并且在它本身的状态改变时主动发出通知。通常通过调用目标对象所提供的方法来实现。</p><p><strong>程序示例</strong></p><p>以上述求职订阅为例，首先给出求职者，有职位发布时会收到通知</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobPost</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $title;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $title)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;title = $title;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTitle</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;title;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobSeeker</span> <span class="keyword">implements</span> <span class="title">Observer</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $name;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;name = $name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onJobPosted</span><span class="params">(JobPost $job)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Do something with the job posting</span></div><div class="line">        <span class="keyword">echo</span> <span class="string">'Hi '</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">'! New job posted: '</span>. $job-&gt;getTitle();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是求职者订阅的职位发布类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobPostings</span> <span class="keyword">implements</span> <span class="title">Observable</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $observers = [];</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">(JobPost $jobPosting)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;observers <span class="keyword">as</span> $observer) &#123;</div><div class="line">            $observer-&gt;onJobPosted($jobPosting);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attach</span><span class="params">(Observer $observer)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;observers[] = $observer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addJob</span><span class="params">(JobPost $jobPosting)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;notify($jobPosting);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create subscribers</span></div><div class="line">$johnDoe = <span class="keyword">new</span> JobSeeker(<span class="string">'John Doe'</span>);</div><div class="line">$janeDoe = <span class="keyword">new</span> JobSeeker(<span class="string">'Jane Doe'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Create publisher and attach subscribers</span></div><div class="line">$jobPostings = <span class="keyword">new</span> JobPostings();</div><div class="line">$jobPostings-&gt;attach($johnDoe);</div><div class="line">$jobPostings-&gt;attach($janeDoe);</div><div class="line"></div><div class="line"><span class="comment">// Add a new job and see if subscribers get notified</span></div><div class="line">$jobPostings-&gt;addJob(<span class="keyword">new</span> JobPost(<span class="string">'Software Engineer'</span>));</div><div class="line"></div><div class="line"><span class="comment">// Output</span></div><div class="line"><span class="comment">// Hi John Doe! New job posted: Software Engineer</span></div><div class="line"><span class="comment">// Hi Jane Doe! New job posted: Software Engineer</span></div></pre></td></tr></table></figure><h3 id="访问者模式"><a href="#访问者模式" class="headerlink" title="访问者模式"></a>访问者模式</h3><h4 id="现实生活示例-13"><a href="#现实生活示例-13" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>假如有人前往迪拜，他们需要有证件（比如签证）就可进入迪拜。到达后，无需获得许可或做一些跑腿工作，他们便可以自由前往迪拜的任何地方; 只要是知道的地方，就能游览。访问者模式可以做到这一点，它可以帮助你添加访问地点，以便在无需跑腿的情况下，可以尽可能多地访问。</p><h4 id="概述-15"><a href="#概述-15" class="headerlink" title="概述"></a>概述</h4><p>访问者模式可以在无需修改对象的情况下增加一些额外操作。</p><h4 id="维基百科-15"><a href="#维基百科-15" class="headerlink" title="维基百科"></a>维基百科</h4><p>在面向对象编程和软件工程中，访问者设计模式是一种从对象结构中分离算法的方式。这种分离的实际结果是能够向现有的对象结构添加新的操作，而无需修改这些结构。这是遵循开放/封闭原则的一种方式。</p><p><strong>编程示例</strong></p><p>以模拟动物园为例，动物园里有几种不同种类的动物，我们需要让它们发出叫声，下面使用访问者模式实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Visitee</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Animal</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Visitor</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AnimalOperation</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitMonkey</span><span class="params">(Monkey $monkey)</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitLion</span><span class="params">(Lion $lion)</span></span>;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitDolphin</span><span class="params">(Dolphin $dolphin)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后实现各种动物</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monkey</span> <span class="keyword">implements</span> <span class="title">Animal</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shout</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Ooh oo aa aa!'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span></div><div class="line">    &#123;</div><div class="line">        $operation-&gt;visitMonkey(<span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lion</span> <span class="keyword">implements</span> <span class="title">Animal</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Roaaar!'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span></div><div class="line">    &#123;</div><div class="line">        $operation-&gt;visitLion(<span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dolphin</span> <span class="keyword">implements</span> <span class="title">Animal</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speak</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Tuut tuttu tuutt!'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span></div><div class="line">    &#123;</div><div class="line">        $operation-&gt;visitDolphin(<span class="keyword">$this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>接下来实现访问者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Speak</span> <span class="keyword">implements</span> <span class="title">AnimalOperation</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitMonkey</span><span class="params">(Monkey $monkey)</span></span></div><div class="line">    &#123;</div><div class="line">        $monkey-&gt;shout();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitLion</span><span class="params">(Lion $lion)</span></span></div><div class="line">    &#123;</div><div class="line">        $lion-&gt;roar();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitDolphin</span><span class="params">(Dolphin $dolphin)</span></span></div><div class="line">    &#123;</div><div class="line">        $dolphin-&gt;speak();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>可以这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$monkey = <span class="keyword">new</span> Monkey();</div><div class="line">$lion = <span class="keyword">new</span> Lion();</div><div class="line">$dolphin = <span class="keyword">new</span> Dolphin();</div><div class="line"></div><div class="line">$speak = <span class="keyword">new</span> Speak();</div><div class="line"></div><div class="line">$monkey-&gt;accept($speak);    <span class="comment">// Ooh oo aa aa!    </span></div><div class="line">$lion-&gt;accept($speak);      <span class="comment">// Roaaar!</span></div><div class="line">$dolphin-&gt;accept($speak);   <span class="comment">// Tuut tutt tuutt!</span></div></pre></td></tr></table></figure><p>当需要为动物添加新动作时，我们本可以通过动物支持继承来实现，但是需要修改动物类。但现在就不必修改动物类了。例如，假设需要向动物添加跳跃行为，我们可以通过创建一个新的访问者来简单地添加此行为，即：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jump</span> <span class="keyword">implements</span> <span class="title">AnimalOperation</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitMonkey</span><span class="params">(Monkey $monkey)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Jumped 20 feet high! on to the tree!'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitLion</span><span class="params">(Lion $lion)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Jumped 7 feet! Back on the ground!'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitDolphin</span><span class="params">(Dolphin $dolphin)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Walked on water a little and disappeared'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$jump = <span class="keyword">new</span> Jump();</div><div class="line"></div><div class="line">$monkey-&gt;accept($speak);   <span class="comment">// Ooh oo aa aa!</span></div><div class="line">$monkey-&gt;accept($jump);    <span class="comment">// Jumped 20 feet high! on to the tree!</span></div><div class="line"></div><div class="line">$lion-&gt;accept($speak);     <span class="comment">// Roaaar!</span></div><div class="line">$lion-&gt;accept($jump);      <span class="comment">// Jumped 7 feet! Back on the ground!</span></div><div class="line"></div><div class="line">$dolphin-&gt;accept($speak);  <span class="comment">// Tuut tutt tuutt!</span></div><div class="line">$dolphin-&gt;accept($jump);   <span class="comment">// Walked on water a little and disappeared</span></div></pre></td></tr></table></figure><h3 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h3><h4 id="现实生活示例-14"><a href="#现实生活示例-14" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>考虑排序的例子，我们实现了冒泡排序，但数据开始增长，冒泡排序开始变得非常慢。为了解决这个问题，我们实现了快速排序。尽管快速排序算法对于大型数据集来说效果很好，但对于较小的数据集却非常慢。为了解决这个问题，我们实施了一个策略，小数据集使用冒泡排序，大数据集使用快速排序。</p><h4 id="概述-16"><a href="#概述-16" class="headerlink" title="概述"></a>概述</h4><p>策略模式允许你基于场景转换算法或策略。</p><h4 id="维基百科-16"><a href="#维基百科-16" class="headerlink" title="维基百科"></a>维基百科</h4><p>在计算机编程中，策略模式是一种行为设计模式，可以在运行时选择算法的行为。</p><p><strong>编程示例</strong></p><p>以上述排序为例，首先给出策略接口及不同的策略实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SortStrategy</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BubbleSortStrategy</span> <span class="keyword">implements</span> <span class="title">SortStrategy</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Sorting using bubble sort"</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Do sorting</span></div><div class="line">        <span class="keyword">return</span> $dataset;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuickSortStrategy</span> <span class="keyword">implements</span> <span class="title">SortStrategy</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Sorting using quick sort"</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Do sorting</span></div><div class="line">        <span class="keyword">return</span> $dataset;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>客户端可以使用任意策略</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sorter</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $sorter;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SortStrategy $sorter)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;sorter = $sorter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sorter-&gt;sort($dataset);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>用法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$dataset = [<span class="number">1</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">8</span>];</div><div class="line"></div><div class="line">$sorter = <span class="keyword">new</span> Sorter(<span class="keyword">new</span> BubbleSortStrategy());</div><div class="line">$sorter-&gt;sort($dataset); <span class="comment">// Output : Sorting using bubble sort</span></div><div class="line"></div><div class="line">$sorter = <span class="keyword">new</span> Sorter(<span class="keyword">new</span> QuickSortStrategy());</div><div class="line">$sorter-&gt;sort($dataset); <span class="comment">// Output : Sorting using quick sort</span></div></pre></td></tr></table></figure><h3 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h3><h4 id="现实生活示例-15"><a href="#现实生活示例-15" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>想象一下，你正在使用一些绘图应用程序，你可以选择笔刷来绘画，刷子根据所选颜色改变其行为，即如果选择红色，它将绘制为红色，如果选择蓝色，那么它将绘制蓝色等。</p><h4 id="概述-17"><a href="#概述-17" class="headerlink" title="概述"></a>概述</h4><p>当状态改变时，类的行为也发生改变。</p><h4 id="维基百科-17"><a href="#维基百科-17" class="headerlink" title="维基百科"></a>维基百科</h4><p>状态模式是以面向对象的方式实现状态机的行为设计模式。对于状态模式，通过将每个单独状态实现为派生类的状态模式接口, 来实现一个状态机，并通过调用模式超类的方法来实现状态转换。状态模式可以被解释为一种策略模式，它能够通过调用模式接口定义的方法来切换当前策略。</p><p><strong>程序示例</strong></p><p>以文本编辑器为例，编辑器可以改变文本的状态如选中粗体，就会以粗体输入文本，选中斜体便以斜体输入。</p><p>首先是状态接口和一些状态实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WritingState</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpperCase</span> <span class="keyword">implements</span> <span class="title">WritingState</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> strtoupper($words);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LowerCase</span> <span class="keyword">implements</span> <span class="title">WritingState</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> strtolower($words);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Default</span> <span class="keyword">implements</span> <span class="title">WritingState</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> $words;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后是文本编辑器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextEditor</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $state;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(WritingState $state)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;state = $state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setState</span><span class="params">(WritingState $state)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;state = $state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">type</span><span class="params">(string $words)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;state-&gt;write($words);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>用法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$editor = <span class="keyword">new</span> TextEditor(<span class="keyword">new</span> <span class="keyword">Default</span>());</div><div class="line"></div><div class="line">$editor-&gt;type(<span class="string">'First line'</span>);</div><div class="line"></div><div class="line">$editor-&gt;setState(<span class="keyword">new</span> UpperCase());</div><div class="line"></div><div class="line">$editor-&gt;type(<span class="string">'Second line'</span>);</div><div class="line">$editor-&gt;type(<span class="string">'Third line'</span>);</div><div class="line"></div><div class="line">$editor-&gt;setState(<span class="keyword">new</span> LowerCase());</div><div class="line"></div><div class="line">$editor-&gt;type(<span class="string">'Fourth line'</span>);</div><div class="line">$editor-&gt;type(<span class="string">'Fifth line'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Output:</span></div><div class="line"><span class="comment">// First line</span></div><div class="line"><span class="comment">// SECOND LINE</span></div><div class="line"><span class="comment">// THIRD LINE</span></div><div class="line"><span class="comment">// fourth line</span></div><div class="line"><span class="comment">// fifth line</span></div></pre></td></tr></table></figure><h3 id="模板方法模式"><a href="#模板方法模式" class="headerlink" title="模板方法模式"></a>模板方法模式</h3><h4 id="现实生活示例-16"><a href="#现实生活示例-16" class="headerlink" title="现实生活示例"></a>现实生活示例</h4><p>假设我们要造一座房子，建造的大体步骤如下：</p><ul><li>打地基</li><li>垒墙</li><li>封顶</li><li>铺地板</li></ul><p>这些步骤的顺序不能被打乱，比如说，你不能在垒墙之前先封顶。但是其中的每一步可以定制，比如墙的材料可以使用木头、聚酯纤维或者石头。</p><h4 id="概述-18"><a href="#概述-18" class="headerlink" title="概述"></a>概述</h4><p>模板方法模式定义了如何执行某种算法的框架，但是将这些步骤的实现推迟到子类中。</p><h4 id="维基百科-18"><a href="#维基百科-18" class="headerlink" title="维基百科"></a>维基百科</h4><p>在软件工程中，模板方法模式是一种行为设计模式，用于定义操作中算法的程序框架，将一些步骤推迟到子类实现。它允许在不改变算法结构的情况下重新定义算法的某些步骤。</p><p><strong>程序示例</strong></p><p>假如我们有一个构建工具，可以帮助我们测试，构建并生成构建报告（即代码覆盖报告，linting报告等），并将应用程序部署到测试服务器上。</p><p>首先是用于确定构建算法框架的基类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Template method</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;test();</div><div class="line">        <span class="keyword">$this</span>-&gt;lint();</div><div class="line">        <span class="keyword">$this</span>-&gt;assemble();</div><div class="line">        <span class="keyword">$this</span>-&gt;deploy();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">lint</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assemble</span><span class="params">()</span></span>;</div><div class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>然后提供一些基类的实现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidBuilder</span> <span class="keyword">extends</span> <span class="title">Builder</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Running android tests'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">lint</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Linting the android code'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assemble</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Assembling the android build'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Deploying android build to server'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IosBuilder</span> <span class="keyword">extends</span> <span class="title">Builder</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Running ios tests'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">lint</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Linting the ios code'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assemble</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Assembling the ios build'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">'Deploying ios build to server'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>用法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$androidBuilder = <span class="keyword">new</span> AndroidBuilder();</div><div class="line">$androidBuilder-&gt;build();</div><div class="line"></div><div class="line"><span class="comment">// Output:</span></div><div class="line"><span class="comment">// Running android tests</span></div><div class="line"><span class="comment">// Linting the android code</span></div><div class="line"><span class="comment">// Assembling the android build</span></div><div class="line"><span class="comment">// Deploying android build to server</span></div><div class="line"></div><div class="line">$iosBuilder = <span class="keyword">new</span> IosBuilder();</div><div class="line">$iosBuilder-&gt;build();</div><div class="line"></div><div class="line"><span class="comment">// Output:</span></div><div class="line"><span class="comment">// Running ios tests</span></div><div class="line"><span class="comment">// Linting the ios code</span></div><div class="line"><span class="comment">// Assembling the ios build</span></div><div class="line"><span class="comment">// Deploying ios build to server</span></div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>提高 MySQL 的性能，从数据库设计规范开始</title>
      <link href="/2017/06/23/2/"/>
      <content type="html"><![CDATA[<p>这几日一直都在看慕课网的一篇有关于数据库设计的实战教程，在其中讲述了关于数据库设计的一些相关规范，可以说是受益匪浅，于是便将学习所得记录下来，如果有想要看视频版的同学可以到慕课网查看。</p><p><a href="http://coding.imooc.com/class/79.html" target="_blank" rel="noopener">点我跳转到慕课网观看视频</a></p><h2 id="数据库名称规范"><a href="#数据库名称规范" class="headerlink" title="数据库名称规范"></a>数据库名称规范</h2><h3 id="1-所有数据库对象名称必须使用小写字母并使用下划线分割"><a href="#1-所有数据库对象名称必须使用小写字母并使用下划线分割" class="headerlink" title="1.所有数据库对象名称必须使用小写字母并使用下划线分割"></a>1.所有数据库对象名称必须使用小写字母并使用下划线分割</h3><p>由于 MySQL数据库的对象名称默认情况下是大小写敏感的，特别是在 Linux 系统下，MySQL 的数据库和表实际上的存储方式就是 Linux 下的一个文件，由于 Linux 系统是对大小写敏感的，所以 MySQL 也就对大小写敏感，这就意味着 DbName dbname 是完全不同的两个数据库。</p><p>如果在开发过程中使用大小写混用的情况下，就会对未来的开发工作造成很多不必要的麻烦，要时刻注意数据库对象的大小写。</p><h3 id="2-所有的数据库对象名称禁止使用-MySQL-的保留字段"><a href="#2-所有的数据库对象名称禁止使用-MySQL-的保留字段" class="headerlink" title="2.所有的数据库对象名称禁止使用 MySQL 的保留字段"></a>2.所有的数据库对象名称禁止使用 MySQL 的保留字段</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select id,username from ,age from tb_user;</div></pre></td></tr></table></figure><p>在上述SQL 语句中存在两个 from，由于 MySQL 并不知道这两个 from 有什么区别，若是执行这条 SQL 语句肯定会报错，但是在建表的时候却不会报错。</p><p>若是已经使用了关键字做了字段名，那就需要在字段名前后加上反引号，示例如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select id,username `from` ,age from tb_user;</div></pre></td></tr></table></figure><blockquote><p>反引号是为了区分MySQL关键字和保留字与普通字符而引入的符号，保留字的列表请点击此网页查看 <a href="https://dev.mysql.com/doc/refman/5.7/en/keywords.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/keywords.html</a></p></blockquote><h3 id="3-数据库对象的命名要做到见名识义，而且最好不要超过32个字符"><a href="#3-数据库对象的命名要做到见名识义，而且最好不要超过32个字符" class="headerlink" title="3. 数据库对象的命名要做到见名识义，而且最好不要超过32个字符"></a>3. 数据库对象的命名要做到见名识义，而且最好不要超过32个字符</h3><p>MySQL 的限制长度是64个字符，但是表名和列名一旦过长，在使用过程中将会很不方便，而且还会增加网络传输的开销。</p><p>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">用户数据库： ex_userdb</div><div class="line">用户账户表： user_account</div></pre></td></tr></table></figure><h3 id="4-所有的临时表必须以-tmp为前缀并以日期为后缀"><a href="#4-所有的临时表必须以-tmp为前缀并以日期为后缀" class="headerlink" title="4. 所有的临时表必须以 tmp为前缀并以日期为后缀"></a>4. 所有的临时表必须以 tmp为前缀并以日期为后缀</h3><p>在我们的日常工作中，会在数据库中建立一些临时表或者中间表，往往无法第一时间将其清理掉，时间一长便无法分清，哪些是临时表或者是持久化表，这样一来就会造成很多的垃圾数据。</p><h3 id="5-备份表必须以bak为前缀并以日期为后缀"><a href="#5-备份表必须以bak为前缀并以日期为后缀" class="headerlink" title="5.备份表必须以bak为前缀并以日期为后缀"></a>5.备份表必须以bak为前缀并以日期为后缀</h3><p>在日常工作中，我们会对数据库进行备份，在备份的时候，以 bak 开头可以清晰的表示出这是一个备份表，并且以时间结尾标注了这个表是在什么时间进行的备份，这样一来能够设计出更加整洁的数据库，并且结构清晰。</p><h3 id="6-所有存储相同数据的列明和列类型必须一致。"><a href="#6-所有存储相同数据的列明和列类型必须一致。" class="headerlink" title="6.所有存储相同数据的列明和列类型必须一致。"></a>6.所有存储相同数据的列明和列类型必须一致。</h3><p>通着这这种字段都是以关联字段进行使用的，如果两个表的关联字段的数据类型不一致，在关联时MySQL 会进行隐式类型转换，造成字段索引失效，影响数据库的运行性能，导致不必要的开销。</p><h2 id="数据库基本设计规范"><a href="#数据库基本设计规范" class="headerlink" title="数据库基本设计规范"></a>数据库基本设计规范</h2><h3 id="1-在没有特殊要求的情况下，所有表必须使用-Innodb-存储引擎"><a href="#1-在没有特殊要求的情况下，所有表必须使用-Innodb-存储引擎" class="headerlink" title="1. 在没有特殊要求的情况下，所有表必须使用 Innodb 存储引擎"></a>1. 在没有特殊要求的情况下，所有表必须使用 Innodb 存储引擎</h3><p>比如列存储、在5.7版本之前存储空间数据，如果还在使用MyISAM 引擎如果在升级到5.6之后应该尽快将存储引擎升级到 Innodb，因为在5.6之后的默认引擎就是 Innodb，Innodb 支持事务，行级锁，更好的恢复性，高并发下性能更好。</p><h3 id="2-数据库和表的字符集使用-UTF8"><a href="#2-数据库和表的字符集使用-UTF8" class="headerlink" title="2.数据库和表的字符集使用 UTF8"></a>2.数据库和表的字符集使用 UTF8</h3><p>统一的字符集可以避免由于字符集转换禅城的乱码，MySQL 中 UTF8字符集汉字站3个字节，ASCII 码占用1个字节，若我们定了一个 varchar(255)的列，并且存储中文的话，255个中文字符将会占用725个字节。</p><h3 id="3-所有的表和字段都需要添加注释"><a href="#3-所有的表和字段都需要添加注释" class="headerlink" title="3.所有的表和字段都需要添加注释"></a>3.所有的表和字段都需要添加注释</h3><p>使用 comment 从句添加表和列的备注，从一开始就进行数据字典维护。</p><h4 id="4-尽量控制单表数据量的大小，建议控制在500万行以内"><a href="#4-尽量控制单表数据量的大小，建议控制在500万行以内" class="headerlink" title="4.尽量控制单表数据量的大小，建议控制在500万行以内"></a>4.尽量控制单表数据量的大小，建议控制在500万行以内</h4><p>500万并不是 MySQL数据库的限制，MySQL 的存储数据量取决于存储设置和文件系统，修改表结构，备份，恢复都会有很大问题。</p><p>可以使用历史数据归档，分库分表等手段来控制数据量的大小，历史数据归档常用语系统日志，分库分表主要应用在业务表上。</p><h4 id="5-谨慎的使用-MySQL-分区表。"><a href="#5-谨慎的使用-MySQL-分区表。" class="headerlink" title="5.谨慎的使用 MySQL 分区表。"></a>5.谨慎的使用 MySQL 分区表。</h4><p>分区表在物理上表现为多个文件，在逻辑上表现为一个表。谨慎的选择分区键，跨分区查询效率可能更低。</p><p>建议采用物理分表的方式管理大数据。</p><h4 id="6-尽量做到冷热数据分离，减小表单的宽度"><a href="#6-尽量做到冷热数据分离，减小表单的宽度" class="headerlink" title="6.尽量做到冷热数据分离，减小表单的宽度"></a>6.尽量做到冷热数据分离，减小表单的宽度</h4><p>MySQL 限制最多存储4096列，并且每一行的大小是不能超过65535个字节的。最好将经常用到的列放到一个表中，这样一来可以减少磁盘 IO，保证热数据的内存缓存命中率。利用更有效的利用缓存，避免读入无用的冷数据。</p><h4 id="7-禁止在表中建立预留字段"><a href="#7-禁止在表中建立预留字段" class="headerlink" title="7.禁止在表中建立预留字段"></a>7.禁止在表中建立预留字段</h4><p>预留字段的命名很难做到见名识义，预留字段无法确认存储的数据类型，所以无法选择合适的类型。对预留字段类型的修改，会对表进行锁定，修改一个字段类型的成本远高于新建一个字段。</p><h4 id="8-禁止在数据库中存储图片，文件等二进制数据"><a href="#8-禁止在数据库中存储图片，文件等二进制数据" class="headerlink" title="8.禁止在数据库中存储图片，文件等二进制数据"></a>8.禁止在数据库中存储图片，文件等二进制数据</h4><p>这类文件都会很大，会在短时间内造成数据量的疯涨，在数据库读取的时会产生大量的 IO 操作，非常好事，影响数据库性能，常规的做法是将图片保存在对应的文件服务器上，然后在数据库中保存地址信息就可以了。</p><h4 id="9-禁止在线上做数据库压力测试"><a href="#9-禁止在线上做数据库压力测试" class="headerlink" title="9.禁止在线上做数据库压力测试"></a>9.禁止在线上做数据库压力测试</h4><p>如果使用生产环境进行压力测试一方面会对正常的业务访问造成影响，另一方面也会对数据库造成影响，产生大量的垃圾数据。</p><h4 id="8-禁止从开发环境，测试环境直接连生产环境数据库"><a href="#8-禁止从开发环境，测试环境直接连生产环境数据库" class="headerlink" title="8.禁止从开发环境，测试环境直接连生产环境数据库"></a>8.禁止从开发环境，测试环境直接连生产环境数据库</h4><p>会对生产环境的数据的完整性进行破坏。</p><h2 id="数据库索引设计规范"><a href="#数据库索引设计规范" class="headerlink" title="数据库索引设计规范"></a>数据库索引设计规范</h2><h3 id="1-限制每张表上的索引数量，建议单标索引不超过5个"><a href="#1-限制每张表上的索引数量，建议单标索引不超过5个" class="headerlink" title="1.限制每张表上的索引数量，建议单标索引不超过5个"></a>1.限制每张表上的索引数量，建议单标索引不超过5个</h3><p>索引数量是和列的数量是成正比的，通常列的数量越多索引的数量也会越多，索引并不是越多越好，索引可以提高效率单同样也可以鉴定效率，索引可以增加查询效率，单同样也会降低插入和更新的效率。</p><p>由于 MySQL 优化器在选择优化查询时，会根据统计信息对每一个可以用到的索引进行评估，以生成出一个最好的执行计划，如果同时有很多索引都可以用于查询，就会增加 MySQL优化器生成优化器的时间，同样机会降低 SQL 查询的性能。</p><p>禁止给表中的每一个列都建立单独的索引。</p><h3 id="2-每一个-Innodb表都必须有一个主键"><a href="#2-每一个-Innodb表都必须有一个主键" class="headerlink" title="2.每一个 Innodb表都必须有一个主键"></a>2.每一个 Innodb表都必须有一个主键</h3><p>Innodb 是一种索引组织表，数据存储的逻辑顺序与索引的顺序是相同的，每一个表上上都会有很多索引，但是存储顺序只有一种，Innodb是按照主键索引进行组织表的。</p><p>如果没有主键，那么 Innodb 会优先以第一非空，唯一索引当做主键，在没有非空唯一所以的情况下，MySQL 会生成一个站位6个字节的主键，这个自动生成的主键性能并不是最好的。</p><p>在表的设计中不要使用更新频繁的列作为主键，不使用多列主键（联合索引），因为 Innodb是一个索引组织表的缘故，如果主键频繁被更新，那么久意味着，数据存储的顺序就会频繁的变动，必然会带来大量的 IO 操作。</p><p>不要使用 UUID，MD5，HASH，字符串列作为主键。因为这类数据无法保证数据的顺序增长，如果后面插入的值比已经存在的值还要小，则为了保证索引的顺序，则会把新的数据插入到前面，这样就会造成所有大于这个值的数据要想后移带来大量的 IO 操作。</p><p>建议使用自增 ID 作为主键。</p><h3 id="3-常见索引列建议"><a href="#3-常见索引列建议" class="headerlink" title="3.常见索引列建议"></a>3.常见索引列建议</h3><p>1.SELECT、UPDATE、DELETE语句的WHERE 从句中的列出现的字段中添加索引<br>2.包含在 ORDER BY、GROUP BY、DISTINCT 中的字段<br>3.多表JOIN的关联列</p><h3 id="4-如何选择索引列的顺序"><a href="#4-如何选择索引列的顺序" class="headerlink" title="4.如何选择索引列的顺序"></a>4.如何选择索引列的顺序</h3><p>在联合索引中索引的使用顺序是由从左到右的顺序来使用的。所以我们需要将区分度最高的列放在联合索引的最左侧，尽量把字段长度小的列房子啊联合索引的最左侧，私用最频繁的列放在联合索引的左侧。</p><p>###避免建立冗余索引和重复索引</p><p>重复索引：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">primary key(id)、index(id)、unique index(id)</div></pre></td></tr></table></figure></p><p>冗余索引：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">index(a,b,c) 、index(a,b)、index(a)</div></pre></td></tr></table></figure></p><h3 id="5-对于频繁的查询优先考虑使用覆盖索引"><a href="#5-对于频繁的查询优先考虑使用覆盖索引" class="headerlink" title="5.对于频繁的查询优先考虑使用覆盖索引"></a>5.对于频繁的查询优先考虑使用覆盖索引</h3><p>覆盖索引：就是包含了所有查询字段的索引</p><p>避免 Innodb 表进行索引的二次查找，</p><h2 id="数据库字段设计规范"><a href="#数据库字段设计规范" class="headerlink" title="数据库字段设计规范"></a>数据库字段设计规范</h2><h3 id="1-优先选择符合存储需要的最小的数据类型"><a href="#1-优先选择符合存储需要的最小的数据类型" class="headerlink" title="1.优先选择符合存储需要的最小的数据类型"></a>1.优先选择符合存储需要的最小的数据类型</h3><ul><li>将字符串转换为数字类型存储</li><li>INET_ATON(‘255.255.255.255’) = 4294967295</li><li>INET_NTOA(4294967295) = ‘255.255.255.255’</li><li>对于非负型的数据来说，要有限选用无符号整型来存储，无符号相对于有符号可以多出一倍的存储空间</li><li>VARCHAR（N）中的 N 代表的是字符数，而不是字节数</li><li>使用 UTF8存储汉字 VARCHAR(255)=765个字节</li><li>过大的长度会消耗更多的内存，因为当数据被载入到内存时为了提高效率是按照所定义的类型长度来申请内存的。</li></ul><h3 id="2-避免使用-Text、BLOG-的数据类型"><a href="#2-避免使用-Text、BLOG-的数据类型" class="headerlink" title="2.避免使用 Text、BLOG 的数据类型"></a>2.避免使用 Text、BLOG 的数据类型</h3><p>Text列分为四种 <code>TinyText</code>、<code>Text</code>、<code>MidumText</code>、<code>LongText</code>，<code>Text</code>类型可以存储下64K的数据，备注或者说明很少会使用到64K 这么庞大的数据，使用 Varchar 类型就可以了。另外由于MySQL 内存表是不支持 Text 和 Blog 的，因此我们在对这种大数据类型进行排序的时候无法使用内存表，而必须使用磁盘内置表，这类数据MySQL 在读取数据时会进行二次查询，所以会使得 SQL 的性能变的很差。</p><p>建议把 BLOG 或是 TEXT列分离到单独的扩展表中    ，并且在查询时一定不要使用 select * 的方式，而是取出必要的列，在使用 BOLOG 或者 TEXT 类型的时候就不要查询该列。</p><p>TEXT或 BLOG 类型只能使用前缀索引，并且 TEXT 的列上是不能有默认值的。</p><h3 id="3-避免使用-ENUM-数据类型"><a href="#3-避免使用-ENUM-数据类型" class="headerlink" title="3.避免使用 ENUM 数据类型"></a>3.避免使用 ENUM 数据类型</h3><p>枚举类型是一个很特别的类型，在其他关系型数据库中并不存在这一类型，枚举本身是一个字符串类型，但是其本身却是以整数类型，所以能够存储65535种不同的枚举值，前面提到要将字符串类型转换成整数进行存储，从这一点看枚举是一种很好的数据类型，有助于我们很好的进行优化。</p><p>但是枚举类型也存在着很大的缺陷，修改 ENUM 值需要使用 ALTER 语句，频繁的对表结构进行修改很容易造成失误，在修改元数据的时候会生成元数据锁，在大量数据访问的时候会造成数据库系统的阻塞，对枚举数据进行操作的时候是存在一定的操作风险的。</p><p>ENUM 类型的 ORDER BY 操作效率低，需额外操作，由于是按照整型进行存储的，所以在查询的时候会对其进行字符串转化然后在进行排序，这种装换是无法使用索引的，所以枚举值排序性能比较差。</p><p>禁止使用数值作为 ENUM 的枚举值，因为枚举本身是索引顺序存储的，如果枚举值也是用整型进行存储，很容易会造成逻辑上的一种混淆，一般情况下枚举值是整型，通常建议使用整型代替。</p><h3 id="4-尽量可能把所有列定义为-NOT-NULL"><a href="#4-尽量可能把所有列定义为-NOT-NULL" class="headerlink" title="4.尽量可能把所有列定义为 NOT NULL"></a>4.尽量可能把所有列定义为 NOT NULL</h3><p>索引 NULL 列需要额外的空间来保存，所以需要占用更多的空间，索引空间占用的越低越好。</p><p>进行比较和计算时候对 NULL 值做特别的处理，所以可能会造成索引失效。</p><h3 id="5-使用-TIMESTAMP-或DATETIME-类型存储时间"><a href="#5-使用-TIMESTAMP-或DATETIME-类型存储时间" class="headerlink" title="5.使用 TIMESTAMP 或DATETIME 类型存储时间"></a>5.使用 TIMESTAMP 或DATETIME 类型存储时间</h3><p>字符串存储日期型的数据（不正确的做法）</p><p>缺点1：无法用日期函数进行计算和比较。<br>缺点2：用字符串存储日期要占用更多的空间</p><p>TIMESTAMP 1970-01-01 00：00：01 ~ 2038-01-19 03：14：07</p><p>其实<code>TimeStamp</code>是以 <code>Int</code> 类型存储的，但是以日期格式显示，<code>TimeStamp</code>占用4字节和 INT 相同，但比 <code>Int</code> 可读性高，</p><p>当超出 <code>TimeStamp</code> 类型的存储范围时我们需要使用 <code>DateTime</code> 类型来进行存储。</p><h3 id="6-同财务相关的金额类数据，必须使用-decimal-类型"><a href="#6-同财务相关的金额类数据，必须使用-decimal-类型" class="headerlink" title="6.同财务相关的金额类数据，必须使用 decimal 类型"></a>6.同财务相关的金额类数据，必须使用 decimal 类型</h3><p>Decimal 类型为精准浮点数，在计算时不会丢失精度，占用空间油定义的宽度决定，可用于存储比 bigint 更大的整数数据。</p><h2 id="数据库-SQL-开发规范"><a href="#数据库-SQL-开发规范" class="headerlink" title="数据库 SQL 开发规范"></a>数据库 SQL 开发规范</h2><h3 id="1-建议使用预编译语句进行数据库"><a href="#1-建议使用预编译语句进行数据库" class="headerlink" title="1.建议使用预编译语句进行数据库"></a>1.建议使用预编译语句进行数据库</h3><ol><li>只传参数，比传递 SQL 语句更高效</li><li>相同语句可以一次解析，多次使用，提高处理效率</li><li>防范 SQL 注入的风险</li></ol><h3 id="2-避免数据类型的隐式转换"><a href="#2-避免数据类型的隐式转换" class="headerlink" title="2.避免数据类型的隐式转换"></a>2.避免数据类型的隐式转换</h3><p>隐式转换一般发生在 Where 从句中，当列类型和参数类型不一致时就会出现隐式转换。， 隐式转换会导致索引失效</p><h3 id="3-充分利用表上已经存在的索引"><a href="#3-充分利用表上已经存在的索引" class="headerlink" title="3.充分利用表上已经存在的索引"></a>3.充分利用表上已经存在的索引</h3><p>尽量避免用%号的查询 例如 a like ‘%123%’<br> 一个 SQL 只能利用到符合索引中的一列进行范围查询<br> 使用 left join 活 not exists 来优化 not in 操作。</p><h3 id="4-程序链接不同的数据库使用不同的账号，禁止跨库查询。"><a href="#4-程序链接不同的数据库使用不同的账号，禁止跨库查询。" class="headerlink" title="4.程序链接不同的数据库使用不同的账号，禁止跨库查询。"></a>4.程序链接不同的数据库使用不同的账号，禁止跨库查询。</h3><ol><li>为了数据库迁移和分库分表留出余地</li><li>降低业务耦合度</li><li>避免由于权限过大产生的安全风险</li></ol><h3 id="5-禁止使用-SELECT-必须使用-SELECT-lt-字段列表-gt-查询"><a href="#5-禁止使用-SELECT-必须使用-SELECT-lt-字段列表-gt-查询" class="headerlink" title="5.禁止使用 SELECT *必须使用 SELECT&lt;字段列表&gt;查询"></a>5.禁止使用 SELECT *必须使用 SELECT&lt;字段列表&gt;查询</h3><ol><li>消耗更多的 CPU 和 IO 以及网络带宽资源</li><li>无法使用覆盖索引</li><li>可减少表结构变更带来的影响</li></ol><h3 id="6-禁止使用不含字段列表的-insert-语句"><a href="#6-禁止使用不含字段列表的-insert-语句" class="headerlink" title="6.禁止使用不含字段列表的 insert 语句"></a>6.禁止使用不含字段列表的 insert 语句</h3> <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span> (<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>); //不包含字段列表的 <span class="keyword">insert</span></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t(c1,c2,c3) <span class="keyword">values</span>(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>); //正确的写</div></pre></td></tr></table></figure><p> 可以减少表结构变更带来的影响</p><h3 id="7-避免使用子查询，可以把子查询优化为join"><a href="#7-避免使用子查询，可以把子查询优化为join" class="headerlink" title="7.避免使用子查询，可以把子查询优化为join"></a>7.避免使用子查询，可以把子查询优化为join</h3><p> 并不是所有的子查询都可以使用 join进行优化，一般情况下只有子查询在 IN 子句中，并且子查询是一个简单的 SQL ，例如其中不包含 order by之类的复杂查询，才可以进行转换。</p><ol><li>子查询的结果集无法使用索引</li><li>子查询会产生临时表操作，如果子查询数据量大则严重影响性能</li><li>临时表会消耗过多 CPU 以及 IO 资源</li></ol><h3 id="8-避免使用-JOIN-关联太多的表"><a href="#8-避免使用-JOIN-关联太多的表" class="headerlink" title="8.避免使用 JOIN 关联太多的表"></a>8.避免使用 JOIN 关联太多的表</h3><ol><li>每Join 一个表会占用一部分内存（join <em> buffer </em> size）</li><li>会产生临时表操作，影响查询效率</li><li>MySQL 最多允许关联61个表，建议不超过五个</li></ol><h3 id="9-减少同数据库的交互次数"><a href="#9-减少同数据库的交互次数" class="headerlink" title="9.减少同数据库的交互次数"></a>9.减少同数据库的交互次数</h3><ol><li>数据库更适合处理批量操作</li><li>合并多个相同的操作到一起，可以提高处理效率</li></ol><h3 id="10-使用-in-代替or"><a href="#10-使用-in-代替or" class="headerlink" title="10.使用 in 代替or"></a>10.使用 in 代替or</h3><ol><li>in 的值不要超过500个</li><li>in 操作可以有效的利用索引</li></ol><h3 id="11-禁止使用-order-by-rand-）进行随机排序"><a href="#11-禁止使用-order-by-rand-）进行随机排序" class="headerlink" title="11.禁止使用 order by rand(）进行随机排序"></a>11.禁止使用 order by rand(）进行随机排序</h3><ol><li>会把表中所有符合条件的数据装载到内存中进行排序</li><li>会消耗大量的 CUP 和 IO 以及内存支援</li><li>推荐在程序中获取一个随机值，然后从数据库中获取数据的方式</li></ol><h3 id="12-WHERE-从句中禁止对列进行函数转换和计算"><a href="#12-WHERE-从句中禁止对列进行函数转换和计算" class="headerlink" title="12.WHERE 从句中禁止对列进行函数转换和计算"></a>12.WHERE 从句中禁止对列进行函数转换和计算</h3><ol><li>对列进行函数转换或计算会导致无法使用索引</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">where date(createtime) = '20160901'</div><div class="line">where createtime &gt;= '20160901' and createtime&lt; '20160902'</div></pre></td></tr></table></figure><h3 id="13-有明显不会重复值时使用-UNION-ALL-而不是UNION"><a href="#13-有明显不会重复值时使用-UNION-ALL-而不是UNION" class="headerlink" title="13.有明显不会重复值时使用 UNION ALL 而不是UNION"></a>13.有明显不会重复值时使用 UNION ALL 而不是UNION</h3><ol><li>UNION 会把所有数据放到临时表中然后进行去重操作</li><li>UNION ALL 不会对结果集进行去重操作</li></ol><h3 id="14-拆分复杂的大-SQL-为多个小-SQL"><a href="#14-拆分复杂的大-SQL-为多个小-SQL" class="headerlink" title="14.拆分复杂的大 SQL 为多个小 SQL"></a>14.拆分复杂的大 SQL 为多个小 SQL</h3><ol><li>MySQL 一个 SQL 只能使用一个 CPU进行计算</li><li>SQL 拆分后可以进行并行执行来提高处理效率</li></ol><h2 id="数据库操作行为规范"><a href="#数据库操作行为规范" class="headerlink" title="数据库操作行为规范"></a>数据库操作行为规范</h2><h3 id="1-超100万行的批量写操作，需分批多次进行操作"><a href="#1-超100万行的批量写操作，需分批多次进行操作" class="headerlink" title="1.超100万行的批量写操作，需分批多次进行操作"></a>1.超100万行的批量写操作，需分批多次进行操作</h3><ol><li>大批量操作可能会造成严重的主从延迟</li><li>binlog 日志为row 格式时会产生大量的日志</li><li>避免产生大事务操作</li></ol><h3 id="2-对大表数据结构的修改一定要谨慎，会造成严重的锁表操作。尤其是生产环境，是不能忍受的。"><a href="#2-对大表数据结构的修改一定要谨慎，会造成严重的锁表操作。尤其是生产环境，是不能忍受的。" class="headerlink" title="2.对大表数据结构的修改一定要谨慎，会造成严重的锁表操作。尤其是生产环境，是不能忍受的。"></a>2.对大表数据结构的修改一定要谨慎，会造成严重的锁表操作。尤其是生产环境，是不能忍受的。</h3><p>对于大表使用 pt-online-schema-change 修改表结构，可以避免主从延时、表锁的问题。</p><h3 id="3-禁止为程序使用的账户赋予-super-权限"><a href="#3-禁止为程序使用的账户赋予-super-权限" class="headerlink" title="3.禁止为程序使用的账户赋予 super 权限"></a>3.禁止为程序使用的账户赋予 super 权限</h3><ol><li>当达到最大连接数贤之士，MySQL 允许1个有 super 权限的用户连接</li><li>super 权限只能留给 DBA 处理问题的账户使用</li></ol><h3 id="4-对于程序链接数据库账户，遵循权限最小原则"><a href="#4-对于程序链接数据库账户，遵循权限最小原则" class="headerlink" title="4.对于程序链接数据库账户，遵循权限最小原则"></a>4.对于程序链接数据库账户，遵循权限最小原则</h3><ol><li>程序使用数据库账号只能在一个 DB下使用，不准夸库</li><li>程序使用账号原则上不准有 drop权限</li></ol>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL 设计规范 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>利用规约设计模式（Specification）开发整洁的规格校验（PHP 语言描述）</title>
      <link href="/2017/06/01/cjjrthles002oc7rdjg7bel4d/"/>
      <content type="html"><![CDATA[<p>规格校验是使我们在日常的开发过程中中比较常见的一种业务需求，最直观的使用是我们在开发电商类网站时我们会对商品的一些规格进行限定，例如重量大小不能超过 N（kg） 。</p><p>如果是一个刚刚加入业界的程序员，很有可能会编写出大量的<code>if</code>语句来进行解决此类的业务逻辑，这样编码可行吗？</p><p>答案是可以，因为顺利的完成了业务逻辑代码的编写任务，但是却违反了类设计中的<code>开闭原则</code>，而且一看就是没有经过正规的训练，没有对于 OOP 编程有更深的了解。</p><p>那么有没有一种设计模式可以让我们设计出优雅而又整洁的逻辑代码呢，答案是显而易见的，要不然也就不会出现这篇文章，它就是——规模设计模式。</p><p>我们可以利用规约模式来解决这一实际问题，开发出优雅而又健全的业务逻辑代码。</p><p>规约设计模式的主要设计目的就是为了生成业务规则的明确规范，通过<code>isSatisfiedBy</code>方法来检测对象是否符合规范。</p><p>下图是规约模式 UML 类图（不懂的同学推荐去看由谭云杰所编写的《大象：Thinking in UML》）</p><p><img src="http://designpatternsphp.readthedocs.io/zh_CN/latest/_images/uml7.png" alt=""></p><p>即使看不懂 UML 类图也没有关系，编码能力的提高是要根据不断的实践才能有所增长的。当你顺着我的思路打完代码，你就已经可以明白规约设计模式的设计理念以及作用。</p><p>当然我还是要解释一下这个类图所代表的含义。</p><p>既然是规格校验，那么一个规格校验到底包括什么呢？</p><p>一般而言主要有：区间、大于、小于、不等于，这几样，那么我们是不是可以将其抽象成一个类呢？</p><p>这就是上面那张 UML 的简单含义，其中主要是用于描述其类的关系，UML 就是帮助我们对类进行抽象的一个工具。</p><p>下面让我们撸起袖子打代码。首先我们应该新建了 Goods类用于表示被规约的产品，其中包含一个 Price 价格属性，然后在建立对 Price 属性的规约，用来检验最新实例化的 Goods 是否满足约定。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//商品类</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> float</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> $price;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $price)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;price = $price;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span><span class="params">()</span>: <span class="title">float</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;price;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在建立规约之前，我们需要建立一个接口，这个接口中定了了一个方法<code>isSatisfiedBy</code>,也就是上文提到的那个检测对象是否满足规约条件的那个方法。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SpecificationInterface</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Goods $goods)</span>: <span class="title">bool</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Ok，在我们编写其余代码之前，我们需要来做一个思考，在程序语言当中，判断条件中的操作符是不是有或、与、非这三个判断条件，对应着 ||、&amp;&amp;、！。</p><p>那么我们是否可以将其抽象成一个又一个的类呢？</p><p>OrSpecification规约用来表示 Or 的关系，与我们的逻辑判断一样，表示在两个规约之间只要满足一条便返回 true。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrSpecification</span> <span class="keyword">implements</span> <span class="title">SpecificationInterface</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> SpecificationInterface[]</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> $specifications;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> SpecificationInterface[] ...$specifications</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SpecificationInterface ...$specifications)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;specifications = $specifications;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * if at least one specification is true, return true, else return false</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span>: <span class="title">bool</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;specifications <span class="keyword">as</span> $specification) &#123;</div><div class="line">            <span class="keyword">if</span> ($specification-&gt;isSatisfiedBy($item)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>AndSpecification 用于表示 And 关系，两条以上规约时，必须都满足条件才会返回 true否则返回false.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndSpecification</span> <span class="keyword">implements</span> <span class="title">SpecificationInterface</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> SpecificationInterface[]</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> $specifications;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> SpecificationInterface[] ...$specifications</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SpecificationInterface ...$specifications)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;specifications = $specifications;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * if at least one specification is false, return false, else return true.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span>: <span class="title">bool</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;specifications <span class="keyword">as</span> $specification) &#123;</div><div class="line">            <span class="keyword">if</span> (!$specification-&gt;isSatisfiedBy($item)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>NotSpecification.php 用于表示Not。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotSpecification</span> <span class="keyword">implements</span> <span class="title">SpecificationInterface</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> SpecificationInterface</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> $specification;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SpecificationInterface $specification)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;specification = $specification;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span>: <span class="title">bool</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;specification-&gt;isSatisfiedBy($item);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>逻辑判断抽编码好了之后，我们就要开始真正的规约了，我们建立一个 Price 规约，其中主要设定了 Price 的范围，构造函数中包含最大值与最小值，并且实现<code>isSatisfiedBy</code>用来判断输入的值是否符合范围。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PriceSpecification</span> <span class="keyword">implements</span> <span class="title">SpecificationInterface</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> float|null</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> $maxPrice;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> float|null</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> $minPrice;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> float $minPrice</div><div class="line">     * <span class="doctag">@param</span> float $maxPrice</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($minPrice, $maxPrice)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;minPrice = $minPrice;</div><div class="line">        <span class="keyword">$this</span>-&gt;maxPrice = $maxPrice;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span>: <span class="title">bool</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;maxPrice !== <span class="keyword">null</span> &amp;&amp; $item-&gt;getPrice() &gt; <span class="keyword">$this</span>-&gt;maxPrice) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;minPrice !== <span class="keyword">null</span> &amp;&amp; $item-&gt;getPrice() &lt; <span class="keyword">$this</span>-&gt;minPrice) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>下面我们进行单元测试，如果不懂单元测试的朋友，也可以直接使用上面的代码进行测试。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">Tests</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">Item</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">NotSpecification</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">OrSpecification</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">AndSpecification</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">PriceSpecification</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpecificationTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanOr</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $spec1 = <span class="keyword">new</span> PriceSpecification(<span class="number">50</span>, <span class="number">99</span>);</div><div class="line">        $spec2 = <span class="keyword">new</span> PriceSpecification(<span class="number">101</span>, <span class="number">200</span>);</div><div class="line"></div><div class="line">        $orSpec = <span class="keyword">new</span> OrSpecification($spec1, $spec2);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertFalse($orSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">100</span>)));</div><div class="line">        <span class="keyword">$this</span>-&gt;assertTrue($orSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">51</span>)));</div><div class="line">        <span class="keyword">$this</span>-&gt;assertTrue($orSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">150</span>)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanAnd</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $spec1 = <span class="keyword">new</span> PriceSpecification(<span class="number">50</span>, <span class="number">100</span>);</div><div class="line">        $spec2 = <span class="keyword">new</span> PriceSpecification(<span class="number">80</span>, <span class="number">200</span>);</div><div class="line"></div><div class="line">        $andSpec = <span class="keyword">new</span> AndSpecification($spec1, $spec2);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertFalse($andSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">150</span>)));</div><div class="line">        <span class="keyword">$this</span>-&gt;assertFalse($andSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">1</span>)));</div><div class="line">        <span class="keyword">$this</span>-&gt;assertFalse($andSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">51</span>)));</div><div class="line">        <span class="keyword">$this</span>-&gt;assertTrue($andSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">100</span>)));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanNot</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $spec1 = <span class="keyword">new</span> PriceSpecification(<span class="number">50</span>, <span class="number">100</span>);</div><div class="line">        $notSpec = <span class="keyword">new</span> NotSpecification($spec1);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertTrue($notSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">150</span>)));</div><div class="line">        <span class="keyword">$this</span>-&gt;assertFalse($notSpec-&gt;isSatisfiedBy(<span class="keyword">new</span> Item(<span class="number">50</span>)));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样一来，我们就设计出了优雅而又健壮的代码。</p><p>说明：</p><p>本文章代码，来自于 Github 开源项目，点击链接进入查看<a href="http://designpatternsphp.readthedocs.io/" target="_blank" rel="noopener">http://designpatternsphp.readthedocs.io/</a></p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>在MYSQL中进行日期操作</title>
      <link href="/2017/04/08/1/"/>
      <content type="html"><![CDATA[<p>平时比较常用的时间、字符串、时间戳之间的互相转换，虽然常用但是几乎每次使用时候都喜欢去搜索一下用法；本文将作为一个笔记，整理一下三者之间的 转换（即：date转字符串、date转时间戳、字符串转date、字符串转时间戳、时间戳转date，时间戳转字符串）用法，方便日后查看；</p><h2 id="涉及的函数"><a href="#涉及的函数" class="headerlink" title="涉及的函数"></a>涉及的函数</h2><p>date_format(date, format) 函数MySQL日期格式化函数date_format()</p><p>str_to_date(str, format) 函数 把字符串转换为日期</p><p>from_unixtime(unix_timestamp, format) 函数，MySQL时间戳格式化函数from_unixtime</p><h2 id="时间转换"><a href="#时间转换" class="headerlink" title="时间转换"></a>时间转换</h2><h3 id="时间转字符串"><a href="#时间转字符串" class="headerlink" title="时间转字符串"></a>时间转字符串</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select date_format(now(), '%Y-%m-%d');   #结果：2016-01-05</div></pre></td></tr></table></figure><h3 id="时间转时间戳"><a href="#时间转时间戳" class="headerlink" title="时间转时间戳"></a>时间转时间戳</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select unix_timestamp(now());  #结果：1452001082</div></pre></td></tr></table></figure><h3 id="字符串转时间"><a href="#字符串转时间" class="headerlink" title="字符串转时间"></a>字符串转时间</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select str_to_date('2016-01-02', '%Y-%m-%d %H');  #结果：2016-01-02 00:00:00</div></pre></td></tr></table></figure><h3 id="字符串转时间戳"><a href="#字符串转时间戳" class="headerlink" title="字符串转时间戳"></a>字符串转时间戳</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select unix_timestamp('2016-01-02');  #结果：1451664000</div></pre></td></tr></table></figure><h3 id="时间戳转时间"><a href="#时间戳转时间" class="headerlink" title="时间戳转时间"></a>时间戳转时间</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select from_unixtime(1451997924);  #结果：2016-01-05 20:45:24</div></pre></td></tr></table></figure><h3 id="时间戳转字符串"><a href="#时间戳转字符串" class="headerlink" title="时间戳转字符串"></a>时间戳转字符串</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select from_unixtime(1451997924,'%Y-%d');  #结果：2016-01-05 20:45:24</div></pre></td></tr></table></figure><h2 id="附表"><a href="#附表" class="headerlink" title="附表"></a>附表</h2><p>MySQL日期格式化（format）取值范围。</p><table><thead><tr><th></th><th>值</th><th>含义</th></tr></thead><tbody><tr><td>秒</td><td>%S、%s</td><td>两位数字形式的秒（ 00,01, …, 59）</td></tr><tr><td>分</td><td>%I、%i</td><td>两位数字形式的分（ 00,01, …, 59）</td></tr><tr><td>小时</td><td>%H</td><td>24小时制，两位数形式小时（00,01, …,23）</td></tr><tr><td>%h</td><td>12小时制，两位数形式小时（00,01, …,12）</td><td></td></tr><tr><td>%k</td><td>24小时制，数形式小时（0,1, …,23）</td><td></td></tr><tr><td>%l</td><td>12小时制，数形式小时（0,1, …,12）</td><td></td></tr><tr><td>%T</td><td>24小时制，时间形式（HH:mm:ss）</td><td></td></tr><tr><td>%r</td><td>12小时制，时间形式（hh:mm:ss AM 或 PM）</td><td></td></tr><tr><td>%p</td><td>AM上午或PM下午</td><td></td></tr><tr><td>周</td><td>%W</td><td>一周中每一天的名称（Sunday,Monday, …,Saturday）</td></tr><tr><td>%a</td><td>一周中每一天名称的缩写（Sun,Mon, …,Sat）</td><td></td></tr><tr><td>%w</td><td>以数字形式标识周（0=Sunday,1=Monday, …,6=Saturday）</td><td></td></tr><tr><td>%U</td><td>数字表示周数，星期天为周中第一天</td><td></td></tr><tr><td>%u</td><td>数字表示周数，星期一为周中第一天</td><td></td></tr><tr><td>天</td><td>%d</td><td>两位数字表示月中天数（01,02, …,31）</td></tr><tr><td>%e</td><td>数字表示月中天数（1,2, …,31）</td><td></td></tr><tr><td>%D</td><td>英文后缀表示月中天数（1st,2nd,3rd …）</td><td></td></tr><tr><td>%j</td><td>以三位数字表示年中天数（001,002, …,366）</td><td></td></tr><tr><td>月</td><td>%M</td><td>英文月名（January,February, …,December）</td></tr><tr><td>%b</td><td>英文缩写月名（Jan,Feb, …,Dec）</td><td></td></tr><tr><td>%m</td><td>两位数字表示月份（01,02, …,12）</td><td></td></tr><tr><td>%c</td><td>数字表示月份（1,2, …,12）</td><td></td></tr><tr><td>年</td><td>%Y</td><td>四位数字表示的年份（2015,2016…）</td></tr><tr><td>%y</td><td>两位数字表示的年份（15,16…）</td><td></td></tr><tr><td>文字输出</td><td>%文字</td><td>直接输出文字内容</td></tr></tbody></table>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP Closures</title>
      <link href="/2017/03/15/cjjrthlen002hc7rdkaaqv29w/"/>
      <content type="html"><![CDATA[<p>闭包函数（closures）也就做匿名函数（Anonymous functions），是指在创建时封装周围状态的函数。即便闭包所在的环境不存在了，闭包中封装的状态依然存在。</p><blockquote><p>理论上，闭包和匿名函数是不同的概念，不过 PHP 将其视作相同的概念，所以闭包与匿名函数相等。</p></blockquote><p>匿名函数其实就是没有名字的函数。匿名函数可以赋值给变量，还能像其他任何 PHP 对象那样传递。不过匿名函数仍然是函数，因此可以调用，还可以传入参数。匿名函数特别适合作为函数或方法的回调。</p><h3 id="创建闭包"><a href="#创建闭包" class="headerlink" title="创建闭包"></a>创建闭包</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$closure = <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sprintf(<span class="string">'Hello %s'</span>, $name);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">echo</span> $closure(<span class="string">'Maksim'</span>);</div><div class="line"><span class="comment">//输出 Hello Maksim</span></div></pre></td></tr></table></figure><p>创建一个闭包对象，然后将其复制给<code>$closure</code> 变量。闭包和普通的 PHP 函数很想：使用语句相同，也接受参数，而且能返回值。不过，匿名函数没有名称。</p><p>我们通常把 PHP 闭包当做函数和方法的回调使用。很多 PHP 函数都会用到回调函数，例如 <code>array_map()</code>和 <code>preg_replace_callback()</code>。这是使用 PHP 匿名函数的最佳时机！</p><p>记住，闭包和其他值一样，可以作为参数传入其他 PHP 函数，我们把一个闭包对象当做回调参数，传给 array_map()函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$numbersPlusOne = array_map(<span class="function"><span class="keyword">function</span> <span class="params">($number)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> $number + <span class="number">1</span>;</div><div class="line">&#125;,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</div><div class="line">print_r($numbersPlusOne);</div><div class="line"><span class="comment">//([0] =&gt; 2 [1] =&gt; 3 [2] =&gt; 4)</span></div></pre></td></tr></table></figure><p>在闭包出现之前，PHP 开发者只能单独创建普通函数，然后使用名称引用那个函数，这么做，代码执行的稍微慢一点，而且把回调场景和使用场景分割开了，如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$numbersPlusOne = array_map(<span class="string">'incrementNumber'</span>,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">incrementNumber</span><span class="params">($number)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> $number + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line">print_r($numbersPlusOne);</div><div class="line"><span class="comment">//([0] =&gt; 2 [1] =&gt; 3 [2] =&gt; 4)</span></div></pre></td></tr></table></figure><p>这样的代码虽然可用，但是没有使用闭包来的间接。如果只需要使用一次回调，没有必要单独定义具名函数。把闭包当做回调使用，写出的代码更加简洁、清晰。</p><h3 id="使用附加状态"><a href="#使用附加状态" class="headerlink" title="使用附加状态"></a>使用附加状态</h3><p>前面演示了如何把匿名函数当做回调使用，下面探讨如何为 PHP 闭包附加兵封装状态。JavaScript 开发者可能对 PHP 的闭包感到奇怪，因为 PHP 闭包不会像真正的 JavaScript 闭包那样自动封装应用状态。在 PHP 中，必须手动调用闭包对象的 bindTo()方法或者使用 use 关键字，把状态附加到 PHP 闭包上。</p><p>使用 use 关键字附加闭包状态常见得多，因此我们先看这种方式。使用 use 关键字把变量附加到闭包上时，附加的变量会记住附加时赋给它的值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">enclosePerson</span><span class="params">($name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($doCommand)</span> <span class="title">use</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sprintf(<span class="string">'%s, %s'</span>, $name, $doCommand);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//把字符串“Maksim”封装在闭包中</span></div><div class="line">$clay = enclosePerson(<span class="string">'Clay'</span>);</div><div class="line"></div><div class="line"><span class="comment">//掺入参数，调用闭包</span></div><div class="line"><span class="keyword">echo</span> $clay(<span class="string">'get sweet tea'</span>);</div><div class="line"><span class="comment">// Clay, get sweet tea</span></div></pre></td></tr></table></figure><blockquote><p>使用 use 关键字可以把多个参数传入闭包，此时要像 PHP 函数或者方法的参数一样，使用逗号分割多个参数</p></blockquote><p>PHP 闭包是对象。与其他 PHP 对象类似，每个闭包实例都可以使用$this 关键字获取闭包的内部状态。闭包对象的默认状态没什么用，不过有一个__invoke()魔术方法和 bindTo()方法，仅此而已。</p><p>但是，bindTo()方法为闭包增加了一些有趣的潜力。我们可以把使用这个方法把 Closure 对象的内部状态绑定到其他对象上。bindTo()方法的第二个参数很重要，其作用是指定绑定闭包的那个对象所属的 PHP 类。因此闭包可以访问绑定闭包的对象中受保护和私有的成员变量。</p><p>你会发现，PHP 框架经常使用 bindTo()方法把路由 URL 映射到匿名回调函数上。框架会把匿名函数绑定到应用对象上，这么做可以把这个匿名函数中使用$this 关键字引用重要的应用对象。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">protected</span> $routes = <span class="keyword">array</span>();</div><div class="line">    <span class="keyword">protected</span> $responseStatus = <span class="string">'200 Ok'</span>;</div><div class="line">    <span class="keyword">protected</span> $responseContentType = <span class="string">'text/html'</span>;</div><div class="line">    <span class="keyword">protected</span> $responseBody = <span class="string">'Hello world'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span><span class="params">($routePath, $routeCallback)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;routes[$routePath] = $routeCallback-&gt;bindTo(<span class="keyword">$this</span>,<span class="keyword">__CLASS__</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">($currentPath)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;routes <span class="keyword">as</span> $routePath =&gt; $callback) &#123;</div><div class="line">            <span class="keyword">if</span> ($currentPath === $currentPath) &#123;</div><div class="line">                $callback();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        header(<span class="string">'HTTP/1.1 '</span>. <span class="keyword">$this</span>-&gt;responseStatus);</div><div class="line">        header(<span class="string">'Content-type: '</span> . <span class="keyword">$this</span>-&gt;responseContentType);</div><div class="line">        header(<span class="string">'Content-length: '</span> . mb_strlen(<span class="keyword">$this</span>-&gt;responseBody));</div><div class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;responseBody;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p> 我们要特别注意 addRoute（）方法。这个方法的参数分别是一个路由路径（例如/users/josh）和一个路由回调。dispatch()方法的参数是当前 HTTP 请求的路径，它调用匹配的路由回调。第10行是重点所在，我们把路由回调绑定到了当前 APP 实例上。这么做能够在回调函数中处理 APP 实例的状态。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$app =  <span class="keyword">new</span> App();</div><div class="line">$app-&gt;addRoute(<span class="string">'/users/josh'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;responseContentType = <span class="string">'application/json;charset=utf8'</span>;</div><div class="line">    <span class="keyword">$this</span>-&gt;responseBody = <span class="string">'&#123;"name":"json"&#125;'</span>;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$app-&gt;dispatch(<span class="string">'/users/josh'</span>);</div></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li>现代 PHP</li><li>官方手册</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Closures </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用 Vagrant 统一公司内开发环境</title>
      <link href="/2016/12/13/cjjrthlel002dc7rdpob401il/"/>
      <content type="html"><![CDATA[<p><strong>Vagrant 是什么?</strong></p><p>简单地说，Vagrant让我们可以通过代码的方式快速地、可重复地创建针对不同虚拟环境的虚拟机，包括Virtualbox、AWS、Docker等。它使得我们可以一次性地、自动创建多个环境相同的虚拟机，对于软件开发和测试尤其有用。本文我们将以Virtualbox为例，看看Vagrant的基本使用。</p><p><strong>Vagrantd的作用?</strong></p><ul><li>统一开发环境。一次配置打包，统一分发给团队成员，统一团队开发环境，解决诸如“编码问题”，“缺少模块”，“配置文件不同”带来的问题；</li><li>避免重复搭建开发环境。新员工加入，不用浪费时间搭建开发环境，快速加入开发，减少时间成本的浪费；</li><li>多个相互隔离开发环境。可以在不用box里跑不同的语言，或者编译安装同一语言不同版本，搭建多个相互隔离的开发环境，卸载清除时也很快捷轻松。</li></ul><p><strong>Vagrant 适用范围</strong></p><ul><li>开发环境</li><li><p>项目配置比较复杂</p><p><strong>官网：</strong><a href="https://www.vagrantup.com/" target="_blank" rel="noopener">https://www.vagrantup.com/</a></p><p>vagrant与 VirtualBox的版本需要注意匹配，在官网有详细介绍，如果版本不匹配会出现一些错误。</p></li></ul><p><strong>常用命令</strong></p><ul><li>vagrant box list 查看目前已有的box</li><li>vagrant box add 新增加一个box</li><li>vagrant box remove 删除指定box</li><li>vagrant init 初始化</li><li>vagrant up 启动虚拟机</li><li>vagrant ssh SSH 登陆虚拟机</li><li>vagrant suspend 挂起虚拟机</li><li>vagrant reload 重启虚拟机</li><li>vagrant halt 关闭虚拟机</li><li>vagrant status 查看虚拟机运行状态</li><li>vagrant destroy 销毁当前虚拟机</li></ul>]]></content>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用策略模式敲开设计模式的大门(PHP语言描述)</title>
      <link href="/2016/09/23/108/"/>
      <content type="html"><![CDATA[<blockquote><p>设计模式（Design pattern）是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结。使用设计模式是为了可重用代码、让代码更容易被他人理解、保证代码可靠性。 毫无疑问，设计模式于己于他人于系统都是多赢的；设计模式使代码编制真正工程化；设计模式是软件工程的基石脉络，如同大厦的结构一样。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ul><li><p>本系列文章不会直接上代码直接进行解释，我一直认为带着问题来学习是效率最高的学习方式。</p></li><li><p>本系列文章不会有演示截图，你为什么不敲一遍加深印象呢，另外说不定我的代码有错。</p></li><li><p>我所写的文章只是我对于编程的理解，如果有错误希望能够得到指正以免误人子弟。</p></li></ul><h2 id="怎么样才可以进行设计模式的学习"><a href="#怎么样才可以进行设计模式的学习" class="headerlink" title="怎么样才可以进行设计模式的学习"></a>怎么样才可以进行设计模式的学习</h2><p>步子迈大了容易扯到蛋，如果在没有熟悉 OOP 编程思想前就开始学习设计模式，我感觉会有两种可能，不是“扯蛋”，就是“拉跨”。</p><p><img src="http://wanzao2.b0.upaiyun.com/system/pictures/17809564/original/5a08021694a003ca.gif" alt=""></p><p>当然上面的话是一句玩笑话，学习设计模式可以有效的提高我们的代码质量与深入的理解 OOP 编程理念，如但是果在没有扎实的功底（至少要要理解了抽象、接口、多态）前就开始学习设计模式会越学越难，脑子越来越浑，那就真变成了从入门到放弃了，因为你的思维还没有真正的走进 OOP(单身狗表示完全无法面向对象^_^)。</p><p>对于设计模式的不理解我感觉主要分为两种，一种是不知道怎么实现的，原因就是如上所述，另外一种是不知道为什么要这么用的，其实没有必要纠结于为什么这么用，这么用了有啥作用，设计模式不过是与算法一样只是为了实现某个特定环境下可以使用的一种更好的选择。</p><p>更好一点的例子就是当我们对一些数据进行排序的时候，我们首先想到就是那几个排序算法一样，当我们打着打着代码突然灵光一闪，好像这个地方用这个设计模式写起来会轻松一点。</p><p>当碰到不懂得地方，思考一下，想不通，就出去走走，把这个东西放下来，反正就算看到第二天凌晨也也是无用的，当真正遇到问题的时候，灵光一闪这个东西可以这么写，然后去实践，这就是我的学习之道。还有就是尽量去学实例，而不是去死扣概念，当你真正用起来了，你也就差不多懂了，算法与数据结构亦是如此。</p><p>本系列文章尽量以推导的形式来进行书写，而不是以现成的代码来进行讲解，让读者知道设计模式是怎么来的也就是如何演化出来的，希望各位能够喜欢。<strong>另外本系列的文章并不会提供运行界面的截图，如果想看看结果是否正确，为什么不自己试试呢？</strong></p><h2 id="设计模式尝鲜（策略模式）"><a href="#设计模式尝鲜（策略模式）" class="headerlink" title="设计模式尝鲜（策略模式）"></a>设计模式尝鲜（策略模式）</h2><p>开头引用的话来自于百度百科，我相信很多刚刚开始接触编程的人都会犯晕，因为所有人都不喜欢被学术化的文字，我们以设计模式中较为常用的策略模式来进行演示，当我们编写一个广告模块的时候，公司给的要求是根据访问者的性别来进行显示广告以提高转化率，那我们应该怎么写呢？</p><p><img src="https://ss0.bdstatic.com/94oJfD_bAAcT8t7mm9GUKT-xh_/timg?image&amp;quality=100&amp;size=b4000_4000&amp;sec=1474639306&amp;di=8cd977b3c8e7d09c8a22672b95423266&amp;src=http://img01.taopic.com/151015/234716-15101509225378.jpg" alt=""></p><p>首先我们想到的是在每一个广告位上面都使用 if 判断来判断访客的性别，这样就能够解决这样的需求，那么我们的每一个广告代码的代码块可能是这个样子的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">判断 男 <span class="keyword">or</span> 女&#123;</div><div class="line">如果是男的就是男人的广告</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">显示女人的广告</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>既然伪代码想好了，那么我们就可以着手进行开发了，然后我们在 if 代码块中添加各自的家在广告代码，于是就变成了下面的样子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($_GET[<span class="string">'sex'</span>] == <span class="string">'man'</span>) &#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'外星人大减价现在购买立即送电竞瑞文皮肤'</span>;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'卡西欧美颜相机不要钱免费送！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>但是这是属于一种硬编码的编程方式，一旦我们增加了某种需求，要求其年龄大于23岁显示什么样的广告，那么我们就不得不在每一个 if 判断处再加上新的判断条件，这样的设计就是不合理的，为了提高可读性与可维护性，我们会考虑建立两个不同的类来对两个广告类来对其进行管理。于是代码变成了下面的样子。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//index.php</span></div><div class="line"><span class="keyword">include</span> <span class="string">'GenderAD.php'</span>;</div><div class="line"><span class="keyword">include</span> <span class="string">'ManAD.php'</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($_GET[<span class="string">'sex'</span>] == <span class="string">'man'</span>) &#123;</div><div class="line">$ad = <span class="keyword">new</span> ManAD();</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">$ad = <span class="keyword">new</span> GenderAD();</div><div class="line">&#125;</div><div class="line">$ad-&gt;show();</div><div class="line"></div><div class="line"><span class="comment">//GenderAD.php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenderAD</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span> algorithm()&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'卡西欧美颜相机不要钱免费送！'</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ManAD.php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManAD</span></span>&#123;</div><div class="line"><span class="keyword">public</span> algorithm()&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'外星人大减价现在购买立即送电竞瑞文皮肤'</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><blockquote><p>algorithm    英[ˈælgərɪðəm] 美[ˈælɡəˌrɪðəm] n.    演算法; 运算法则; 计算程序;</p></blockquote><p>其实到了这一步就已经算是一个简单的策略模式了，因为他已经具有策略的特质了，只不过还不够完善，如果说这不算什么的话我也没有办法，因为所有的设计模式其实都是思维模式与表现形式罢了，就像上面的引用中提到的一样，设计模式只不过是为了能够让代码可以重用，更容易他让人理解，因为你的代码并不是你一个人在维护，那么问题来了，只是简单的对其进行封装真的就提高代码的可维护性了么，其实并没有，我们还没有将 OOP 的设计概念发挥到极致。</p><p>经过分析我们发现其实 ManAD类和 GenderAD最终都要进行显示，他们的方法的显示方法都是 show，如果是你一个人在开发那么没有什么问题，可是若是两个人开发呢，你们可以直接可以对话的方式进行沟通，协定好都是 show方法来显示，可是为什么不用更工程化的方式来实现呢？</p><p>我们可以使用接口来实现这一目的，如果对接口还不了解，可以去查阅一下资料，很快你就能够明白，在本文结束后我会在下方标注出参考范例。</p><p>我们可以新建一个接口来对这些策略进行控制。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ADinterface</span></span>&#123;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManAD</span> <span class="keyword">implements</span> <span class="title">ADInterface</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'外星人大减价现在购买立即送电竞瑞文皮肤'</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenderAD</span> <span class="keyword">implements</span> <span class="title">ADInterface</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'卡西欧美颜相机不要钱免费送！'</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样一来广告策略必须遵循这个接口进行开发，就保证了所有策略类都需要实现 show 方法。</p><p>到目前为止，策略模式已经相对的完善了，但是还是不够完美，因为代码依旧并不是很 OOP，我们其实还可以更进一步，让他更 OOP，我们可以对那些策略外面套一个壳子，给外面一个选择器。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StrategySelect</span> </span>&#123;</div><div class="line"><span class="comment">//具体策略对象</span></div><div class="line">    <span class="keyword">private</span> $strategyInstance;</div><div class="line">    </div><div class="line">    <span class="comment">//构造函数</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($instance)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;strategyInstance = $instance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">($strategy)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strategyInstance-&gt;algorithm();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>我们通过构造函数接收到具体的执行策略，然后使用algorithm()执行相对应的策略。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ADinterface</span></span>&#123;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StrategySelect</span> </span>&#123;</div><div class="line"><span class="comment">//具体策略对象</span></div><div class="line">    <span class="keyword">private</span> $strategyInstance;</div><div class="line">    </div><div class="line">    <span class="comment">//构造函数</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($instance)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;strategyInstance = $instance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strategyInstance-&gt;algorithm();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManAD</span> <span class="keyword">implements</span> <span class="title">ADInterface</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'外星人大减价现在购买立即送电竞瑞文皮肤'</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenderAD</span> <span class="keyword">implements</span> <span class="title">ADInterface</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">algorithm</span><span class="params">()</span></span>&#123;</div><div class="line"><span class="keyword">echo</span> <span class="string">'卡西欧相机免费赠送啦'</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">header(<span class="string">"Content-type:text/html;charset=utf-8"</span>);</div><div class="line"><span class="keyword">if</span> ($_GET[<span class="string">'sex'</span>] == <span class="string">'man'</span>) &#123;</div><div class="line">$stratey = <span class="keyword">new</span> StrategySelect(<span class="keyword">new</span> ManAD());</div><div class="line">$stratey-&gt;algorithm();</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">$stratey = <span class="keyword">new</span> StrategySelect(<span class="keyword">new</span> GenderAD());</div><div class="line">$stratey-&gt;algorithm();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Strategy其实算是一个策略选择器，当满足一定条件的时候，我们通过这个策略选测器来进行选择相对应的策略。这样一来更符合逻辑。是不是很 OOP？</p><p>如果有什么不懂得可以在评论区进行留言，有时间我会一一答复，如果发现本文中有什么错误请指出，我也害怕误人子弟，特别是概念上的东西，在最后StrategySelect类的讲解上我依旧感觉写的很模糊，有些差强人意。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><p>《Leaning PHP Design Patterns》 William Sanders 著 苏金国 王宇飞等译</p></li><li><p>《PHP之道》</p></li><li><p>《PHP大话设计模式》 Rango(韩天峰) 录制者 慕课网视频教程</p></li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用 Feedly RSS阅读器订阅技术大牛的博客</title>
      <link href="/2016/05/08/cjjrthleg0023c7rd1mx6yhd5/"/>
      <content type="html"><![CDATA[<p>这几天一直都在自己看书，可是书上面的东西都比较落后一点，而且没有大牛博文上的东西讲的深入，可是来回跳转各位大牛的博客又非常的麻烦，有一些公众账号虽然也会推荐一些知识内容，可是你应该有过看到多个公众号发一篇博文的经历吧。</p><p>这个时候我想起了一个叫做 RSS 订阅的一个功能，可是国产的RSS 订阅器的 UI 是一个很大的槽点，而且功能相对于臃肿，很多功能都用不到，最终选择了 Feedly 这款 APP，UI 清爽，功能简单，完全符合我的需要，而且还支持 OPML 导入。</p><p>AirCrayon 是一名 iOS 程序员，所以我订阅的大多都是 iOS 的技术大牛，大牛唐巧一直在维护一个中文博文列表的项目地：<a href="https://github.com/tangqiaoboy/iOSBlogCN" target="_blank" rel="noopener">https://github.com/tangqiaoboy/iOSBlogCN</a></p><a id="more"></a><p>在其中为广大 iOS 程序员提供了一个OPML 文件，将其文件下载来进入Feedly 的官网。</p><p>没有账户的同学请先注册账户，虽然是英文的但是一般都应该能看的懂，也就不做注册介绍了。</p><p>第一步,登录后点击 AddContent</p><p><img src="http://www.aircrayon.xyz/uploads/Snip20160508_3.png" alt=""></p><p>第二步，右侧栏拉倒底部点击 Import OPML</p><p><img src="http://www.aircrayon.xyz/uploads/Snip20160508_5.png" alt=""></p><p>第三步，上传 OPML 文件</p><p><img src="http://www.aircrayon.xyz/uploads/Snip20160508_8.png" alt=""></p><p>这样一来就已经大功告成了，进入 AppStore 或者安卓市场下载一个 Feedly 后登陆自己的账户后便可以使用手机直接查看技术大牛的最新博文了。</p><p><img src="http://www.aircrayon.xyz/uploads/Snip20160508_9.png" alt=""></p>]]></content>
      
      <categories>
          
          <category> Objective-C </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>内存管理 Form《Objectivce-C编程全解》&amp;《Objectivce-C编程》</title>
      <link href="/2016/05/06/cjjrthlej0029c7rdg7ui37jp/"/>
      <content type="html"><![CDATA[<blockquote><p>Xcode4.2之后可以使用自动引用计数（ARC,Automatic Reference Counting）的管理方式进行说明，ARC 是 Mac OS X 10.7和 iOS5引入的新特性，也是苹果公司推荐使用的内存管理方式。弃用 ARC 后，编译器会在适当的地方自动加入 retaion、release、autorelease 等语句，来简化 Objective-C 编程在内存管理方面的工作量</p></blockquote><h1 id="动态内存管理"><a href="#动态内存管理" class="headerlink" title="动态内存管理"></a>动态内存管理</h1><h2 id="内存管理的必要性"><a href="#内存管理的必要性" class="headerlink" title="内存管理的必要性"></a>内存管理的必要性</h2><p>C 语言中需要手动利用 malloc()和 free()对内存进行管理。当程序运行结束时，操作系统会释放掉为其分配的内存。如果是很小、运行时间短的程序，就算是内存没有释放也没有问题，程序结束时操作系统会进行自动释放。而对于长时间运行的程序，则需要程序员释放不再使用的内存，否则程序就会崩溃。</p><p>如果程序没能妥善管理内存，运行过程中就不但不能释放不再使用的内存，而且还会不停的分配内容村，这样所占用的内存就会越来越多，程序速度也会越来越慢，最后甚至会出现内存耗尽而崩溃。</p><p>就好像滴水一样，程序未能释放已不使用的内存叫做<strong>内存泄漏</strong>(memory leak)。C 语言中要特别注意内存的动态分配和释放，以防内存泄漏。有效地管理内存，会提高程序的执行效率。</p><p>如果访问了以被释放的内存，则会造成数据错误，严重时甚至会导致程序异常终止。在指针指向已被释放或回收的情况下，该指针就称之为<strong>悬垂指针</strong>（danling pointer）或野指针。继续使用这种指针会造成程序崩溃。</p><p>Objective—C 会通过向对象发送 alloc 消息来生成实例对象，alloc 的作用就是分配内存。alloc 方法的返回值是 id 类型，我们之前介绍过 id 其实就是指针类型，而其指向的就是为实例对象分配的内存。生成的实例对象用完之后如果不被释放的话，就会发生内存泄漏。另一方面，如果给已经被释放了的实例对象发送消息，运气好的话会得到警告，告诉你已被释放的对象发送了消息，运气不好的话则会程序错误甚至异常终止，所以 Objective-C 的程序一定要注意内存管理。</p><p>在面向对象的语言中，对象是程序的核心。而对象也有生命周期，既有从头到尾一直存在的对象，也有声明起短暂的临时对象。对象之间也可能相互引用，构成结构复杂的数据结构。同面向过程的语言相比，面向对象语言的内存管理更复杂一些。</p><h3 id="引用计数器、自动引用计数和自动垃圾回收"><a href="#引用计数器、自动引用计数和自动垃圾回收" class="headerlink" title="引用计数器、自动引用计数和自动垃圾回收"></a>引用计数器、自动引用计数和自动垃圾回收</h3><p>Coca 环境的 Objective-C 提供了一种动态内存管理方式，称之为<strong>引用计数</strong>（reference counter）。这种方式会跟踪每一个对象被引用的次数，当对象的引用次数为0的时候，系统会释放掉这个对象所占用的内存。这种内存管理方式也被称之为基于引用计数器的内存管理。</p><p>比引用计数内存管理更高级一点的就是<strong>自动引用计数</strong>（Automatic Reference Counting，简写 ARC）的内存管理。自动引用计数使开发人员不需要考虑何时使用 retain、release、autorelease 来管理内存，它提供了自动评估对象生存期的工恩给你，在编译期间会自动加入何时的内存管理方法，为了同自动引用计数器进行区分，将引用计数内存管理方式称之为手动引用技术内存管理。</p><p>除了 ARC 外，Objective-C2.0还引入了另外一种自动内存管理机制——<strong>垃圾回收</strong>，使用垃圾回收时，就不需要通过引用计数来刮泥创建的对象，系统会自动识别那些对象仍在使用，那些对象可以回收。</p><p>程序员可以从手动引用计数管理、ARC 和垃圾回收中选择任意一种内存管理方式来进行开发，不过还是推荐大家使用 ARC 的方式来进行内存管理。</p><table><thead><tr><th>内存管理方式</th><th style="text-align:center">难易度</th><th style="text-align:center">Mac</th><th style="text-align:center">iOS</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td>手动引用计数</td><td style="text-align:center">较难</td><td style="text-align:center">支持</td><td style="text-align:center">支持</td><td style="text-align:center"></td></tr><tr><td>自动引用计数</td><td style="text-align:center">容易</td><td style="text-align:center">支持</td><td style="text-align:center">支持</td><td style="text-align:center">现在已经默认使用此方式</td></tr><tr><td>垃圾回收</td><td style="text-align:center">容易</td><td style="text-align:center">支持</td><td style="text-align:center">不支持</td></tr></tbody></table><h3 id="兼容方法"><a href="#兼容方法" class="headerlink" title="兼容方法"></a>兼容方法</h3><p>在ARC的程序中,有一些类使用MRC实现的.</p><p>如果希望某些指定的类还是使用MRC. 那么这个时候可以在</p><pre><code>在targets的build phases选项下Compile Sources下选择要不使用arc编译的文件，双击它，输入 -fno-objc-arc 即可</code></pre><p>MRC工程中也可以使用ARC的类。方法如下：</p><p>在targets的build phases选项下Compile Sources下选择要使用arc编译的文件，双击它，输入 -fobjc-arc 即可</p><h2 id="手动引用计数内存管理"><a href="#手动引用计数内存管理" class="headerlink" title="手动引用计数内存管理"></a>手动引用计数内存管理</h2><p>本节将说明如何基于引用计数器来管理内存。手中引用计数是内存引用计数的基础，就算程序使用自动引用计数的内存管理，也需要了解手动引用计数的原理。</p><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>Cocoa 环境的 Objective-C 使用了一种叫做引用计数的计数来管理对象所占的内存。每个对象都有一个与之相关的整数——引用计数，当某段代码需要使用一个对象时，就将该对象的引用计数值加1。当这段代码不再使用这个对象的时候，则将对象的引用计数器减1.换而言之，引用计数就是指程序中到底有多少个地方需要访问这个对象。</p><p>使用 alloc 和初始化方法创建一个对象的时候，该对象的引用计数初始值为1.假设有一个类 A 在进行某些处理的过程中需要使用到实例 B，为了防止实例化 B被别的对象随意释放，类 A 会实现给实例 B 发送一个 retain 消息。这样，没执行一次 retain，实例 B 的引用计数就会加1。</p><p>反之，不需要某个对象时，可以发送 release 消息，使对象的引用计数减1。</p><p>实际上，释放内存的并不是 release，而是 dealloc 方法。同 alloc 不同，dealloc 不是类方法而是一个实例方法。没收到一个 release 消息，对象的引用计数器就会减一。当对象的引用计数器达到0的时候，系统就知道这个对象不需要了。这时，Objectivce—C 会自动向对象发送一条 delloc 消息来释放内存。通常允许在程序内直接调用 dealloc。</p><p>retain、release和 dealloc 的定义如下所示。retain 的返回值是接收消息的对象。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)<span class="keyword">retain</span>;</div><div class="line">-(<span class="keyword">oneway</span> <span class="keyword">void</span>)release;</div><div class="line">-(<span class="keyword">void</span>)dealloc;</div></pre></td></tr></table></figure><p>retain 是“保持”的意思，给一个对象发送 retain 消息，就意味着“保持”这个对象。生成对象或通过给对象发送 retain 消息来保持对象这种状态，都可以说是拥有这个对象的<strong>所有权</strong>（ownership）拥有实例所有权的对象叫做<strong>所有者</strong>（owner）。</p><p>这里需要注意的是，所有权是一个虚拟的概念。既无法通过语法标记，也无法通过这个对象的某个属性表示出来。程序在运行时没发确认某个对象的所有者是谁。所有权仅仅是人们分析阅读程序时，为了说明对象之间的关系而加上去的一个属性。</p><p>通过引用计数能够表现出一个对象有几个所有者。只要某个对象的引用计数器大于0就表示这个对象有所有者。引用计数变为0的时候，说明这个对象没有所有者，会被释放。</p><p><strong>图1 没有使用引用计数器的例子</strong></p><p><img src="http://i2.piimg.com/1aa5fe7fdc3d7b06.png" alt=""></p><p>让我们通过例子来说明一下基于应用技术的内存管理。首先，假设图（1）中对象 A 的方法把一个新生成的一个实例对象复制给了 A 的实例变量。这个时候新生成的对象的引用计数为1，他的所有者是对象 A，然后，图（2）中把这个对象的指针付给了对象 B 的某个实例变量。因为对象鼻没有发送 retain 消息，所以并不是这个对象的所有者，这个独享的引用计数器还是1.最后图（3）中对象 A 不再使用这个对象的时候发送了一个 release 消息，于是，虽然对象 B 还在使用这个对象，但该对象也被释放了。而此时如果对象 B 给已经释放的消息在发送消息，就会发生运行错误，程序将会异常终止！</p><p>为了防止这样的情况发生，一定要给动态生成的对象发送 retain 消息来增加它的引用计数。只要对对象的引用次数大于零，系统就不会释放它。</p><h3 id="测试引用计数"><a href="#测试引用计数" class="headerlink" title="测试引用计数"></a>测试引用计数</h3><p>让我们通过一个例子来看引用计数到底是如何工作的。</p><p>retain 和 release 方法是类 NSObject 的实例方法，方法 retainCount 可以获得对象的引用计数的当前值。retainCount 方法并没有太大的使用价值，一般在调试程序的时候使用。</p><p>代码清单的程序显示了对象生成后收到 retain、release 消息时引用计数器的变化。retainCount 的返回值是 NSUInteger 类型，使用 printf 输出返回值的时候需要进行类型转换。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc]init];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"init:%d"</span>,(<span class="keyword">int</span>)[obj retainCount]);</div><div class="line">    [obj <span class="keyword">retain</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"retain:%d"</span>,(<span class="keyword">int</span>)[obj retainCount]);</div><div class="line">    [obj <span class="keyword">retain</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"retain:%d"</span>,(<span class="keyword">int</span>)[obj retainCount]);</div><div class="line">    [obj release];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"release:%d"</span>,(<span class="keyword">int</span>)[obj retainCount]);</div><div class="line">    [obj release];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"release:%d"</span>,(<span class="keyword">int</span>)[obj retainCount]);</div><div class="line">    [obj release];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"release:%d"</span>,(<span class="keyword">int</span>)[obj retainCount]); </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>程序的输出如下所示。我们可以看出，对象刚生成的时候引用计数器的值为1，没收到一次 retain 消息，引用计数器的值就会加1；而收到 release 消息，引用计数器的值就减少1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">2016-05-06 13:19:16.761 引用计数器学习[6574:600738] init:1</div><div class="line">2016-05-06 13:19:16.762 引用计数器学习[6574:600738] retain:2</div><div class="line">2016-05-06 13:19:16.762 引用计数器学习[6574:600738] retain:3</div><div class="line">2016-05-06 13:19:16.762 引用计数器学习[6574:600738] release:2</div><div class="line">2016-05-06 13:19:16.763 引用计数器学习[6574:600738] release:1</div><div class="line">2016-05-06 13:19:16.763 引用计数器学习[6574:600738] release:1</div><div class="line">Program ended with exit code: 0</div></pre></td></tr></table></figure><h3 id="释放对象的方法"><a href="#释放对象的方法" class="headerlink" title="释放对象的方法"></a>释放对象的方法</h3><p>在自定义类的时候，如果累的实例变量是一个对象类型，那么，在销毁类的对象的时候，也要给类的实例变量发送 release 消息。</p><p>通过给对象发送 release 消息可以放弃对这个对象的所有权，但如前所述，真正释放对象占用的内存方法是 dealloc方法。</p><p>释放一个类的实例对象时，为了彻底释放该实例对象的所有对象的所有权，需要为该类重写 dealloc 方法，在其中释放已经分配的资源，放弃实例变量的所有权。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)dealloc&#123; <span class="comment">//重写的是 dealloc 方法而不是 release 方法</span></div><div class="line"><span class="comment">/*</span></div><div class="line">这里通过 release 方法放弃子类中所有实例变量的所有权</div><div class="line">其他用于释放前的善后操作也都卸载这里</div><div class="line">*/</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在重写 dealloc 犯法中，在释放自身之前，首先做好“善后工作”（释放所有需要释放的资源）。一般情况下，“善后工作”包括通过使用 release 放弃自身的实例变量的所有权。销毁对象的时候，不允许直接使用 dealloc，而是使用 release。release 会让引用计数减少1，只有当引用计数等于0的时候系统才会自动调用 dealloc 真正的销毁这个对象。</p><p>子类“善后工作”完成后，调用父类的 dealloc 方法来释放父类中定义的实例变量，这样，内存的释放会从子类一直向上知道 NSObject，最终这个对象就会被彻底释放掉。<br>下面的分数计算器的例子中展示了如何重写 dealloc。</p><h3 id="Retain计数原则"><a href="#Retain计数原则" class="headerlink" title="Retain计数原则"></a>Retain计数原则</h3><p>当使用Objective-C编写程序时，如果没有使用 ARC，就必须遵守特定的内存管理约定，否则可以由 ARC 来自动完成相关任务。</p><p>下面为 retain 计数总结若干规则，规则中的“你”代表“当前正在使用的某个类实例”。这是一种很有用的带入形式：请读者将自己想象成是在正在编写的那个对象。例如，“如果你保留了某个 NSString 对象，那么该实例就不会被释放掉”的真是意思是“如果读者正在使用的实例保留了某个 NSString 实例，那么该实例就不会被释放。”</p><p>下面列出规则（袁阔闹中的是实现细节）</p><ul><li>如果用来创建对象的方法，其方法名是以 alloc 或new 开头的，或者包含 copy，那么你已经得到了该对象的所有权（即可以假设新对象的 retain计数是1，而且该对象不再 NSAutoreleasePool 对象中）。你要负责不再需要使用该对象的时候释放掉他。以下是部分常见的、会“传输”所有权的方法：alloc（后面总会跟一个 init 方法）、copy 和 mutableCopy</li><li>通过任何其他途径创建的对象（例如通过便捷方法），你是没有所有权的（即可以假设新对象的 retain 计数是1，而且该对象已经在 NSAutoreleasePool 对象中。如果没有保留该对象，那么当NSAutoreleasePool被“排干”时，这个对象会被释放）。</li><li>如果你不拥有某个对象，但是要确保该对象能继续存在，那么可以通过响起发送 retain 消息来获得所有权。</li><li>当你拥有某个对象并且不再需要使用该对象的时候，可以向其方发送 release 消息或者 autorelease 消息</li><li>只要对象还有只要一个拥有方，该对象就会继续存在下去。</li></ul><p>##参考文献：</p><p>① Objectivce-C编程全解（第三版） [日]荻原刚志 著 唐璐 翟俊杰 译</p><p>② Objectivce-C编程 [美]Aaron Hillegass 著 夏伟频 译</p>]]></content>
      
      <categories>
          
          <category> ios </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>读书总结之NSObject</title>
      <link href="/2016/05/06/cjjrthlee0020c7rdvr4ci4p1/"/>
      <content type="html"><![CDATA[<blockquote><p>使用 Objectvice-C 进行全面对象编程时，除了需要知道语言本身的语法和面向对象的知识外，还需要了解Objectvice-C的根类 NSObject 的信息。</p></blockquote><h2 id="NSObject"><a href="#NSObject" class="headerlink" title="NSObject"></a>NSObject</h2><h3 id="根类的作用"><a href="#根类的作用" class="headerlink" title="根类的作用"></a>根类的作用</h3><p>作为一门动态编程语言，Objectstvice-C有很多动态的特性，因此，Objectvice-C不进需要编译环境，同时还需要一个<strong>运行时系统</strong>（runtime system）来执行编译好的代码。运行时系统扮演的角色类似于Objectvice-C的操作系统，他负责完成对象生成、释放时的内存管理、发来的消息查找对应的处理方法等工作。</p><p>通常情况下，程序无法直接使用运行时系统提供的功能。根类方法提供了运行时系统的基本工恩给你。继承了 NSObject 的所有类都可以自由的使用运行时系统的功能，也就是说，根类就想到于系统的一个借口。</p><p>根类通过哪些方式提供了哪些功能对系统有很大的影响。因此，根类不同的系统之间是无法开发出通用的程序的。</p><p>Cocoa 是以OPENSTEPDE的核心 API 为基础发展起来的。OPENSTEP的前身为 NeXTstep。在 NeXTstep 时代，根类是累 Object,而在 OPENSTEP 时代，根类则变为了 NSObject，同时类的设计也得到了大幅度的改进。</p><a id="more"></a><blockquote><p>NSArray,NSString 等等NS前缀类、函数归属于cocoa Fundation基础类库,其”NS”的由来据说是这样的：乔布斯被苹果开除后,创立了NeSt公司,而cocoa Fundation基础类库就是出自于NeST公司,NeST中的”NS”被作为Fundation中所有成员的前缀</p></blockquote><h3 id="类和实例"><a href="#类和实例" class="headerlink" title="类和实例"></a>类和实例</h3><p>NSObject 只是一个实例变量，就是 Class 类型的变量 isa。isa 用于表示实例对象属于哪个类对象。因为 isa 决定着实例变量和类的关系，非常重要，所以子类不可以修改 isa 的值。另外，也不能通过直接访问 isa 来查询实例变量到底属于哪个类，而是要通过实例方法 class 来完成查询。</p><p>在运行时的代码中我们可以查看到objc_class的定义如下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</div><div class="line"></div><div class="line"><span class="comment">/// Represents an instance of a class.</span></div><div class="line"><span class="keyword">struct</span> objc_object &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>下面对类和实例变量的相关方法进行说明。NSObject 的方法与其说是为自己定义的，不如说是为了其子类和所有实例对象而定义的。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">class</span>) <span class="keyword">class</span></div><div class="line">返回消息接收者所属类的类对象</div><div class="line"></div><div class="line">+ (<span class="keyword">class</span>) <span class="keyword">class</span></div><div class="line">返回类型对</div><div class="line">虽然可以使用类名作为消息的接受者来调用类方法，但类对象是其他消息的参数，或者将类对象赋值给变量的时候，需要通过这个方法来获取类的参数</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>) <span class="keyword">self</span></div><div class="line">返回接受者自身。是一个无任何实际动作但很有用的方法。</div><div class="line"></div><div class="line">-(<span class="built_in">BOOL</span>) isMemberOfClass: (Class) aClass</div><div class="line">判断消息接受者是不是参数 aClass 类的对象</div><div class="line"></div><div class="line">-(<span class="built_in">BOOL</span>) isKindOfClass: (Class) aClass</div><div class="line">判断消息接受者是否是参数 aClass 类或者 aClass 的子类的实例。这个函数和 isMemberOfClass:的区别在于当消息的接受者是 aClass 的子类的实例时也返回 <span class="literal">YES</span>。</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>) isSubclassOfClass: (Class) aClass</div><div class="line">判断消息接受者是不是参数 aClass 的子类或自身，如果是则返回 <span class="literal">YES</span></div><div class="line"></div><div class="line">- (Class) superclass</div><div class="line">返回消息接受者所在类的父类的类对象。</div><div class="line"></div><div class="line">+ (Class) superclass</div><div class="line">返回消息接收类的父类和类对象</div></pre></td></tr></table></figure><h3 id="实例对象的生成和释放"><a href="#实例对象的生成和释放" class="headerlink" title="实例对象的生成和释放"></a>实例对象的生成和释放</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">id</span>) alloc</div><div class="line">生成消息接收类的实例对象。通常和 init 或者 init 开头的方法连用，生成实例化对象的同事需要对其进行初始化。子类中不润徐重写 alloc 方法</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>) dealloc</div><div class="line">释放实例对象。dealloc 被称之为 release 的结果调用。除了在子类中重写 dealloc 的情况之外，程序不润徐直接调用 dealloc</div><div class="line"></div><div class="line">- (<span class="keyword">oneway</span> <span class="keyword">void</span>)release</div><div class="line">将消息接受者的引用计数减<span class="number">1.</span>引用计数变为<span class="number">0</span>时，dealloc 方法被调用，消息接受者被释放</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)<span class="keyword">retain</span></div><div class="line">为消息接收者的引用计数加<span class="number">1</span>，同事返回消息接收者</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)autorelease</div><div class="line">把消息的接受者加入到自动释放池中，同事返回消息接受者</div><div class="line"></div><div class="line">- (<span class="built_in">NSUinteger</span>) retainCount</div><div class="line">返回消息接受者的引用计数，可在调试时使用这个方法。<span class="built_in">NSUInteger</span> 是无符号证书类型</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)finalize</div><div class="line">垃圾收集器在释放接受者对象之前会执行该 finalize 方法。</div></pre></td></tr></table></figure><p>上面从 dealloc 到 retainCount 都是手动引用计数管理内存时使用的方法，使用 ARC 时不可用。finalize 仅供垃圾回收有效时使用。</p><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>) init</div><div class="line">init 可对 alloc 生成的实例对象进行初始化。子类中可以重写 init 或者自定义的心的以 init 开头的初始化函数。</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)initialize</div><div class="line">被用于类的初始化，也就是对类中共同使用的变量进行初始化设定等。这个方法会在类收到第一个消息之前被自动执行，不需手动调用</div><div class="line"></div><div class="line">+ (<span class="keyword">id</span>) new</div><div class="line">new 是 alloc 和 init 的组合。new 方法返回的实例对象的所有者就是调用 new 方法的对象。但是把 alloc 和 init 组合定义为 new 没有什么优点，并不建议使用。</div><div class="line">根据类的实现不同，new 方法并不会每次都返回一个全新的实例对象。有时new 方法会返回对象池中预先生成的对象，也有可能每次都返回同一个对象。</div></pre></td></tr></table></figure><h3 id="对象的比较"><a href="#对象的比较" class="headerlink" title="对象的比较"></a>对象的比较</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-(<span class="built_in">BOOL</span>) isEqual: (<span class="keyword">id</span>) anObject</div><div class="line">消息的接受者如果和参数 anObject 相等则返回 <span class="literal">YES</span></div><div class="line"></div><div class="line">- (<span class="built_in">NSUInteger</span>) hash</div><div class="line">把对象放入容器的时候，返回系统内部用的散列表</div></pre></td></tr></table></figure><p>原则上来讲，具有相同 id 值也就是同一个指针指向的对象被认为是相等的。而子类在这个基础上进行了扩展，把拥有相同值认为是相等。我们可以根据需求对“想通知”激进型定义，但一般都会让具备“相同值”的对象返回相同的散列表，因此就需要对散列表方法进行重新定义。而反之则并不成立，也就是说，散列值相等的两个对象不一定相等。</p><p>另外，有的累中还自定义了 compare:或者isEqualTo 之类的方法。至于到底是哪个方法或者自定义类的时候是否需要定义比较的方法，都需要根据目的和类的内容做具体分析。</p><h3 id="对象的内容描述"><a href="#对象的内容描述" class="headerlink" title="对象的内容描述"></a>对象的内容描述</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSString</span>*) description</div><div class="line">返回一个 <span class="built_in">NSString</span> 类型的字符串，表示消息接受者所属类的内容。通常是这个类的名称。</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span>*)description</div><div class="line">返回一个 <span class="built_in">NSString</span> 类型的字符串，表示消息接受者的实例对象的内容。通常是类名家 <span class="keyword">id</span> 值。子类中可以重新定义 description 的返回值。例如 <span class="built_in">NSString</span>的实例会返回字符串的内容，<span class="built_in">NSArray</span> 的实例会对数组中的每一个元素调用 description，然后将调用结果用句号进行分割，并且一起返回。</div></pre></td></tr></table></figure><h2 id="消息发送机制"><a href="#消息发送机制" class="headerlink" title="消息发送机制"></a>消息发送机制</h2><h3 id="选择器和-SEL-类型"><a href="#选择器和-SEL-类型" class="headerlink" title="选择器和 SEL 类型"></a>选择器和 SEL 类型</h3><p>至今为止我们把选择器（方法名）和消息关键字放在一起进行说明。程序中的方法名（选择器）在便有被一个内部标识符所代替，这个内部标识符所对应的数据类型就是 SEL 类型。</p><p>Objective-C为了能够在程序中操作编译后的选择器，定义了@selector()指令。通过使用@selector()指令，就可以直接饮用编译后的选择器。使用方法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@selector(mutableCopy)</div><div class="line">@selector(compare:)</div><div class="line">@selector(replaceObjectAtIndex:withObject:)</div></pre></td></tr></table></figure><p>也可以声明 SEL 类型的变量</p><p>选择器不同的情况下，编译器转换后生成的 SEL 类型的值也一定不同，相同的算择期对应的 SEL 类型的值一定相同。Objective-C的程序员不需要知道选择器对应的 SEL 类型的值到底是什么，具体的值是和处理器相关的。但是如果 SEL 类型的便利功能无效的话，可设其为 NULL，或者也可以使用(SEL)0这种常见的表达方式</p><p>可以使用 SEL 类型的变量来发送消息，为此，NSObject 中准备了如下方法</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">id</span>)performSelector: (SEL) aSelector</div><div class="line">向消息的接收者发送 aSelector代表的消息，返回这个消息的执行结果</div><div class="line"></div><div class="line">-(<span class="keyword">id</span>)performSelector: (SEL) aSelector </div><div class="line">withObject: (<span class="keyword">id</span>) anObject</div><div class="line">与上面的方法一直，不过可以传递参数</div></pre></td></tr></table></figure><p>例如下面两个消息表达式进行的处理是相同的</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[target description]</div><div class="line">[targ performSelector: <span class="keyword">@selector</span>(description)];</div></pre></td></tr></table></figure><p>下面的例子展示了如何根据条件动态决定执行那个方法</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SEL method = (void1) ? <span class="keyword">@selector</span>(activate:) : <span class="keyword">@selector</span>(hide:);</div><div class="line"><span class="keyword">id</span> obj = (cond2) ? MyDocument : defaultDocument;</div><div class="line">[target performSelector:method withObject:obj]</div></pre></td></tr></table></figure><p>这种调用方式很想 C 语言中函数指针的用法，使用函数指针可以实现和上面的程序同样的功能。</p><p>函数指针是函数在内存中的地址。指针对应的函数是在编译的时候决定的，不能够执行指定之外的函数。SEL 类型就相当于方法名，根据消息接受者的不同（上例子中 target 的赋值），来动态执行不同的方法。</p><p>通过 SEL 类型来指定要中子星的方法，这就是 Objectivce-C消息发送的方式。也正是通过这种方法才实现了 Objectivce-C的动态性</p><h3 id="消息搜索"><a href="#消息搜索" class="headerlink" title="消息搜索"></a>消息搜索</h3><p>对象收到一个消息后执行哪个方法是动态决定的。</p><p>所有的实例变量都存在一个 Class 类型的 isa 变量，它就是类对象。当收到消息后，运行时系统会检查类内是否有和这个消息选择器相同的方法，如果有就执行对应的方法，如果没有就通过类对象中指向父类的指针来查找父类中是否有对应的方法。如果一直找到根类都没有找到对应的方法，就会提示执行时错误。</p><p>如果每次收到消息都需要查找对应的方法的话，消息发送过程的开销就会很大，是针对这种情况，运行时内部会缓存一个散列表，表中记录着某个类拥有和什么样的选择器相对应的方法、方法被定义在何处等信息。这样一来，当下次在收到同样的消息时，直接利用上次缓存好的信息即可。</p><p>NSObject 中定义了可以动态检查一个对象是否能够响应某个选择器的方法。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>) respondsToSelector: (SEL) aSelector</div><div class="line">查询消息的接收者中是否能够响应 aSelector 的方法，包括从父类继承来的方法，如果存在的话则返回 <span class="literal">YES</span></div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>) instancesRespondToSelector: (SEL) aSelector</div><div class="line">查询消息的接收者所属的类中是否能够响应 aSelector 的实例方法，如果存在的话则返回 <span class="literal">YES</span></div></pre></td></tr></table></figure><h3 id="一函数的形式来调用方法"><a href="#一函数的形式来调用方法" class="headerlink" title="一函数的形式来调用方法"></a>一函数的形式来调用方法</h3><p>类中定义的方法通常是以函数的形式来实现的，但通常在编程的时候并不会直接操作方法所对应的函数。</p><p>但如果想尽可能第让程序更快一点，或者需要按照 C 语言的管理传递函数指针的时候，可以直接调用方法对应的函数，以节省发送消息的开销。另外执行时动态加载方法的定义等时，也可以将方法作为函数调用。但是需要注意的是，如果以函数的形式来调用方法的话，将无法利用面向对象的动态绑定等功能。虽然消息发送同函数调用相比确实慢一点，但却有面向对象的动态绑定、多态等优点。同这些优点相比，速度上略微的损失是不值得一提的。而其实消息发送的速度也非常的快。</p><p>通过使用下面的方法，可以获得某个对象持有的方法的函数指针，这些方法都被定义在 NSObject 中。</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (IMP) methodForSelector: (SEL) aSelector</div><div class="line">搜索和执行选择器对应的方法，并返回指向该方法实现的函数指针。实例对象和类对象都可以使用这个方法。对实例对象使用时，会返回实例方法对应的函数，对类对象使用时，会返回类对象对应的函数</div><div class="line">+ (IMP) instanceMethodForSelector: (SEL)aSelector;</div><div class="line">搜索和制定选择器相对应的实例方法，并返回该指向实例方法实现的函数指针</div></pre></td></tr></table></figure><p>IMP 是“implemention”的缩写，它是一个函数指针，指向了方法实现代码的入口</p><p>IMP 的定义为：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#if !OBJC_OLD_DISPATCH_PROTOTYPES</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (*IMP)(<span class="keyword">void</span> <span class="comment">/* id, SEL, ... */</span> ); </div><div class="line"><span class="meta">#else</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">id</span> (*IMP)(<span class="keyword">id</span>, SEL, ...); </div><div class="line"><span class="meta">#endif</span></div></pre></td></tr></table></figure><p>这个被指向的函数包括 id(self 指针)、调用的 SEL（方法名），以及其他参数</p><p>例如：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)setBox:(<span class="keyword">id</span>)obj1 title:(<span class="keyword">id</span>)obj2;</div></pre></td></tr></table></figure><p>foo 是这个方法所属类的一个实例变量。获取指向 setBox 的函数指针，并且通过该指针进行函数调用的过程如下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">IMP funcp;</div><div class="line">funcp = [foo methodForSelector:<span class="keyword">@selector</span>[setBox:title]];</div><div class="line">xyz = (*funcp)(foo,<span class="keyword">@selector</span>[setBox:title:],param1,param2)</div></pre></td></tr></table></figure><h3 id="类对象和跟对象"><a href="#类对象和跟对象" class="headerlink" title="类对象和跟对象"></a>类对象和跟对象</h3><p>因为累对象也是一个对象，所以累对象可以作为根类 NSObject 的某个子类的对象来使用。下面这句话看上去好像比较奇怪，但是实际上他是正确的，会返回 YES</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="built_in">NSString</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]</div></pre></td></tr></table></figure><p>这就说明了相当于类对象的类的对象是存在的。而类对象的类就被叫做元类(metaclass)。实例对象(instance object)所属的类是 class，类对象(class object)所属的类是 metaclass。</p><p>Objective-C 中的很多概念都来源于 Smalltalk，元类的概念就是其中之一。但现在的 Objective-C中已经不存在元类的概念了，程序中不能操作元类。用于表示对象的 id 类型和表示类的 Class 类实际上都是指向结构体的指针。被详细定义在/usr/include/objc 下面的 objc.h 头文件中。通过查看 objc.h 中 id和 Class 的定义，就会发现类和元类的关系如图所示。Objective-C2.0更新了基本的数据结构，但是没有改变类和元类的关系。</p><p><img src="http://i3.buimg.com/1eb8e25c5b87d1ec.jpg" alt=""></p><p>类 A 是 NSObject 的子类，类 B是 A 的子类。类对象和实例对象都存在一个成员变量 isa，它是一个 objc_class 类型的指针</p><p>图中带有 isa 的实现表明了 isa 指向的对象，带有 super_class 的虚线则表明了父类的关系。</p><p>类对象中保存的是实例方法，元对象中保存的是累方法。通过这样的定义能够统一实现实例方法和类方法的调用机制。</p><p>因为编程时不可以直接操作元类，所以并不需要完全了解图中的细节。大家只需要记住任何一个类对象都是继承了根类的元对象的一个实例即可。也就是说，类对象可以执行根类对象的实例方法。</p><p>例如，类对象可以执行 NSObject 的实例方法 performSelector:和 respondsToSelector:。当然提前是没有将这些方法作为类方法再次定义。</p><p>下面让我们总结一下。其中（1）和（2）我们已经介绍过了。（3）比较不容易理解，</p><ol><li><p>所有类的实例对象都可以执行根类的实例方法</p><ul><li>如果在派生类中重新定义了实例方法，新定义的方法会被执行</li></ul></li><li><p>所有类的类对象都可以执行根类的类方法</p><ul><li>如果在派生类中重新定义了类方法，新定义的方法会被执行</li></ul></li><li><p>所有类的类对象都可以执行根类的实例方法</p><ul><li>即使在派生类中重新定义了实例方法，根类中的方法也会被执行</li><li>如果在派生类中将实例方法作为类方法重新定义了的话，新定义的方法会被执行</li></ul></li></ol><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>① Objectivce-C编程全解（第三版） [日]荻原刚志 著 唐璐 翟俊杰 译</p>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>UITableView 系统 API实现滑动删除Cell</title>
      <link href="/2016/04/23/cjjrthleb001uc7rdgtdgqmgw/"/>
      <content type="html"><![CDATA[<p>#UITableView 系统 API实现滑动删除Cell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">import UIKit</div><div class="line"></div><div class="line">class ViewController: UIViewController &#123;</div><div class="line"></div><div class="line">    private lazy var tableview:UITableView = &#123;</div><div class="line">        let tb = UITableView(frame: CGRectZero,style: UITableViewStyle.Plain)</div><div class="line">        tb.dataSource = self</div><div class="line">        tb.delegate = self</div><div class="line">        tb.registerClass(UITableViewCell.self, forCellReuseIdentifier: &quot;Cell&quot;)</div><div class="line">        return tb</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    private var dataArray = [&quot;lazy&quot;,&quot;make&quot;,&quot;help&quot;,&quot;papa&quot;]</div><div class="line">    </div><div class="line">    override func viewDidLoad() &#123;</div><div class="line">        super.viewDidLoad()</div><div class="line">        view = tableview</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">extension ViewController:UITableViewDataSource&#123;</div><div class="line">    func tableView(tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;</div><div class="line">        return dataArray.count;</div><div class="line">    &#125;</div><div class="line">    func tableView(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath) -&gt; UITableViewCell &#123;</div><div class="line">        let cell = tableview.dequeueReusableCellWithIdentifier(&quot;Cell&quot;, forIndexPath: indexPath)</div><div class="line">        cell.textLabel?.text = dataArray[indexPath.row]</div><div class="line">        return cell</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">extension ViewController:UITableViewDelegate&#123;</div><div class="line">    //1.设置Cell 可编辑</div><div class="line">    func tableView(tableView: UITableView, canEditRowAtIndexPath indexPath: NSIndexPath) -&gt; Bool &#123;</div><div class="line">        return true</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //2.进入编辑模式，滑动初选删除按钮</div><div class="line">      func tableView(tableView: UITableView, titleForDeleteConfirmationButtonForRowAtIndexPath indexPath: NSIndexPath) -&gt; String? &#123;</div><div class="line">        return &quot;删除&quot;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    //3.响应删除按钮事件</div><div class="line">    func tableView(tableView: UITableView, commitEditingStyle editingStyle: UITableViewCellEditingStyle, forRowAtIndexPath indexPath: NSIndexPath) &#123;</div><div class="line">        tableview.setEditing(false, animated: true)</div><div class="line">        print(&quot;删除\(dataArray[indexPath.row])&quot;)</div><div class="line">        dataArray.removeAtIndex(indexPath.row)</div><div class="line">        tableview.reloadData()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Objective-C </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>iOS多线程</title>
      <link href="/2016/03/22/cjjrthlec001xc7rd69s6ctmy/"/>
      <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>多线程是所有程序员都应该知道的一个概念，因为当一个程序开始运行，进程就已经开启了！</p><h3 id="多线程基本概念"><a href="#多线程基本概念" class="headerlink" title="多线程基本概念"></a>多线程基本概念</h3><p>进程(process)和文件(files)是UNIX/Linux操作系统最基本的抽象。进程是处于执行期的程序和它所包含的资源的综合，也就是说一个进程就是处于执行期的程序。一个线程（thread）就是运行在一个程序上下文中的一个逻辑刘，不难看出，线程是进程中最基本的活动对象。</p><blockquote><p>在软件工程中，上下文是一种属性的有序序列，它们为主流在环境内的对象定义环境，在对象的激活过程中创建上下文，对象呗配置为要求某些自动服务，如同步、事务、实时激活、安全性等等。又比如计算机技术中，对象鱼进程而言，上下文就是进程执行时候的环境，具体来就是各个变量和数据，包括所有的寄存器变量、进程打开的文件、内存信息等。</p></blockquote><p>在传统系统中，一个进程只包含一个线程。但是在现代系统中，润徐一个进程里面可以同时运行多个县城，这类程序被称之为多线程程序。所有的程序都有一个主线程（main thread，在iOS开发中，主线程主要用于UI呈现，要将耗时操作放到其他线程之中，否则UI界面会被卡死），主直选成是进程的控制流或者执行线程在多线程程序中，主线可以创建一个活多个对等线程（peer thread），从这个时间点开始，这些线程就开始兵法执行，主线程和对等线程的区别仅在于主线程总是进程中第一个运行的线程。从某种程度上看，线程可以看做是轻量级的进程（lightweight process）。</p><p>每个程序都拥有独立的线程上下文（thread context），线程ID（Thread ID，TID），程序计数器（PC），线程栈（stack），一组寄存器（register）和条件码，其中内核正式通过线程ID（TID）来识别线程，进行线程调度的。</p><p>上面的内容是否晦涩难懂，那么我们看一看百度百科是如何解释多线程的：</p><p>在百度百科中，多线程是指软件或者硬件上实现多个线程并发执行的技术。具有多线程能力的计算机因有硬件支持而能够在同一时间执行多余一个线程，今儿提高整体处理性能。就这样的一句话就解释了什么是线程和线程的作用，就是为了提高程序的执行效率，能够在同一时间段执行多个任务。</p><p>这样一来是否就容易理解了，其实每一个软件都是一个进程，每个进程中包含一个到多个的线程，我们在window有的时候程序卡死，我们使用任务管理器结束程序的时候就是杀死那个进程。进程也可能是整个程序或者是部分程序的动态执行，线程是一组指令的集合，或者是程序的特殊段，它可以在程序里面单独执行，也可以把它理解成为代码运行的上下文，所以线程基本上是轻量级的进程，它负责在单个程序里执行多任务。通常由操作系统负责多个线程的调度和执行。</p><p>线程是程序中一个单一的顺序控制流程，在单个程序中同时运行多个线程完成不同的工作，成为多线程。</p><p>线程和进程的主要区别在于子进程和父进程有不同的代码和数据空间，而多个线程则共享数据空间，每个线程有自己的执行堆栈和程序计数器为其知心上下文，多线程主要是为了节省CPU时间，发挥利用，根据具体情况而定。线程的运行需要使用计算机的内存资源和CPU。</p><p>到了这里你应该已经知道了什么是多线程了，首先让我们来整理一下然后再进行进行学习。</p><ol><li>进程:就是指在系统中运行的一个应用程序，每个进程之间是独立的，每个进程均运行在其专用且受保护的内存空间中</li><li>线程:一个进程要执行任务，必须得有线程（每一个进程只要有一条线程），一个进程的所有任务都是放在线程中完成的<ul><li>线程的串行：一个线程中执行的任务是串行的，如果在一个线程中赤星多个任务，只能一个一个的按照顺序执行</li></ul></li><li>多线程：一个进程中可以开启多条线程，每条线程可以并行（同时），执行不同的任务。</li></ol><h3 id="多线程的优缺点"><a href="#多线程的优缺点" class="headerlink" title="多线程的优缺点"></a>多线程的优缺点</h3><h4 id="多线程的优点"><a href="#多线程的优点" class="headerlink" title="多线程的优点"></a>多线程的优点</h4><ol><li>能适当提高程序的执行效率</li><li>能适当提高资源利用率（CPU、内存利用率）</li></ol><h4 id="多线程的缺点"><a href="#多线程的缺点" class="headerlink" title="多线程的缺点"></a>多线程的缺点</h4><ol><li>开启线程需要占用一定的内存空间（默认情况下，主线程占用1M，子线程占用512KB），如果开启大量的线程，会占用大量的内存空间，降低程序的性能</li><li>线程越多，CPU在调度线程上的开销就越大</li><li>程序设计更加复杂：比如线程之间的通信、多线程的数据共享</li></ol><h4 id="多线程在iOS开发中的应用"><a href="#多线程在iOS开发中的应用" class="headerlink" title="多线程在iOS开发中的应用"></a>多线程在iOS开发中的应用</h4><p>主线程:一个iOS程序运行后，默认会开启1条线程，称为“主线程”或“UI线程”<br>主线程的主要作用<br>显示、刷新UI界面<br>处理UI事件（比如点击事件、滚动事件、拖拽事件等）<br>主线程的使用注意:别将比较耗时的操作放到主线程中。<br>耗时操作会卡住主线程，严重影响UI的流畅度，给用户一种“卡”的坏体验</p><h2 id="Pthread"><a href="#Pthread" class="headerlink" title="Pthread"></a>Pthread</h2><p>POSIX线程（POSIX threads）简称Pthreads，是线程的POSIX标准。该标准定义了创建和操纵线程的一套API，在类Unix系统中，都是用Pthreads作为系统的线程。在这里只讲一下其基本使用，因为在日常的开发之中并不是很常用这种方式进行多线程的开发。</p><h3 id="Pthread的基本使用"><a href="#Pthread的基本使用" class="headerlink" title="Pthread的基本使用"></a>Pthread的基本使用</h3><p>由于Pthreads是使用C语言进行开发的，所以其使用都是C语法。</p><h4 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pthread_create(pthread_t *thread,pthread_attr_t * attr,void*(*start_routine)(void*),void*arg);</div></pre></td></tr></table></figure><h5 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h5><p>thread:返回创建的线程ID</p><p>attr:线程属性，调度策略、优先级等都在这里设置，如果为NULL则标识默认属性</p><p>start_rountine:线程入口函数，可以返回一个void*类型的返回值，该返回值可由pthread_join()捕获<br>arg:传给start_rountine的参数，可以为NULL</p><h5 id="设置线程属性"><a href="#设置线程属性" class="headerlink" title="设置线程属性"></a>设置线程属性</h5><p>线程属性通过attr进行设置<br>设置与查询attr结构为pthread_attr_get<del>()与pthread_attr_set</del>()两个系列函数，也可以在创建时通过pthread_create参数参数，有些必须在线程创建时进行设置比如跳读策略。</p><h5 id="调度策略"><a href="#调度策略" class="headerlink" title="调度策略"></a>调度策略</h5><p>POSIX定义一种优先级调度模型，此模型确定任何两个线程相对于对方的重要程度。当两个线程同时准备就绪的时候，系统就会自动选择具有最高优先级的线程。</p><p>SCHED_OTHER：非实时、正常<br>SCHED_RR：实时、轮询法<br>SCHED_FIFO：实时、先入先出，与vxworks的调度机制一致</p><p>例程：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pthread_attr_t attr;</div><div class="line">pthread_attr_init(&amp;attr);</div><div class="line">pthread_attr_setschedpolicy(&amp;attr, SCHED_FIFO);//sched_policy</div></pre></td></tr></table></figure><h2 id="NSThread"><a href="#NSThread" class="headerlink" title="NSThread"></a>NSThread</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>NSThread 是 Objective-C 对 pthread 的一个封装。通过封装，在 Cocoa 环境中，可以让代码看起来更加亲切,通过NSThread这个API我们可以实现简单的多线程编程,但需要管理线程的声明周期、同步、加锁等问题，这样会导致一定的性能开销，当我们进行多线程开发的时候，并不推荐此方法。</p><h3 id="NSThread的初始化"><a href="#NSThread的初始化" class="headerlink" title="NSThread的初始化"></a>NSThread的初始化</h3><h4 id="动态方法"><a href="#动态方法" class="headerlink" title="动态方法"></a>动态方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (id)initWithTarget:(id)target selector:(SEL)selector object:(id)argument;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 初始化线程</div><div class="line">NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(run) object:nil];</div><div class="line">// 设置线程的优先级(0.0 - 1.0，1.0最高级)</div><div class="line">thread.threadPriority = 1;</div><div class="line">// 开启线程</div><div class="line">[thread start];</div><div class="line">参数解析：</div><div class="line">selector ：线程执行的方法，这个selector最多只能接收一个参数</div><div class="line">target ：selector消息发送的对象</div><div class="line">argument : 传给selector的唯一参数，也可以是nil</div></pre></td></tr></table></figure><h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (void)detachNewThreadSelector:(SEL)selector toTarget:(id)target withObject:(id)argument;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[NSThread detachNewThreadSelector:@selector(run) toTarget:self withObject:nil];</div><div class="line">// 调用完毕后，会马上创建并开启新线程</div></pre></td></tr></table></figure><h4 id="隐式创建线程的方法"><a href="#隐式创建线程的方法" class="headerlink" title="隐式创建线程的方法"></a>隐式创建线程的方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self performSelectorInBackground:@selector(run) withObject:nil];</div></pre></td></tr></table></figure><h3 id="获取当前线程"><a href="#获取当前线程" class="headerlink" title="获取当前线程"></a>获取当前线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSThread *current = [NSThread currentThread];</div></pre></td></tr></table></figure><h3 id="获取主线程"><a href="#获取主线程" class="headerlink" title="获取主线程"></a>获取主线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSThread *main = [NSThread mainThread];</div></pre></td></tr></table></figure><h3 id="暂停当前线程"><a href="#暂停当前线程" class="headerlink" title="暂停当前线程"></a>暂停当前线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 暂停2s</div><div class="line">[NSThread sleepForTimeInterval:2];</div><div class="line"></div><div class="line">// 或者</div><div class="line">NSDate *date = [NSDate dateWithTimeInterval:2 sinceDate:[NSDate date]];</div><div class="line">[NSThread sleepUntilDate:date];</div></pre></td></tr></table></figure><h3 id="线程间的通信"><a href="#线程间的通信" class="headerlink" title="线程间的通信"></a>线程间的通信</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">1.在指定线程上执行操作</div><div class="line">[self performSelector:@selector(run) onThread:thread withObject:nil waitUntilDone:YES];</div><div class="line"></div><div class="line">2.在主线程上执行操作</div><div class="line">[self performSelectorOnMainThread:@selector(run) withObject:nil waitUntilDone:YES];</div><div class="line"></div><div class="line">3.在当前线程执行操作</div><div class="line">[self performSelector:@selector(run) withObject:nil];</div></pre></td></tr></table></figure><h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p>1.优点：NSThread比其他两种多线程方案较轻量级，更直观地控制线程对象<br>2.缺点：需要自己管理线程的生命周期，线程同步。线程同步对数据的加锁会有一定的系统开销</p><h2 id="NSOperation"><a href="#NSOperation" class="headerlink" title="NSOperation"></a>NSOperation</h2><p>NSOperation的作用</p><ul><li>配合使用NSOperation和NSOperationQueue实现多线程编程</li><li>NSOperation和NSOperationQueue实现多线程的具体步骤<ol><li>先将需要执行的操作封装到一个NSOperation对象中</li><li>然后将NSOperation对象添加到NSOperationQueue中</li><li>系统会自动的将NSOperationQueue中的NSOperation中取出来</li><li>将取出的NSOperation封装的操作放到一条线程中执行</li></ol></li></ul><h3 id="NSOperation的子类"><a href="#NSOperation的子类" class="headerlink" title="NSOperation的子类"></a>NSOperation的子类</h3><p>NSOperation是一个抽象的类,它并不具备封装操作的能力,当我们进行多线程编程的时候,必须使用它的子类.</p><ol><li>NSInvocationOperation</li><li>NSBlockOperation</li><li>自定义子类继承NSOperation,实现内部相对应的方法</li></ol><h3 id="NSInvocationOperation"><a href="#NSInvocationOperation" class="headerlink" title="NSInvocationOperation"></a>NSInvocationOperation</h3><p><em>创建NSInvocationOperation对象</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-(id)initWithTarget:(id)target selector:(SEL)sel object:(id)arg;</div></pre></td></tr></table></figure><p><em>调用start方法开启线程</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-(void)start;</div></pre></td></tr></table></figure><blockquote><p>一旦执行操作，就会调用target的sel方法默认情况下，调用了start方法后并不会开一条新线程去执行操作，而是在当前线程同步执行操作<br>只有将NSOperation放到一个NSOperationQueue中，才会异步执行操作</p></blockquote><h3 id="NSBlockOperation"><a href="#NSBlockOperation" class="headerlink" title="NSBlockOperation"></a>NSBlockOperation</h3><p><em>创建NSBlockOperation对象</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+(id)blockOperationWithBlock:(void (^)(void))block;</div></pre></td></tr></table></figure><p><em>通过addExecutionBlock:方法添加更多的操作</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-(void)addExecutionBlock:(void (^)(void))block;</div></pre></td></tr></table></figure><blockquote><p>只要NSBlockOperation封装的操作数 &gt; 1，就会异步执行操作</p></blockquote><h3 id="NSOperationQueue"><a href="#NSOperationQueue" class="headerlink" title="NSOperationQueue"></a>NSOperationQueue</h3><p>NSOperationQueue可以调用start放啊来进行执行任务,但是默认是同步执行的</p><p>如果将NSOperationQueue添加到NSOperationQueue操作队列中,系统会自动异步执行.</p><p>添加操作:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-(void)addOperation:(NSOperation *)op;</div><div class="line">-(void)addOperationWithBlock:(void (^)(void))bloc</div></pre></td></tr></table></figure><h3 id="最大并发数"><a href="#最大并发数" class="headerlink" title="最大并发数"></a>最大并发数</h3><p><strong>什么是并发数</strong></p><p>同时执行的任务数<br>比如，同时开3个线程执行3个任务，并发数就是3</p><p><strong>最大并发数的相关方法</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-(NSInteger)maxConcurrentOperationCount;</div><div class="line">-(void)setMaxConcurrentOperationCount:(NSInteger)cnt;</div></pre></td></tr></table></figure><h3 id="队列的取消-暂停-回复"><a href="#队列的取消-暂停-回复" class="headerlink" title="队列的取消,暂停,回复"></a>队列的取消,暂停,回复</h3><p><strong>取消队列的所有操作</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-(void)cancelAllOperations;</div></pre></td></tr></table></figure><blockquote><p>提示：也可以调用NSOperation的 -(void)cancel方法取消单个操作</p></blockquote><p><em>暂停和恢复队列</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-(void)setSuspended:(BOOL)b; // YES代表暂停队列，NO代表恢复队列</div><div class="line">-(BOOL)isSuspended;</div></pre></td></tr></table></figure><h3 id="操作依赖"><a href="#操作依赖" class="headerlink" title="操作依赖"></a>操作依赖</h3><p>NSOperation之间可以设置依赖来保证执行顺序<br>比如一定要让操作A执行完后，才能执行操作B，可以这么写</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[operationB addDependency:operationA]; // 操作B依赖于操作A</div></pre></td></tr></table></figure><p>可以在不同queue的NSOperation之间创建依赖关系</p><h3 id="操作监听"><a href="#操作监听" class="headerlink" title="操作监听"></a>操作监听</h3><p>可以监听一个操作的执行完毕</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-(void (^)(void))completionBlock;</div><div class="line">-(void)setCompletionBlock:(void (^)(void))block;</div></pre></td></tr></table></figure><h3 id="自定义NSOperation"><a href="#自定义NSOperation" class="headerlink" title="自定义NSOperation"></a>自定义NSOperation</h3><p><em>自定义NSOperation的步骤</em></p><p>重写<code>-(void)main</code>方法，在里面实现想执行的任务</p><p>重写<code>-(void)main</code>方法的注意点<br>自己创建自动释放池（因为如果是异步操作，无法访问主线程的自动释放池）<br>经常通过<code>- (BOOL)isCancelled</code>方法检测操作是否被取消，对取消做出响应</p><h2 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>GCD 是 libdispatch 的市场名称，而 libdispatch 作为 Apple 的一个库，为并发代码在多核硬件（跑 iOS 或 OS X ）上执行提供有力支持。它具有以下优点：</p><ol><li>GCD 能通过推迟昂贵计算任务并在后台运行它们来改善你的应用的响应性能。</li><li>GCD 提供一个易于使用的并发模型而不仅仅只是锁和线程，以帮助我们避开并发陷阱。</li><li>GCD 具有在常见模式（例如单例）上用更高性能的原语优化你的代码的潜在能力</li></ol><p>（未完待续）</p><p>参考文献：</p><p>[1] <a href="http://blog.chinaunix.net/uid-20528014-id-333508.html" target="_blank" rel="noopener">fireaxe - Pthread编程基础 </a></p>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>移动info.plist后无法运行</title>
      <link href="/2016/03/04/cjjrthle6001oc7rd3ua6pdte/"/>
      <content type="html"><![CDATA[<p>今天做项目的时候,不小心将info.plist移动了,再移动回项目中的时候直接报错,查了一下百度找到了解决办法.</p><p>只需要在bulid Phases中的Copy Bundle Resources重新加入info.plist即可。</p>]]></content>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>统一设置tabBarItem字体样式</title>
      <link href="/2016/03/04/1/"/>
      <content type="html"><![CDATA[<p>一般我们在使用tabBar的时候都需要进行自定义,统一设置其字体样式的方法如下.</p><p>在iOS开发中有两个方法:load与initialize.</p><p>load是在类加载的时候会自动调用,iOS工程在运行的时候,会自动将工程内的类加载到内存之中,这个时候就是load执行的时候.</p><p>initialize是在第一次使用或者调用子类的时候回自动执行,具有初始化类的功能,我们可以通过这两个方式的执行特性来对tabBarItem的样式进行设置.</p><p>tabBarItem其实是一个模型(Item是苹果对模型的一种命名规范),我们并不能够对模型直接格式操作,但是我们可以对控件的格式进行设置,这样也就是使用到了文本属性(富文本)来进行设置.</p><p>代码如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+(void)initialize&#123;</div><div class="line">    //获取所有的tabBarItem 获取所有的外观</div><div class="line">    UITabBarItem *item = [UITabBarItem appearance];</div><div class="line">    NSMutableDictionary *att = [[NSMutableDictionary alloc]init];</div><div class="line">    [att setObject:[UIColor grayColor] forKey:NSForegroundColorAttributeName];</div><div class="line">    NSMutableDictionary *selectedAtt = [[NSMutableDictionary alloc]init];</div><div class="line">    [selectedAtt setObject:[UIColor orangeColor] forKey:NSForegroundColorAttributeName];</div><div class="line">    [item setTitleTextAttributes:att forState:UIControlStateNormal];</div><div class="line">    [item setTitleTextAttributes:selectedAtt forState:UIControlStateSelected];    </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这样一来我们就完成了样式的设置,appearance在英语中的意思是外观,在iOS中算是一个标记,通过这个标记,我们可以取得UITabBarItem中所有Item的外观.</p>]]></content>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用iOS本地通知</title>
      <link href="/2016/03/03/1/"/>
      <content type="html"><![CDATA[<p>在 iOS 开发中推送通知被分为两种，本地通知与推送通知，</p><p>本地通知是应用在后台运行时，把一些消息提示给用户，一个很好的例子就是基于定位的应用，这类应用在后台运行，到他发现到达某个特殊地点是给予用户提醒，本地通知只能使用在 iOS 设备中，他可以立即发出通知也可以在计划时间后发出。</p><p>本地通知只是应用所在设备上给用户通知，而推送通知是远程通知，它是由远程服务器推送过来的。无论是哪一种，通知的形式都是一样的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">//本地推送,主要用于一些常规类的提醒</div><div class="line">    /**</div><div class="line">     *  1.健康类 定时几点运动</div><div class="line">     *  2.社交类 几点约会</div><div class="line">     *  3.游戏类 到时见领取奖励</div><div class="line">     *  4.新闻类 每日早间提醒阅读</div><div class="line">     *  5.医药类 你该吃药了,药别停</div><div class="line">     */</div><div class="line">     </div><div class="line">    //在iOS8下需要注册一下本地推送</div><div class="line">    [[UIApplication sharedApplication] registerUserNotificationSettings: [UIUserNotificationSettings settingsForTypes:UIUserNotificationTypeBadge|UIUserNotificationTypeAlert|UIUserNotificationTypeSound categories:nil]];</div><div class="line">    //初始创建本地推送</div><div class="line">    UILocalNotification *local = [[UILocalNotification alloc]init];</div><div class="line">    //设置推送时间</div><div class="line">    local.fireDate = [NSDate dateWithTimeIntervalSinceNow:5];</div><div class="line">    //设置推送的内容</div><div class="line">    local.alertBody = @&quot;你该吃药了!&quot;;</div><div class="line">    //设置时区 根据当前手机时区设置的</div><div class="line">    local.timeZone = [NSTimeZone defaultTimeZone];</div><div class="line">    //设置重复的间隔</div><div class="line">    local.repeatInterval = kCFCalendarUnitDay;</div><div class="line">    //设置推送声音(本地需要有相对应的声音,该声音需要少于三十秒)</div><div class="line">    //local.soundName = UILocalNotificationDefaultSoundName;</div><div class="line">    local.soundName = @&quot;音效.caf&quot;;</div><div class="line">    local.userInfo = @&#123;@&quot;name&quot;:@&quot;王花花&quot;&#125;;</div><div class="line">    local.applicationIconBadgeNumber = 9999;</div><div class="line">    //加入到系统级推送</div><div class="line">    [[UIApplication sharedApplication] scheduleLocalNotification:local];</div></pre></td></tr></table></figure><p>清除本地推送</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//如何取消推送</div><div class="line">//获取目前已经加入本地消息推送的有几个.</div><div class="line">NSArray *array = [[UIApplication sharedApplication]scheduledLocalNotifications];</div><div class="line">//遍历推送内容</div><div class="line">for (UILocalNotification *notification in array) &#123;</div><div class="line">    NSLog(@&quot;%@&quot;,notification.userInfo);</div><div class="line">    //如果遇到我们想要取消的本地推送</div><div class="line">    [[UIApplication sharedApplication] cancelLocalNotification:notification];</div><div class="line">&#125;</div><div class="line">//如果全部取消</div><div class="line">//[[UIApplication sharedApplication]cancelAllLocalNotifications];</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>iOS多线程概念入门</title>
      <link href="/2016/03/01/cjjrthle2001hc7rdpt1cys34/"/>
      <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>我们为何需要多线程呢？多线程其实是为了实现并发执行，而且线程是并发执行多个代码路径的多种技术之中比较轻量级的一种（对应较重的实现是多进程）。</p><p>在单核 CPU 时代，支持多线程的操作系统会通过分配 CPU 计算时间，来实现软件层面的多线程。创建线程，线程间切换都是有成本开销的。但由于多线程可以避免阻塞所造成的 CPU 计算时间浪费，所以多线程所带来的开销成本总体看来是值得的。任务一般都可以被拆分成多个子任务，如果一个子任务发生了阻塞，计算时间就可以分配给其他子任务。这样就提高了 CPU 的利用率。</p><p>在多核 CPU 时代，就更好理解了。由于硬件上就支持多线程技术，就可以让多个线程真正同时地运行。如果任务能够被拆分，各个子任务就能并行地在 CPU 上运行，这就能显著加快运行速度。</p><p>总结说来，多线程的目的是，通过并发执行提高 CPU 的使用效率，进而提供程序运行效率。</p><p>OS X 和 iOS 是多线程操作系统，它们追随 UNIX 系统使用了 POSIX 线程模型。OS X 和 iOS 都提供了一套底层的 C 语言 POSIX 线程 API 来创建和管理线程。但实际应用开发中，除非需要跨平台，我们并不常直接使用 POSIX 线程 API，而是使用系统或语言提供的其他一些更为简单的方案。</p><h2 id="多线程基本概念"><a href="#多线程基本概念" class="headerlink" title="多线程基本概念"></a>多线程基本概念</h2><p>在了解多线程之前，我们应该先搞懂几个概念，首先了解几个基本概念</p><ol><li>进程</li><li>线程</li><li>多线程</li><li>主线程</li></ol><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>进程（process），是计算机中已运行程序的实体。在面向线程设计的系统中，进程是线程的容器。程序本身只是指令、数据以及其组织形式的描述，进程才是程序（那些指令和数据）的真正运行实例。若干进程有可能与同一个程序相关系，而且每个进程皆可以同步或者异步的方法独立运行。现代计算机系统刻在统一时间内以进程的形式将多个程序加载到存储器中，并且借由时间共享（分时复用），在一个处理器上表选出同时运行的感觉。同样的，使用多线程技术（多线程即每一个线程都代表一个进程内的一个独立执行上下文）的操作系统或计算机架构，同样程序的平行线程，可在多CPU主机或网络上真正同时运行（在不同的CPU上）</p><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>线程（英语：thread）是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。</p><h3 id="多线程（软件多线程）"><a href="#多线程（软件多线程）" class="headerlink" title="多线程（软件多线程）"></a>多线程（软件多线程）</h3><p>多线程（英语：multithreading），是指从软件或者硬件上实现多个线程并发执行的技术。具有多线程能力的计算机因有硬件支持而能够在同一时间执行多于一个执行绪，进而提升整体处理性能。</p><p>软件多线程。即便处理器只能运行一个线程，操作系统也可以通过快速的在不同线程之间进行切换，由于时间间隔很小，来给用户造成一种多个线程同时运行的假象。这样的程序运行机制被称为软件多线程。</p><h3 id="主线程"><a href="#主线程" class="headerlink" title="主线程"></a>主线程</h3><p>在一个 iOS 程序运行后，默认会开启1条线程。称之为主线程或者是 UI 线程。</p><p>主线程是进程的控制流或者执行线程在多线程程序中，主线可以创建一个或多个对等线程（peer thread），从这个时间点开始，这些线程就开始兵法执行，主线程和对等线程的区别仅在于主线程总是进程中第一个运行的线程。从某种程度上看，线程可以看做是轻量级的进程（lightweight process）。</p><p>每个程序都拥有独立的线程上下文（thread context），线程ID（Thread ID，TID），程序计数器（PC），线程栈（stack），一组寄存器（register）和条件码，其中内核正式通过线程ID（TID）来识别线程，进行线程调度的。</p><p>我们要知道，一条线程只能处理一个任务，如果将大规模运算放到主线程之中，就会造成 UI 界面卡顿的现象。</p><h2 id="线程进程的主要区别"><a href="#线程进程的主要区别" class="headerlink" title="线程进程的主要区别"></a>线程进程的主要区别</h2><p>线程和进程的主要区别在于子进程和父进程有不同的代码和数据空间，而多个线程则共享数据空间，每个线程有自己的执行堆栈和程序计数器为其知心上下文，多线程主要是为了节省CPU时间，发挥利用，根据具体情况而定。线程的运行需要使用计算机的内存资源和CPU。<br>​    </p><h3 id="多线程的优缺点"><a href="#多线程的优缺点" class="headerlink" title="多线程的优缺点"></a>多线程的优缺点</h3><h4 id="多线程的优点"><a href="#多线程的优点" class="headerlink" title="多线程的优点"></a>多线程的优点</h4><ol><li>能适当提高程序的执行效率</li><li>能适当提高资源利用率（CPU、内存利用率）</li></ol><h4 id="多线程的缺点"><a href="#多线程的缺点" class="headerlink" title="多线程的缺点"></a>多线程的缺点</h4><ol><li>开启线程需要占用一定的内存空间（默认情况下，主线程占用1M，子线程占用512KB），如果开启大量的线程，会占用大量的内存空间，降低程序的性能</li><li>线程越多，CPU在调度线程上的开销就越大</li><li>程序设计更加复杂：比如线程之间的通信、多线程的数据共享</li></ol><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] 维基百科</p><p>[3] <a href="http://www.infoq.com/cn/articles/os-x-ios-multithread-technology" target="_blank" rel="noopener">OS X 和 iOS 中的多线程技术 infoq</a></p><p>[2] <a href="http://blog.chinaunix.net/uid-20528014-id-333508.html" target="_blank" rel="noopener">fireaxe - Pthread编程基础 </a></p>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Objective-C Block的基本使用</title>
      <link href="/2016/02/17/231/"/>
      <content type="html"><![CDATA[<h2 id="什么是Block"><a href="#什么是Block" class="headerlink" title="什么是Block"></a>什么是Block</h2><p>Block是iOS4.0后推出的一种比较特殊的<strong>数据类型</strong>，用来保存某一段代码，可以在恰当的时间取出来再调用。，应用场景有:动画、多线程、集合遍历、网络请求回调等。</p><p>用Block替换代理可以使代码更加简洁、直观，苹果官方也更推荐使用block来进行传值等操作。</p><h2 id="Block-的定义"><a href="#Block-的定义" class="headerlink" title="Block 的定义"></a>Block 的定义</h2><p>定义和使用Block，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">-(void)viewDidLoad &#123;</div><div class="line"></div><div class="line">[super viewDidLoad];</div><div class="line">  </div><div class="line">//1、定义无参无返回值的Block</div><div class="line">void (^printBlock)() = ^()&#123;</div><div class="line">printf(&quot;no number&quot;);</div><div class="line">&#125;;</div><div class="line">  </div><div class="line">printBlock();</div><div class="line">printBlock(9);</div><div class="line">  </div><div class="line">int mutiplier = 7;</div><div class="line"></div><div class="line">//3、定义名为myBlock的代码块，返回值类型为int</div><div class="line">int (^myBlock)(int) = ^(int num)&#123;</div><div class="line">return num*mutiplier;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//使用定义的myBlock</div><div class="line">int newMutiplier = myBlock(3);</div><div class="line">printf(&quot;newMutiplier is %d&quot;,myBlock(3));</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//定义在-viewDidLoad方法外部</div><div class="line">//2、定义一个有参数，没有返回值的Block</div><div class="line">void (^printNumBlock)(int) = ^(int num)&#123;</div><div class="line">printf(&quot;int number is %d&quot;,num)；</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>定义Block变量，就相当于定义了一个函数。但是区别也很明显，因为函数肯定是在-viewDidLoad方法外面定义，而Block变量定义在了viewDidLoad方法内部。当然，我们也可以把Block定义在-viewDidLoad方法外部，例如上面的代码块printNumBlock的定义，就在-viewDidLoad外面。</p><p>再来看看上面代码运行的顺序问题，以第（3）个myBlock距离来说，在定义的地方，并不会执行Block{}内部的代码，而在myBlock(3)调用之后才会执行其中的代码，这跟函数的理解其实差不多，就是只要在调用Block（函数）的时候才会执行Block体内（函数体内）的代码。所以上面的简单代码示例，我可以作出如下的结论，</p><ol><li>在类中，定义一个Block变量，就像定义一个函数；</li><li>Block可以定义在方法内部，也可以定义在方法外部；</li><li>只有调用Block时候，才会执行其{}体内的代码；</li></ol><blockquote><p>关于第（2）条，定义在方法外部的Block，其实就是文件级别的全局变量</p></blockquote><p>那么在类中定义一个Block，特别是在-viewDidLoad方法体内定义一个Block到底有什么意义呢？我表示这时候只把它当做私有函数就可以了。我之前说过，Block其实就相当于代理，那么这时候我该怎样将其与代理类比以了解呢。这时候我可以这样说：本类中的Block就相当于类自己服从某个协议，然后让自己代理自己去做某个事情。很拗口吧？看看下面的代码，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//定义一个协议</div><div class="line">@protocol ViewControllerDelegate</div><div class="line">-(void)selfDelegateMethod;</div><div class="line">@end</div><div class="line">    </div><div class="line">//本类实现这个协议ViewControllerDelegate</div><div class="line">@interface ViewController ()</div><div class="line">@property (nonatomic, assign) id delegate;</div><div class="line">@end</div></pre></td></tr></table></figure><p>接着在-viewDidLoad中的代码如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">[super viewDidLoad];</div><div class="line">// Do any additional setup after loading the view from its nib.</div><div class="line">self.delegate = self;</div><div class="line">if (self.delegate &amp;&amp; [self.delegate respondsToSelector:@selector(selfDelegateMethod)] &#123;</div><div class="line">[self.delegate selfDelegateMethod];</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">        </div><div class="line">#pragma mark - ViewControllerDelegate method</div><div class="line">//实现协议中的方法</div><div class="line">- (void)selfDelegateMethod&#123;</div><div class="line">NSLog(@&quot;自己委托自己实现的方法&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>看出这种写法的奇葩地方了吗？自己委托自己去实现某个方法，而不是委托别的类去实现某个方法。本类中定义的一个Block其实就是闲的蛋疼，委托自己去字做某件事情，实际的意义不大，所以你很少看见别人的代码直接在类中定义Block然后使用的，Block很多的用处是跨越两个类来使用的，比如作为property属性或者作为方法的参数，这样就能跨越两个类了。</p><h2 id="block关键字的使用"><a href="#block关键字的使用" class="headerlink" title="__block关键字的使用"></a>__block关键字的使用</h2><p>在Block的{}体内，是不可以对外面的变量进行更改的，比如下面的语句，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">//将Block定义在方法内部</div><div class="line">int x = 100;</div><div class="line">void (^sumXAndYBlock)(int) = ^(int y)&#123;</div><div class="line">x = x+y;</div><div class="line">printf(&quot;new x value is %d&quot;,x);</div><div class="line">&#125;;</div><div class="line">sumXAndYBlock(50);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这段代码有什么问题呢，Xcode会提示x变量错误信息：Variable is not assigning (missing__block type)，这时候给int x = 100;语句前面加上__block关键字即可，如下，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__block int x = 100;</div></pre></td></tr></table></figure><p>这样在Block的{}体内，就可以修改外部变量了。</p><h3 id="Block作为Property属性实现页面之间传值"><a href="#Block作为Property属性实现页面之间传值" class="headerlink" title="Block作为Property属性实现页面之间传值"></a>Block作为Property属性实现页面之间传值</h3><p>需求：在ViewController中，点击Button，push到下一个页面NextViewController，在NextViewController的输入框TextField中输入一串字符，返回的时候，在ViewController的Label上面显示文字内容，</p><p><strong>1、第一种方法：首先看看通过“协议/代理”是怎么实现两个页面之间传值的吧，</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//NextViewController是push进入的第二个页面</div><div class="line">//NextViewController.h 文件</div><div class="line">//定义一个协议，前一个页面ViewController要服从该协议，并且实现协议中的方法</div><div class="line">@protocol NextViewControllerDelegate</div><div class="line">- (void)passTextValue:(NSString *)tfText;</div><div class="line">@end</div><div class="line">  </div><div class="line">@interface NextViewController : UIViewController</div><div class="line">@property (nonatomic, assign) id delegate;</div><div class="line">@end</div></pre></td></tr></table></figure><p>//NextViewController.m 文件<br>//点击Button返回前一个ViewController页面</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (IBAction)popBtnClicked:(id)sender &#123;</div><div class="line">if (self.delegate &amp;&amp; [self.delegate respondsToSelector:@selector(passTextValue:)]) &#123;</div><div class="line">//self.inputTF是该页面中的TextField输入框</div><div class="line">    [self.delegate passTextValue:self.inputTF.text];</div><div class="line">&#125;</div><div class="line">[self.navigationController popViewControllerAnimated:YES];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>接下来我们在看看ViewController文件中的内容，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">//ViewController.m 文件</div><div class="line">@interface ViewController ()</div><div class="line">@property (strong, nonatomic) IBOutlet UILabel *nextVCInfoLabel;</div><div class="line">@end</div><div class="line">//点击Button进入下一个NextViewController页面</div><div class="line">- (IBAction)btnClicked:(id)sender</div><div class="line">&#123;</div><div class="line">NextViewController *nextVC = [[NextViewController alloc] initWithNibName:@&quot;NextViewController&quot; bundle:nil];</div><div class="line">nextVC.delegate = self;//设置代理</div><div class="line">[self.navigationController pushViewController:nextVC animated:YES];</div><div class="line">&#125;</div><div class="line">//实现协议NextViewControllerDelegate中的方法</div><div class="line">#pragma mark - NextViewControllerDelegate method</div><div class="line">- (void)passTextValue:(NSString *)tfText</div><div class="line">&#123;</div><div class="line">//self.nextVCInfoLabel是显示NextViewController传递过来的字符串Label对象</div><div class="line">self.nextVCInfoLabel.text = tfText;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这是通过“协议/代理”来实现的两个页面之间传值的方式。<br><strong>2、第二种方法：使用Block作为property，实现两个页面之间传值，</strong><br>先看看NextViewController文件中的内容，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//NextViewController.h 文件</div><div class="line">@interface NextViewController : UIViewController</div><div class="line">@property (nonatomic, copy) void (^NextViewControllerBlock)(NSString *tfText);</div><div class="line">@end</div><div class="line">//NextViewContorller.m 文件</div><div class="line">- (IBAction)popBtnClicked:(id)sender &#123;</div><div class="line">if (self.NextViewControllerBlock) &#123;</div><div class="line">self.NextViewControllerBlock(self.inputTF.text);</div><div class="line">&#125;</div><div class="line">[self.navigationController popViewControllerAnimated:YES];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>再来看看ViewController文件中的内容，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (IBAction)btnClicked:(id)sender&#123;</div><div class="line">NextViewController *nextVC = [[NextViewController alloc] initWithNibName:@&quot;NextViewController&quot; bundle:nil];</div><div class="line">nextVC.NextViewControllerBlock = ^(NSString *tfText)&#123;</div><div class="line">[self resetLabel:tfText];</div><div class="line">&#125;;</div><div class="line">[self.navigationController pushViewController:nextVC animated:YES];</div><div class="line">&#125;</div><div class="line">#pragma mark - NextViewControllerBlock method</div><div class="line">- (void)resetLabel:(NSString *)textStr &#123;</div><div class="line">self.nextVCInfoLabel.text = textStr;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>好了就这么多代码，可以使用Block来实现两个页面之间传值的目的，实际上就是取代了Delegate的功能。</p><p>另外，博客中的代码Sample Code可以再Github下载，如果因为Github被墙了，可以在终端使用git clone + 完整链接，即可克隆项目到本地。</p><p>Github中的代码，可以开启两种调试模式，你需要在项目的配置文件BlockSamp-Prefix.pch中注释或者解注释下面的代码.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define Debug_BlcokPassValueEnable</div></pre></td></tr></table></figure><p>即可开启两种调试的方式，如果注释了上面的语句就是使用Delegate进行调试；否则使用Block进行调试。</p>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CGFloat、CGPoint、CGSize和CGRect</title>
      <link href="/2016/01/31/2/"/>
      <content type="html"><![CDATA[<p>CGFloat、CGPoint、CGSize和CGRect主要是用来描述UI控件的几何属性的基本类型。</p><ul><li>CGFloat: 浮点值的基本类型</li><li>CGPoint: 表示一个二维坐标系中的点</li><li>CGSize: 表示一个矩形的宽度和高度</li><li>CGRect: 表示一个矩形的位置和大小</li></ul><h2 id="CGFloat"><a href="#CGFloat" class="headerlink" title="CGFloat"></a>CGFloat</h2><p>CGFloat是这四种类型中最基本的类型，这是一个浮点型的数据，他就是一个数值，下面三种类型都需要使用该数值来进行赋值，当我们使用CMD键进入CGBase.h文件后，可以清楚的看到关于CGFloat的定义，映入眼帘的是一个别名定义：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> CGFLOAT_TYPE CGFloat;</div></pre></td></tr></table></figure><p>当我们CMD点击CGFLOAT_TYPE的时候，我们可以跳转到宏定义的代码区域，其实就在其上面</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__) &amp;amp;&amp;amp; __LP64__</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_TYPE double</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_IS_DOUBLE 1</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_MIN DBL_MIN</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_MAX DBL_MAX</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_TYPE float</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_IS_DOUBLE 0</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_MIN FLT_MIN</span></div><div class="line"><span class="meta"># <span class="meta-keyword">define</span> CGFLOAT_MAX FLT_MAX</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure><p>我们可以清晰的看到这就是一段宏定义，#if defined(<strong>LP64</strong>) &amp;&amp; <strong>LP64</strong>这一段代码主要使用来判断操作系统是64位还是32位，如果是64位那么CGFloat就是double类型，如果不是那边是32位操作系统，则会被系统定义为float类型,接下来的三种类型都是基于CGFloat的结构体。</p><h2 id="CGPoint"><a href="#CGPoint" class="headerlink" title="CGPoint"></a>CGPoint</h2><p>CGPoint用于表示二维坐标系中的某一个点，在IOS中以左上角（0，0）为起始坐标。<br>CMD进入CGGeometry.h中便可以直接查看其类型的定义如下（CGSize、CGRect都在此文件中）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CGPoint</span> &#123;</span></div><div class="line">    CGFloat x;</div><div class="line">    CGFloat y;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CGPoint</span> <span class="title">CGPoint</span>;</span></div></pre></td></tr></table></figure><h2 id="CGSize"><a href="#CGSize" class="headerlink" title="CGSize"></a>CGSize</h2><p>CGSize主要用于描述UI控件的宽与高</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CGSize</span> &#123;</span></div><div class="line">    CGFloat width;</div><div class="line">    CGFloat height;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CGSize</span> <span class="title">CGSize</span>;</span></div></pre></td></tr></table></figure><h2 id="CGRect"><a href="#CGRect" class="headerlink" title="CGRect"></a>CGRect</h2><p>CGRect同样也是一个结构体，通过上面的了解，我们知道了原来CGRect是由CGSize和CGPoint组成，这样一来便可以确定一个UI空间的大小与位置。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CGRect</span> &#123;</span></div><div class="line">    CGPoint origin;</div><div class="line">    CGSize size;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CGRect</span> <span class="title">CGRect</span>;</span></div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>懒加载与模型转换</title>
      <link href="/2016/01/30/219/"/>
      <content type="html"><![CDATA[<p>所谓的懒加载其实就是重写getter方法，以实现实例化类的同时自动加载数据，简化代码的一个作用,代码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//这是一个实例</div><div class="line">-(NSArray*)question&#123;</div><div class="line">if (!_question) &#123;</div><div class="line">//判断是否为空</div><div class="line">_question = [GZModelName questionList];</div><div class="line">&#125;</div><div class="line">return _question;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>接下来便是模型转化,因为使用点语法写起来的方法也非常简单，只需要重新定义构造方法即可,其中用到的plist文件如下图：</p><p><a href="http://www.aircrayon.xyz/wp-content/uploads/2016/01/1.png" target="_blank" rel="noopener"><img src="http://www.aircrayon.xyz/wp-content/uploads/2016/01/1-300x97.png" alt="1"></a></p><p>.h文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@interface GZQuestion : NSObject</div><div class="line">@property (nonatomic,copy) NSString *answer;</div><div class="line">@property (nonatomic,copy) NSString *icon;</div><div class="line">@property (nonatomic,copy) NSString *title;</div><div class="line">@property (nonatomic,strong) NSArray *options;</div><div class="line">-(instancetype)initWithDic:(NSDictionary *)dic;</div><div class="line">+(instancetype)questionWithDic:(NSDictionary *)dic;</div><div class="line">+(NSArray*)questionList;</div><div class="line">@end</div></pre></td></tr></table></figure><p>.m文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">-(instancetype)initWithDic:(NSDictionary *)dic&#123;</div><div class="line">if (self = [super init]) &#123;</div><div class="line">//KVC 直接从字典中读取对应的值，需要注意的是，定义的属性名称，要与字典的key值相对应，否则会崩溃</div><div class="line">[self setValuesForKeysWithDictionary:dic];</div><div class="line">&#125;</div><div class="line">return self;</div><div class="line">&#125;</div><div class="line">+(instancetype)questionWithDic:(NSDictionary *)dic&#123;</div><div class="line">return [[self alloc]initWithDic:dic];</div><div class="line">&#125;</div><div class="line">+(NSArray *)questionList&#123;</div><div class="line">//加载plist</div><div class="line">NSString *path = [[NSBundle mainBundle] pathForResource:@&quot;questions&quot; ofType:@&quot;plist&quot;];</div><div class="line">NSArray *dicArray = [NSArray arrayWithContentsOfFile:path];</div><div class="line">//字典转模型</div><div class="line">NSMutableArray *tempArray = [NSMutableArray array];</div><div class="line">for (NSDictionary *dic in dicArray) &#123;</div><div class="line">GZQuestion *question = [GZQuestion questionWithDic:dic];</div><div class="line">[tempArray addObject:question];</div><div class="line">&#125;</div><div class="line">return tempArray;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Objective-C </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Objective-C 简单的数组排序</title>
      <link href="/2016/01/05/3/"/>
      <content type="html"><![CDATA[<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NSMutableArray *array  = [NSMutableArray arrayWithObjects:@"8123",@"456",@"378", nil];</div><div class="line"></div><div class="line">NSComparator cmp = ^(id obj,id obj1) &#123;</div><div class="line">return [obj compare:obj1];</div><div class="line">&#125;;</div><div class="line"></div><div class="line">[array sortUsingComparator:cmp];</div><div class="line"></div><div class="line">NSLog(@"%@",array);&lt;/pre&gt;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>iOS图层树</title>
      <link href="/2015/12/21/cjjrthldp000yc7rd7r255631/"/>
      <content type="html"><![CDATA[<h1 id="图层树"><a href="#图层树" class="headerlink" title="图层树"></a>图层树</h1><p>Core Animation 是一个符合引擎，塔的职责就是尽可能快地组合屏幕上不同的可视内容，这个内容被分分解成独立的图层，存储在一个叫做图层数的体系中，于是这个树形成了 UIKit 以及在 iOS 10应用程序当中你所看能在屏幕上看见的一切的基础。</p><h2 id="图层与视图"><a href="#图层与视图" class="headerlink" title="图层与视图"></a>图层与视图</h2><p>如果你曾经在 iOS 10或MacOS 平台上面写过应用程序，你可能能会对视图的概念比较熟悉。一个视图就是在屏幕上显示一个矩形块（比如图片，文字或者视频），它能拦截类似于鼠标点击或者触摸手势等用户输入。视图在层级关系中可以互相嵌套，一个视图可以管理它的所有子视图的位置。图1.1显示了一种典型的视图层级关系。</p><p><img src="https://zsisme.gitbooks.io/ios-/content/chapter1/1.1.jpeg" alt=""></p><p>图1.1一种典型的 iOS 屏幕（左边）和型城市图的层级关系（右边）</p><p>在 iOS 中，所有的视图都从一个叫做 UIview 的基类派生而来，UIView 可以处理触摸事件，可以支持基于 Core Graphics 绘图，可以做仿射变换（例如旋转或者缩放），或者简单的类似于滑动或者渐变的动画。</p><h2 id="CALayer"><a href="#CALayer" class="headerlink" title="CALayer"></a>CALayer</h2><p>CALayer类在概念上和 UIView 类似，同样也是一些被层级关系树管理的矩形块，同样可以包含一些内容（像图片，文本或者背景色），管理子视图的位置。它们有一些方法和尚需经用来做动画和变换。</p><p>和 UIview 最大的不同是 CALayer 不处理用户的交互。</p><p>CALayer 兵不清楚具体的响应链（iOS通过视图层级关系用来传递触摸事件的机制），于是它并不能够响应事件，即使它提供了一些方法来判断是否一个触电在图层的范围之内。</p><h2 id="平行的层级关系"><a href="#平行的层级关系" class="headerlink" title="平行的层级关系"></a>平行的层级关系</h2><p>每一个 UIView 都有一个 CALayer 实例的图层属性，也就是所谓的 Backing layer,视图的职责就是创建并管理这个图层，以确保子视图在层级关系中添加或者被移除的时候，他们关联的图层也同样对应是在层级关系树当中有相同的操作（见图1.2）</p><p><img src="https://zsisme.gitbooks.io/ios-/content/chapter1/1.2.jpeg" alt=""></p><p>图1.2 图层的树状结构（左边）以及对应的视图层级（右边）</p><p>实际上这些背后关联的图层才是真正用来在屏幕上显示和做动画，UIView 仅仅是对它的一个封装，提供了一些 iOS 类似于处理触摸事件的具体功能，以及 Core Animation 底层方法的高级借口。</p><p>但是为什么 iOS 要基于 UIview 和 CALayer 提供两个平行的层级关系呢？为什么不用一个简单的层级来处理所有事情呢？原因在于要做职责分离，这也是能避免很多重复代码。在 iOS 和 Mac OS两个平台上，时间和用户交互有很多地方不同，基于多点触控的用户界面和基于鼠标键盘有着本质的区别，这就是为什么 iOS有 UIKit 和 UIView，但是 MacOS 有 APPKit 和 NSView 的元婴。他们功能上很类似，但是在实现上有着显著的区别。</p><p>绘图，布局和动画，相比之下就是类似Mac笔记本和桌面系列一样应用于iPhone和iPad触屏的概念。把这种功能的逻辑分开并应用到独立的Core Animation框架，苹果就能够在iOS和Mac OS之间共享代码，使得对苹果自己的OS开发团队和第三方开发者去开发两个平台的应用更加便捷。+</p><p>实际上，这里并不是两个层级关系，而是四个，每一个都扮演不同的角色，除了视图层级和图层树之外，还存在呈现树和渲染树，</p>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>iOS多线程</title>
      <link href="/2015/12/10/1/"/>
      <content type="html"><![CDATA[<p>NSObject 提供了以 performSelector 为前缀的一系列方法。它们可以让用户在制定的线程中、或者立即、延迟执行某个方法调用个。这个方法给用户实现多线程编程最简单的方法。</p><p>在当前线程中执行方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)performSelector:(SEL)aSelector withObject:(id)anArgument afterDelay:(NSTimeInterval)delay</div><div class="line"></div><div class="line">- (void)performSelector:(SEL)aSelector withObject:(id)anArgument afterDelay: (NSTimeInterval)delay inModes:(NSArray *)modes</div></pre></td></tr></table></figure><p>在指定线程中执行方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thread </div><div class="line">withObject:(id)arg waitUntilDone:(BOOL)wait</div><div class="line"></div><div class="line">- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thread withObject:</div><div class="line">(id)arg waitUntilDone:(BOOL)wait modes:(NSArray *)array</div></pre></td></tr></table></figure><p>在主线程中执行方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)performSelectorOnMainThread: (SEL)selector withObject:(id)argument </div><div class="line">waitUntilDone:(BOOL)wait</div><div class="line"></div><div class="line">- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(id)arg </div><div class="line">waitUntilDone:(BOOL)wait modes:(NSArray *)array</div></pre></td></tr></table></figure><p>在后台线程中执行方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)performSelectorInBackground:(SEL)aSelector withObject:(id)arg</div></pre></td></tr></table></figure><p>这一系列方法简单易用，但只提供了有限的几个选择：指定执行的方法（但传入方法的参数数量有限制）；指定是在当前线程，还是在主线程，还是在后台线程执行；指定是否需要阻塞当前线程等待结果。</p><p>例如，以下代码使得方法 foo: 在一个新的后台线程执行，并传入了 object 参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SEL selector ＝ @selector(foo:);</div><div class="line">[self performSelectorInBackground:selector withObject:object];</div></pre></td></tr></table></figure><p>以下代码使得 updateUI 方法在主线程内得到执行，并且当前线程会被阻塞，直到主线程执行完该函数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self performSelectorOnMainThread:@selector(updateUI) withObject:nil waitUntilDone:YES];</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Objc,多线程 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title></title>
      <link href="/2015/12/02/1/"/>
      <content type="html"><![CDATA[<p>当一个方法在类定义内部被调用时，有一个可用的伪变量 $this。$this 是一个到主叫对象的引用（通常是该方法所从属的对象，但如果是从第二个对象静态调用时也可能是另一个对象）。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleClass</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// property declaration</span></div><div class="line">    <span class="keyword">public</span> $var = <span class="string">'a default value'</span>;</div><div class="line"></div><div class="line">    <span class="comment">// method declaration</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;var;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure><p><strong>$this 伪变量的示例</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>)) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">'$this is defined ('</span>;</div><div class="line">            <span class="keyword">echo</span> get_class(<span class="keyword">$this</span>);</div><div class="line">            <span class="keyword">echo</span> <span class="string">")\n"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"\$this is not defined.\n"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// <span class="doctag">Note:</span> the next line will issue a warning if E_STRICT is enabled.</span></div><div class="line">        A::foo();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$a = <span class="keyword">new</span> A();</div><div class="line">$a-&gt;foo();</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">Note:</span> the next line will issue a warning if E_STRICT is enabled.</span></div><div class="line">A::foo();</div><div class="line">$b = <span class="keyword">new</span> B();</div><div class="line">$b-&gt;bar();</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">Note:</span> the next line will issue a warning if E_STRICT is enabled.</span></div><div class="line">B::bar();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure><p>以上例程会输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span>this is defined (A)</div><div class="line"><span class="meta"></span></div><div class="line">$this is not defined.</div><div class="line"><span class="meta"></span></div><div class="line">$this is defined (B)</div><div class="line"><span class="meta"></span></div><div class="line">$this is not defined.</div></pre></td></tr></table></figure><p>由于静态方法不需要通过对象即可调用，所以伪变量 $this 在静态方法中不可用。用静态方式调用一个非静态方法会导致一个 <strong>E_STRICT</strong> 级别的错误。</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>PHP基础教程：将Session存储到MySQL中</title>
      <link href="/2015/10/20/1/"/>
      <content type="html"><![CDATA[<p>我们知道，Session是一种会话技术，用来实现跨脚本共享数据。Session是存放在服务器端的文件里的，因此Session有可能因为文件数量过多，会在查询 Session 文件以及读取的时候产生压力。一般我们有三种解决方案</p><ol><li>使用文件分层（缺点：I/O操作是系统的一个瓶颈，即使分层也不能避免此问题）</li><li>将session放入数据库</li><li>将session放在内存中（非关系性数据库）（缺点：对服务器内存要求教高）</li></ol><p>将Session存入MySQL数据库，也就是我们要讲的重点（其实并不建议这么做，因为在高并发和大流量的情况下，无疑会增加MySQL的压力，建议放到缓存服务中，如Memcache、Redis），</p><p>要实现session入库，首先我们要了解session 机制：</p><p>在PHP中，Session 可以理解为一套单独的小系统，在该系统中有很多关于 Session 的处理方法，用来解决各种问题，用户只需要在 Session 之外，调用session_start函数（session系统的一个接口）</p><p>其他操作都是session系统帮忙去处理</p><p><img src="http://ogxeww23n.bkt.clouddn.com/528226-20160317093240693-1557806104.png" alt="img"></p><p>由图可知我们应该修改session机制中的session的读取和最终的写入。要修改session机制要借助一个系统函数session_set_save_handler():用来使用外部用户定义的函数，来取代session系统本身的函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bool session_set_save_handler ( callable $open , callable $close , callable $read , callable $write , callable $destroy , callable $gc [, callable $create_sid [, callable $validate_sid [, callable $update_timestamp ]]] )</div></pre></td></tr></table></figure><p><code>open(string $savePath, string $sessionName)</code></p><p>open 回调函数类似于类的构造函数， 在会话打开的时候会被调用。 这是自动开始会话或者通过调用 <a href="http://php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">session_start()</a> 手动开始会话 之后第一个被调用的回调函数。 此回调函数操作成功返回 <strong>TRUE</strong>，反之返回 <strong>FALSE</strong>。</p><p><code>close()</code></p><p>close 回调函数类似于类的析构函数。 在 write 回调函数调用之后调用。 当调用 <a href="http://php.net/manual/zh/function.session-write-close.php" target="_blank" rel="noopener">session_write_close()</a> 函数之后，也会调用 close 回调函数。 此回调函数操作成功返回 <strong>TRUE</strong>，反之返回 <strong>FALSE</strong>。</p><p><code>read(string $sessionId)</code></p><p>如果会话中有数据，read 回调函数必须返回将会话数据编码（序列化）后的字符串。 如果会话中没有数据，read 回调函数返回空字符串。</p><p>在自动开始会话或者通过调用 <a href="http://php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">session_start()</a> 函数手动开始会话之后，PHP 内部调用 read 回调函数来获取会话数据。 在调用 read 之前，PHP 会调用 open 回调函数。</p><p>read 回调返回的序列化之后的字符串格式必须与 <code>write</code> 回调函数保存数据时的格式完全一致。 PHP 会自动反序列化返回的字符串并填充<a href="http://php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a> 超级全局变量。 虽然数据看起来和 <a href="http://php.net/manual/zh/function.serialize.php" target="_blank" rel="noopener">serialize()</a> 函数很相似， 但是需要提醒的是，它们是不同的。 请参考：<a href="http://php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" target="_blank" rel="noopener">session.serialize_handler</a>。</p><p><code>write(string $sessionId, string $data)</code></p><p>在会话保存数据时会调用 <code>write</code> 回调函数。 此回调函数接收当前会话 ID 以及 <a href="http://php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a> 中数据序列化之后的字符串作为参数。 序列化会话数据的过程由 PHP 根据 <a href="http://php.net/manual/zh/session.configuration.php#ini.session.serialize-handler" target="_blank" rel="noopener">session.serialize_handler</a> 设定值来完成。</p><p>序列化后的数据将和会话 ID 关联在一起进行保存。 当调用 <code>read</code> 回调函数获取数据时，所返回的数据必须要和 传入 <code>write</code> 回调函数的数据完全保持一致。</p><p>PHP 会在脚本执行完毕或调用 <a href="http://php.net/manual/zh/function.session-write-close.php" target="_blank" rel="noopener">session_write_close()</a> 函数之后调用此回调函数。 注意，在调用完此回调函数之后，PHP 内部会调用 <code>close</code>回调函数。</p><blockquote><p><strong>Note</strong>:</p><p>PHP 会在输出流写入完毕并且关闭之后 才调用 write 回调函数， 所以在 write 回调函数中的调试信息不会输出到浏览器中。 如果需要在 write 回调函数中使用调试输出， 建议将调试输出写入到文件。</p></blockquote><p><code>destroy($sessionId)</code></p><p>当调用 <a href="http://php.net/manual/zh/function.session-destroy.php" target="_blank" rel="noopener">session_destroy()</a> 函数， 或者调用 <a href="http://php.net/manual/zh/function.session-regenerate-id.php" target="_blank" rel="noopener">session_regenerate_id()</a> 函数并且设置 destroy 参数为 <strong>TRUE</strong> 时， 会调用此回调函数。此回调函数操作成功返回 <strong>TRUE</strong>，反之返回 <strong>FALSE</strong>。</p><p><code>gc($lifetime)</code></p><p>为了清理会话中的旧数据，PHP 会不时的调用垃圾收集回调函数。 调用周期由 <a href="http://php.net/manual/zh/session.configuration.php#ini.session.gc-probability" target="_blank" rel="noopener">session.gc_probability</a> 和 <a href="http://php.net/manual/zh/session.configuration.php#ini.session.gc-divisor" target="_blank" rel="noopener">session.gc_divisor</a> 参数控制。 传入到此回调函数的 lifetime 参数由 <a href="http://php.net/manual/zh/session.configuration.php#ini.session.gc-maxlifetime" target="_blank" rel="noopener">session.gc_maxlifetime</a> 设置。 此回调函数操作成功返回 <strong>TRUE</strong>，反之返回 <strong>FALSE</strong>。</p><p><code>create_sid()</code></p><p>当需要新的会话 ID 时被调用的回调函数。 回调函数被调用时无传入参数， 其返回值应该是一个字符串格式的、有效的会话 ID。</p><p>因此我们要准备六个函数。</p><p>代码实现：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">//session入库</span></div><div class="line"></div><div class="line"><span class="comment">//以为修改session机制必须借助session_set_save_handler()函数，该函数需要6个可以调用的回调函数，因此需要创建6个人对应的函数</span></div><div class="line"></div><div class="line"><span class="comment">//1.开启session机制</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sess_open</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//开启资源</span></div><div class="line">    <span class="comment">//连接数据库</span></div><div class="line">    mysql_connect(<span class="string">'localhost'</span>,<span class="string">'root'</span>,<span class="string">''</span>);</div><div class="line">    mysql_query(<span class="string">'set names utf8'</span>);</div><div class="line">    mysql_query(<span class="string">'use session'</span>);</div><div class="line">    <span class="keyword">echo</span> <span class="function"><span class="keyword">FUNCTION</span>,'&lt;<span class="title">br</span>/&gt;'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//2.关闭session</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sess_close</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//关闭资源</span></div><div class="line">    mysql_close();</div><div class="line">    <span class="keyword">echo</span> <span class="function"><span class="keyword">FUNCTION</span>,'&lt;<span class="title">br</span>/&gt;'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//3.读取session</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sess_read</span><span class="params">($sess_id)</span> </span>&#123;</div><div class="line">    <span class="comment">//从数据库读取数据</span></div><div class="line">    <span class="comment">//根据sess_id（由系统提供）获取数据</span></div><div class="line">    <span class="comment">//读数据时要过滤掉过期的数据</span></div><div class="line">    $expire=time()-ini_get(<span class="string">'session.gc_maxlifetime'</span>);</div><div class="line">    $sql=<span class="string">"selsct * from session where sess_id='&#123;$sess_id&#125;' and sess_expire&gt;='&#123;$expire&#125;'"</span>;</div><div class="line">    res=mysql_query(sql);</div><div class="line"></div><div class="line">    <span class="comment">//得到的是一个数组</span></div><div class="line">    <span class="keyword">if</span>(sess=@mysql_fetch_assoc(res)) &#123;</div><div class="line">        <span class="comment">//得到一个序列化后的字符串</span></div><div class="line">        <span class="comment">//要进行反序列化，read只负责读取数据，不负责加工数据</span></div><div class="line">        <span class="keyword">return</span> $sess[<span class="string">'sess_info'</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">echo</span> <span class="function"><span class="keyword">FUNCTION</span>,'&lt;<span class="title">br</span>/&gt;'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//4.写入session</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sess_write</span><span class="params">(sess_id,sess_info)</span> </span>&#123;</div><div class="line">    <span class="comment">//向数据库中写入数据</span></div><div class="line">    $time=time();</div><div class="line">    $sql=<span class="string">"replace into session values('&#123;$sess_id&#125;','&#123;$sess_info&#125;','&#123;$time&#125;')"</span>;</div><div class="line">    mysql_query($sql);</div><div class="line">    <span class="keyword">echo</span> <span class="function"><span class="keyword">FUNCTION</span>,'&lt;<span class="title">br</span>/&gt;'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//5.销毁session</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sess_destroy</span><span class="params">($sess_id)</span> </span>&#123;</div><div class="line">    $sql=<span class="string">"delete from session where sess_id='&#123;$sess_id&#125;'"</span>;</div><div class="line">    <span class="keyword">return</span> mysql_query($sql);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//6.回收session</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sess_gc</span><span class="params">()</span> </span>&#123; </div><div class="line">    <span class="comment">//从数据库删除过期的session数据</span></div><div class="line">    <span class="comment">//判断session是否过期，过期的删除</span></div><div class="line">    $expire=ini_get(<span class="string">'session.gc_maxlifetime'</span>);</div><div class="line">    <span class="comment">//得到最迟的时间，在$expire之前的都是过期的</span></div><div class="line">    expire=time()-expire;</div><div class="line">    $sql=<span class="string">"delete from session where sess_expire &lt; '&#123;expire&#125;'"</span>;</div><div class="line">    <span class="keyword">return</span> mysql_query($sql);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//使用session_set_save_handler()修改session机制</span></div><div class="line">session_set_save_handler(<span class="string">'sess_open'</span>,<span class="string">'sess_close'</span>,<span class="string">'sess_read'</span>,<span class="string">'sess_write'</span>,<span class="string">'sess_destroy'</span>,<span class="string">'sess_gc'</span>);</div><div class="line"></div><div class="line"><span class="comment">//想要使用session，必须要用session_start()来开启</span></div><div class="line">session_start();</div><div class="line"></div><div class="line">$_SESSION[<span class="string">'name'</span>]=<span class="string">'wangqixing'</span>;</div><div class="line"></div><div class="line">$_SESSION[<span class="string">'age'</span>]=<span class="string">'23'</span>;</div><div class="line"></div><div class="line"><span class="comment">//session_destroy();</span></div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Cookie和Session</title>
      <link href="/2015/10/19/1/"/>
      <content type="html"><![CDATA[<h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><p>HTTP协议是无状态的，也就导致服务器无法分片是谁浏览了网页，为了解决此问题，1994年网景通讯的一名员工 Lou Montulli将 “magic cookies” 的概念应用到 Web 通讯中。他试图解决 Web 的第一个购物车应用，现在购物车成了购物网站的支柱。他的原始说明文档提供了 cookie 工作原理的基本信息，该文档后来被作为规范纳入到 RFC 2109（大多数浏览器的实现参考文档）中，最终被纳入到 RFC 2965 中。Montulli 也被授予 cookie 的美国专利。网景浏览器在它的第一个版本中就开始支持 cookie，现在所有 Web 浏览器都支持 cookie。</p><p>cookie是浏览器保存在用户电脑上的一小段文本，用来保存用户在网站上的必要的信息。Web页面或服务器告诉浏览器按照一定的规范存储这些信息，并且在以后的所有请求中，这些信息就会自动加在HTTP请求头中发送给服务器，服务器根据这些信息判断不同的用户。并且cookie本身是安全的。</p><h3 id="创建Cookie"><a href="#创建Cookie" class="headerlink" title="创建Cookie"></a>创建Cookie</h3><p>Web 服务器通过发送一个称为 Set-Cookie 的 HTTP 消息头来创建一个 cookie，Set-Cookie消息头是一个字符串，其格式如下（中括号中的部分是可选的）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Set-Cookie: value; expires=date; path=path</div></pre></td></tr></table></figure><p>在PHP开发过程中，我们可以使用<strong>setcookie</strong>函数来进行设置：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bool setcookie ( string $name [, string $value = <span class="string">""</span> [, int $expire = <span class="number">0</span> [, string $path = <span class="string">""</span> [, string $domain = <span class="string">""</span> [, bool $secure = <span class="keyword">false</span> [, bool $httponly = <span class="keyword">false</span> ]]]]]] )</div></pre></td></tr></table></figure><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p><strong>name：</strong> Cookie 名称。</p><p><strong>value： </strong>Cookie 值。 这个值储存于用户的电脑里，请勿储存敏感信息。 比如 <code>name</code> 是 <em>‘cookiename’</em>， 可通过 $_COOKIE[‘cookiename’]获取它的值。</p><p><strong>expire</strong>： Cookie 的过期时间。 这是个 Unix 时间戳，即 Unix 纪元以来（格林威治时间 1970 年 1 月 1 日 00:00:00）的秒数。 也就是说，基本可以用<a href="http://php.net/manual/zh/function.time.php" target="_blank" rel="noopener">time()</a> 函数的结果加上希望过期的秒数。 或者也可以用 <a href="http://php.net/manual/zh/function.mktime.php" target="_blank" rel="noopener">mktime()</a>。 <em>time()+60\</em>60<em>24</em>30* 就是设置 Cookie 30 天后过期。 如果设置成零，或者忽略参数， Cookie 会在会话结束时过期（也就是关掉浏览器时）。</p><blockquote><p><strong>Note</strong>:</p><p>你可能注意到了，<code>expire</code> 使用 Unix 时间戳而非 <em>Wdy, DD-Mon-YYYY HH:MM:SS GMT</em> 这样的日期格式，是因为 PHP 内部作了转换。</p></blockquote><p><strong>path:</strong> Cookie 有效的服务器路径。 设置成 <em>‘/‘</em> 时，Cookie 对整个域名 <code>domain</code> 有效。 如果设置成 <em>‘/foo/‘</em>， Cookie 仅仅对 <code>domain</code> 中 <em>/foo/</em> 目录及其子目录有效（比如 <em>/foo/bar/</em>）。 默认值是设置 Cookie 时的当前目录。</p><p><strong>domain</strong>: Cookie 的有效域名/子域名。 设置成子域名（例如 <em>‘www.example.com’</em>），会使 Cookie 对这个子域名和它的三级域名有效（例如 w2.www.example.com）。 要让 Cookie 对整个域名有效（包括它的全部子域名），只要设置成域名就可以了（这个例子里是<em>‘example.com’</em>）。</p><p>旧版浏览器仍然在使用废弃的 <a href="http://www.faqs.org/rfcs/rfc2109" target="_blank" rel="noopener">» RFC 2109</a>， 需要一个前置的点 <em>.</em> 来匹配所有子域名。</p><p><strong>secure:</strong> 设置这个 Cookie 是否仅仅通过安全的 HTTPS 连接传给客户端。 设置成 <strong>TRUE</strong> 时，只有安全连接存在时才会设置 Cookie。 如果是在服务器端处理这个需求，程序员需要仅仅在安全连接上发送此类 Cookie （通过 <a href="http://php.net/manual/zh/reserved.variables.server.php" target="_blank" rel="noopener">$_SERVER[“HTTPS”]</a> 判断）。</p><p><strong>httponly : </strong>设置成 <strong>TRUE</strong>，Cookie 仅可通过 HTTP 协议访问。 这意思就是 Cookie 无法通过类似 JavaScript 这样的脚本语言访问。 要有效减少 XSS 攻击时的身份窃取行为，可建议用此设置（虽然不是所有浏览器都支持），不过这个说法经常有争议。 PHP 5.2.0 中添加。 <strong>TRUE</strong> 或 <strong>FALSE</strong></p><p><strong>JavaScript 操作 cookie</strong></p><p>在 JavaScript 中通过 document.cookie 属性，你可以创建、维护和删除 cookie。创建 cookie 时该属性等同于 Set-Cookie 消息头，而在读取 cookie 时则等同于 Cookie 消息头。</p><h3 id="删除cookie"><a href="#删除cookie" class="headerlink" title="删除cookie"></a>删除cookie</h3><p>会话 cooke (Session cookie) 在会话结束时（浏览器关闭）会被删除。</p><p>持久化 cookie（Persistent cookie）在到达失效日期时会被删除。</p><p>如果浏览器中的 cookie 数量达到限制，那么 cookie 会被删除以为新建的 cookie 创建空间。</p><h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><p>session的作用和cookie差不多，也是用来解决Http协议不能维持状态的问题。但是session只存储在服务器端的，不会在网络中进行传输，所以较cookie来说，session相对安全一些。但是session是依赖cookie的，当用户访问某一站点时，服务器会为这个用户产生唯一的session_id,并把这个session_id以cookie的形式发送到客户端，以后的客户端的所有请求都会自动携带这个cookie（前提是浏览器支持并且没有禁用cookie）。</p><p>用下面这个图来了解下session的工作原理:</p><p><img src="http://www.phpfensi.com/uploadfile/2016/0830/20160830022704117.png" alt="img"></p><p>禁用cookie时如何使用session</p><p>有些时候,为了安全浏览器会禁用cookie,这时可以用传参的方式将session_id发送到服务器,session可以照常工作.</p><h2 id="删除session"><a href="#删除session" class="headerlink" title="删除session"></a>删除session</h2><p>会话关闭后，session会自动失效，如果想手动删除session，可以在服务器端编程实现。如PHP是这样做的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$_SESSION = <span class="keyword">array</span>();</div><div class="line">session_destory();</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Cookie和Session</title>
      <link href="/2015/10/19/1/"/>
      <content type="html"><![CDATA[<h2 id="session技术"><a href="#session技术" class="headerlink" title="session技术"></a>session技术</h2><h1 id="Session基础"><a href="#Session基础" class="headerlink" title="Session基础"></a>Session基础</h1><p>PHP有内建的会话支持，帮助你维护所有cookie的状态来通过不同的页面和多访问提供持久的变量访问，会话可以让你简单地创建多页面表单（如购物车），页面之间的用户认证信息保存，以及在站点上存储持久的用户偏好。</p><p>每个初次访问的客户会分配到一个唯一的会话ID，默认情况下，会话ID会存储到cookie中，叫做PHPSESSID。如果浏览器不支持cookie或者关闭了</p><h2 id="创建Session"><a href="#创建Session" class="headerlink" title="创建Session"></a>创建Session</h2><p>在创建Session之前，我们需要知道，</p><p>3，保存session信息</p><p>index1.php</p><p>index2.php</p><p>　　先在网页中运行index1.php，再运行index2.php页面输出：</p><p><img src="https://images2015.cnblogs.com/blog/527602/201609/527602-20160927164512656-711284124.png" alt="img"></p><h2 id="session可以保存多种数据类型"><a href="#session可以保存多种数据类型" class="headerlink" title="session可以保存多种数据类型"></a>session可以保存多种数据类型</h2><p>session不但保存字符串，还可以保存整型，布尔型，数组，对象等。</p><p>index1.php</p><p>index2.php</p><p>　　先在网页中运行index1.php，再运行index2.php页面输出：</p><p><img src="https://images2015.cnblogs.com/blog/527602/201609/527602-20160927164844735-530897279.png" alt="img"></p><p><img src="https://images2015.cnblogs.com/blog/527602/201609/527602-20160927165530578-1895480954.png" alt="img"></p><h2 id="获取session信息"><a href="#获取session信息" class="headerlink" title="获取session信息"></a>获取session信息</h2><p>直接获取所有session</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012000955406-233131158.png" alt="img"></p><p>根据key获取</p><p>直接获取某个变量</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001004953-995359578.png" alt="img"></p><p>获取数组</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001011609-1786708842.png" alt="img"></p><p>获取对象，session在保存对象时候，没法保存类的信息，因此在获取对象，需要先声明这个类。可以把类单独作为一个文件，存储和读取session时候分别引用这个文件。</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001019234-875162513.png" alt="img"></p><p>6，Session的更新，就是根据key值重新保存session的值。</p><h2 id="Session的删除"><a href="#Session的删除" class="headerlink" title="Session的删除"></a>Session的删除</h2><p>(1) 指定删除session中某个键值对</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001026109-724254497.png" alt="img"></p><p>(2) 删除所有session</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001032171-280699486.png" alt="img"></p><h2 id="设置默认时间"><a href="#设置默认时间" class="headerlink" title="设置默认时间"></a>设置默认时间</h2><p>session数据默认存在时间是1440s（24分钟），可以在php.ini中修改， session.gc_maxlifetime = 1440。Session文件的存放路径是可以修改的，可以通过修改php.ini改变sesion文件存放路径，session.save_path = “tcp://127.0.0.1:11211”。</p><h2 id="自动开启Session"><a href="#自动开启Session" class="headerlink" title="自动开启Session"></a>自动开启Session</h2><p>Session使用前，先进行初始化，session_start();这样比较麻烦，可以在php.ini设置session自动初始化，session.auto_start = 0（此方法不推荐）。</p><p>10，浏览器访问页面a.php时候，服务器产生一个session文件，将其存放在服务器，同时将session_id发送给浏览器，浏览器将其保存到cookie，浏览器再次访问b.php时候，从cookie中获取session_id发送到服务器，服务器根据session_id获取相应session内容。</p><p>问题：如果浏览器禁用cookie，怎么使用session呢？</p><p>使用URL重写的方式，url重写分为手动和自动。自动重写url就是配置php.ini，开启透明的SID，其他程序不变，自动重写url不安全，不建议使用。</p><p>开启透明SID，需要修改的php.ini是：</p><p>session.use_trans_sid = 1  //由0改为1</p><p>session.use_only_cookies = 0  //是否只使用cookie来保存session值  该参数为1时，上述机制失效。</p><p>session.use_cookies = 0  //设置客户端是否使用cookie来保存session值  该参数的值不影响上述机制的进行。这个可改可不改</p><p>手动模式：</p><p>index1.php</p><p>index2.php</p><p>而自动模式，会将url后面自动添加PHPSESSID参数，所以在index1.php中去掉SID即可，index2.php不变。</p><p>index1.php</p><p>11，php.ini中关于session和cookie的配置</p><p>(1) session.use_trans_sid = 0，开启后，默认为每个url后添加了session_name=session_id。</p><p>(2) session.save_path=”c:/mysession”，save_path是session文件在服务器的存放路径。</p><p>(3) session.gc_maxlifetime = 1440,session默认最大生命周期，当session文件在1440s后没被访问的话，则该session被视为“垃圾文件”，并且等待gc(垃圾回收)进程的调用时候被清理掉；session.gc_probability=1;session.gc_divisor=1000;这两个参数根据网站规模合理设置。每当初始化一个session时候，有gc_probability/gc_divisor的概率执行一次垃圾回收。</p><p>我开启三个会话，则创建三个对应的session文件，当每个文件在30秒内都没被调用的话，就会被当成是“垃圾文件”，等到gc进程调用的时候，“垃圾文件”就会被unlink，因为之前我已经通过修改php.ini配置文件，将gc被调用的概率改成百分百，所以接下来，如果我重新使用任何一个浏览器刷新下页面的时候，三个session文件，应该只剩下一个了。</p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001042968-352947356.png" alt="img"></p><p> <img src="https://images2015.cnblogs.com/blog/527602/201610/527602-20161012001052203-1655209067.png" alt="img"></p><p>(4) session.cookie_lifetime，以秒数指定了发送到浏览器的cookie的生命周期，值为0表示“直到关闭浏览器”。默认为0。这个与程序中setCookie(“name”,”zhangsan”,time()+60);类似。</p><h2 id="禁用cookie的session使用方案"><a href="#禁用cookie的session使用方案" class="headerlink" title="禁用cookie的session使用方案"></a>禁用cookie的session使用方案</h2><p>在浏览器中，有的用户会禁用掉cookie(现在基本上已经不会出现了)，但是这种情况还是会有发生。</p><ul><li>通过URL传值，把session id附加到URL上（缺点：整个站点中不能有纯净静态页面，因为纯静态页面的session id将无法传递到下一个页面）。</li><li>通过隐藏表单，把session id放到表单的隐藏文本框中同表单一块提交过去（缺点不适用\<a\>标签这种直接跳转的非标单情况）</a\></li><li>直接配置php.ini，将session.use_trans_sid = 0设置为1</li><li>用文件、数据库等形式保存session id，在跨页面中手动调用。</li></ul>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>利用 INSERT 命令将表中字段导入到新表中</title>
      <link href="/2015/09/18/1/"/>
      <content type="html"><![CDATA[<p>最近为公司内部系统写了一个爬虫，爬了一个问答社区的三万多条数据，由于一开始的设计不够合理，将所有记录都放入了一个表中，由于是问答系统，合理的数据库设计，应该是将问题和答案分离开来，这样的结构更加合理，也易于未来的扩展。</p><p>我刚开始做iOS 的，转到 PHP 有一年多了，大学时有自学PHP，东学学西搞搞，结果就变成了啥都快记不住了，什么也都懂一些。</p><p>到了现在MYSQL 的基础也忘了许多，你让我扯一扯大规模，主从，分表，优化，我倒是能说上一堆，但是实际操作起来，啧啧。</p><p>这么一个简单的功能一时之间竟然都没有想起来，搜索引擎的确是个好东西（当然不拿医疗盈利的话）。</p><p>现在 iOS 也快忘得差不多了，感叹 ing，Swift 4都出了···</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`new_table_name`</span> <span class="keyword">VALUE</span> (<span class="string">`c1`</span>,<span class="string">`c2`</span>) <span class="keyword">SELECT</span> <span class="string">`c1`</span>,<span class="string">`c2`</span> <span class="keyword">FROM</span> <span class="string">`old_table_name`</span></div></pre></td></tr></table></figure><p>简单的一命令即可将数据导出。</p>]]></content>
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> INSERT </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>DATA URI image封装类</title>
      <link href="/2015/08/17/1/"/>
      <content type="html"><![CDATA[<p>Base64是网络上最常见的用于传输8Bit字节代码的编码方式之一，大家可以查看RFC2045～RFC2049，上面有MIME的详细规范。Base64编码可用于在HTTP环境下传递较长的标识信息。例如，在Java Persistence系统Hibernate中，就采用了Base64来将一个较长的唯一标识符（一般为128-bit的UUID）编码为一个字符串，用作HTTP表单和HTTP GET URL中的参数。在其他应用程序中，也常常需要把二进制数据编码为适合放在URL（包括隐藏表单域）中的形式。此时，采用Base64编码具有不可读性，即所编码的数据不会被人用肉眼所直接看到。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">class DataBase64&#123;</div><div class="line">public $file = &apos;&apos;;</div><div class="line">public function __construct($file)&#123;</div><div class="line">$this-&gt;file = $file;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public function getBase64()&#123;</div><div class="line">$type = getimagesize($this-&gt;file);</div><div class="line">$fp = fopen($this-&gt;file, &apos;r&apos;) or die(&quot;Can&apos;t open file&quot;);</div><div class="line">$file_content= chunk_split(base64_encode(fread($fp, filesize($this-&gt;file)))) ;</div><div class="line">switch($type[2])&#123;//判读图片类型  </div><div class="line">case 1:$img_type=&quot;gif&quot;;break;  </div><div class="line">case 2:$img_type=&quot;jpg&quot;;break;  </div><div class="line">case 3:$img_type=&quot;png&quot;;break;  </div><div class="line">&#125;  </div><div class="line">return $img=&apos;data:image/&apos;.$img_type.&apos;;base64,&apos;.$file_content;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">$data = new DataBase64(&apos;image/1.jpg&apos;);</div><div class="line">$img = $data-&gt;getBase64();</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>目录常量：PATH_SEPARATOR和DIRECTORY_SEPARATOR</title>
      <link href="/2015/07/30/1/"/>
      <content type="html"><![CDATA[<p><strong>DIRECTORY_SEPARATOR（string）</strong></p><p>目录分隔符，这是PHP内置的一个常量，代表着”/“或“”</p><p>因为系统原因，目录的分隔符被分为两种，在windows中目录的分割符号可以使用‘/’或者‘’，但是在linux中目录分隔符只能使用’/‘;</p><p><strong>PATH_SEPARATOR</strong></p><p>路径分隔符，同样是PHP内置的一个常量，在windows系统中，如果使用include包含多个路径可以使用分号（;）来进行分割，可是在linux系统中却要使用冒号（：）。</p><p>这两个常量主要就是用来解决linux与windows的兼容问题，避免因为系统差异出现的错误，可以增强移植性。</p><p>在 THINKPHP 中，将DIRECTORY_SEPARATOR定义为了一个DR 常量用来方便调用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">"DS"</span>, DIRECTORY_SEPARATOR);</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>deepin下安装 php的扩展</title>
      <link href="/2015/05/26/1/"/>
      <content type="html"><![CDATA[<p>一直没用过linux开发PHP，昨天试了一下，却发现deepin下安装的php默认是不开其扩展的，可是PHP.INI中却没有开启扩展的选项，无奈之下百度了一番，却发现文章很少，但是却找到了ubuntu的命令，型号deepin的命令跟ubuntu一样，到是解决了PHP扩展的一些问题，原来只需要将所需要的扩展下载下来，重启服务器便可。</p><p>代码如下： </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install php5-你所需要的扩展。</div><div class="line"></div><div class="line">sudo service apache2 restart</div></pre></td></tr></table></figure><p>这样用来扩展就可以使用了。</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Smarty3封装类</title>
      <link href="/2015/05/21/1/"/>
      <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// load Smarty library </span></div><div class="line">   <span class="keyword">require</span>(<span class="string">'Smarty.class.php'</span>); </div><div class="line"><span class="comment">// The setup.php file is a good place to load </span></div><div class="line"><span class="comment">// required application library files, and you </span></div><div class="line"><span class="comment">// can do that right here. An example: </span></div><div class="line">   <span class="keyword">require</span>(<span class="string">'guestbook/guestbook.lib.php'</span>); </div><div class="line">   <span class="class"><span class="keyword">class</span> <span class="title">Smarty_GuestBook</span> <span class="keyword">extends</span> <span class="title">Smarty</span> </span>&#123;    </div><div class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;         </div><div class="line"><span class="comment">// Class Constructor.         </span></div><div class="line"><span class="comment">// These automatically get set with each new instance.         </span></div><div class="line">        <span class="keyword">parent</span>::__construct();         </div><div class="line">        <span class="keyword">$this</span>-&gt;setTemplateDir(<span class="string">'/web/www.example.com/guestbook/templates/'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;setCompileDir(<span class="string">'/web/www.example.com/guestbook/templates_c/'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;setConfigDir(<span class="string">'/web/www.example.com/guestbook/configs/'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;setCacheDir(<span class="string">'/web/www.example.com/guestbook/cache/'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;caching = Smarty::CACHING_LIFETIME_CURRENT;</div><div class="line">        <span class="keyword">$this</span>-&gt;assign(<span class="string">'app_name'</span>, <span class="string">'Guest Book'</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP框架编写（二）单入口路由</title>
      <link href="/2015/04/30/1/"/>
      <content type="html"><![CDATA[<h1 id="PHP框架编写（二）单入口路由"><a href="#PHP框架编写（二）单入口路由" class="headerlink" title="PHP框架编写（二）单入口路由"></a>PHP框架编写（二）单入口路由</h1><p>基本思路是浏览器端通过URL字符串提供控制器类的名字和方法的名字，PHP据此找到对应的类和方法。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/******************************************************* </span></div><div class="line"> * </div><div class="line"> * URL 路由原理展示代码 </div><div class="line"> * </div><div class="line"> * 浏览器访问地址: http://server/index.php?C=Controler1&amp;M=Method1 </div><div class="line"> * 根据C找到控制器类，再根据M找到方法，然后执行这个方法 </div><div class="line"> *  </div><div class="line"> * ****************************************************/ </div><div class="line">  </div><div class="line">$C = <span class="keyword">isset</span>($_GET[<span class="string">'C'</span>]) ? $_GET[<span class="string">'C'</span>]: <span class="keyword">null</span>;  </div><div class="line">$M = <span class="keyword">isset</span>($_GET[<span class="string">'M'</span>]) ? $_GET[<span class="string">'M'</span>]: <span class="keyword">null</span>;  </div><div class="line">  </div><div class="line"><span class="keyword">if</span>($C != <span class="keyword">NULL</span> &amp;&amp; $M != <span class="keyword">NULL</span> &amp;&amp; class_exists($C) &amp;&amp; method_exists($C, $M)) &#123;  </div><div class="line">    $cObj = <span class="keyword">new</span> $C();  </div><div class="line">    $cObj-&gt;$M();  </div><div class="line">&#125;<span class="keyword">else</span>&#123;  </div><div class="line">    <span class="keyword">echo</span> <span class="string">'找不到控制器或方法'</span>;  </div><div class="line">    <span class="keyword">exit</span>;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">// 控制器1  </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controler1</span>  </span></div><div class="line">&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Method1</span><span class="params">()</span>  </span></div><div class="line">    &#123;     </div><div class="line">        <span class="keyword">echo</span> <span class="string">'Controler1, Method1'</span>;  </div><div class="line">    &#125;     </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Method2</span><span class="params">()</span>  </span></div><div class="line">    &#123;     </div><div class="line">        <span class="keyword">echo</span> <span class="string">'Controler1, Method2'</span>;  </div><div class="line">    &#125;     </div><div class="line">&#125;  </div><div class="line"><span class="comment">// 控制器2  </span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controler2</span>  </span></div><div class="line">&#123;  </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Method1</span><span class="params">()</span>  </span></div><div class="line">    &#123;     </div><div class="line">        <span class="keyword">echo</span> <span class="string">'Controler2, Method1'</span>;  </div><div class="line">    &#125;     </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Method2</span><span class="params">()</span>  </span></div><div class="line">    &#123;     </div><div class="line">        <span class="keyword">echo</span> <span class="string">'Controler2, Method2'</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PHP框架编写（一）：框架运行流程</title>
      <link href="/2015/04/29/1/"/>
      <content type="html"><![CDATA[<p>首先欢迎各位进入我的博客，我感觉非常荣幸，我并不是什么高手，现在的我不过是个在校的大学生，写这篇系列的博文只不过是为了加深自己对PHP的理解，以及对之前的学习做一个总结，同时也希望各位能够给我提一些意见。</p><p> PHP框架总给人以高大上的感觉，很多人学框架都学的头晕脑胀，百思不得其解，看完这篇博文后应该可以让还处于迷茫中的学习者找到一个入门的道路。</p><p>PHP框架到底是什么，框架不过是其他程序员提供的一个快速开发的一个代码而已，他帮助PHP开发者能够快速的开发，免去一些代码而已，PHP框架目前的核心就是MVC和数据库操作，更加大白话一点其实就是编程中最基础的增删改查，不过就是将他变的更加漂亮而已。</p><p>那么什么是MVC呢，M模型,V显示,C控制器。</p><p>这基本上是所有教程和书中都会提及的概念，也就不再多进行赘述模糊不清的概念了。</p><p>M是啥，字面上理解太费劲了，其实M模型我感觉表面上就是对数据库的操作，以及业务逻辑的梳理，这便是M模型，主要进行逻辑分析，将分析的结果传递给C也就是控制器，M就是一个深藏功与名的人，他默默就默默地站在幕后，干着最累的工作。</p><p>V就是显示，也就是其中最好面子的人，他们两个人忙活半天，其实都是在给我忙活，所有东西都处理完了，拿到他这里来显示。</p><p>C控制器，这个字面上就好理解了，那就是起到控制的作用，他控制着全局，属于M和C的一个中间层。（如果说错了，还请高手指正）</p><p>现在市面上的PHP框架基本上都是单一入口的文件。下面就是一个PHP框架的运行的简单流程图。</p><p> 对PHP框架有了一定的了解之后，我们下一篇就开始讲PHP框架的目录结构了。</p><p>仅以此文先给刚刚入门的菜鸟，和正在努力奋斗的程序员们，祝各位早日成为攻城狮！出任CTO，赢取白富美，走向人生巅峰。</p><p>（如有转载，请注明出处，小弟感激不尽。）</p>]]></content>
      
      <categories>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
